diff --git a/.editorconfig b/.editorconfig
deleted file mode 100644
index e1217265..00000000
--- a/.editorconfig
+++ /dev/null
@@ -1,13 +0,0 @@
-# EditorConfig helps developers define and maintain consistent
-# coding styles between different editors and IDEs
-# editorconfig.org
-
-root = true
-
-[*]
-end_of_line = lf
-charset = utf-8
-trim_trailing_whitespace = true
-insert_final_newline = true
-indent_style = tab
-indent_size = 4
diff --git a/.gitattributes b/.gitattributes
index 15852b98..8359151a 100644
--- a/.gitattributes
+++ b/.gitattributes
@@ -1,5 +1,2 @@
-/.gitattributes export-ignore
-/.gitignore export-ignore
-/composer.json export-ignore
-/composer.lock export-ignore
-/tests export-ignore
+.gitattributes	export-ignore
+.gitignore	export-ignore
diff --git a/.gitignore b/.gitignore
index aa655964..c7ddbedf 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,7 +1,9 @@
-# Composer dependencies
-/vendor/
-
-# FluxBB-specific files
+/*.sublime-project
+/.project
+/.settings/
+/nbproject/
+*.sublime-project
+.idea
 /cache/cache_*.php
 /cache/*.cache
 /cache/db_update.lock
diff --git a/addons/recaptcha.php b/addons/recaptcha.php
new file mode 100644
index 00000000..668de1c4
--- /dev/null
+++ b/addons/recaptcha.php
@@ -0,0 +1,136 @@
+<?php
+
+class addon_recaptcha extends flux_addon
+{
+	function register($manager)
+	{
+		global $pun_user;
+
+		if (!$this->is_configured()) return;
+
+		$this->get_language();
+
+		if ($this->enabled_location('register'))
+		{
+			$manager->bind('register_after_validation', array($this, 'hook_after_validation'));
+			$manager->bind('register_before_submit', array($this, 'hook_before_submit'));
+		}
+
+		if ($this->enabled_location('login'))
+		{
+			$manager->bind('login_after_validation', array($this, 'hook_after_validation'));
+			$manager->bind('login_before_submit', array($this, 'hook_before_submit'));
+		}
+
+		if ($this->enabled_location('guestpost') && $pun_user['is_guest'])
+		{
+			$manager->bind('post_after_validation', array($this, 'hook_after_validation'));
+			$manager->bind('post_before_submit', array($this, 'hook_before_submit'));
+			$manager->bind('quickpost_before_submit', array($this, 'hook_before_submit'));
+		}
+	}
+
+	function is_configured()
+	{
+		global $pun_config;
+
+		return !empty($pun_config['recaptcha_enabled']) && !empty($pun_config['recaptcha_site_key']) && !empty($pun_config['recaptcha_secret_key']);
+	}
+
+	function enabled_location($page)
+	{
+		global $pun_config;
+
+		return !empty($pun_config['recaptcha_location_'.$page]);
+	}
+
+	function get_language()
+	{
+		global $pun_user;
+
+		if (file_exists(PUN_ROOT.'lang/'.$pun_user['language'].'/recaptcha_addon.php'))
+			require PUN_ROOT.'lang/'.$pun_user['language'].'/recaptcha_addon.php';
+		else
+			require PUN_ROOT.'lang/English/recaptcha_addon.php';
+	}
+
+	function hook_after_validation()
+	{
+		global $errors, $lang_recaptcha;
+
+		if (empty($errors) && !$this->verify_user_response())
+		{
+			$errors[] = $lang_recaptcha['Error'];
+		}
+	}
+
+	function hook_before_submit()
+	{
+		global $pun_config, $lang_recaptcha;
+
+		$site_key = $pun_config['recaptcha_site_key'];
+
+		?>
+        <div class="inform">
+            <fieldset>
+                <legend><?= $lang_recaptcha['Human']; ?></legend>
+                <div class="infldset">
+                    <p><?= $lang_recaptcha['Prove']; ?></p>
+                    <script src="https://www.google.com/recaptcha/api.js"></script>
+                    <div class="g-recaptcha" data-sitekey="<?php echo pun_htmlspecialchars($site_key) ?>"></div>
+                </div>
+            </fieldset>
+        </div>
+		<?php
+	}
+
+	function verify_user_response()
+	{
+		global $pun_config;
+
+		if (empty($_POST['g-recaptcha-response'])) return false;
+
+		$secret = $pun_config['recaptcha_secret_key'];
+		$response = $_POST['g-recaptcha-response'];
+		$ip = get_remote_address();
+
+		$query = "secret=$secret&response=$response&remoteip=$ip";
+		$url = "https://www.google.com/recaptcha/api/siteverify?$query";
+
+		$response = $this->send_request($url);
+
+		return strpos($response, '"success": true') !== false;
+	}
+
+	function send_request($url)
+	{
+		if (function_exists('curl_version'))
+			return $this->send_curl_request($url);
+		else
+			return $this->get_remote_file($url);
+	}
+
+	function send_curl_request($url)
+	{
+		$ch = curl_init();
+		curl_setopt($ch, CURLOPT_URL, $url);
+		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
+		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
+		$response = curl_exec($ch);
+		curl_close($ch);
+
+		return $response;
+	}
+
+	function get_remote_file($url)
+	{
+		global $lang_recaptcha;
+
+		$response = file_get_contents($url);
+
+		if ($response === false)
+			throw new Exception($lang_recaptcha['API error']);
+
+		return $response;
+	}
+}
diff --git a/admin_bans.php b/admin_bans.php
index 2a9df67d..06b22c3c 100644
--- a/admin_bans.php
+++ b/admin_bans.php
@@ -1,600 +1,602 @@
-<?php
-
-/**
- * Copyright (C) 2008-2012 FluxBB
- * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
- * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
- */
-
-// Tell header.php to use the admin template
-define('PUN_ADMIN_CONSOLE', 1);
-
-define('PUN_ROOT', dirname(__FILE__).'/');
-require PUN_ROOT.'include/common.php';
-require PUN_ROOT.'include/common_admin.php';
-
-
-if ($pun_user['g_id'] != PUN_ADMIN && ($pun_user['g_moderator'] != '1' || $pun_user['g_mod_ban_users'] == '0'))
-	message($lang_common['No permission'], false, '403 Forbidden');
-
-// Load the admin_bans.php language file
-require PUN_ROOT.'lang/'.$admin_language.'/admin_bans.php';
-
-// Add/edit a ban (stage 1)
-if (isset($_REQUEST['add_ban']) || isset($_GET['edit_ban']))
-{
-	if (isset($_GET['add_ban']) || isset($_POST['add_ban']))
-	{
-		// If the ID of the user to ban was provided through GET (a link from profile.php)
-		if (isset($_GET['add_ban']))
-		{
-			$user_id = intval($_GET['add_ban']);
-			if ($user_id < 2)
-				message($lang_common['Bad request'], false, '404 Not Found');
-
-			$result = $db->query('SELECT group_id, username, email FROM '.$db->prefix.'users WHERE id='.$user_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
-				list($group_id, $ban_user, $ban_email) = $db->fetch_row($result);
-			else
-				message($lang_admin_bans['No user ID message']);
-		}
-		else // Otherwise the username is in POST
-		{
-			$ban_user = pun_trim($_POST['new_ban_user']);
-
-			if ($ban_user != '')
-			{
-				$result = $db->query('SELECT id, group_id, username, email FROM '.$db->prefix.'users WHERE username=\''.$db->escape($ban_user).'\' AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-				if ($db->has_rows($result))
-					list($user_id, $group_id, $ban_user, $ban_email) = $db->fetch_row($result);
-				else
-					message($lang_admin_bans['No user message']);
-			}
-		}
-
-		// Make sure we're not banning an admin or moderator
-		if (isset($group_id))
-		{
-			if ($group_id == PUN_ADMIN)
-				message(sprintf($lang_admin_bans['User is admin message'], pun_htmlspecialchars($ban_user)));
-
-			$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());
-			$is_moderator_group = $db->result($result);
-
-			if ($is_moderator_group)
-				message(sprintf($lang_admin_bans['User is mod message'], pun_htmlspecialchars($ban_user)));
-		}
-
-		// If we have a $user_id, we can try to find the last known IP of that user
-		if (isset($user_id))
-		{
-			$result = $db->query('SELECT poster_ip FROM '.$db->prefix.'posts WHERE poster_id='.$user_id.' ORDER BY posted DESC LIMIT 1') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-			$ban_ip = ($db->has_rows($result)) ? $db->result($result) : '';
-
-			if ($ban_ip == '')
-			{
-				$result = $db->query('SELECT registration_ip FROM '.$db->prefix.'users WHERE id='.$user_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-				$ban_ip = ($db->has_rows($result)) ? $db->result($result) : '';
-			}
-		}
-
-		$mode = 'add';
-	}
-	else // We are editing a ban
-	{
-		$ban_id = intval($_GET['edit_ban']);
-		if ($ban_id < 1)
-			message($lang_common['Bad request'], false, '404 Not Found');
-
-		$result = $db->query('SELECT username, ip, email, message, expire FROM '.$db->prefix.'bans WHERE id='.$ban_id) or error('Unable to fetch ban info', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
-			list($ban_user, $ban_ip, $ban_email, $ban_message, $ban_expire) = $db->fetch_row($result);
-		else
-			message($lang_common['Bad request'], false, '404 Not Found');
-
-		$diff = ($pun_user['timezone'] + $pun_user['dst']) * 3600;
-		$ban_expire = ($ban_expire != '') ? gmdate('Y-m-d', $ban_expire + $diff) : '';
-
-		$mode = 'edit';
-	}
-
-	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans']);
-	$focus_element = array('bans2', 'ban_user');
-	define('PUN_ACTIVE_PAGE', 'admin');
-	require PUN_ROOT.'header.php';
-
-	generate_admin_menu('bans');
-
-?>
-	<div class="blockform">
-		<h2><span><?php echo $lang_admin_bans['Ban advanced head'] ?></span></h2>
-		<div class="box">
-			<form id="bans2" method="post" action="admin_bans.php">
-				<div class="inform">
-				<input type="hidden" name="mode" value="<?php echo $mode ?>" />
-<?php if ($mode == 'edit'): ?>				<input type="hidden" name="ban_id" value="<?php echo $ban_id ?>" />
-<?php endif; ?>				<fieldset>
-						<legend><?php echo $lang_admin_bans['Ban advanced subhead'] ?></legend>
-						<div class="infldset">
-							<table class="aligntop">
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?></th>
-									<td>
-										<input type="text" name="ban_user" size="25" maxlength="25" value="<?php if (isset($ban_user)) echo pun_htmlspecialchars($ban_user); ?>" tabindex="1" />
-										<span><?php echo $lang_admin_bans['Username help'] ?></span>
-									</td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['IP label'] ?></th>
-									<td>
-										<input type="text" name="ban_ip" size="45" maxlength="255" value="<?php if (isset($ban_ip)) echo pun_htmlspecialchars($ban_ip); ?>" tabindex="2" />
-										<span><?php echo $lang_admin_bans['IP help'] ?><?php if ($ban_user != '' && isset($user_id)) printf(' '.$lang_admin_bans['IP help link'], '<a href="admin_users.php?ip_stats='.$user_id.'">'.$lang_admin_common['here'].'</a>') ?></span>
-									</td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['E-mail label'] ?></th>
-									<td>
-										<input type="text" name="ban_email" size="40" maxlength="80" value="<?php if (isset($ban_email)) echo pun_htmlspecialchars($ban_email); ?>" tabindex="3" />
-										<span><?php echo $lang_admin_bans['E-mail help'] ?></span>
-									</td>
-								</tr>
-							</table>
-							<p class="topspace"><strong class="warntext"><?php echo $lang_admin_bans['Ban IP range info'] ?></strong></p>
-						</div>
-					</fieldset>
-				</div>
-				<div class="inform">
-					<fieldset>
-						<legend><?php echo $lang_admin_bans['Message expiry subhead'] ?></legend>
-						<div class="infldset">
-							<table class="aligntop">
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Ban message label'] ?></th>
-									<td>
-										<input type="text" name="ban_message" size="50" maxlength="255" value="<?php if (isset($ban_message)) echo pun_htmlspecialchars($ban_message); ?>" tabindex="4" />
-										<span><?php echo $lang_admin_bans['Ban message help'] ?></span>
-									</td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Expire date label'] ?></th>
-									<td>
-										<input type="text" name="ban_expire" size="17" maxlength="10" value="<?php if (isset($ban_expire)) echo $ban_expire; ?>" tabindex="5" />
-										<span><?php echo $lang_admin_bans['Expire date help'] ?></span>
-									</td>
-								</tr>
-							</table>
-						</div>
-					</fieldset>
-				</div>
-				<p class="submitend"><input type="submit" name="add_edit_ban" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="6" /></p>
-			</form>
-		</div>
-	</div>
-	<div class="clearer"></div>
-</div>
-<?php
-
-	require PUN_ROOT.'footer.php';
-}
-
-// Add/edit a ban (stage 2)
-else if (isset($_POST['add_edit_ban']))
-{
-	confirm_referrer('admin_bans.php');
-
-	$ban_user = pun_trim($_POST['ban_user']);
-	$ban_ip = pun_trim($_POST['ban_ip']);
-	$ban_email = strtolower(pun_trim($_POST['ban_email']));
-	$ban_message = pun_trim($_POST['ban_message']);
-	$ban_expire = pun_trim($_POST['ban_expire']);
-
-	if ($ban_user == '' && $ban_ip == '' && $ban_email == '')
-		message($lang_admin_bans['Must enter message']);
-	else if (strtolower($ban_user) == 'guest')
-		message($lang_admin_bans['Cannot ban guest message']);
-
-	// Make sure we're not banning an admin or moderator
-	if (!empty($ban_user))
-	{
-		$result = $db->query('SELECT group_id FROM '.$db->prefix.'users WHERE username=\''.$db->escape($ban_user).'\' AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
-		{
-			$group_id = $db->result($result);
-
-			if ($group_id == PUN_ADMIN)
-				message(sprintf($lang_admin_bans['User is admin message'], pun_htmlspecialchars($ban_user)));
-
-			$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());
-			$is_moderator_group = $db->result($result);
-
-			if ($is_moderator_group)
-				message(sprintf($lang_admin_bans['User is mod message'], pun_htmlspecialchars($ban_user)));
-		}
-	}
-
-	// Validate IP/IP range (it's overkill, I know)
-	if ($ban_ip != '')
-	{
-		$ban_ip = preg_replace('%\s{2,}%S', ' ', $ban_ip);
-		$addresses = explode(' ', $ban_ip);
-		$addresses = array_map('pun_trim', $addresses);
-
-		for ($i = 0; $i < count($addresses); ++$i)
-		{
-			if (strpos($addresses[$i], ':') !== false)
-			{
-				$octets = explode(':', $addresses[$i]);
-
-				for ($c = 0; $c < count($octets); ++$c)
-				{
-					$octets[$c] = ltrim($octets[$c], "0");
-
-					if ($c > 7 || (!empty($octets[$c]) && !ctype_xdigit($octets[$c])) || intval($octets[$c], 16) > 65535)
-						message($lang_admin_bans['Invalid IP message']);
-				}
-
-				$cur_address = implode(':', $octets);
-				$addresses[$i] = $cur_address;
-			}
-			else
-			{
-				$octets = explode('.', $addresses[$i]);
-
-				for ($c = 0; $c < count($octets); ++$c)
-				{
-					$octets[$c] = (strlen($octets[$c]) > 1) ? ltrim($octets[$c], "0") : $octets[$c];
-
-					if ($c > 3 || preg_match('%[^0-9]%', $octets[$c]) || intval($octets[$c]) > 255)
-						message($lang_admin_bans['Invalid IP message']);
-				}
-
-				$cur_address = implode('.', $octets);
-				$addresses[$i] = $cur_address;
-			}
-		}
-
-		$ban_ip = implode(' ', $addresses);
-	}
-
-	require PUN_ROOT.'include/email.php';
-	if ($ban_email != '')
-	{
-		// Validate email or domain format
-		if (!is_valid_email($ban_email) && !preg_match('%^[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,63})$%', $ban_email))
-			message($lang_admin_bans['Invalid e-mail message']);
-
-		// Let's ensure we are not adding a duplicate ban
-		$dup_conditions = array('(expire IS NULL OR expire > '.time().')');
-
-		// If we're adding an email address, we can also check for the domain
-		$domain_index = strpos($ban_email, '@');
-
-		if ($domain_index !== false && $_POST['mode'] == 'add')
-		{
-			// We are not checking for domains when editing bans, as that might
-			// prevent editing other fields of already existing email bans for
-			// which a domain ban was added later.
-			$ban_domain = substr($ban_email, $domain_index + 1);
-			$dup_conditions[] = 'email IN (\''.$db->escape($ban_email).'\', \''.$db->escape($ban_domain).'\')';
-		}
-		else
-			$dup_conditions[] = 'email = \''.$db->escape($ban_email).'\'';
-
-		// When editing, we also need to exclude the current ban
-		if ($_POST['mode'] == 'edit')
-			$dup_conditions[] = 'id != '.intval($_POST['ban_id']);
-
-		$result = $db->query('SELECT email FROM '.$db->prefix.'bans WHERE '.implode(' AND ', $dup_conditions)) or error('Unable to check for duplicate bans', __FILE__, __LINE__, $db->error());
-		if ($match = $db->result($result))
-		{
-			$is_domain = strpos($match, '@') === false;
-
-			if ($is_domain)
-				message(sprintf($lang_admin_bans['Duplicate domain message'], $match));
-			else
-				message(sprintf($lang_admin_bans['Duplicate e-mail message'], $match));
-		}
-	}
-
-	if ($ban_expire != '' && $ban_expire != 'Never')
-	{
-		$ban_expire = strtotime($ban_expire.' GMT');
-
-		if ($ban_expire == -1 || !$ban_expire)
-			message($lang_admin_bans['Invalid date message'].' '.$lang_admin_bans['Invalid date reasons']);
-
-		$diff = ($pun_user['timezone'] + $pun_user['dst']) * 3600;
-		$ban_expire -= $diff;
-
-		if ($ban_expire <= time())
-			message($lang_admin_bans['Invalid date message'].' '.$lang_admin_bans['Invalid date reasons']);
-	}
-	else
-		$ban_expire = 'NULL';
-
-	$ban_user = ($ban_user != '') ? '\''.$db->escape($ban_user).'\'' : 'NULL';
-	$ban_ip = ($ban_ip != '') ? '\''.$db->escape($ban_ip).'\'' : 'NULL';
-	$ban_email = ($ban_email != '') ? '\''.$db->escape($ban_email).'\'' : 'NULL';
-	$ban_message = ($ban_message != '') ? '\''.$db->escape($ban_message).'\'' : 'NULL';
-
-	if ($_POST['mode'] == 'add')
-		$db->query('INSERT INTO '.$db->prefix.'bans (username, ip, email, message, expire, ban_creator) VALUES('.$ban_user.', '.$ban_ip.', '.$ban_email.', '.$ban_message.', '.$ban_expire.', '.$pun_user['id'].')') or error('Unable to add ban', __FILE__, __LINE__, $db->error());
-	else
-		$db->query('UPDATE '.$db->prefix.'bans SET username='.$ban_user.', ip='.$ban_ip.', email='.$ban_email.', message='.$ban_message.', expire='.$ban_expire.' WHERE id='.intval($_POST['ban_id'])) or error('Unable to update ban', __FILE__, __LINE__, $db->error());
-
-	// Regenerate the bans cache
-	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))
-		require PUN_ROOT.'include/cache.php';
-
-	generate_bans_cache();
-
-	if ($_POST['mode'] == 'edit')
-		redirect('admin_bans.php', $lang_admin_bans['Ban edited redirect']);
-	else
-		redirect('admin_bans.php', $lang_admin_bans['Ban added redirect']);
-}
-
-// Remove a ban
-else if (isset($_GET['del_ban']))
-{
-	confirm_referrer('admin_bans.php');
-
-	$ban_id = intval($_GET['del_ban']);
-	if ($ban_id < 1)
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	$db->query('DELETE FROM '.$db->prefix.'bans WHERE id='.$ban_id) or error('Unable to delete ban', __FILE__, __LINE__, $db->error());
-
-	// Regenerate the bans cache
-	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))
-		require PUN_ROOT.'include/cache.php';
-
-	generate_bans_cache();
-
-	redirect('admin_bans.php', $lang_admin_bans['Ban removed redirect']);
-}
-
-// Find bans
-else if (isset($_GET['find_ban']))
-{
-	$form = isset($_GET['form']) ? $_GET['form'] : array();
-
-	// trim() all elements in $form
-	$form = array_map('pun_trim', $form);
-	$conditions = $query_str = array();
-
-	$expire_after = isset($_GET['expire_after']) ? pun_trim($_GET['expire_after']) : '';
-	$expire_before = isset($_GET['expire_before']) ? pun_trim($_GET['expire_before']) : '';
-	$order_by = isset($_GET['order_by']) && in_array($_GET['order_by'], array('username', 'ip', 'email', 'expire')) ? $_GET['order_by'] : 'username';
-	$direction = isset($_GET['direction']) && $_GET['direction'] == 'DESC' ? 'DESC' : 'ASC';
-
-	$query_str[] = 'order_by='.$order_by;
-	$query_str[] = 'direction='.$direction;
-
-	// Try to convert date/time to timestamps
-	if ($expire_after != '')
-	{
-		$query_str[] = 'expire_after='.$expire_after;
-
-		$expire_after = strtotime($expire_after);
-		if ($expire_after === false || $expire_after == -1)
-			message($lang_admin_bans['Invalid date message']);
-
-		$conditions[] = 'b.expire>'.$expire_after;
-	}
-	if ($expire_before != '')
-	{
-		$query_str[] = 'expire_before='.$expire_before;
-
-		$expire_before = strtotime($expire_before);
-		if ($expire_before === false || $expire_before == -1)
-			message($lang_admin_bans['Invalid date message']);
-
-		$conditions[] = 'b.expire<'.$expire_before;
-	}
-
-	$like_command = ($db_type == 'pgsql') ? 'ILIKE' : 'LIKE';
-	foreach ($form as $key => $input)
-	{
-		if ($input != '' && in_array($key, array('username', 'ip', 'email', 'message')))
-		{
-			$conditions[] = 'b.'.$db->escape($key).' '.$like_command.' \''.$db->escape(str_replace(array('*', '_'), array('%', '\\_'), $input)).'\'';
-			$query_str[] = 'form%5B'.$key.'%5D='.urlencode($input);
-		}
-	}
-
-	// Fetch ban count
-	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'bans as b WHERE b.id>0'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '')) or error('Unable to fetch ban list', __FILE__, __LINE__, $db->error());
-	$num_bans = $db->result($result);
-
-	// Determine the ban offset (based on $_GET['p'])
-	$num_pages = ceil($num_bans / 50);
-
-	$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);
-	$start_from = 50 * ($p - 1);
-
-	// Generate paging links
-	$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'admin_bans.php?find_ban=&amp;'.implode('&amp;', $query_str));
-
-	$crumbs = generate_crumbs(array(
-		array($lang_admin_common['Admin'].' '.$lang_admin_common['Index'], 'admin_index.php'),
-		array($lang_admin_common['Bans'], 'admin_bans.php'),
-		$lang_admin_bans['Results head'],
-	));
-
-	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans'], $lang_admin_bans['Results head']);
-	define('PUN_ACTIVE_PAGE', 'admin');
-	require PUN_ROOT.'header.php';
-
-?>
-<div class="linkst">
-	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
-		<div class="pagepost">
-			<p class="pagelink"><?php echo $paging_links ?></p>
-		</div>
-		<div class="clearer"></div>
-	</div>
-</div>
-
-
-<div id="bans1" class="blocktable">
-	<h2><span><?php echo $lang_admin_bans['Results head'] ?></span></h2>
-	<div class="box">
-		<div class="inbox">
-			<table>
-			<thead>
-				<tr>
-					<th class="tcl" scope="col"><?php echo $lang_admin_bans['Results username head'] ?></th>
-					<th class="tc2" scope="col"><?php echo $lang_admin_bans['Results e-mail head'] ?></th>
-					<th class="tc3" scope="col"><?php echo $lang_admin_bans['Results IP address head'] ?></th>
-					<th class="tc4" scope="col"><?php echo $lang_admin_bans['Results expire head'] ?></th>
-					<th class="tc5" scope="col"><?php echo $lang_admin_bans['Results message head'] ?></th>
-					<th class="tc6" scope="col"><?php echo $lang_admin_bans['Results banned by head'] ?></th>
-					<th class="tcr" scope="col"><?php echo $lang_admin_bans['Results actions head'] ?></th>
-				</tr>
-			</thead>
-			<tbody>
-<?php
-
-	$result = $db->query('SELECT b.id, b.username, b.ip, b.email, b.message, b.expire, b.ban_creator, u.username AS ban_creator_username FROM '.$db->prefix.'bans AS b LEFT JOIN '.$db->prefix.'users AS u ON b.ban_creator=u.id WHERE b.id>0'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '').' ORDER BY b.'.$db->escape($order_by).' '.$db->escape($direction).' LIMIT '.$start_from.', 50') or error('Unable to fetch ban list', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result))
-	{
-		while ($ban_data = $db->fetch_assoc($result))
-		{
-
-			$actions = '<a href="admin_bans.php?edit_ban='.$ban_data['id'].'">'.$lang_admin_common['Edit'].'</a> | <a href="admin_bans.php?del_ban='.$ban_data['id'].'">'.$lang_admin_common['Remove'].'</a>';
-			$expire = format_time($ban_data['expire'], true);
-
-?>
-				<tr>
-					<td class="tcl"><?php echo ($ban_data['username'] != '') ? pun_htmlspecialchars($ban_data['username']) : '&#160;' ?></td>
-					<td class="tc2"><?php echo ($ban_data['email'] != '') ? pun_htmlspecialchars($ban_data['email']) : '&#160;' ?></td>
-					<td class="tc3"><?php echo ($ban_data['ip'] != '') ? pun_htmlspecialchars($ban_data['ip']) : '&#160;' ?></td>
-					<td class="tc4"><?php echo $expire ?></td>
-					<td class="tc5"><?php echo ($ban_data['message'] != '') ? pun_htmlspecialchars($ban_data['message']) : '&#160;' ?></td>
-					<td class="tc6"><?php echo ($ban_data['ban_creator_username'] != '') ? '<a href="profile.php?id='.$ban_data['ban_creator'].'">'.pun_htmlspecialchars($ban_data['ban_creator_username']).'</a>' : $lang_admin_bans['Unknown'] ?></td>
-					<td class="tcr"><?php echo $actions ?></td>
-				</tr>
-<?php
-
-		}
-	}
-	else
-		echo "\t\t\t\t".'<tr><td class="tcl" colspan="7">'.$lang_admin_bans['No match'].'</td></tr>'."\n";
-
-?>
-			</tbody>
-			</table>
-		</div>
-	</div>
-</div>
-
-<div class="linksb">
-	<div class="inbox crumbsplus">
-		<div class="pagepost">
-			<p class="pagelink"><?php echo $paging_links ?></p>
-		</div>
-		<?php echo $crumbs ?>
-		<div class="clearer"></div>
-	</div>
-</div>
-<?php
-
-	require PUN_ROOT.'footer.php';
-}
-
-$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans']);
-$focus_element = array('bans', 'new_ban_user');
-define('PUN_ACTIVE_PAGE', 'admin');
-require PUN_ROOT.'header.php';
-
-generate_admin_menu('bans');
-
-?>
-	<div class="blockform">
-		<h2><span><?php echo $lang_admin_bans['New ban head'] ?></span></h2>
-		<div class="box">
-			<form id="bans" method="post" action="admin_bans.php?action=more">
-				<div class="inform">
-					<fieldset>
-						<legend><?php echo $lang_admin_bans['Add ban subhead'] ?></legend>
-						<div class="infldset">
-							<table class="aligntop">
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?><div><input type="submit" name="add_ban" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="2" /></div></th>
-									<td>
-										<input type="text" name="new_ban_user" size="25" maxlength="25" tabindex="1" />
-										<span><?php echo $lang_admin_bans['Username advanced help'] ?></span>
-									</td>
-								</tr>
-							</table>
-						</div>
-					</fieldset>
-				</div>
-			</form>
-		</div>
-
-		<h2 class="block2"><span><?php echo $lang_admin_bans['Ban search head'] ?></span></h2>
-		<div class="box">
-			<form id="find_bans" method="get" action="admin_bans.php">
-				<p class="submittop"><input type="submit" name="find_ban" value="<?php echo $lang_admin_bans['Submit search'] ?>" tabindex="3" /></p>
-				<div class="inform">
-					<fieldset>
-						<legend><?php echo $lang_admin_bans['Ban search subhead'] ?></legend>
-						<div class="infldset">
-							<p><?php echo $lang_admin_bans['Ban search info'] ?></p>
-							<table class="aligntop">
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?></th>
-									<td><input type="text" name="form[username]" size="25" maxlength="25" tabindex="4" /></td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['IP label'] ?></th>
-									<td><input type="text" name="form[ip]" size="30" maxlength="255" tabindex="5" /></td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['E-mail label'] ?></th>
-									<td><input type="text" name="form[email]" size="30" maxlength="80" tabindex="6" /></td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Message label'] ?></th>
-									<td><input type="text" name="form[message]" size="30" maxlength="255" tabindex="7" /></td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Expire after label'] ?></th>
-									<td><input type="text" name="expire_after" size="10" maxlength="10" tabindex="8" />
-									<span><?php echo $lang_admin_bans['Date help'] ?></span></td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Expire before label'] ?></th>
-									<td><input type="text" name="expire_before" size="10" maxlength="10" tabindex="9" />
-									<span><?php echo $lang_admin_bans['Date help'] ?></span></td>
-								</tr>
-								<tr>
-									<th scope="row"><?php echo $lang_admin_bans['Order by label'] ?></th>
-									<td>
-										<select name="order_by" tabindex="10">
-											<option value="username" selected="selected"><?php echo $lang_admin_bans['Order by username'] ?></option>
-											<option value="ip"><?php echo $lang_admin_bans['Order by ip'] ?></option>
-											<option value="email"><?php echo $lang_admin_bans['Order by e-mail'] ?></option>
-											<option value="expire"><?php echo $lang_admin_bans['Order by expire'] ?></option>
-										</select>&#160;&#160;&#160;<select name="direction" tabindex="11">
-											<option value="ASC" selected="selected"><?php echo $lang_admin_bans['Ascending'] ?></option>
-											<option value="DESC"><?php echo $lang_admin_bans['Descending'] ?></option>
-										</select>
-									</td>
-								</tr>
-							</table>
-						</div>
-					</fieldset>
-				</div>
-				<p class="submitend"><input type="submit" name="find_ban" value="<?php echo $lang_admin_bans['Submit search'] ?>" tabindex="12" /></p>
-			</form>
-		</div>
-	</div>
-	<div class="clearer"></div>
-</div>
-<?php
-
-require PUN_ROOT.'footer.php';
+<?php
+
+/**
+ * Copyright (C) 2008-2012 FluxBB
+ * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
+ * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
+ */
+
+// Tell header.php to use the admin template
+define('PUN_ADMIN_CONSOLE', 1);
+
+define('PUN_ROOT', dirname(__FILE__).'/');
+require PUN_ROOT.'include/common.php';
+require PUN_ROOT.'include/common_admin.php';
+
+
+if ($pun_user['g_id'] != PUN_ADMIN && ($pun_user['g_moderator'] != '1' || $pun_user['g_mod_ban_users'] == '0'))
+	message($lang_common['No permission'], false, '403 Forbidden');
+
+// Load the admin_bans.php language file
+require PUN_ROOT.'lang/'.$admin_language.'/admin_bans.php';
+
+// Add/edit a ban (stage 1)
+if (isset($_REQUEST['add_ban']) || isset($_GET['edit_ban']))
+{
+	if (isset($_GET['add_ban']) || isset($_POST['add_ban']))
+	{
+		// If the ID of the user to ban was provided through GET (a link from profile.php)
+		if (isset($_GET['add_ban']))
+		{
+			$user_id = intval($_GET['add_ban']);
+			if ($user_id < 2)
+				message($lang_common['Bad request'], false, '404 Not Found');
+
+			$result = $db->query('SELECT group_id, username, email FROM '.$db->prefix.'users WHERE id='.$user_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+			if ($db->num_rows($result))
+				list($group_id, $ban_user, $ban_email) = $db->fetch_row($result);
+			else
+				message($lang_admin_bans['No user ID message']);
+		}
+		else // Otherwise the username is in POST
+		{
+			$ban_user = pun_trim($_POST['new_ban_user']);
+
+			if ($ban_user != '')
+			{
+				$result = $db->query('SELECT id, group_id, username, email FROM '.$db->prefix.'users WHERE username=\''.$db->escape($ban_user).'\' AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+				if ($db->num_rows($result))
+					list($user_id, $group_id, $ban_user, $ban_email) = $db->fetch_row($result);
+				else
+					message($lang_admin_bans['No user message']);
+			}
+		}
+
+		// Make sure we're not banning an admin or moderator
+		if (isset($group_id))
+		{
+			if ($group_id == PUN_ADMIN)
+				message(sprintf($lang_admin_bans['User is admin message'], pun_htmlspecialchars($ban_user)));
+
+			$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());
+			$is_moderator_group = $db->result($result);
+
+			if ($is_moderator_group)
+				message(sprintf($lang_admin_bans['User is mod message'], pun_htmlspecialchars($ban_user)));
+		}
+
+		// If we have a $user_id, we can try to find the last known IP of that user
+		if (isset($user_id))
+		{
+			$result = $db->query('SELECT poster_ip FROM '.$db->prefix.'posts WHERE poster_id='.$user_id.' ORDER BY posted DESC LIMIT 1') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
+			$ban_ip = ($db->num_rows($result)) ? $db->result($result) : '';
+
+			if ($ban_ip == '')
+			{
+				$result = $db->query('SELECT registration_ip FROM '.$db->prefix.'users WHERE id='.$user_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+				$ban_ip = ($db->num_rows($result)) ? $db->result($result) : '';
+			}
+		}
+
+		$mode = 'add';
+	}
+	else // We are editing a ban
+	{
+		$ban_id = intval($_GET['edit_ban']);
+		if ($ban_id < 1)
+			message($lang_common['Bad request'], false, '404 Not Found');
+
+		$result = $db->query('SELECT username, ip, email, message, expire FROM '.$db->prefix.'bans WHERE id='.$ban_id) or error('Unable to fetch ban info', __FILE__, __LINE__, $db->error());
+		if ($db->num_rows($result))
+			list($ban_user, $ban_ip, $ban_email, $ban_message, $ban_expire) = $db->fetch_row($result);
+		else
+			message($lang_common['Bad request'], false, '404 Not Found');
+
+		$diff = ($pun_user['timezone'] + $pun_user['dst']) * 3600;
+		$ban_expire = ($ban_expire != '') ? gmdate('Y-m-d', $ban_expire + $diff) : '';
+
+		$mode = 'edit';
+	}
+
+	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans']);
+	$focus_element = array('bans2', 'ban_user');
+	define('PUN_ACTIVE_PAGE', 'admin');
+	require PUN_ROOT.'header.php';
+
+	generate_admin_menu('bans');
+
+?>
+	<div class="blockform">
+		<h2><span><?php echo $lang_admin_bans['Ban advanced head'] ?></span></h2>
+		<div class="box">
+			<form id="bans2" method="post" action="admin_bans.php">
+				<div class="inform">
+				<input type="hidden" name="mode" value="<?php echo $mode ?>" />
+<?php if ($mode == 'edit'): ?>				<input type="hidden" name="ban_id" value="<?php echo $ban_id ?>" />
+<?php endif; ?>				<fieldset>
+						<legend><?php echo $lang_admin_bans['Ban advanced subhead'] ?></legend>
+						<div class="infldset">
+							<table class="aligntop">
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?></th>
+									<td>
+										<input type="text" name="ban_user" size="25" maxlength="25" value="<?php if (isset($ban_user)) echo pun_htmlspecialchars($ban_user); ?>" />
+										<span><?php echo $lang_admin_bans['Username help'] ?></span>
+									</td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['IP label'] ?></th>
+									<td>
+										<input type="text" name="ban_ip" size="45" maxlength="255" value="<?php if (isset($ban_ip)) echo pun_htmlspecialchars($ban_ip); ?>" />
+										<span><?php echo $lang_admin_bans['IP help'] ?><?php if ($ban_user != '' && isset($user_id)) printf(' '.$lang_admin_bans['IP help link'], '<a href="admin_users.php?ip_stats='.$user_id.'">'.$lang_admin_common['here'].'</a>') ?></span>
+									</td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['E-mail label'] ?></th>
+									<td>
+										<input type="text" name="ban_email" size="40" maxlength="80" value="<?php if (isset($ban_email)) echo pun_htmlspecialchars($ban_email); ?>" />
+										<span><?php echo $lang_admin_bans['E-mail help'] ?></span>
+									</td>
+								</tr>
+							</table>
+							<p class="topspace"><strong class="warntext"><?php echo $lang_admin_bans['Ban IP range info'] ?></strong></p>
+						</div>
+					</fieldset>
+				</div>
+				<div class="inform">
+					<fieldset>
+						<legend><?php echo $lang_admin_bans['Message expiry subhead'] ?></legend>
+						<div class="infldset">
+							<table class="aligntop">
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Ban message label'] ?></th>
+									<td>
+										<input type="text" name="ban_message" size="50" maxlength="255" value="<?php if (isset($ban_message)) echo pun_htmlspecialchars($ban_message); ?>" />
+										<span><?php echo $lang_admin_bans['Ban message help'] ?></span>
+									</td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Expire date label'] ?></th>
+									<td>
+										<input type="text" name="ban_expire" size="17" maxlength="10" value="<?php if (isset($ban_expire)) echo $ban_expire; ?>" />
+										<span><?php echo $lang_admin_bans['Expire date help'] ?></span>
+									</td>
+								</tr>
+							</table>
+						</div>
+					</fieldset>
+				</div>
+				<p class="submitend"><input type="submit" name="add_edit_ban" value="<?php echo $lang_admin_common['Save'] ?>" /></p>
+			</form>
+		</div>
+	</div>
+	<div class="clearer"></div>
+</div>
+<?php
+
+	require PUN_ROOT.'footer.php';
+}
+
+// Add/edit a ban (stage 2)
+else if (isset($_POST['add_edit_ban']))
+{
+	confirm_referrer('admin_bans.php');
+
+	$ban_user = pun_trim($_POST['ban_user']);
+	$ban_ip = pun_trim($_POST['ban_ip']);
+	$ban_email = strtolower(pun_trim($_POST['ban_email']));
+	$ban_message = pun_trim($_POST['ban_message']);
+	$ban_expire = pun_trim($_POST['ban_expire']);
+
+	if ($ban_user == '' && $ban_ip == '' && $ban_email == '')
+		message($lang_admin_bans['Must enter message']);
+	else if (strtolower($ban_user) == 'guest')
+		message($lang_admin_bans['Cannot ban guest message']);
+
+	// Make sure we're not banning an admin or moderator
+	if (!empty($ban_user))
+	{
+		$result = $db->query('SELECT group_id FROM '.$db->prefix.'users WHERE username=\''.$db->escape($ban_user).'\' AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+		if ($db->num_rows($result))
+		{
+			$group_id = $db->result($result);
+
+			if ($group_id == PUN_ADMIN)
+				message(sprintf($lang_admin_bans['User is admin message'], pun_htmlspecialchars($ban_user)));
+
+			$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());
+			$is_moderator_group = $db->result($result);
+
+			if ($is_moderator_group)
+				message(sprintf($lang_admin_bans['User is mod message'], pun_htmlspecialchars($ban_user)));
+		}
+	}
+
+	// Validate IP/IP range (it's overkill, I know)
+	if ($ban_ip != '')
+	{
+		$ban_ip = preg_replace('%\s{2,}%S', ' ', $ban_ip);
+		$addresses = explode(' ', $ban_ip);
+		$addresses = array_map('pun_trim', $addresses);
+
+		for ($i = 0; $i < count($addresses); ++$i)
+		{
+			if (strpos($addresses[$i], ':') !== false)
+			{
+				$octets = explode(':', $addresses[$i]);
+
+				for ($c = 0; $c < count($octets); ++$c)
+				{
+					$octets[$c] = ltrim($octets[$c], "0");
+
+					if ($c > 7 || (!empty($octets[$c]) && !ctype_xdigit($octets[$c])) || intval($octets[$c], 16) > 65535)
+						message($lang_admin_bans['Invalid IP message']);
+				}
+
+				$cur_address = implode(':', $octets);
+				$addresses[$i] = $cur_address;
+			}
+			else
+			{
+				$octets = explode('.', $addresses[$i]);
+
+				for ($c = 0; $c < count($octets); ++$c)
+				{
+					$octets[$c] = (strlen($octets[$c]) > 1) ? ltrim($octets[$c], "0") : $octets[$c];
+
+					if ($c > 3 || preg_match('%[^0-9]%', $octets[$c]) || intval($octets[$c]) > 255)
+						message($lang_admin_bans['Invalid IP message']);
+				}
+
+				$cur_address = implode('.', $octets);
+				$addresses[$i] = $cur_address;
+			}
+		}
+
+		$ban_ip = implode(' ', $addresses);
+	}
+
+	require PUN_ROOT.'include/email.php';
+	if ($ban_email != '')
+	{
+	    // Validate email or domain format
+		if (!is_valid_email($ban_email) && !preg_match('%^[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,63})$%', $ban_email))
+			message($lang_admin_bans['Invalid e-mail message']);
+
+		// Let's ensure we are not adding a duplicate ban
+        $dup_conditions = array('(expire IS NULL OR expire > '.time().')');
+
+        // If we're adding an email address, we can also check for the domain
+        $domain_index = strpos($ban_email, '@');
+
+        if ($domain_index !== false && $_POST['mode'] == 'add')
+        {
+            // We are not checking for domains when editing bans, as that might
+            // prevent editing other fields of already existing email bans for
+            // which a domain ban was added later.
+            $ban_domain = substr($ban_email, $domain_index + 1);
+            $dup_conditions[] = 'email IN (\''.$db->escape($ban_email).'\', \''.$db->escape($ban_domain).'\')';
+        }
+        else
+			$dup_conditions[] = 'email = \''.$db->escape($ban_email).'\'';
+
+        // When editing, we also need to exclude the current ban
+		if ($_POST['mode'] == 'edit')
+		    $dup_conditions[] = 'id != '.intval($_POST['ban_id']);
+
+        $result = $db->query('SELECT email FROM '.$db->prefix.'bans WHERE '.implode(' AND ', $dup_conditions)) or error('Unable to check for duplicate bans', __FILE__, __LINE__, $db->error());
+        if ($match = $db->result($result))
+        {
+            $is_domain = strpos($match, '@') === false;
+
+            if ($is_domain)
+				message(sprintf($lang_admin_bans['Duplicate domain message'], $match));
+			else
+				message(sprintf($lang_admin_bans['Duplicate e-mail message'], $match));
+        }
+	}
+
+	if ($ban_expire != '' && $ban_expire != 'Never')
+	{
+		$ban_expire = strtotime($ban_expire.' GMT');
+
+		if ($ban_expire == -1 || !$ban_expire)
+			message($lang_admin_bans['Invalid date message'].' '.$lang_admin_bans['Invalid date reasons']);
+
+		$diff = ($pun_user['timezone'] + $pun_user['dst']) * 3600;
+		$ban_expire -= $diff;
+
+		if ($ban_expire <= time())
+			message($lang_admin_bans['Invalid date message'].' '.$lang_admin_bans['Invalid date reasons']);
+	}
+	else
+		$ban_expire = 'NULL';
+
+	$ban_user = ($ban_user != '') ? '\''.$db->escape($ban_user).'\'' : 'NULL';
+	$ban_ip = ($ban_ip != '') ? '\''.$db->escape($ban_ip).'\'' : 'NULL';
+	$ban_email = ($ban_email != '') ? '\''.$db->escape($ban_email).'\'' : 'NULL';
+	$ban_message = ($ban_message != '') ? '\''.$db->escape($ban_message).'\'' : 'NULL';
+
+	if ($_POST['mode'] == 'add')
+		$db->query('INSERT INTO '.$db->prefix.'bans (username, ip, email, message, expire, ban_creator) VALUES('.$ban_user.', '.$ban_ip.', '.$ban_email.', '.$ban_message.', '.$ban_expire.', '.$pun_user['id'].')') or error('Unable to add ban', __FILE__, __LINE__, $db->error());
+	else
+		$db->query('UPDATE '.$db->prefix.'bans SET username='.$ban_user.', ip='.$ban_ip.', email='.$ban_email.', message='.$ban_message.', expire='.$ban_expire.' WHERE id='.intval($_POST['ban_id'])) or error('Unable to update ban', __FILE__, __LINE__, $db->error());
+
+	// Regenerate the bans cache
+	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))
+		require PUN_ROOT.'include/cache.php';
+
+	generate_bans_cache();
+
+	if ($_POST['mode'] == 'edit')
+		redirect('admin_bans.php', $lang_admin_bans['Ban edited redirect']);
+	else
+		redirect('admin_bans.php', $lang_admin_bans['Ban added redirect']);
+}
+
+// Remove a ban
+else if (isset($_GET['del_ban']))
+{
+	confirm_referrer('admin_bans.php');
+
+	$ban_id = intval($_GET['del_ban']);
+	if ($ban_id < 1)
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	$db->query('DELETE FROM '.$db->prefix.'bans WHERE id='.$ban_id) or error('Unable to delete ban', __FILE__, __LINE__, $db->error());
+
+	// Regenerate the bans cache
+	if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))
+		require PUN_ROOT.'include/cache.php';
+
+	generate_bans_cache();
+
+	redirect('admin_bans.php', $lang_admin_bans['Ban removed redirect']);
+}
+
+// Find bans
+else if (isset($_GET['find_ban']))
+{
+	$form = isset($_GET['form']) ? $_GET['form'] : array();
+
+	// trim() all elements in $form
+	$form = array_map('pun_trim', $form);
+	$conditions = $query_str = array();
+
+	$expire_after = isset($_GET['expire_after']) ? pun_trim($_GET['expire_after']) : '';
+	$expire_before = isset($_GET['expire_before']) ? pun_trim($_GET['expire_before']) : '';
+	$order_by = isset($_GET['order_by']) && in_array($_GET['order_by'], array('username', 'ip', 'email', 'expire')) ? 'b.'.$_GET['order_by'] : 'b.username';
+	$direction = isset($_GET['direction']) && $_GET['direction'] == 'DESC' ? 'DESC' : 'ASC';
+
+	$query_str[] = 'order_by='.$order_by;
+	$query_str[] = 'direction='.$direction;
+
+	// Try to convert date/time to timestamps
+	if ($expire_after != '')
+	{
+		$query_str[] = 'expire_after='.$expire_after;
+
+		$expire_after = strtotime($expire_after);
+		if ($expire_after === false || $expire_after == -1)
+			message($lang_admin_bans['Invalid date message']);
+
+		$conditions[] = 'b.expire>'.$expire_after;
+	}
+	if ($expire_before != '')
+	{
+		$query_str[] = 'expire_before='.$expire_before;
+
+		$expire_before = strtotime($expire_before);
+		if ($expire_before === false || $expire_before == -1)
+			message($lang_admin_bans['Invalid date message']);
+
+		$conditions[] = 'b.expire<'.$expire_before;
+	}
+
+	$like_command = ($db_type == 'pgsql') ? 'ILIKE' : 'LIKE';
+	foreach ($form as $key => $input)
+	{
+		if ($input != '' && in_array($key, array('username', 'ip', 'email', 'message')))
+		{
+			$conditions[] = 'b.'.$db->escape($key).' '.$like_command.' \''.$db->escape(str_replace(array('*', '_'), array('%', '\\_'), $input)).'\'';
+			$query_str[] = 'form%5B'.$key.'%5D='.urlencode($input);
+		}
+	}
+
+	// Fetch ban count
+	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'bans as b WHERE b.id>0'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '')) or error('Unable to fetch ban list', __FILE__, __LINE__, $db->error());
+	$num_bans = $db->result($result);
+
+	// Determine the ban offset (based on $_GET['p'])
+	$num_pages = ceil($num_bans / 50);
+
+	$p = (!isset($_GET['p']) || $_GET['p'] <= 1 || $_GET['p'] > $num_pages) ? 1 : intval($_GET['p']);
+	$start_from = 50 * ($p - 1);
+
+	// Generate paging links
+	$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'admin_bans.php?find_ban=&amp;'.implode('&amp;', $query_str));
+
+	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans'], $lang_admin_bans['Results head']);
+	define('PUN_ACTIVE_PAGE', 'admin');
+	require PUN_ROOT.'header.php';
+
+?>
+<div class="linkst">
+	<div class="inbox crumbsplus">
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_bans.php"><?php echo $lang_admin_common['Bans'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_bans['Results head'] ?></strong></li>
+		</ul>
+		<div class="pagepost">
+			<p class="pagelink"><?php echo $paging_links ?></p>
+		</div>
+		<div class="clearer"></div>
+	</div>
+</div>
+
+
+<div id="bans1" class="blocktable">
+	<h2><span><?php echo $lang_admin_bans['Results head'] ?></span></h2>
+	<div class="box">
+		<div class="inbox">
+			<table>
+			<thead>
+				<tr>
+					<th class="tcl" scope="col"><?php echo $lang_admin_bans['Results username head'] ?></th>
+					<th class="tc2" scope="col"><?php echo $lang_admin_bans['Results e-mail head'] ?></th>
+					<th class="tc3" scope="col"><?php echo $lang_admin_bans['Results IP address head'] ?></th>
+					<th class="tc4" scope="col"><?php echo $lang_admin_bans['Results expire head'] ?></th>
+					<th class="tc5" scope="col"><?php echo $lang_admin_bans['Results message head'] ?></th>
+					<th class="tc6" scope="col"><?php echo $lang_admin_bans['Results banned by head'] ?></th>
+					<th class="tcr" scope="col"><?php echo $lang_admin_bans['Results actions head'] ?></th>
+				</tr>
+			</thead>
+			<tbody>
+<?php
+
+	$result = $db->query('SELECT b.id, b.username, b.ip, b.email, b.message, b.expire, b.ban_creator, u.username AS ban_creator_username FROM '.$db->prefix.'bans AS b LEFT JOIN '.$db->prefix.'users AS u ON b.ban_creator=u.id WHERE b.id>0'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '').' ORDER BY '.$db->escape($order_by).' '.$db->escape($direction).' LIMIT '.$start_from.', 50') or error('Unable to fetch ban list', __FILE__, __LINE__, $db->error());
+	if ($db->num_rows($result))
+	{
+		while ($ban_data = $db->fetch_assoc($result))
+		{
+
+			$actions = '<a href="admin_bans.php?edit_ban='.$ban_data['id'].'">'.$lang_admin_common['Edit'].'</a> | <a href="admin_bans.php?del_ban='.$ban_data['id'].'">'.$lang_admin_common['Remove'].'</a>';
+			$expire = format_time($ban_data['expire'], true);
+
+?>
+				<tr>
+					<td class="tcl"><?php echo ($ban_data['username'] != '') ? pun_htmlspecialchars($ban_data['username']) : '&#160;' ?></td>
+					<td class="tc2"><?php echo ($ban_data['email'] != '') ? pun_htmlspecialchars($ban_data['email']) : '&#160;' ?></td>
+					<td class="tc3"><?php echo ($ban_data['ip'] != '') ? pun_htmlspecialchars($ban_data['ip']) : '&#160;' ?></td>
+					<td class="tc4"><?php echo $expire ?></td>
+					<td class="tc5"><?php echo ($ban_data['message'] != '') ? pun_htmlspecialchars($ban_data['message']) : '&#160;' ?></td>
+					<td class="tc6"><?php echo ($ban_data['ban_creator_username'] != '') ? '<a href="profile.php?id='.$ban_data['ban_creator'].'">'.pun_htmlspecialchars($ban_data['ban_creator_username']).'</a>' : $lang_admin_bans['Unknown'] ?></td>
+					<td class="tcr"><?php echo $actions ?></td>
+				</tr>
+<?php
+
+		}
+	}
+	else
+		echo "\t\t\t\t".'<tr><td class="tcl" colspan="7">'.$lang_admin_bans['No match'].'</td></tr>'."\n";
+
+?>
+			</tbody>
+			</table>
+		</div>
+	</div>
+</div>
+
+<div class="linksb">
+	<div class="inbox crumbsplus">
+		<div class="pagepost">
+			<p class="pagelink"><?php echo $paging_links ?></p>
+		</div>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_bans.php"><?php echo $lang_admin_common['Bans'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_bans['Results head'] ?></strong></li>
+		</ul>
+		<div class="clearer"></div>
+	</div>
+</div>
+<?php
+
+	require PUN_ROOT.'footer.php';
+}
+
+$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Bans']);
+$focus_element = array('bans', 'new_ban_user');
+define('PUN_ACTIVE_PAGE', 'admin');
+require PUN_ROOT.'header.php';
+
+generate_admin_menu('bans');
+
+?>
+	<div class="blockform">
+		<h2><span><?php echo $lang_admin_bans['New ban head'] ?></span></h2>
+		<div class="box">
+			<form id="bans" method="post" action="admin_bans.php?action=more">
+				<div class="inform">
+					<fieldset>
+						<legend><?php echo $lang_admin_bans['Add ban subhead'] ?></legend>
+						<div class="infldset">
+							<table class="aligntop">
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?><div><input type="submit" name="add_ban" value="<?php echo $lang_admin_common['Add'] ?>" /></div></th>
+									<td>
+										<input type="text" name="new_ban_user" size="25" maxlength="25" />
+										<span><?php echo $lang_admin_bans['Username advanced help'] ?></span>
+									</td>
+								</tr>
+							</table>
+						</div>
+					</fieldset>
+				</div>
+			</form>
+		</div>
+
+		<h2 class="block2"><span><?php echo $lang_admin_bans['Ban search head'] ?></span></h2>
+		<div class="box">
+			<form id="find_bans" method="get" action="admin_bans.php">
+				<p class="submittop"><input type="submit" name="find_ban" value="<?php echo $lang_admin_bans['Submit search'] ?>" /></p>
+				<div class="inform">
+					<fieldset>
+						<legend><?php echo $lang_admin_bans['Ban search subhead'] ?></legend>
+						<div class="infldset">
+							<p><?php echo $lang_admin_bans['Ban search info'] ?></p>
+							<table class="aligntop">
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Username label'] ?></th>
+									<td><input type="text" name="form[username]" size="25" maxlength="25" /></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['IP label'] ?></th>
+									<td><input type="text" name="form[ip]" size="30" maxlength="255" /></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['E-mail label'] ?></th>
+									<td><input type="text" name="form[email]" size="30" maxlength="80" /></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Message label'] ?></th>
+									<td><input type="text" name="form[message]" size="30" maxlength="255" /></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Expire after label'] ?></th>
+									<td><input type="text" name="expire_after" size="10" maxlength="10" />
+									<span><?php echo $lang_admin_bans['Date help'] ?></span></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Expire before label'] ?></th>
+									<td><input type="text" name="expire_before" size="10" maxlength="10" />
+									<span><?php echo $lang_admin_bans['Date help'] ?></span></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_bans['Order by label'] ?></th>
+									<td>
+										<select name="order_by">
+											<option value="username" selected="selected"><?php echo $lang_admin_bans['Order by username'] ?></option>
+											<option value="ip"><?php echo $lang_admin_bans['Order by ip'] ?></option>
+											<option value="email"><?php echo $lang_admin_bans['Order by e-mail'] ?></option>
+											<option value="expire"><?php echo $lang_admin_bans['Order by expire'] ?></option>
+										</select>&#160;&#160;&#160;<select name="direction">
+											<option value="ASC" selected="selected"><?php echo $lang_admin_bans['Ascending'] ?></option>
+											<option value="DESC"><?php echo $lang_admin_bans['Descending'] ?></option>
+										</select>
+									</td>
+								</tr>
+							</table>
+						</div>
+					</fieldset>
+				</div>
+				<p class="submitend"><input type="submit" name="find_ban" value="<?php echo $lang_admin_bans['Submit search'] ?>" /></p>
+			</form>
+		</div>
+	</div>
+	<div class="clearer"></div>
+</div>
+<?php
+
+require PUN_ROOT.'footer.php';
diff --git a/admin_categories.php b/admin_categories.php
index d7b247d0..4b4b46f3 100644
--- a/admin_categories.php
+++ b/admin_categories.php
@@ -48,24 +48,30 @@ else if (isset($_POST['del_cat']) || isset($_POST['del_cat_comply']))
 		@set_time_limit(0);
 
 		$result = $db->query('SELECT id FROM '.$db->prefix.'forums WHERE cat_id='.$cat_to_delete) or error('Unable to fetch forum list', __FILE__, __LINE__, $db->error());
+		$num_forums = $db->num_rows($result);
 
-		while ($cur_forum = $db->fetch_assoc($result))
+		for ($i = 0; $i < $num_forums; ++$i)
 		{
+			$cur_forum = $db->result($result, $i);
+
 			// Prune all posts and topics
-			prune($cur_forum['id'], 1, -1);
+			prune($cur_forum, 1, -1);
 
 			// Delete the forum
-			$db->query('DELETE FROM '.$db->prefix.'forums WHERE id='.$cur_forum['id']) or error('Unable to delete forum', __FILE__, __LINE__, $db->error());
+			$db->query('DELETE FROM '.$db->prefix.'forums WHERE id='.$cur_forum) or error('Unable to delete forum', __FILE__, __LINE__, $db->error());
 		}
 
 		// Locate any "orphaned redirect topics" and delete them
 		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());
+		$num_orphans = $db->num_rows($result);
 
-		while ($cur_topic = $db->fetch_assoc($result))
-			$orphans[] = $cur_topic['id'];
+		if ($num_orphans)
+		{
+			for ($i = 0; $i < $num_orphans; ++$i)
+				$orphans[] = $db->result($result, $i);
 
-		if (!empty($orphans))
 			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());
+		}
 
 		// Delete the category
 		$db->query('DELETE FROM '.$db->prefix.'categories WHERE id='.$cat_to_delete) or error('Unable to delete category', __FILE__, __LINE__, $db->error());
@@ -149,9 +155,10 @@ else if (isset($_POST['update'])) // Change position and name of the categories
 
 // Generate an array with all categories
 $result = $db->query('SELECT id, cat_name, disp_position FROM '.$db->prefix.'categories ORDER BY disp_position') or error('Unable to fetch category list', __FILE__, __LINE__, $db->error());
+$num_cats = $db->num_rows($result);
 
-while ($cur_cat = $db->fetch_assoc($result))
-	$cat_list[] = $cur_cat;
+for ($i = 0; $i < $num_cats; ++$i)
+	$cat_list[] = $db->fetch_assoc($result);
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Categories']);
 define('PUN_ACTIVE_PAGE', 'admin');
@@ -170,9 +177,9 @@ generate_admin_menu('categories');
 						<div class="infldset">
 							<table class="aligntop">
 								<tr>
-									<th scope="row"><?php echo $lang_admin_categories['Add category label'] ?><div><input type="submit" name="add_cat" value="<?php echo $lang_admin_categories['Add new submit'] ?>" tabindex="2" /></div></th>
+									<th scope="row"><?php echo $lang_admin_categories['Add category label'] ?><div><input type="submit" name="add_cat" value="<?php echo $lang_admin_categories['Add new submit'] ?>" /></div></th>
 									<td>
-										<input type="text" name="new_cat_name" size="35" maxlength="80" tabindex="1" />
+										<input type="text" name="new_cat_name" size="35" maxlength="80" />
 										<span><?php printf($lang_admin_categories['Add category help'], '<a href="admin_forums.php">'.$lang_admin_common['Forums'].'</a>') ?></span>
 									</td>
 								</tr>
@@ -183,7 +190,7 @@ generate_admin_menu('categories');
 			</form>
 		</div>
 
-<?php if (!empty($cat_list)): ?>		<h2 class="block2"><span><?php echo $lang_admin_categories['Delete categories head'] ?></span></h2>
+<?php if ($num_cats): ?>		<h2 class="block2"><span><?php echo $lang_admin_categories['Delete categories head'] ?></span></h2>
 		<div class="box">
 			<form method="post" action="admin_categories.php">
 				<div class="inform">
@@ -192,9 +199,9 @@ generate_admin_menu('categories');
 						<div class="infldset">
 							<table class="aligntop">
 								<tr>
-									<th scope="row"><?php echo $lang_admin_categories['Delete category label'] ?><div><input type="submit" name="del_cat" value="<?php echo $lang_admin_common['Delete'] ?>" tabindex="4" /></div></th>
+									<th scope="row"><?php echo $lang_admin_categories['Delete category label'] ?><div><input type="submit" name="del_cat" value="<?php echo $lang_admin_common['Delete'] ?>" /></div></th>
 									<td>
-										<select name="cat_to_delete" tabindex="3">
+										<select name="cat_to_delete">
 <?php
 
 	foreach ($cat_list as $cur_cat)
@@ -213,7 +220,7 @@ generate_admin_menu('categories');
 		</div>
 <?php endif; ?>
 
-<?php if (!empty($cat_list)): ?>		<h2 class="block2"><span><?php echo $lang_admin_categories['Edit categories head'] ?></span></h2>
+<?php if ($num_cats): ?>		<h2 class="block2"><span><?php echo $lang_admin_categories['Edit categories head'] ?></span></h2>
 		<div class="box">
 			<form method="post" action="admin_categories.php">
 				<div class="inform">
diff --git a/admin_censoring.php b/admin_censoring.php
index e5a70a3a..c3eba722 100644
--- a/admin_censoring.php
+++ b/admin_censoring.php
@@ -111,9 +111,9 @@ generate_admin_menu('censoring');
 							</thead>
 							<tbody>
 								<tr>
-									<td class="tcl"><input type="text" name="new_search_for" size="24" maxlength="60" tabindex="1" /></td>
-									<td class="tc2"><input type="text" name="new_replace_with" size="24" maxlength="60" tabindex="2" /></td>
-									<td><input type="submit" name="add_word" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="3" /></td>
+									<td class="tcl"><input type="text" name="new_search_for" size="24" maxlength="60" /></td>
+									<td class="tc2"><input type="text" name="new_replace_with" size="24" maxlength="60" /></td>
+									<td><input type="submit" name="add_word" value="<?php echo $lang_admin_common['Add'] ?>" /></td>
 								</tr>
 							</tbody>
 							</table>
@@ -127,7 +127,7 @@ generate_admin_menu('censoring');
 <?php
 
 $result = $db->query('SELECT id, search_for, replace_with FROM '.$db->prefix.'censoring ORDER BY id') or error('Unable to fetch censor word list', __FILE__, __LINE__, $db->error());
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 {
 
 ?>
diff --git a/admin_forums.php b/admin_forums.php
index 65ecb73d..a4f68db0 100644
--- a/admin_forums.php
+++ b/admin_forums.php
@@ -59,12 +59,15 @@ else if (isset($_GET['del_forum']))
 
 		// Locate any "orphaned redirect topics" and delete them
 		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());
+		$num_orphans = $db->num_rows($result);
 
-		while ($cur_topic = $db->fetch_assoc($result))
-			$orphans[] = $cur_topic['id'];
+		if ($num_orphans)
+		{
+			for ($i = 0; $i < $num_orphans; ++$i)
+				$orphans[] = $db->result($result, $i);
 
-		if (!empty($orphans))
 			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());
+		}
 
 		// Delete the forum and any forum specific group permissions
 		$db->query('DELETE FROM '.$db->prefix.'forums WHERE id='.$forum_id) or error('Unable to delete forum', __FILE__, __LINE__, $db->error());
@@ -222,7 +225,7 @@ else if (isset($_GET['edit_forum']))
 
 	// Fetch forum info
 	$result = $db->query('SELECT id, forum_name, forum_desc, redirect_url, num_topics, sort_by, cat_id FROM '.$db->prefix.'forums WHERE id='.$forum_id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
+	if (!$db->num_rows($result))
 		message($lang_common['Bad request'], false, '404 Not Found');
 
 	$cur_forum = $db->fetch_assoc($result);
@@ -238,7 +241,7 @@ else if (isset($_GET['edit_forum']))
 		<h2><span><?php echo $lang_admin_forums['Edit forum head'] ?></span></h2>
 		<div class="box">
 			<form id="edit_forum" method="post" action="admin_forums.php?edit_forum=<?php echo $forum_id ?>">
-				<p class="submittop"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" tabindex="6" /></p>
+				<p class="submittop"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" /></p>
 				<div class="inform">
 					<fieldset>
 						<legend><?php echo $lang_admin_forums['Edit details subhead'] ?></legend>
@@ -246,16 +249,16 @@ else if (isset($_GET['edit_forum']))
 							<table class="aligntop">
 								<tr>
 									<th scope="row"><?php echo $lang_admin_forums['Forum name label'] ?></th>
-									<td><input type="text" name="forum_name" size="35" maxlength="80" value="<?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?>" tabindex="1" /></td>
+									<td><input type="text" name="forum_name" size="35" maxlength="80" value="<?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?>" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_forums['Forum description label'] ?></th>
-									<td><textarea name="forum_desc" rows="3" cols="50" tabindex="2"><?php echo pun_htmlspecialchars($cur_forum['forum_desc']) ?></textarea></td>
+									<td><textarea name="forum_desc" rows="3" cols="50"><?php echo pun_htmlspecialchars($cur_forum['forum_desc']) ?></textarea></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_forums['Category label'] ?></th>
 									<td>
-										<select name="cat_id" tabindex="3">
+										<select name="cat_id">
 <?php
 
 	$result = $db->query('SELECT id, cat_name FROM '.$db->prefix.'categories ORDER BY disp_position') or error('Unable to fetch category list', __FILE__, __LINE__, $db->error());
@@ -272,7 +275,7 @@ else if (isset($_GET['edit_forum']))
 								<tr>
 									<th scope="row"><?php echo $lang_admin_forums['Sort by label'] ?></th>
 									<td>
-										<select name="sort_by" tabindex="4">
+										<select name="sort_by">
 											<option value="0"<?php if ($cur_forum['sort_by'] == '0') echo ' selected="selected"' ?>><?php echo $lang_admin_forums['Last post'] ?></option>
 											<option value="1"<?php if ($cur_forum['sort_by'] == '1') echo ' selected="selected"' ?>><?php echo $lang_admin_forums['Topic start'] ?></option>
 											<option value="2"<?php if ($cur_forum['sort_by'] == '2') echo ' selected="selected"' ?>><?php echo $lang_admin_forums['Subject'] ?></option>
@@ -281,7 +284,7 @@ else if (isset($_GET['edit_forum']))
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_forums['Redirect label'] ?></th>
-									<td><?php echo ($cur_forum['num_topics']) ? $lang_admin_forums['Redirect help'] : '<input type="text" name="redirect_url" size="45" maxlength="100" value="'.pun_htmlspecialchars($cur_forum['redirect_url']).'" tabindex="5" />'; ?></td>
+									<td><?php echo ($cur_forum['num_topics']) ? $lang_admin_forums['Redirect help'] : '<input type="text" name="redirect_url" size="45" maxlength="100" value="'.pun_htmlspecialchars($cur_forum['redirect_url']).'" />'; ?></td>
 								</tr>
 							</table>
 						</div>
@@ -324,15 +327,15 @@ else if (isset($_GET['edit_forum']))
 									<th class="atcl"><?php echo pun_htmlspecialchars($cur_perm['g_title']) ?></th>
 									<td<?php if (!$read_forum_def) echo ' class="nodefault"'; ?>>
 										<input type="hidden" name="read_forum_old[<?php echo $cur_perm['g_id'] ?>]" value="<?php echo ($read_forum) ? '1' : '0'; ?>" />
-										<input type="checkbox" name="read_forum_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($read_forum) ? ' checked="checked"' : ''; ?><?php echo ($cur_perm['g_read_board'] == '0') ? ' disabled="disabled"' : ''; ?> tabindex="<?php echo $cur_index++ ?>" />
+										<input type="checkbox" name="read_forum_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($read_forum) ? ' checked' : ''; ?><?php echo ($cur_perm['g_read_board'] == '0') ? ' disabled' : ''; ?> />
 									</td>
 									<td<?php if (!$post_replies_def && $cur_forum['redirect_url'] == '') echo ' class="nodefault"'; ?>>
 										<input type="hidden" name="post_replies_old[<?php echo $cur_perm['g_id'] ?>]" value="<?php echo ($post_replies) ? '1' : '0'; ?>" />
-										<input type="checkbox" name="post_replies_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($post_replies) ? ' checked="checked"' : ''; ?><?php echo ($cur_forum['redirect_url'] != '') ? ' disabled="disabled"' : ''; ?> tabindex="<?php echo $cur_index++ ?>" />
+										<input type="checkbox" name="post_replies_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($post_replies) ? ' checked' : ''; ?><?php echo ($cur_forum['redirect_url'] != '') ? ' disabled' : ''; ?> />
 									</td>
 									<td<?php if (!$post_topics_def && $cur_forum['redirect_url'] == '') echo ' class="nodefault"'; ?>>
 										<input type="hidden" name="post_topics_old[<?php echo $cur_perm['g_id'] ?>]" value="<?php echo ($post_topics) ? '1' : '0'; ?>" />
-										<input type="checkbox" name="post_topics_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($post_topics) ? ' checked="checked"' : ''; ?><?php echo ($cur_forum['redirect_url'] != '') ? ' disabled="disabled"' : ''; ?> tabindex="<?php echo $cur_index++ ?>" />
+										<input type="checkbox" name="post_topics_new[<?php echo $cur_perm['g_id'] ?>]" value="1"<?php echo ($post_topics) ? ' checked' : ''; ?><?php echo ($cur_forum['redirect_url'] != '') ? ' disabled' : ''; ?> />
 									</td>
 								</tr>
 <?php
@@ -342,11 +345,11 @@ else if (isset($_GET['edit_forum']))
 ?>
 							</tbody>
 							</table>
-							<div class="fsetsubmit"><input type="submit" name="revert_perms" value="<?php echo $lang_admin_forums['Revert to default'] ?>" tabindex="<?php echo $cur_index++ ?>" /></div>
+							<div class="fsetsubmit"><input type="submit" name="revert_perms" value="<?php echo $lang_admin_forums['Revert to default'] ?>" /></div>
 						</div>
 					</fieldset>
 				</div>
-				<p class="submitend"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" tabindex="<?php echo $cur_index++ ?>" /></p>
+				<p class="submitend"><input type="submit" name="save" value="<?php echo $lang_admin_common['Save changes'] ?>" /></p>
 			</form>
 		</div>
 	</div>
@@ -373,7 +376,7 @@ generate_admin_menu('forums');
 
 $result = $db->query('SELECT id, cat_name FROM '.$db->prefix.'categories ORDER BY disp_position') or error('Unable to fetch category list', __FILE__, __LINE__, $db->error());
 
-if ($db->has_rows($result))
+if ($db->num_rows($result) > 0)
 {
 
 ?>
@@ -383,9 +386,9 @@ if ($db->has_rows($result))
 						<div class="infldset">
 							<table class="aligntop">
 								<tr>
-									<th scope="row"><?php echo $lang_admin_forums['Add forum label'] ?><div><input type="submit" name="add_forum" value="<?php echo $lang_admin_forums['Add forum'] ?>" tabindex="2" /></div></th>
+									<th scope="row"><?php echo $lang_admin_forums['Add forum label'] ?><div><input type="submit" name="add_forum" value="<?php echo $lang_admin_forums['Add forum'] ?>" /></div></th>
 									<td>
-										<select name="add_to_cat" tabindex="1">
+										<select name="add_to_cat">
 <?php
 
 	while ($cur_cat = $db->fetch_assoc($result))
@@ -427,14 +430,14 @@ else
 // Display all the categories and forums
 $result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.disp_position FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id ORDER BY c.disp_position, c.id, f.disp_position') or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());
 
-if ($db->has_rows($result))
+if ($db->num_rows($result) > 0)
 {
 
 ?>
 		<h2 class="block2"><span><?php echo $lang_admin_forums['Edit forums head'] ?></span></h2>
 		<div class="box">
 			<form id="edforum" method="post" action="admin_forums.php?action=edit">
-				<p class="submittop"><input type="submit" name="update_positions" value="<?php echo $lang_admin_forums['Update positions'] ?>" tabindex="3" /></p>
+				<p class="submittop"><input type="submit" name="update_positions" value="<?php echo $lang_admin_forums['Update positions'] ?>" /></p>
 <?php
 
 $cur_index = 4;
@@ -468,8 +471,8 @@ while ($cur_forum = $db->fetch_assoc($result))
 
 ?>
 								<tr>
-									<td class="tcl"><a href="admin_forums.php?edit_forum=<?php echo $cur_forum['fid'] ?>" tabindex="<?php echo $cur_index++ ?>"><?php echo $lang_admin_forums['Edit link'] ?></a> | <a href="admin_forums.php?del_forum=<?php echo $cur_forum['fid'] ?>" tabindex="<?php echo $cur_index++ ?>"><?php echo $lang_admin_forums['Delete link'] ?></a></td>
-									<td class="tc2"><input type="text" name="position[<?php echo $cur_forum['fid'] ?>]" size="3" maxlength="3" value="<?php echo $cur_forum['disp_position'] ?>" tabindex="<?php echo $cur_index++ ?>" /></td>
+									<td class="tcl"><a href="admin_forums.php?edit_forum=<?php echo $cur_forum['fid'] ?>"><?php echo $lang_admin_forums['Edit link'] ?></a> | <a href="admin_forums.php?del_forum=<?php echo $cur_forum['fid'] ?>"><?php echo $lang_admin_forums['Delete link'] ?></a></td>
+									<td class="tc2"><input type="text" name="position[<?php echo $cur_forum['fid'] ?>]" size="3" maxlength="3" value="<?php echo $cur_forum['disp_position'] ?>" /></td>
 									<td class="tcr"><strong><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></strong></td>
 								</tr>
 <?php
@@ -482,7 +485,7 @@ while ($cur_forum = $db->fetch_assoc($result))
 						</div>
 					</fieldset>
 				</div>
-				<p class="submitend"><input type="submit" name="update_positions" value="<?php echo $lang_admin_forums['Update positions'] ?>" tabindex="<?php echo $cur_index++ ?>" /></p>
+				<p class="submitend"><input type="submit" name="update_positions" value="<?php echo $lang_admin_forums['Update positions'] ?>" /></p>
 			</form>
 		</div>
 <?php
diff --git a/admin_groups.php b/admin_groups.php
index bdd1a392..6a63b21a 100644
--- a/admin_groups.php
+++ b/admin_groups.php
@@ -75,20 +75,20 @@ if (isset($_POST['add_group']) || isset($_GET['edit_group']))
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Group title label'] ?></th>
 									<td>
-										<input type="text" name="req_title" size="25" maxlength="50" value="<?php if ($mode == 'edit') echo pun_htmlspecialchars($group['g_title']); ?>" tabindex="1" />
+										<input type="text" name="req_title" size="25" maxlength="50" value="<?php if ($mode == 'edit') echo pun_htmlspecialchars($group['g_title']); ?>" required />
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['User title label'] ?></th>
 									<td>
-										<input type="text" name="user_title" size="25" maxlength="50" value="<?php echo pun_htmlspecialchars($group['g_user_title']) ?>" tabindex="2" />
+										<input type="text" name="user_title" size="25" maxlength="50" value="<?php echo pun_htmlspecialchars($group['g_user_title']) ?>" />
 										<span><?php printf($lang_admin_groups['User title help'], ($group['g_id'] != PUN_GUEST ? $lang_common['Member'] : $lang_common['Guest'])) ?></span>
 									</td>
 								</tr>
 <?php if ($group['g_id'] != PUN_ADMIN): if ($group['g_id'] != PUN_GUEST): ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Promote users label'] ?></th>
 									<td>
-										<select name="promote_next_group" tabindex="3">
+										<select name="promote_next_group">
 											<option value="0"><?php echo $lang_admin_groups['Disable promotion'] ?></option>
 <?php
 
@@ -105,179 +105,179 @@ foreach ($groups as $cur_group)
 
 ?>
 										</select>
-										<input type="text" name="promote_min_posts" size="5" maxlength="10" value="<?php echo pun_htmlspecialchars($group['g_promote_min_posts']) ?>" tabindex="4" />
+										<input type="text" name="promote_min_posts" size="5" maxlength="10" value="<?php echo pun_htmlspecialchars($group['g_promote_min_posts']) ?>" />
 										<span><?php printf($lang_admin_groups['Promote users help'], $lang_admin_groups['Disable promotion']) ?></span>
 									</td>
 								</tr>
 <?php if ($mode != 'edit' || $pun_config['o_default_user_group'] != $group['g_id']): ?>								<tr>
 									<th scope="row"> <?php echo $lang_admin_groups['Mod privileges label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="moderator" value="1"<?php if ($group['g_moderator'] == '1') echo ' checked="checked"' ?> tabindex="5" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="moderator" value="0"<?php if ($group['g_moderator'] == '0') echo ' checked="checked"' ?> tabindex="6" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="moderator" value="1"<?php if ($group['g_moderator'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="moderator" value="0"<?php if ($group['g_moderator'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Mod privileges help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Edit profile label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="mod_edit_users" value="1"<?php if ($group['g_mod_edit_users'] == '1') echo ' checked="checked"' ?> tabindex="7" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="mod_edit_users" value="0"<?php if ($group['g_mod_edit_users'] == '0') echo ' checked="checked"' ?> tabindex="8" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_edit_users" value="1"<?php if ($group['g_mod_edit_users'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_edit_users" value="0"<?php if ($group['g_mod_edit_users'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Edit profile help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Rename users label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="mod_rename_users" value="1"<?php if ($group['g_mod_rename_users'] == '1') echo ' checked="checked"' ?> tabindex="9" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="mod_rename_users" value="0"<?php if ($group['g_mod_rename_users'] == '0') echo ' checked="checked"' ?> tabindex="10" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_rename_users" value="1"<?php if ($group['g_mod_rename_users'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_rename_users" value="0"<?php if ($group['g_mod_rename_users'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Rename users help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Change passwords label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="mod_change_passwords" value="1"<?php if ($group['g_mod_change_passwords'] == '1') echo ' checked="checked"' ?> tabindex="11" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="mod_change_passwords" value="0"<?php if ($group['g_mod_change_passwords'] == '0') echo ' checked="checked"' ?> tabindex="12" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_change_passwords" value="1"<?php if ($group['g_mod_change_passwords'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_change_passwords" value="0"<?php if ($group['g_mod_change_passwords'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Change passwords help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Mod promote users label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="mod_promote_users" value="1"<?php if ($group['g_mod_promote_users'] == '1') echo ' checked="checked"' ?> tabindex="13" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="mod_promote_users" value="0"<?php if ($group['g_mod_promote_users'] == '0') echo ' checked="checked"' ?> tabindex="14" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_promote_users" value="1"<?php if ($group['g_mod_promote_users'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_promote_users" value="0"<?php if ($group['g_mod_promote_users'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Mod promote users help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Ban users label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="mod_ban_users" value="1"<?php if ($group['g_mod_ban_users'] == '1') echo ' checked="checked"' ?> tabindex="15" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="mod_ban_users" value="0"<?php if ($group['g_mod_ban_users'] == '0') echo ' checked="checked"' ?> tabindex="16" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_ban_users" value="1"<?php if ($group['g_mod_ban_users'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="mod_ban_users" value="0"<?php if ($group['g_mod_ban_users'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Ban users help'] ?></span>
 									</td>
 								</tr>
 <?php endif; endif; ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Read board label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="read_board" value="1"<?php if ($group['g_read_board'] == '1') echo ' checked="checked"' ?> tabindex="17" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="read_board" value="0"<?php if ($group['g_read_board'] == '0') echo ' checked="checked"' ?> tabindex="18" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="read_board" value="1"<?php if ($group['g_read_board'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="read_board" value="0"<?php if ($group['g_read_board'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Read board help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['View user info label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="view_users" value="1"<?php if ($group['g_view_users'] == '1') echo ' checked="checked"' ?> tabindex="19" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="view_users" value="0"<?php if ($group['g_view_users'] == '0') echo ' checked="checked"' ?> tabindex="20" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="view_users" value="1"<?php if ($group['g_view_users'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="view_users" value="0"<?php if ($group['g_view_users'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['View user info help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Post replies label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="post_replies" value="1"<?php if ($group['g_post_replies'] == '1') echo ' checked="checked"' ?> tabindex="21" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="post_replies" value="0"<?php if ($group['g_post_replies'] == '0') echo ' checked="checked"' ?> tabindex="22" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="post_replies" value="1"<?php if ($group['g_post_replies'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="post_replies" value="0"<?php if ($group['g_post_replies'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Post replies help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Post topics label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="post_topics" value="1"<?php if ($group['g_post_topics'] == '1') echo ' checked="checked"' ?> tabindex="23" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="post_topics" value="0"<?php if ($group['g_post_topics'] == '0') echo ' checked="checked"' ?> tabindex="24" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="post_topics" value="1"<?php if ($group['g_post_topics'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="post_topics" value="0"<?php if ($group['g_post_topics'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Post topics help'] ?></span>
 									</td>
 								</tr>
 <?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Edit posts label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="edit_posts" value="1"<?php if ($group['g_edit_posts'] == '1') echo ' checked="checked"' ?> tabindex="25" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="edit_posts" value="0"<?php if ($group['g_edit_posts'] == '0') echo ' checked="checked"' ?> tabindex="26" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="edit_posts" value="1"<?php if ($group['g_edit_posts'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="edit_posts" value="0"<?php if ($group['g_edit_posts'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Edit posts help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Delete posts label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="delete_posts" value="1"<?php if ($group['g_delete_posts'] == '1') echo ' checked="checked"' ?> tabindex="27" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="delete_posts" value="0"<?php if ($group['g_delete_posts'] == '0') echo ' checked="checked"' ?> tabindex="28" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="delete_posts" value="1"<?php if ($group['g_delete_posts'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="delete_posts" value="0"<?php if ($group['g_delete_posts'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Delete posts help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Delete topics label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="delete_topics" value="1"<?php if ($group['g_delete_topics'] == '1') echo ' checked="checked"' ?> tabindex="29" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="delete_topics" value="0"<?php if ($group['g_delete_topics'] == '0') echo ' checked="checked"' ?> tabindex="30" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="delete_topics" value="1"<?php if ($group['g_delete_topics'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="delete_topics" value="0"<?php if ($group['g_delete_topics'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Delete topics help'] ?></span>
 									</td>
 								</tr>
 <?php endif; ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Post links label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="post_links" value="1"<?php if ($group['g_post_links'] == '1') echo ' checked="checked"' ?> tabindex="31" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="post_links" value="0"<?php if ($group['g_post_links'] == '0') echo ' checked="checked"' ?> tabindex="32" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="post_links" value="1"<?php if ($group['g_post_links'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="post_links" value="0"<?php if ($group['g_post_links'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Post links help'] ?></span>
 									</td>
 								</tr>
 <?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Set own title label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="set_title" value="1"<?php if ($group['g_set_title'] == '1') echo ' checked="checked"' ?> tabindex="33" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="set_title" value="0"<?php if ($group['g_set_title'] == '0') echo ' checked="checked"' ?> tabindex="34" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="set_title" value="1"<?php if ($group['g_set_title'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="set_title" value="0"<?php if ($group['g_set_title'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Set own title help'] ?></span>
 									</td>
 								</tr>
 <?php endif; ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['User search label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="search" value="1"<?php if ($group['g_search'] == '1') echo ' checked="checked"' ?> tabindex="35" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="search" value="0"<?php if ($group['g_search'] == '0') echo ' checked="checked"' ?> tabindex="36" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="search" value="1"<?php if ($group['g_search'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="search" value="0"<?php if ($group['g_search'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['User search help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['User list search label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="search_users" value="1"<?php if ($group['g_search_users'] == '1') echo ' checked="checked"' ?> tabindex="37" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="search_users" value="0"<?php if ($group['g_search_users'] == '0') echo ' checked="checked"' ?> tabindex="38" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="search_users" value="1"<?php if ($group['g_search_users'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="search_users" value="0"<?php if ($group['g_search_users'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['User list search help'] ?></span>
 									</td>
 								</tr>
 <?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Send e-mails label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="send_email" value="1"<?php if ($group['g_send_email'] == '1') echo ' checked="checked"' ?> tabindex="39" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="send_email" value="0"<?php if ($group['g_send_email'] == '0') echo ' checked="checked"' ?> tabindex="40" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="send_email" value="1"<?php if ($group['g_send_email'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="send_email" value="0"<?php if ($group['g_send_email'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_groups['Send e-mails help'] ?></span>
 									</td>
 								</tr>
 <?php endif; ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Post flood label'] ?></th>
 									<td>
-										<input type="text" name="post_flood" size="5" maxlength="4" value="<?php echo $group['g_post_flood'] ?>" tabindex="41" />
+										<input type="text" name="post_flood" size="5" maxlength="4" value="<?php echo $group['g_post_flood'] ?>" />
 										<span><?php echo $lang_admin_groups['Post flood help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Search flood label'] ?></th>
 									<td>
-										<input type="text" name="search_flood" size="5" maxlength="4" value="<?php echo $group['g_search_flood'] ?>" tabindex="42" />
+										<input type="text" name="search_flood" size="5" maxlength="4" value="<?php echo $group['g_search_flood'] ?>" />
 										<span><?php echo $lang_admin_groups['Search flood help'] ?></span>
 									</td>
 								</tr>
 <?php if ($group['g_id'] != PUN_GUEST): ?>								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['E-mail flood label'] ?></th>
 									<td>
-										<input type="text" name="email_flood" size="5" maxlength="4" value="<?php echo $group['g_email_flood'] ?>" tabindex="43" />
+										<input type="text" name="email_flood" size="5" maxlength="4" value="<?php echo $group['g_email_flood'] ?>" />
 										<span><?php echo $lang_admin_groups['E-mail flood help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_groups['Report flood label'] ?></th>
 									<td>
-										<input type="text" name="report_flood" size="5" maxlength="4" value="<?php echo $group['g_report_flood'] ?>" tabindex="44" />
+										<input type="text" name="report_flood" size="5" maxlength="4" value="<?php echo $group['g_report_flood'] ?>" />
 										<span><?php echo $lang_admin_groups['Report flood help'] ?></span>
 									</td>
 								</tr>
@@ -286,7 +286,7 @@ foreach ($groups as $cur_group)
 <?php endif; ?>						</div>
 					</fieldset>
 				</div>
-				<p class="submitend"><input type="submit" name="add_edit_group" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="45" /></p>
+				<p class="submitend"><input type="submit" name="add_edit_group" value="<?php echo $lang_admin_common['Save'] ?>" /></p>
 			</form>
 		</div>
 	</div>
@@ -349,7 +349,7 @@ else if (isset($_POST['add_edit_group']))
 	if ($_POST['mode'] == 'add')
 	{
 		$result = $db->query('SELECT 1 FROM '.$db->prefix.'groups WHERE g_title=\''.$db->escape($title).'\'') or error('Unable to check group title collision', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
+		if ($db->num_rows($result))
 			message(sprintf($lang_admin_groups['Title already exists message'], pun_htmlspecialchars($title)));
 
 		$db->query('INSERT INTO '.$db->prefix.'groups (g_title, g_user_title, g_promote_min_posts, g_promote_next_group, g_moderator, g_mod_edit_users, g_mod_rename_users, g_mod_change_passwords, g_mod_ban_users, g_mod_promote_users, g_read_board, g_view_users, g_post_replies, g_post_topics, g_edit_posts, g_delete_posts, g_delete_topics, g_post_links, g_set_title, g_search, g_search_users, g_send_email, g_post_flood, g_search_flood, g_email_flood, g_report_flood) VALUES(\''.$db->escape($title).'\', '.$user_title.', '.$promote_min_posts.', '.$promote_next_group.', '.$moderator.', '.$mod_edit_users.', '.$mod_rename_users.', '.$mod_change_passwords.', '.$mod_ban_users.', '.$mod_promote_users.', '.$read_board.', '.$view_users.', '.$post_replies.', '.$post_topics.', '.$edit_posts.', '.$delete_posts.', '.$delete_topics.', '.$post_links.', '.$set_title.', '.$search.', '.$search_users.', '.$send_email.', '.$post_flood.', '.$search_flood.', '.$email_flood.', '.$report_flood.')') or error('Unable to add group', __FILE__, __LINE__, $db->error());
@@ -363,7 +363,7 @@ else if (isset($_POST['add_edit_group']))
 	else
 	{
 		$result = $db->query('SELECT 1 FROM '.$db->prefix.'groups WHERE g_title=\''.$db->escape($title).'\' AND g_id!='.intval($_POST['group_id'])) or error('Unable to check group title collision', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
+		if ($db->num_rows($result))
 			message(sprintf($lang_admin_groups['Title already exists message'], pun_htmlspecialchars($title)));
 
 		$db->query('UPDATE '.$db->prefix.'groups SET g_title=\''.$db->escape($title).'\', g_user_title='.$user_title.', g_promote_min_posts='.$promote_min_posts.', g_promote_next_group='.$promote_next_group.', g_moderator='.$moderator.', g_mod_edit_users='.$mod_edit_users.', g_mod_rename_users='.$mod_rename_users.', g_mod_change_passwords='.$mod_change_passwords.', g_mod_ban_users='.$mod_ban_users.', g_mod_promote_users='.$mod_promote_users.', g_read_board='.$read_board.', g_view_users='.$view_users.', g_post_replies='.$post_replies.', g_post_topics='.$post_topics.', g_edit_posts='.$edit_posts.', g_delete_posts='.$delete_posts.', g_delete_topics='.$delete_topics.', g_post_links='.$post_links.', g_set_title='.$set_title.', g_search='.$search.', g_search_users='.$search_users.', g_send_email='.$send_email.', g_post_flood='.$post_flood.', g_search_flood='.$search_flood.', g_email_flood='.$email_flood.', g_report_flood='.$report_flood.' WHERE g_id='.intval($_POST['group_id'])) or error('Unable to update group', __FILE__, __LINE__, $db->error());
@@ -431,7 +431,7 @@ else if (isset($_GET['del_group']))
 	$result = $db->query('SELECT g.g_title, COUNT(u.id) FROM '.$db->prefix.'groups AS g INNER JOIN '.$db->prefix.'users AS u ON g.g_id=u.group_id WHERE g.g_id='.$group_id.' GROUP BY g.g_id, g_title') or error('Unable to fetch group info', __FILE__, __LINE__, $db->error());
 
 	// If the group doesn't have any members or if we've already selected a group to move the members to
-	if (!$db->has_rows($result) || isset($_POST['del_group']))
+	if (!$db->num_rows($result) || isset($_POST['del_group']))
 	{
 		if (isset($_POST['del_group_comply']) || isset($_POST['del_group']))
 		{
@@ -476,7 +476,7 @@ else if (isset($_GET['del_group']))
 						</div>
 					</fieldset>
 				</div>
-				<p class="buttons"><input type="submit" name="del_group_comply" value="<?php echo $lang_admin_common['Delete'] ?>" tabindex="1" /><a href="javascript:history.go(-1)" tabindex="2"><?php echo $lang_admin_common['Go back'] ?></a></p>
+				<p class="buttons"><input type="submit" name="del_group_comply" value="<?php echo $lang_admin_common['Delete'] ?>" /><a href="javascript:history.go(-1)"><?php echo $lang_admin_common['Go back'] ?></a></p>
 			</form>
 		</div>
 	</div>
@@ -555,9 +555,9 @@ generate_admin_menu('groups');
 						<div class="infldset">
 							<table class="aligntop">
 								<tr>
-									<th scope="row"><?php echo $lang_admin_groups['New group label'] ?><div><input type="submit" name="add_group" value="<?php echo $lang_admin_common['Add'] ?>" tabindex="2" /></div></th>
+									<th scope="row"><?php echo $lang_admin_groups['New group label'] ?><div><input type="submit" name="add_group" value="<?php echo $lang_admin_common['Add'] ?>" /></div></th>
 									<td>
-										<select id="base_group" name="base_group" tabindex="1">
+										<select id="base_group" name="base_group">
 <?php
 
 foreach ($groups as $cur_group)
@@ -586,9 +586,9 @@ foreach ($groups as $cur_group)
 						<div class="infldset">
 							<table class="aligntop">
 								<tr>
-									<th scope="row"><?php echo $lang_admin_groups['Default group label'] ?><div><input type="submit" name="set_default_group" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="4" /></div></th>
+									<th scope="row"><?php echo $lang_admin_groups['Default group label'] ?><div><input type="submit" name="set_default_group" value="<?php echo $lang_admin_common['Save'] ?>" /></div></th>
 									<td>
-										<select id="default_group" name="default_group" tabindex="3">
+										<select id="default_group" name="default_group">
 <?php
 
 foreach ($groups as $cur_group)
@@ -628,7 +628,7 @@ foreach ($groups as $cur_group)
 $cur_index = 5;
 
 foreach ($groups as $cur_group)
-	echo "\t\t\t\t\t\t\t\t".'<tr><th scope="row"><a href="admin_groups.php?edit_group='.$cur_group['g_id'].'" tabindex="'.$cur_index++.'">'.$lang_admin_groups['Edit link'].'</a>'.(($cur_group['g_id'] > PUN_MEMBER) ? ' | <a href="admin_groups.php?del_group='.$cur_group['g_id'].'" tabindex="'.$cur_index++.'">'.$lang_admin_groups['Delete link'].'</a>' : '').'</th><td>'.pun_htmlspecialchars($cur_group['g_title']).'</td></tr>'."\n";
+	echo "\t\t\t\t\t\t\t\t".'<tr><th scope="row"><a href="admin_groups.php?edit_group='.$cur_group['g_id'].'">'.$lang_admin_groups['Edit link'].'</a>'.(($cur_group['g_id'] > PUN_MEMBER) ? ' | <a href="admin_groups.php?del_group='.$cur_group['g_id'].'">'.$lang_admin_groups['Delete link'].'</a>' : '').'</th><td>'.pun_htmlspecialchars($cur_group['g_title']).'</td></tr>'."\n";
 
 ?>
 							</table>
diff --git a/admin_index.php b/admin_index.php
index 9ae4c5e8..7692bf2e 100644
--- a/admin_index.php
+++ b/admin_index.php
@@ -28,14 +28,14 @@ if ($action == 'check_upgrade')
 	if (!ini_get('allow_url_fopen'))
 		message($lang_admin_index['fopen disabled message']);
 
-	$latest_version = trim(@file_get_contents('https://fluxbb.org/latest_version'));
+	$latest_version = trim(@file_get_contents('http://fluxbb.org/latest_version'));
 	if (empty($latest_version))
 		message($lang_admin_index['Upgrade check failed message']);
 
 	if (version_compare($pun_config['o_cur_version'], $latest_version, '>='))
 		message($lang_admin_index['Running latest version message']);
 	else
-		message(sprintf($lang_admin_index['New version available message'], '<a href="https://fluxbb.org/">FluxBB.org</a>'));
+		message(sprintf($lang_admin_index['New version available message'], '<a href="http://fluxbb.org/">FluxBB.org</a>'));
 }
 // Remove install.php
 else if ($action == 'remove_install_file')
@@ -97,7 +97,7 @@ generate_admin_menu('index');
 					</dd>
 					<dt><?php echo $lang_admin_index['Support label'] ?></dt>
 					<dd>
-						<a href="https://fluxbb.org/forums/index.php"><?php echo $lang_admin_index['Forum label'] ?></a> - <a href="https://fluxbb.org/community/irc.html"><?php echo $lang_admin_index['IRC label'] ?></a>
+						<a href="http://fluxbb.org/forums/index.php"><?php echo $lang_admin_index['Forum label'] ?></a> - <a href="http://fluxbb.org/community/irc.html"><?php echo $lang_admin_index['IRC label'] ?></a>
 					</dd>
 				</dl>
 			</div>
diff --git a/admin_maintenance.php b/admin_maintenance.php
index cb23617a..6617e4f0 100644
--- a/admin_maintenance.php
+++ b/admin_maintenance.php
@@ -26,9 +26,9 @@ $action = isset($_REQUEST['action']) ? pun_trim($_REQUEST['action']) : '';
 
 if ($action == 'rebuild')
 {
-	confirm_referrer('admin_maintenance.php');
+    confirm_referrer('admin_maintenance.php');
 
-	check_csrf($_GET['csrf_token']);
+    check_csrf($_GET['csrf_token']);
 
 	$per_page = isset($_GET['i_per_page']) ? intval($_GET['i_per_page']) : 0;
 	$start_at = isset($_GET['i_start_at']) ? intval($_GET['i_start_at']) : 0;
@@ -114,7 +114,7 @@ h1 {
 	{
 		$result = $db->query('SELECT id FROM '.$db->prefix.'posts WHERE id > '.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to fetch next ID', __FILE__, __LINE__, $db->error());
 
-		if ($db->has_rows($result))
+		if ($db->num_rows($result) > 0)
 			$query_str = '?action=rebuild&csrf_token='.pun_csrf_token().'&i_per_page='.$per_page.'&i_start_at='.$db->result($result);
 	}
 
@@ -141,11 +141,14 @@ if ($action == 'prune')
 		if ($prune_from == 'all')
 		{
 			$result = $db->query('SELECT id FROM '.$db->prefix.'forums') or error('Unable to fetch forum list', __FILE__, __LINE__, $db->error());
+			$num_forums = $db->num_rows($result);
 
-			while ($cur_forum = $db->fetch_assoc())
+			for ($i = 0; $i < $num_forums; ++$i)
 			{
-				prune($cur_forum['id'], $prune_sticky, $prune_date);
-				update_forum($cur_forum['id']);
+				$fid = $db->result($result, $i);
+
+				prune($fid, $prune_sticky, $prune_date);
+				update_forum($fid);
 			}
 		}
 		else
@@ -157,12 +160,15 @@ if ($action == 'prune')
 
 		// Locate any "orphaned redirect topics" and delete them
 		$result = $db->query('SELECT t1.id FROM '.$db->prefix.'topics AS t1 LEFT JOIN '.$db->prefix.'topics AS t2 ON t1.moved_to=t2.id WHERE t2.id IS NULL AND t1.moved_to IS NOT NULL') or error('Unable to fetch redirect topics', __FILE__, __LINE__, $db->error());
+		$num_orphans = $db->num_rows($result);
 
-		while ($cur_topic = $db->fetch_assoc($result))
-			$orphans[] = $cur_topic['id'];
+		if ($num_orphans)
+		{
+			for ($i = 0; $i < $num_orphans; ++$i)
+				$orphans[] = $db->result($result, $i);
 
-		if (!empty($orphans))
 			$db->query('DELETE FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $orphans).')') or error('Unable to delete redirect topics', __FILE__, __LINE__, $db->error());
+		}
 
 		redirect('admin_maintenance.php', $lang_admin_maintenance['Posts pruned redirect']);
 	}
@@ -237,7 +243,7 @@ if ($action == 'prune')
 
 // Get the first post ID from the db
 $result = $db->query('SELECT id FROM '.$db->prefix.'posts ORDER BY id ASC LIMIT 1') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 	$first_id = $db->result($result);
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Maintenance']);
@@ -253,7 +259,7 @@ generate_admin_menu('maintenance');
 			<form method="get" action="admin_maintenance.php">
 				<div class="inform">
 					<input type="hidden" name="action" value="rebuild" />
-					<input type="hidden" name="csrf_token" value="<?php echo pun_csrf_token() ?>" />
+                    <input type="hidden" name="csrf_token" value="<?php echo pun_csrf_token() ?>" />
 					<fieldset>
 						<legend><?php echo $lang_admin_maintenance['Rebuild index subhead'] ?></legend>
 						<div class="infldset">
@@ -262,26 +268,26 @@ generate_admin_menu('maintenance');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_maintenance['Posts per cycle label'] ?></th>
 									<td>
-										<input type="text" name="i_per_page" size="7" maxlength="7" value="300" tabindex="1" />
+										<input type="text" name="i_per_page" size="7" maxlength="7" value="300" />
 										<span><?php echo $lang_admin_maintenance['Posts per cycle help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_maintenance['Starting post label'] ?></th>
 									<td>
-										<input type="text" name="i_start_at" size="7" maxlength="7" value="<?php echo (isset($first_id)) ? $first_id : 0 ?>" tabindex="2" />
+										<input type="text" name="i_start_at" size="7" maxlength="7" value="<?php echo (isset($first_id)) ? $first_id : 0 ?>" />
 										<span><?php echo $lang_admin_maintenance['Starting post help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_maintenance['Empty index label'] ?></th>
 									<td class="inputadmin">
-										<label><input type="checkbox" name="i_empty_index" value="1" tabindex="3" checked="checked" />&#160;&#160;<?php echo $lang_admin_maintenance['Empty index help'] ?></label>
+										<label><input type="checkbox" name="i_empty_index" value="1" checked />&#160;&#160;<?php echo $lang_admin_maintenance['Empty index help'] ?></label>
 									</td>
 								</tr>
 							</table>
 							<p class="topspace"><?php echo $lang_admin_maintenance['Rebuild completed info'] ?></p>
-							<div class="fsetsubmit"><input type="submit" name="rebuild_index" value="<?php echo $lang_admin_maintenance['Rebuild index'] ?>" tabindex="4" /></div>
+							<div class="fsetsubmit"><input type="submit" name="rebuild_index" value="<?php echo $lang_admin_maintenance['Rebuild index'] ?>" /></div>
 						</div>
 					</fieldset>
 				</div>
@@ -297,14 +303,14 @@ generate_admin_menu('maintenance');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_maintenance['Days old label'] ?></th>
 									<td>
-										<input type="text" name="req_prune_days" size="3" maxlength="3" tabindex="5" />
+										<input type="text" name="req_prune_days" size="3" maxlength="3" required />
 										<span><?php echo $lang_admin_maintenance['Days old help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_maintenance['Prune sticky label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="prune_sticky" value="1" tabindex="6" checked="checked" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="prune_sticky" value="1" checked />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
 										<label class="conl"><input type="radio" name="prune_sticky" value="0" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_maintenance['Prune sticky help'] ?></span>
 									</td>
@@ -312,7 +318,7 @@ generate_admin_menu('maintenance');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_maintenance['Prune from label'] ?></th>
 									<td>
-										<select name="prune_from" tabindex="7">
+										<select name="prune_from">
 											<option value="all"><?php echo $lang_admin_maintenance['All forums'] ?></option>
 <?php
 
@@ -341,7 +347,7 @@ generate_admin_menu('maintenance');
 								</tr>
 							</table>
 							<p class="topspace"><?php printf($lang_admin_maintenance['Prune info'], '<a href="admin_options.php#maintenance">'.$lang_admin_common['Maintenance mode'].'</a>') ?></p>
-							<div class="fsetsubmit"><input type="submit" name="prune" value="<?php echo $lang_admin_common['Prune'] ?>" tabindex="8" /></div>
+							<div class="fsetsubmit"><input type="submit" name="prune" value="<?php echo $lang_admin_common['Prune'] ?>" /></div>
 						</div>
 					</fieldset>
 				</div>
diff --git a/admin_options.php b/admin_options.php
index 2cb687a0..ad2a3e20 100644
--- a/admin_options.php
+++ b/admin_options.php
@@ -311,8 +311,8 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['DST label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[default_dst]" value="1"<?php if ($pun_config['o_default_dst'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[default_dst]" value="0"<?php if ($pun_config['o_default_dst'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[default_dst]" value="1"<?php if ($pun_config['o_default_dst'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[default_dst]" value="0"<?php if ($pun_config['o_default_dst'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['DST help'] ?></span>
 									</td>
 								</tr>
@@ -420,48 +420,48 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Version number label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[show_version]" value="1"<?php if ($pun_config['o_show_version'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[show_version]" value="0"<?php if ($pun_config['o_show_version'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_version]" value="1"<?php if ($pun_config['o_show_version'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_version]" value="0"<?php if ($pun_config['o_show_version'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Version number help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Info in posts label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[show_user_info]" value="1"<?php if ($pun_config['o_show_user_info'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[show_user_info]" value="0"<?php if ($pun_config['o_show_user_info'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_user_info]" value="1"<?php if ($pun_config['o_show_user_info'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_user_info]" value="0"<?php if ($pun_config['o_show_user_info'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Info in posts help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Post count label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[show_post_count]" value="1"<?php if ($pun_config['o_show_post_count'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[show_post_count]" value="0"<?php if ($pun_config['o_show_post_count'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_post_count]" value="1"<?php if ($pun_config['o_show_post_count'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_post_count]" value="0"<?php if ($pun_config['o_show_post_count'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Post count help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Smilies label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[smilies]" value="1"<?php if ($pun_config['o_smilies'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[smilies]" value="0"<?php if ($pun_config['o_smilies'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[smilies]" value="1"<?php if ($pun_config['o_smilies'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[smilies]" value="0"<?php if ($pun_config['o_smilies'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Smilies help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Smilies sigs label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[smilies_sig]" value="1"<?php if ($pun_config['o_smilies_sig'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[smilies_sig]" value="0"<?php if ($pun_config['o_smilies_sig'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[smilies_sig]" value="1"<?php if ($pun_config['o_smilies_sig'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[smilies_sig]" value="0"<?php if ($pun_config['o_smilies_sig'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Smilies sigs help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Clickable links label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[make_links]" value="1"<?php if ($pun_config['o_make_links'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[make_links]" value="0"<?php if ($pun_config['o_make_links'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[make_links]" value="1"<?php if ($pun_config['o_make_links'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[make_links]" value="0"<?php if ($pun_config['o_make_links'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Clickable links help'] ?></span>
 									</td>
 								</tr>
@@ -512,72 +512,72 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Quick post label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[quickpost]" value="1"<?php if ($pun_config['o_quickpost'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[quickpost]" value="0"<?php if ($pun_config['o_quickpost'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[quickpost]" value="1"<?php if ($pun_config['o_quickpost'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[quickpost]" value="0"<?php if ($pun_config['o_quickpost'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Quick post help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Users online label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[users_online]" value="1"<?php if ($pun_config['o_users_online'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[users_online]" value="0"<?php if ($pun_config['o_users_online'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[users_online]" value="1"<?php if ($pun_config['o_users_online'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[users_online]" value="0"<?php if ($pun_config['o_users_online'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Users online help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><a name="censoring"></a><?php echo $lang_admin_options['Censor words label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[censoring]" value="1"<?php if ($pun_config['o_censoring'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[censoring]" value="0"<?php if ($pun_config['o_censoring'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[censoring]" value="1"<?php if ($pun_config['o_censoring'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[censoring]" value="0"<?php if ($pun_config['o_censoring'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php printf($lang_admin_options['Censor words help'], '<a href="admin_censoring.php">'.$lang_admin_common['Censoring'].'</a>') ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><a name="signatures"></a><?php echo $lang_admin_options['Signatures label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[signatures]" value="1"<?php if ($pun_config['o_signatures'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[signatures]" value="0"<?php if ($pun_config['o_signatures'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[signatures]" value="1"<?php if ($pun_config['o_signatures'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[signatures]" value="0"<?php if ($pun_config['o_signatures'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Signatures help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['User has posted label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[show_dot]" value="1"<?php if ($pun_config['o_show_dot'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[show_dot]" value="0"<?php if ($pun_config['o_show_dot'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_dot]" value="1"<?php if ($pun_config['o_show_dot'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[show_dot]" value="0"<?php if ($pun_config['o_show_dot'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['User has posted help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Topic views label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[topic_views]" value="1"<?php if ($pun_config['o_topic_views'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[topic_views]" value="0"<?php if ($pun_config['o_topic_views'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[topic_views]" value="1"<?php if ($pun_config['o_topic_views'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[topic_views]" value="0"<?php if ($pun_config['o_topic_views'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Topic views help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Quick jump label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[quickjump]" value="1"<?php if ($pun_config['o_quickjump'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[quickjump]" value="0"<?php if ($pun_config['o_quickjump'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[quickjump]" value="1"<?php if ($pun_config['o_quickjump'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[quickjump]" value="0"<?php if ($pun_config['o_quickjump'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Quick jump help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['GZip label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[gzip]" value="1"<?php if ($pun_config['o_gzip'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[gzip]" value="0"<?php if ($pun_config['o_gzip'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[gzip]" value="1"<?php if ($pun_config['o_gzip'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[gzip]" value="0"<?php if ($pun_config['o_gzip'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['GZip help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Search all label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[search_all_forums]" value="1"<?php if ($pun_config['o_search_all_forums'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[search_all_forums]" value="0"<?php if ($pun_config['o_search_all_forums'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[search_all_forums]" value="1"<?php if ($pun_config['o_search_all_forums'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[search_all_forums]" value="0"<?php if ($pun_config['o_search_all_forums'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Search all help'] ?></span>
 									</td>
 								</tr>
@@ -600,9 +600,9 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Default feed label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[feed_type]" value="0"<?php if ($pun_config['o_feed_type'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_options['None'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[feed_type]" value="1"<?php if ($pun_config['o_feed_type'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_options['RSS'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[feed_type]" value="2"<?php if ($pun_config['o_feed_type'] == '2') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_options['Atom'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[feed_type]" value="0"<?php if ($pun_config['o_feed_type'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_options['None'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[feed_type]" value="1"<?php if ($pun_config['o_feed_type'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_options['RSS'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[feed_type]" value="2"<?php if ($pun_config['o_feed_type'] == '2') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_options['Atom'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Default feed help'] ?></span>
 									</td>
 								</tr>
@@ -635,9 +635,9 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Reporting method label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[report_method]" value="0"<?php if ($pun_config['o_report_method'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_options['Internal'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[report_method]" value="1"<?php if ($pun_config['o_report_method'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_options['By e-mail'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[report_method]" value="2"<?php if ($pun_config['o_report_method'] == '2') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_options['Both'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[report_method]" value="0"<?php if ($pun_config['o_report_method'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_options['Internal'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[report_method]" value="1"<?php if ($pun_config['o_report_method'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_options['By e-mail'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[report_method]" value="2"<?php if ($pun_config['o_report_method'] == '2') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_options['Both'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Reporting method help'] ?></span>
 									</td>
 								</tr>
@@ -660,8 +660,8 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Use avatars label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[avatars]" value="1"<?php if ($pun_config['o_avatars'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[avatars]" value="0"<?php if ($pun_config['o_avatars'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[avatars]" value="1"<?php if ($pun_config['o_avatars'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[avatars]" value="0"<?php if ($pun_config['o_avatars'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Use avatars help'] ?></span>
 									</td>
 								</tr>
@@ -719,16 +719,16 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Forum subscriptions label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[forum_subscriptions]" value="1"<?php if ($pun_config['o_forum_subscriptions'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[forum_subscriptions]" value="0"<?php if ($pun_config['o_forum_subscriptions'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[forum_subscriptions]" value="1"<?php if ($pun_config['o_forum_subscriptions'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[forum_subscriptions]" value="0"<?php if ($pun_config['o_forum_subscriptions'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Forum subscriptions help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Topic subscriptions label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[topic_subscriptions]" value="1"<?php if ($pun_config['o_topic_subscriptions'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[topic_subscriptions]" value="0"<?php if ($pun_config['o_topic_subscriptions'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[topic_subscriptions]" value="1"<?php if ($pun_config['o_topic_subscriptions'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[topic_subscriptions]" value="0"<?php if ($pun_config['o_topic_subscriptions'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Topic subscriptions help'] ?></span>
 									</td>
 								</tr>
@@ -759,8 +759,8 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['SMTP SSL label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[smtp_ssl]" value="1"<?php if ($pun_config['o_smtp_ssl'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[smtp_ssl]" value="0"<?php if ($pun_config['o_smtp_ssl'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[smtp_ssl]" value="1"<?php if ($pun_config['o_smtp_ssl'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[smtp_ssl]" value="0"<?php if ($pun_config['o_smtp_ssl'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['SMTP SSL help'] ?></span>
 									</td>
 								</tr>
@@ -776,32 +776,32 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Allow new label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[regs_allow]" value="1"<?php if ($pun_config['o_regs_allow'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[regs_allow]" value="0"<?php if ($pun_config['o_regs_allow'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[regs_allow]" value="1"<?php if ($pun_config['o_regs_allow'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[regs_allow]" value="0"<?php if ($pun_config['o_regs_allow'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Allow new help'] ?></span>
 									</td> 
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Verify label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[regs_verify]" value="1"<?php if ($pun_config['o_regs_verify'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[regs_verify]" value="0"<?php if ($pun_config['o_regs_verify'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[regs_verify]" value="1"<?php if ($pun_config['o_regs_verify'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[regs_verify]" value="0"<?php if ($pun_config['o_regs_verify'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Verify help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Report new label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[regs_report]" value="1"<?php if ($pun_config['o_regs_report'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[regs_report]" value="0"<?php if ($pun_config['o_regs_report'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[regs_report]" value="1"<?php if ($pun_config['o_regs_report'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[regs_report]" value="0"<?php if ($pun_config['o_regs_report'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Report new help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Use rules label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[rules]" value="1"<?php if ($pun_config['o_rules'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[rules]" value="0"<?php if ($pun_config['o_rules'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[rules]" value="1"<?php if ($pun_config['o_rules'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[rules]" value="0"<?php if ($pun_config['o_rules'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Use rules help'] ?></span>
 									</td>
 								</tr>
@@ -816,9 +816,9 @@ generate_admin_menu('options');
 									<th scope="row"><?php echo $lang_admin_options['E-mail default label'] ?></th>
 									<td>
 										<span><?php echo $lang_admin_options['E-mail default help'] ?></span>
-										<label><input type="radio" name="form[default_email_setting]" id="form_default_email_setting_0" value="0"<?php if ($pun_config['o_default_email_setting'] == '0') echo ' checked="checked"' ?> />&#160;<?php echo $lang_admin_options['Display e-mail label'] ?></label>
-										<label><input type="radio" name="form[default_email_setting]" id="form_default_email_setting_1" value="1"<?php if ($pun_config['o_default_email_setting'] == '1') echo ' checked="checked"' ?> />&#160;<?php echo $lang_admin_options['Hide allow form label'] ?></label>
-										<label><input type="radio" name="form[default_email_setting]" id="form_default_email_setting_2" value="2"<?php if ($pun_config['o_default_email_setting'] == '2') echo ' checked="checked"' ?> />&#160;<?php echo $lang_admin_options['Hide both label'] ?></label>
+										<label><input type="radio" name="form[default_email_setting]" id="form_default_email_setting_0" value="0"<?php if ($pun_config['o_default_email_setting'] == '0') echo ' checked' ?> />&#160;<?php echo $lang_admin_options['Display e-mail label'] ?></label>
+										<label><input type="radio" name="form[default_email_setting]" id="form_default_email_setting_1" value="1"<?php if ($pun_config['o_default_email_setting'] == '1') echo ' checked' ?> />&#160;<?php echo $lang_admin_options['Hide allow form label'] ?></label>
+										<label><input type="radio" name="form[default_email_setting]" id="form_default_email_setting_2" value="2"<?php if ($pun_config['o_default_email_setting'] == '2') echo ' checked' ?> />&#160;<?php echo $lang_admin_options['Hide both label'] ?></label>
 									</td>
 								</tr>
 							</table>
@@ -833,8 +833,8 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_options['Display announcement label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[announcement]" value="1"<?php if ($pun_config['o_announcement'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[announcement]" value="0"<?php if ($pun_config['o_announcement'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[announcement]" value="1"<?php if ($pun_config['o_announcement'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[announcement]" value="0"<?php if ($pun_config['o_announcement'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Display announcement help'] ?></span>
 									</td>
 								</tr>
@@ -857,8 +857,8 @@ generate_admin_menu('options');
 								<tr>
 									<th scope="row"><a name="maintenance"></a><?php echo $lang_admin_options['Maintenance mode label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[maintenance]" value="1"<?php if ($pun_config['o_maintenance'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[maintenance]" value="0"<?php if ($pun_config['o_maintenance'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[maintenance]" value="1"<?php if ($pun_config['o_maintenance'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[maintenance]" value="0"<?php if ($pun_config['o_maintenance'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_options['Maintenance mode help'] ?></span>
 									</td>
 								</tr>
diff --git a/admin_permissions.php b/admin_permissions.php
index 806b6513..8516a676 100644
--- a/admin_permissions.php
+++ b/admin_permissions.php
@@ -67,40 +67,40 @@ generate_admin_menu('permissions');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['BBCode label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[message_bbcode]" value="1"<?php if ($pun_config['p_message_bbcode'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[message_bbcode]" value="0"<?php if ($pun_config['p_message_bbcode'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[message_bbcode]" value="1"<?php if ($pun_config['p_message_bbcode'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[message_bbcode]" value="0"<?php if ($pun_config['p_message_bbcode'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['BBCode help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['Image tag label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[message_img_tag]" value="1"<?php if ($pun_config['p_message_img_tag'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[message_img_tag]" value="0"<?php if ($pun_config['p_message_img_tag'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[message_img_tag]" value="1"<?php if ($pun_config['p_message_img_tag'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[message_img_tag]" value="0"<?php if ($pun_config['p_message_img_tag'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['Image tag help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['All caps message label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[message_all_caps]" value="1"<?php if ($pun_config['p_message_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[message_all_caps]" value="0"<?php if ($pun_config['p_message_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[message_all_caps]" value="1"<?php if ($pun_config['p_message_all_caps'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[message_all_caps]" value="0"<?php if ($pun_config['p_message_all_caps'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['All caps message help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['All caps subject label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="1"<?php if ($pun_config['p_subject_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="0"<?php if ($pun_config['p_subject_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="1"<?php if ($pun_config['p_subject_all_caps'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[subject_all_caps]" value="0"<?php if ($pun_config['p_subject_all_caps'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['All caps subject help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['Require e-mail label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[force_guest_email]" value="1"<?php if ($pun_config['p_force_guest_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[force_guest_email]" value="0"<?php if ($pun_config['p_force_guest_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[force_guest_email]" value="1"<?php if ($pun_config['p_force_guest_email'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[force_guest_email]" value="0"<?php if ($pun_config['p_force_guest_email'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['Require e-mail help'] ?></span>
 									</td>
 								</tr>
@@ -116,24 +116,24 @@ generate_admin_menu('permissions');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['BBCode sigs label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="1"<?php if ($pun_config['p_sig_bbcode'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="0"<?php if ($pun_config['p_sig_bbcode'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="1"<?php if ($pun_config['p_sig_bbcode'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[sig_bbcode]" value="0"<?php if ($pun_config['p_sig_bbcode'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['BBCode sigs help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['Image tag sigs label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="1"<?php if ($pun_config['p_sig_img_tag'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="0"<?php if ($pun_config['p_sig_img_tag'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="1"<?php if ($pun_config['p_sig_img_tag'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[sig_img_tag]" value="0"<?php if ($pun_config['p_sig_img_tag'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['Image tag sigs help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['All caps sigs label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="1"<?php if ($pun_config['p_sig_all_caps'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="0"<?php if ($pun_config['p_sig_all_caps'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="1"<?php if ($pun_config['p_sig_all_caps'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[sig_all_caps]" value="0"<?php if ($pun_config['p_sig_all_caps'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['All caps sigs help'] ?></span>
 									</td>
 								</tr>
@@ -163,16 +163,16 @@ generate_admin_menu('permissions');
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['Banned e-mail label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="1"<?php if ($pun_config['p_allow_banned_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="0"<?php if ($pun_config['p_allow_banned_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="1"<?php if ($pun_config['p_allow_banned_email'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[allow_banned_email]" value="0"<?php if ($pun_config['p_allow_banned_email'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['Banned e-mail help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_permissions['Duplicate e-mail label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="1"<?php if ($pun_config['p_allow_dupe_email'] == '1') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="0"<?php if ($pun_config['p_allow_dupe_email'] == '0') echo ' checked="checked"' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="1"<?php if ($pun_config['p_allow_dupe_email'] == '1') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="form[allow_dupe_email]" value="0"<?php if ($pun_config['p_allow_dupe_email'] == '0') echo ' checked' ?> />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_permissions['Duplicate e-mail help'] ?></span>
 									</td>
 								</tr>
diff --git a/admin_reports.php b/admin_reports.php
index c861d21d..77f2163b 100644
--- a/admin_reports.php
+++ b/admin_reports.php
@@ -35,7 +35,7 @@ if (isset($_POST['zap_id']))
 
 	// Delete old reports (which cannot be viewed anyway)
 	$result = $db->query('SELECT zapped FROM '.$db->prefix.'reports WHERE zapped IS NOT NULL ORDER BY zapped DESC LIMIT 10,1') or error('Unable to fetch read reports to delete', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result))
+	if ($db->num_rows($result) > 0)
 	{
 		$zapped_threshold = $db->result($result);
 		$db->query('DELETE FROM '.$db->prefix.'reports WHERE zapped <= '.$zapped_threshold) or error('Unable to delete old read reports', __FILE__, __LINE__, $db->error());
@@ -60,7 +60,7 @@ generate_admin_menu('reports');
 
 $result = $db->query('SELECT r.id, r.topic_id, r.forum_id, r.reported_by, r.created, r.message, p.id AS pid, t.subject, f.forum_name, u.username AS reporter FROM '.$db->prefix.'reports AS r LEFT JOIN '.$db->prefix.'posts AS p ON r.post_id=p.id LEFT JOIN '.$db->prefix.'topics AS t ON r.topic_id=t.id LEFT JOIN '.$db->prefix.'forums AS f ON r.forum_id=f.id LEFT JOIN '.$db->prefix.'users AS u ON r.reported_by=u.id WHERE r.zapped IS NULL ORDER BY created DESC') or error('Unable to fetch report list', __FILE__, __LINE__, $db->error());
 
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 {
 	while ($cur_report = $db->fetch_assoc($result))
 	{
@@ -122,7 +122,7 @@ else
 
 $result = $db->query('SELECT r.id, r.topic_id, r.forum_id, r.reported_by, r.message, r.zapped, r.zapped_by AS zapped_by_id, p.id AS pid, t.subject, f.forum_name, u.username AS reporter, u2.username AS zapped_by FROM '.$db->prefix.'reports AS r LEFT JOIN '.$db->prefix.'posts AS p ON r.post_id=p.id LEFT JOIN '.$db->prefix.'topics AS t ON r.topic_id=t.id LEFT JOIN '.$db->prefix.'forums AS f ON r.forum_id=f.id LEFT JOIN '.$db->prefix.'users AS u ON r.reported_by=u.id LEFT JOIN '.$db->prefix.'users AS u2 ON r.zapped_by=u2.id WHERE r.zapped IS NOT NULL ORDER BY zapped DESC LIMIT 10') or error('Unable to fetch report list', __FILE__, __LINE__, $db->error());
 
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 {
 	while ($cur_report = $db->fetch_assoc($result))
 	{
diff --git a/admin_users.php b/admin_users.php
index 2813c76d..dd54d35f 100644
--- a/admin_users.php
+++ b/admin_users.php
@@ -28,8 +28,8 @@ if (isset($_GET['ip_stats']))
 		message($lang_common['Bad request'], false, '404 Not Found');
 
 	// Fetch ip count
-	$result = $db->query('SELECT COUNT(DISTINCT poster_ip) FROM '.$db->prefix.'posts WHERE poster_id='.$ip_stats) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-	$num_ips = $db->result($result);
+	$result = $db->query('SELECT poster_ip, MAX(posted) AS last_used FROM '.$db->prefix.'posts WHERE poster_id='.$ip_stats.' GROUP BY poster_ip') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
+	$num_ips = $db->num_rows($result);
 
 	// Determine the ip offset (based on $_GET['p'])
 	$num_pages = ceil($num_ips / 50);
@@ -40,12 +40,6 @@ if (isset($_GET['ip_stats']))
 	// Generate paging links
 	$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'admin_users.php?ip_stats='.$ip_stats );
 
-	$crumbs = generate_crumbs(array(
-		array($lang_admin_common['Admin'].' '.$lang_admin_common['Index'], 'admin_index.php'),
-		array($lang_admin_common['Users'], 'admin_users.php'),
-		$lang_admin_users['Results head'],
-	));
-
 	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Users'], $lang_admin_users['Results head']);
 	define('PUN_ACTIVE_PAGE', 'admin');
 	require PUN_ROOT.'header.php';
@@ -53,7 +47,11 @@ if (isset($_GET['ip_stats']))
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_users['Results head'] ?></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
@@ -78,7 +76,7 @@ if (isset($_GET['ip_stats']))
 <?php
 
 	$result = $db->query('SELECT poster_ip, MAX(posted) AS last_used, COUNT(id) AS used_times FROM '.$db->prefix.'posts WHERE poster_id='.$ip_stats.' GROUP BY poster_ip ORDER BY last_used DESC LIMIT '.$start_from.', 50') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 	{
 		while ($cur_ip = $db->fetch_assoc($result))
 		{
@@ -109,7 +107,11 @@ if (isset($_GET['ip_stats']))
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_users['Results head'] ?></strong></li>
+		</ul>
 		<div class="clearer"></div>
 	</div>
 </div>
@@ -127,8 +129,8 @@ if (isset($_GET['show_users']))
 		message($lang_admin_users['Bad IP message']);
 
 	// Fetch user count
-	$result = $db->query('SELECT COUNT(DISTINCT poster_id, poster) FROM '.$db->prefix.'posts WHERE poster_ip=\''.$db->escape($ip).'\'') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-	$num_users = $db->result($result);
+	$result = $db->query('SELECT DISTINCT poster_id, poster FROM '.$db->prefix.'posts WHERE poster_ip=\''.$db->escape($ip).'\'') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
+	$num_users = $db->num_rows($result);
 
 	// Determine the user offset (based on $_GET['p'])
 	$num_pages = ceil($num_users / 50);
@@ -139,12 +141,6 @@ if (isset($_GET['show_users']))
 	// Generate paging links
 	$paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'admin_users.php?show_users='.$ip);
 
-	$crumbs = generate_crumbs(array(
-		array($lang_admin_common['Admin'].' '.$lang_admin_common['Index'], 'admin_index.php'),
-		array($lang_admin_common['Users'], 'admin_users.php'),
-		$lang_admin_users['Results head'],
-	));
-
 	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Users'], $lang_admin_users['Results head']);
 	define('PUN_ACTIVE_PAGE', 'admin');
 	require PUN_ROOT.'header.php';
@@ -152,7 +148,11 @@ if (isset($_GET['show_users']))
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_users['Results head'] ?></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
@@ -179,16 +179,17 @@ if (isset($_GET['show_users']))
 <?php
 
 	$result = $db->query('SELECT DISTINCT poster_id, poster FROM '.$db->prefix.'posts WHERE poster_ip=\''.$db->escape($ip).'\' ORDER BY poster ASC LIMIT '.$start_from.', 50') or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
+	$num_posts = $db->num_rows($result);
 
-	$posters = $poster_ids = array();
-	while ($cur_poster = $db->fetch_assoc($result))
+	if ($num_posts)
 	{
-		$posters[] = $cur_poster;
-		$poster_ids[] = $cur_poster['poster_id'];
-	}
+		$posters = $poster_ids = array();
+		while ($cur_poster = $db->fetch_assoc($result))
+		{
+			$posters[] = $cur_poster;
+			$poster_ids[] = $cur_poster['poster_id'];
+		}
 
-	if (!empty($posters))
-	{
 		$result = $db->query('SELECT u.id, u.username, u.email, u.title, u.num_posts, u.admin_note, g.g_id, g.g_user_title FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id WHERE u.id>1 AND u.id IN('.implode(',', $poster_ids).')') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
 
 		$user_data = array();
@@ -248,7 +249,11 @@ if (isset($_GET['show_users']))
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_users['Results head'] ?></strong></li>
+		</ul>
 		<div class="clearer"></div>
 	</div>
 </div>
@@ -360,7 +365,7 @@ else if (isset($_POST['move_users']) || isset($_POST['move_users_comply']))
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['New group label'] ?></th>
 									<td>
-										<select name="new_group" tabindex="1">
+										<select name="new_group">
 <?php foreach ($all_groups as $gid => $group) : ?>											<option value="<?php echo $gid ?>"><?php echo pun_htmlspecialchars($group) ?></option>
 <?php endforeach; ?>
 										</select>
@@ -371,7 +376,7 @@ else if (isset($_POST['move_users']) || isset($_POST['move_users_comply']))
 						</div>
 					</fieldset>
 				</div>
-				<p class="submitend"><input type="submit" name="move_users_comply" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="2" /></p>
+				<p class="submitend"><input type="submit" name="move_users_comply" value="<?php echo $lang_admin_common['Save'] ?>" /></p>
 			</form>
 		</div>
 	</div>
@@ -460,7 +465,7 @@ else if (isset($_POST['delete_users']) || isset($_POST['delete_users_comply']))
 
 			// Find all posts made by this user
 			$result = $db->query('SELECT p.id, p.topic_id, t.forum_id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id WHERE p.poster_id IN ('.implode(',', $user_ids).')') or error('Unable to fetch posts', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 			{
 				while ($cur_post = $db->fetch_assoc($result))
 				{
@@ -514,7 +519,7 @@ else if (isset($_POST['delete_users']) || isset($_POST['delete_users_comply']))
 						<div class="infldset">
 							<p><?php echo $lang_admin_users['Confirm delete info'] ?></p>
 							<div class="rbox">
-								<label><input type="checkbox" name="delete_posts" value="1" checked="checked" /><?php echo $lang_admin_users['Delete posts'] ?><br /></label>
+								<label><input type="checkbox" name="delete_posts" value="1" checked /><?php echo $lang_admin_users['Delete posts'] ?><br /></label>
 							</div>
 							<p class="warntext"><strong><?php echo $lang_admin_users['Delete warning'] ?></strong></p>
 						</div>
@@ -642,22 +647,22 @@ else if (isset($_POST['ban_users']) || isset($_POST['ban_users_comply']))
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Ban message label'] ?></th>
 									<td>
-										<input type="text" name="ban_message" size="50" maxlength="255" tabindex="1" />
+										<input type="text" name="ban_message" size="50" maxlength="255" />
 										<span><?php echo $lang_admin_users['Ban message help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Expire date label'] ?></th>
 									<td>
-										<input type="text" name="ban_expire" size="17" maxlength="10" tabindex="2" />
+										<input type="text" name="ban_expire" size="17" maxlength="10" />
 										<span><?php echo $lang_admin_users['Expire date help'] ?></span>
 									</td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Ban IP label'] ?></th>
 									<td>
-										<label class="conl"><input type="radio" name="ban_the_ip" tabindex="3" value="1" checked="checked" />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
-										<label class="conl"><input type="radio" name="ban_the_ip" tabindex="4" value="0" checked="checked" />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
+										<label class="conl"><input type="radio" name="ban_the_ip" value="1" checked />&#160;<strong><?php echo $lang_admin_common['Yes'] ?></strong></label>
+										<label class="conl"><input type="radio" name="ban_the_ip" value="0" checked />&#160;<strong><?php echo $lang_admin_common['No'] ?></strong></label>
 										<span class="clearb"><?php echo $lang_admin_users['Ban IP help'] ?></span>
 									</td>
 								</tr>
@@ -665,7 +670,7 @@ else if (isset($_POST['ban_users']) || isset($_POST['ban_users_comply']))
 						</div>
 					</fieldset>
 				</div>
-				<p class="submitend"><input type="submit" name="ban_users_comply" value="<?php echo $lang_admin_common['Save'] ?>" tabindex="3" /></p>
+				<p class="submitend"><input type="submit" name="ban_users_comply" value="<?php echo $lang_admin_common['Save'] ?>" /></p>
 			</form>
 		</div>
 	</div>
@@ -769,7 +774,7 @@ else if (isset($_GET['find_user']))
 	$like_command = ($db_type == 'pgsql') ? 'ILIKE' : 'LIKE';
 	foreach ($form as $key => $input)
 	{
-		if ($input != '' && in_array($key, array('username', 'email', 'title', 'realname', 'url', 'jabber', 'icq', 'msn', 'yahoo', 'location', 'signature', 'admin_note')))
+		if ($input != '' && in_array($key, array('username', 'email', 'title', 'realname', 'url', 'jabber', 'icq', 'msn', 'aim', 'yahoo', 'location', 'signature', 'admin_note')))
 		{
 			$conditions[] = 'u.'.$db->escape($key).' '.$like_command.' \''.$db->escape(str_replace(array('*', '_'), array('%', '\\_'), $input)).'\'';
 			$query_str[] = 'form%5B'.$key.'%5D='.urlencode($input);
@@ -808,12 +813,6 @@ else if (isset($_GET['find_user']))
 	$can_ban = $pun_user['g_id'] == PUN_ADMIN || ($pun_user['g_moderator'] == '1' && $pun_user['g_mod_ban_users'] == '1');
 	$can_action = ($can_delete || $can_ban || $can_move) && $num_users > 0;
 
-	$crumbs = generate_crumbs(array(
-		array($lang_admin_common['Admin'].' '.$lang_admin_common['Index'], 'admin_index.php'),
-		array($lang_admin_common['Users'], 'admin_users.php'),
-		$lang_admin_users['Results head'],
-	));
-
 	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_admin_common['Admin'], $lang_admin_common['Users'], $lang_admin_users['Results head']);
 	$page_head = array('js' => '<script type="text/javascript" src="common.js"></script>');
 	define('PUN_ACTIVE_PAGE', 'admin');
@@ -822,7 +821,11 @@ else if (isset($_GET['find_user']))
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_users['Results head'] ?></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
@@ -853,7 +856,7 @@ else if (isset($_GET['find_user']))
 <?php
 
 	$result = $db->query('SELECT u.id, u.username, u.email, u.title, u.num_posts, u.admin_note, g.g_id, g.g_user_title FROM '.$db->prefix.'users AS u LEFT JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id WHERE u.id>1'.(!empty($conditions) ? ' AND '.implode(' AND ', $conditions) : '').' ORDER BY '.$db->escape($order_by).' '.$db->escape($direction).' LIMIT '.$start_from.', 50') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 	{
 		while ($user_data = $db->fetch_assoc($result))
 		{
@@ -897,7 +900,11 @@ else if (isset($_GET['find_user']))
 <?php if ($can_action): ?>			<p class="conr modbuttons"><a href="#" onclick="return select_checkboxes('search-users-form', this, '<?php echo $lang_admin_users['Unselect all'] ?>')"><?php echo $lang_admin_users['Select all'] ?></a> <?php if ($can_ban) : ?><input type="submit" name="ban_users" value="<?php echo $lang_admin_users['Ban'] ?>" /><?php endif; if ($can_delete) : ?><input type="submit" name="delete_users" value="<?php echo $lang_admin_users['Delete'] ?>" /><?php endif; if ($can_move) : ?><input type="submit" name="move_users" value="<?php echo $lang_admin_users['Change group'] ?>" /><?php endif; ?></p>
 <?php endif; ?>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="admin_index.php"><?php echo $lang_admin_common['Admin'].' '.$lang_admin_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="admin_users.php"><?php echo $lang_admin_common['Users'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_admin_users['Results head'] ?></strong></li>
+		</ul>
 		<div class="clearer"></div>
 	</div>
 </div>
@@ -922,7 +929,7 @@ else
 		<h2><span><?php echo $lang_admin_users['User search head'] ?></span></h2>
 		<div class="box">
 			<form id="find_user" method="get" action="admin_users.php">
-				<p class="submittop"><input type="submit" name="find_user" value="<?php echo $lang_admin_users['Submit search'] ?>" tabindex="1" /></p>
+				<p class="submittop"><input type="submit" name="find_user" value="<?php echo $lang_admin_users['Submit search'] ?>" /></p>
 				<div class="inform">
 					<fieldset>
 						<legend><?php echo $lang_admin_users['User search subhead'] ?></legend>
@@ -931,101 +938,105 @@ else
 							<table class="aligntop">
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Username label'] ?></th>
-									<td><input type="text" name="form[username]" size="25" maxlength="25" tabindex="2" /></td>
+									<td><input type="text" name="form[username]" size="25" maxlength="25" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['E-mail address label'] ?></th>
-									<td><input type="text" name="form[email]" size="30" maxlength="80" tabindex="3" /></td>
+									<td><input type="text" name="form[email]" size="30" maxlength="80" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Title label'] ?></th>
-									<td><input type="text" name="form[title]" size="30" maxlength="50" tabindex="4" /></td>
+									<td><input type="text" name="form[title]" size="30" maxlength="50" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Real name label'] ?></th>
-									<td><input type="text" name="form[realname]" size="30" maxlength="40" tabindex="5" /></td>
+									<td><input type="text" name="form[realname]" size="30" maxlength="40" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Website label'] ?></th>
-									<td><input type="text" name="form[url]" size="35" maxlength="100" tabindex="6" /></td>
+									<td><input type="text" name="form[url]" size="35" maxlength="100" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Jabber label'] ?></th>
-									<td><input type="text" name="form[jabber]" size="30" maxlength="75" tabindex="7" /></td>
+									<td><input type="text" name="form[jabber]" size="30" maxlength="75" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['ICQ label'] ?></th>
-									<td><input type="text" name="form[icq]" size="12" maxlength="12" tabindex="8" /></td>
+									<td><input type="text" name="form[icq]" size="12" maxlength="12" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['MSN label'] ?></th>
-									<td><input type="text" name="form[msn]" size="30" maxlength="50" tabindex="9" /></td>
+									<td><input type="text" name="form[msn]" size="30" maxlength="50" /></td>
+								</tr>
+								<tr>
+									<th scope="row"><?php echo $lang_admin_users['AOL label'] ?></th>
+									<td><input type="text" name="form[aim]" size="20" maxlength="20" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Yahoo label'] ?></th>
-									<td><input type="text" name="form[yahoo]" size="20" maxlength="20" tabindex="11" /></td>
+									<td><input type="text" name="form[yahoo]" size="20" maxlength="20" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Location label'] ?></th>
-									<td><input type="text" name="form[location]" size="30" maxlength="30" tabindex="12" /></td>
+									<td><input type="text" name="form[location]" size="30" maxlength="30" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Signature label'] ?></th>
-									<td><input type="text" name="form[signature]" size="35" maxlength="512" tabindex="13" /></td>
+									<td><input type="text" name="form[signature]" size="35" maxlength="512" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Admin note label'] ?></th>
-									<td><input type="text" name="form[admin_note]" size="30" maxlength="30" tabindex="14" /></td>
+									<td><input type="text" name="form[admin_note]" size="30" maxlength="30" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Posts more than label'] ?></th>
-									<td><input type="text" name="posts_greater" size="5" maxlength="8" tabindex="15" /></td>
+									<td><input type="text" name="posts_greater" size="5" maxlength="8" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Posts less than label'] ?></th>
-									<td><input type="text" name="posts_less" size="5" maxlength="8" tabindex="16" /></td>
+									<td><input type="text" name="posts_less" size="5" maxlength="8" /></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Last post after label'] ?></th>
-									<td><input type="text" name="last_post_after" size="24" maxlength="19" tabindex="17" />
+									<td><input type="text" name="last_post_after" size="24" maxlength="19" />
 									<span><?php echo $lang_admin_users['Date help'] ?></span></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Last post before label'] ?></th>
-									<td><input type="text" name="last_post_before" size="24" maxlength="19" tabindex="18" />
+									<td><input type="text" name="last_post_before" size="24" maxlength="19" />
 									<span><?php echo $lang_admin_users['Date help'] ?></span></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Last visit after label'] ?></th>
-									<td><input type="text" name="last_visit_after" size="24" maxlength="19" tabindex="17" />
+									<td><input type="text" name="last_visit_after" size="24" maxlength="19" />
 									<span><?php echo $lang_admin_users['Date help'] ?></span></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Last visit before label'] ?></th>
-									<td><input type="text" name="last_visit_before" size="24" maxlength="19" tabindex="18" />
+									<td><input type="text" name="last_visit_before" size="24" maxlength="19" />
 									<span><?php echo $lang_admin_users['Date help'] ?></span></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Registered after label'] ?></th>
-									<td><input type="text" name="registered_after" size="24" maxlength="19" tabindex="19" />
+									<td><input type="text" name="registered_after" size="24" maxlength="19" />
 									<span><?php echo $lang_admin_users['Date help'] ?></span></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Registered before label'] ?></th>
-									<td><input type="text" name="registered_before" size="24" maxlength="19" tabindex="20" />
+									<td><input type="text" name="registered_before" size="24" maxlength="19" />
 									<span><?php echo $lang_admin_users['Date help'] ?></span></td>
 								</tr>
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['Order by label'] ?></th>
 									<td>
-										<select name="order_by" tabindex="21">
+										<select name="order_by">
 											<option value="username" selected="selected"><?php echo $lang_admin_users['Order by username'] ?></option>
 											<option value="email"><?php echo $lang_admin_users['Order by e-mail'] ?></option>
 											<option value="num_posts"><?php echo $lang_admin_users['Order by posts'] ?></option>
 											<option value="last_post"><?php echo $lang_admin_users['Order by last post'] ?></option>
 											<option value="last_visit"><?php echo $lang_admin_users['Order by last visit'] ?></option>
 											<option value="registered"><?php echo $lang_admin_users['Order by registered'] ?></option>
-										</select>&#160;&#160;&#160;<select name="direction" tabindex="22">
+										</select>&#160;&#160;&#160;<select name="direction">
 											<option value="ASC" selected="selected"><?php echo $lang_admin_users['Ascending'] ?></option>
 											<option value="DESC"><?php echo $lang_admin_users['Descending'] ?></option>
 										</select>
@@ -1034,7 +1045,7 @@ else
 								<tr>
 									<th scope="row"><?php echo $lang_admin_users['User group label'] ?></th>
 									<td>
-										<select name="user_group" tabindex="23">
+										<select name="user_group">
 											<option value="-1" selected="selected"><?php echo $lang_admin_users['All groups'] ?></option>
 											<option value="0"><?php echo $lang_admin_users['Unverified users'] ?></option>
 <?php
@@ -1052,7 +1063,7 @@ else
 						</div>
 					</fieldset>
 				</div>
-				<p class="submitend"><input type="submit" name="find_user" value="<?php echo $lang_admin_users['Submit search'] ?>" tabindex="25" /></p>
+				<p class="submitend"><input type="submit" name="find_user" value="<?php echo $lang_admin_users['Submit search'] ?>" /></p>
 			</form>
 		</div>
 
@@ -1065,8 +1076,8 @@ else
 						<div class="infldset">
 							<table class="aligntop">
 								<tr>
-									<th scope="row"><?php echo $lang_admin_users['IP address label'] ?><div><input type="submit" value="<?php echo $lang_admin_users['Find IP address'] ?>" tabindex="26" /></div></th>
-									<td><input type="text" name="show_users" size="18" maxlength="15" tabindex="24" />
+									<th scope="row"><?php echo $lang_admin_users['IP address label'] ?><div><input type="submit" value="<?php echo $lang_admin_users['Find IP address'] ?>" /></div></th>
+									<td><input type="text" name="show_users" size="18" maxlength="15" />
 									<span><?php echo $lang_admin_users['IP address help'] ?></span></td>
 								</tr>
 							</table>
diff --git a/composer.json b/composer.json
deleted file mode 100644
index bb14b289..00000000
--- a/composer.json
+++ /dev/null
@@ -1,34 +0,0 @@
-{
-	"name": "fluxbb/fluxbb",
-	"description": "FluxBB is a fast, light, user-friendly, free and open-source forum application for your website.",
-	"type": "project",
-	"license": "GPL-2.0-or-later",
-	"homepage": "https://fluxbb.org",
-	"support": {
-		"issues": "https://fluxbb.org/development/core/tickets/",
-		"forum": "https://fluxbb.org/forums/",
-		"source": "https://github.com/fluxbb/fluxbb",
-		"docs": "https://fluxbb.org/docs/"
-	},
-	"authors": [
-		{
-			"name": "Rickard Andersson"
-		},
-		{
-			"name": "Franz Liedke",
-			"email": "franz@develophp.org"
-		}
-	],
-	"require": {
-		"php": ">=5.6.4"
-	},
-	"require-dev": {
-		"phpunit/phpunit": "^7"
-	},
-	"scripts": {
-		"test": "phpunit tests"
-	},
-	"config": {
-		"sort-packages": true
-	}
-}
diff --git a/composer.lock b/composer.lock
deleted file mode 100644
index f7769195..00000000
--- a/composer.lock
+++ /dev/null
@@ -1,1487 +0,0 @@
-{
-    "_readme": [
-        "This file locks the dependencies of your project to a known state",
-        "Read more about it at https://getcomposer.org/doc/01-basic-usage.md#installing-dependencies",
-        "This file is @generated automatically"
-    ],
-    "content-hash": "4ebd6dd9a9d29f6c7f5236bb5cefceeb",
-    "packages": [],
-    "packages-dev": [
-        {
-            "name": "doctrine/instantiator",
-            "version": "1.1.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/doctrine/instantiator.git",
-                "reference": "185b8868aa9bf7159f5f953ed5afb2d7fcdc3bda"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/doctrine/instantiator/zipball/185b8868aa9bf7159f5f953ed5afb2d7fcdc3bda",
-                "reference": "185b8868aa9bf7159f5f953ed5afb2d7fcdc3bda",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "require-dev": {
-                "athletic/athletic": "~0.1.8",
-                "ext-pdo": "*",
-                "ext-phar": "*",
-                "phpunit/phpunit": "^6.2.3",
-                "squizlabs/php_codesniffer": "^3.0.2"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.2.x-dev"
-                }
-            },
-            "autoload": {
-                "psr-4": {
-                    "Doctrine\\Instantiator\\": "src/Doctrine/Instantiator/"
-                }
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Marco Pivetta",
-                    "email": "ocramius@gmail.com",
-                    "homepage": "http://ocramius.github.com/"
-                }
-            ],
-            "description": "A small, lightweight utility to instantiate objects in PHP without invoking their constructors",
-            "homepage": "https://github.com/doctrine/instantiator",
-            "keywords": [
-                "constructor",
-                "instantiate"
-            ],
-            "time": "2017-07-22T11:58:36+00:00"
-        },
-        {
-            "name": "myclabs/deep-copy",
-            "version": "1.8.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/myclabs/DeepCopy.git",
-                "reference": "3e01bdad3e18354c3dce54466b7fbe33a9f9f7f8"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/myclabs/DeepCopy/zipball/3e01bdad3e18354c3dce54466b7fbe33a9f9f7f8",
-                "reference": "3e01bdad3e18354c3dce54466b7fbe33a9f9f7f8",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "replace": {
-                "myclabs/deep-copy": "self.version"
-            },
-            "require-dev": {
-                "doctrine/collections": "^1.0",
-                "doctrine/common": "^2.6",
-                "phpunit/phpunit": "^7.1"
-            },
-            "type": "library",
-            "autoload": {
-                "psr-4": {
-                    "DeepCopy\\": "src/DeepCopy/"
-                },
-                "files": [
-                    "src/DeepCopy/deep_copy.php"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "description": "Create deep copies (clones) of your objects",
-            "keywords": [
-                "clone",
-                "copy",
-                "duplicate",
-                "object",
-                "object graph"
-            ],
-            "time": "2018-06-11T23:09:50+00:00"
-        },
-        {
-            "name": "phar-io/manifest",
-            "version": "1.0.3",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/phar-io/manifest.git",
-                "reference": "7761fcacf03b4d4f16e7ccb606d4879ca431fcf4"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/phar-io/manifest/zipball/7761fcacf03b4d4f16e7ccb606d4879ca431fcf4",
-                "reference": "7761fcacf03b4d4f16e7ccb606d4879ca431fcf4",
-                "shasum": ""
-            },
-            "require": {
-                "ext-dom": "*",
-                "ext-phar": "*",
-                "phar-io/version": "^2.0",
-                "php": "^5.6 || ^7.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.0.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Arne Blankerts",
-                    "email": "arne@blankerts.de",
-                    "role": "Developer"
-                },
-                {
-                    "name": "Sebastian Heuer",
-                    "email": "sebastian@phpeople.de",
-                    "role": "Developer"
-                },
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "Developer"
-                }
-            ],
-            "description": "Component for reading phar.io manifest information from a PHP Archive (PHAR)",
-            "time": "2018-07-08T19:23:20+00:00"
-        },
-        {
-            "name": "phar-io/version",
-            "version": "2.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/phar-io/version.git",
-                "reference": "45a2ec53a73c70ce41d55cedef9063630abaf1b6"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/phar-io/version/zipball/45a2ec53a73c70ce41d55cedef9063630abaf1b6",
-                "reference": "45a2ec53a73c70ce41d55cedef9063630abaf1b6",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^5.6 || ^7.0"
-            },
-            "type": "library",
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Arne Blankerts",
-                    "email": "arne@blankerts.de",
-                    "role": "Developer"
-                },
-                {
-                    "name": "Sebastian Heuer",
-                    "email": "sebastian@phpeople.de",
-                    "role": "Developer"
-                },
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "Developer"
-                }
-            ],
-            "description": "Library for handling version information and constraints",
-            "time": "2018-07-08T19:19:57+00:00"
-        },
-        {
-            "name": "phpdocumentor/reflection-common",
-            "version": "1.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/phpDocumentor/ReflectionCommon.git",
-                "reference": "21bdeb5f65d7ebf9f43b1b25d404f87deab5bfb6"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/phpDocumentor/ReflectionCommon/zipball/21bdeb5f65d7ebf9f43b1b25d404f87deab5bfb6",
-                "reference": "21bdeb5f65d7ebf9f43b1b25d404f87deab5bfb6",
-                "shasum": ""
-            },
-            "require": {
-                "php": ">=5.5"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^4.6"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.0.x-dev"
-                }
-            },
-            "autoload": {
-                "psr-4": {
-                    "phpDocumentor\\Reflection\\": [
-                        "src"
-                    ]
-                }
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Jaap van Otterdijk",
-                    "email": "opensource@ijaap.nl"
-                }
-            ],
-            "description": "Common reflection classes used by phpdocumentor to reflect the code structure",
-            "homepage": "http://www.phpdoc.org",
-            "keywords": [
-                "FQSEN",
-                "phpDocumentor",
-                "phpdoc",
-                "reflection",
-                "static analysis"
-            ],
-            "time": "2017-09-11T18:02:19+00:00"
-        },
-        {
-            "name": "phpdocumentor/reflection-docblock",
-            "version": "4.3.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/phpDocumentor/ReflectionDocBlock.git",
-                "reference": "94fd0001232e47129dd3504189fa1c7225010d08"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/phpDocumentor/ReflectionDocBlock/zipball/94fd0001232e47129dd3504189fa1c7225010d08",
-                "reference": "94fd0001232e47129dd3504189fa1c7225010d08",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.0",
-                "phpdocumentor/reflection-common": "^1.0.0",
-                "phpdocumentor/type-resolver": "^0.4.0",
-                "webmozart/assert": "^1.0"
-            },
-            "require-dev": {
-                "doctrine/instantiator": "~1.0.5",
-                "mockery/mockery": "^1.0",
-                "phpunit/phpunit": "^6.4"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "4.x-dev"
-                }
-            },
-            "autoload": {
-                "psr-4": {
-                    "phpDocumentor\\Reflection\\": [
-                        "src/"
-                    ]
-                }
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Mike van Riel",
-                    "email": "me@mikevanriel.com"
-                }
-            ],
-            "description": "With this component, a library can provide support for annotations via DocBlocks or otherwise retrieve information that is embedded in a DocBlock.",
-            "time": "2017-11-30T07:14:17+00:00"
-        },
-        {
-            "name": "phpdocumentor/type-resolver",
-            "version": "0.4.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/phpDocumentor/TypeResolver.git",
-                "reference": "9c977708995954784726e25d0cd1dddf4e65b0f7"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/phpDocumentor/TypeResolver/zipball/9c977708995954784726e25d0cd1dddf4e65b0f7",
-                "reference": "9c977708995954784726e25d0cd1dddf4e65b0f7",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^5.5 || ^7.0",
-                "phpdocumentor/reflection-common": "^1.0"
-            },
-            "require-dev": {
-                "mockery/mockery": "^0.9.4",
-                "phpunit/phpunit": "^5.2||^4.8.24"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.0.x-dev"
-                }
-            },
-            "autoload": {
-                "psr-4": {
-                    "phpDocumentor\\Reflection\\": [
-                        "src/"
-                    ]
-                }
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Mike van Riel",
-                    "email": "me@mikevanriel.com"
-                }
-            ],
-            "time": "2017-07-14T14:27:02+00:00"
-        },
-        {
-            "name": "phpspec/prophecy",
-            "version": "1.8.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/phpspec/prophecy.git",
-                "reference": "4ba436b55987b4bf311cb7c6ba82aa528aac0a06"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/phpspec/prophecy/zipball/4ba436b55987b4bf311cb7c6ba82aa528aac0a06",
-                "reference": "4ba436b55987b4bf311cb7c6ba82aa528aac0a06",
-                "shasum": ""
-            },
-            "require": {
-                "doctrine/instantiator": "^1.0.2",
-                "php": "^5.3|^7.0",
-                "phpdocumentor/reflection-docblock": "^2.0|^3.0.2|^4.0",
-                "sebastian/comparator": "^1.1|^2.0|^3.0",
-                "sebastian/recursion-context": "^1.0|^2.0|^3.0"
-            },
-            "require-dev": {
-                "phpspec/phpspec": "^2.5|^3.2",
-                "phpunit/phpunit": "^4.8.35 || ^5.7 || ^6.5 || ^7.1"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.8.x-dev"
-                }
-            },
-            "autoload": {
-                "psr-0": {
-                    "Prophecy\\": "src/"
-                }
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Konstantin Kudryashov",
-                    "email": "ever.zet@gmail.com",
-                    "homepage": "http://everzet.com"
-                },
-                {
-                    "name": "Marcello Duarte",
-                    "email": "marcello.duarte@gmail.com"
-                }
-            ],
-            "description": "Highly opinionated mocking framework for PHP 5.3+",
-            "homepage": "https://github.com/phpspec/prophecy",
-            "keywords": [
-                "Double",
-                "Dummy",
-                "fake",
-                "mock",
-                "spy",
-                "stub"
-            ],
-            "time": "2018-08-05T17:53:17+00:00"
-        },
-        {
-            "name": "phpunit/php-code-coverage",
-            "version": "6.1.4",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/php-code-coverage.git",
-                "reference": "807e6013b00af69b6c5d9ceb4282d0393dbb9d8d"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/php-code-coverage/zipball/807e6013b00af69b6c5d9ceb4282d0393dbb9d8d",
-                "reference": "807e6013b00af69b6c5d9ceb4282d0393dbb9d8d",
-                "shasum": ""
-            },
-            "require": {
-                "ext-dom": "*",
-                "ext-xmlwriter": "*",
-                "php": "^7.1",
-                "phpunit/php-file-iterator": "^2.0",
-                "phpunit/php-text-template": "^1.2.1",
-                "phpunit/php-token-stream": "^3.0",
-                "sebastian/code-unit-reverse-lookup": "^1.0.1",
-                "sebastian/environment": "^3.1 || ^4.0",
-                "sebastian/version": "^2.0.1",
-                "theseer/tokenizer": "^1.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.0"
-            },
-            "suggest": {
-                "ext-xdebug": "^2.6.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "6.1-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "lead"
-                }
-            ],
-            "description": "Library that provides collection, processing, and rendering functionality for PHP code coverage information.",
-            "homepage": "https://github.com/sebastianbergmann/php-code-coverage",
-            "keywords": [
-                "coverage",
-                "testing",
-                "xunit"
-            ],
-            "time": "2018-10-31T16:06:48+00:00"
-        },
-        {
-            "name": "phpunit/php-file-iterator",
-            "version": "2.0.2",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/php-file-iterator.git",
-                "reference": "050bedf145a257b1ff02746c31894800e5122946"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/php-file-iterator/zipball/050bedf145a257b1ff02746c31894800e5122946",
-                "reference": "050bedf145a257b1ff02746c31894800e5122946",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.1"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "2.0.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "lead"
-                }
-            ],
-            "description": "FilterIterator implementation that filters files based on a list of suffixes.",
-            "homepage": "https://github.com/sebastianbergmann/php-file-iterator/",
-            "keywords": [
-                "filesystem",
-                "iterator"
-            ],
-            "time": "2018-09-13T20:33:42+00:00"
-        },
-        {
-            "name": "phpunit/php-text-template",
-            "version": "1.2.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/php-text-template.git",
-                "reference": "31f8b717e51d9a2afca6c9f046f5d69fc27c8686"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/php-text-template/zipball/31f8b717e51d9a2afca6c9f046f5d69fc27c8686",
-                "reference": "31f8b717e51d9a2afca6c9f046f5d69fc27c8686",
-                "shasum": ""
-            },
-            "require": {
-                "php": ">=5.3.3"
-            },
-            "type": "library",
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "lead"
-                }
-            ],
-            "description": "Simple template engine.",
-            "homepage": "https://github.com/sebastianbergmann/php-text-template/",
-            "keywords": [
-                "template"
-            ],
-            "time": "2015-06-21T13:50:34+00:00"
-        },
-        {
-            "name": "phpunit/php-timer",
-            "version": "2.0.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/php-timer.git",
-                "reference": "8b8454ea6958c3dee38453d3bd571e023108c91f"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/php-timer/zipball/8b8454ea6958c3dee38453d3bd571e023108c91f",
-                "reference": "8b8454ea6958c3dee38453d3bd571e023108c91f",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "2.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "lead"
-                }
-            ],
-            "description": "Utility class for timing",
-            "homepage": "https://github.com/sebastianbergmann/php-timer/",
-            "keywords": [
-                "timer"
-            ],
-            "time": "2018-02-01T13:07:23+00:00"
-        },
-        {
-            "name": "phpunit/php-token-stream",
-            "version": "3.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/php-token-stream.git",
-                "reference": "c99e3be9d3e85f60646f152f9002d46ed7770d18"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/php-token-stream/zipball/c99e3be9d3e85f60646f152f9002d46ed7770d18",
-                "reference": "c99e3be9d3e85f60646f152f9002d46ed7770d18",
-                "shasum": ""
-            },
-            "require": {
-                "ext-tokenizer": "*",
-                "php": "^7.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "3.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Wrapper around PHP's tokenizer extension.",
-            "homepage": "https://github.com/sebastianbergmann/php-token-stream/",
-            "keywords": [
-                "tokenizer"
-            ],
-            "time": "2018-10-30T05:52:18+00:00"
-        },
-        {
-            "name": "phpunit/phpunit",
-            "version": "7.5.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/phpunit.git",
-                "reference": "c23d78776ad415d5506e0679723cb461d71f488f"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/phpunit/zipball/c23d78776ad415d5506e0679723cb461d71f488f",
-                "reference": "c23d78776ad415d5506e0679723cb461d71f488f",
-                "shasum": ""
-            },
-            "require": {
-                "doctrine/instantiator": "^1.1",
-                "ext-dom": "*",
-                "ext-json": "*",
-                "ext-libxml": "*",
-                "ext-mbstring": "*",
-                "ext-xml": "*",
-                "myclabs/deep-copy": "^1.7",
-                "phar-io/manifest": "^1.0.2",
-                "phar-io/version": "^2.0",
-                "php": "^7.1",
-                "phpspec/prophecy": "^1.7",
-                "phpunit/php-code-coverage": "^6.0.7",
-                "phpunit/php-file-iterator": "^2.0.1",
-                "phpunit/php-text-template": "^1.2.1",
-                "phpunit/php-timer": "^2.0",
-                "sebastian/comparator": "^3.0",
-                "sebastian/diff": "^3.0",
-                "sebastian/environment": "^4.0",
-                "sebastian/exporter": "^3.1",
-                "sebastian/global-state": "^2.0",
-                "sebastian/object-enumerator": "^3.0.3",
-                "sebastian/resource-operations": "^2.0",
-                "sebastian/version": "^2.0.1"
-            },
-            "conflict": {
-                "phpunit/phpunit-mock-objects": "*"
-            },
-            "require-dev": {
-                "ext-pdo": "*"
-            },
-            "suggest": {
-                "ext-soap": "*",
-                "ext-xdebug": "*",
-                "phpunit/php-invoker": "^2.0"
-            },
-            "bin": [
-                "phpunit"
-            ],
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "7.5-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "lead"
-                }
-            ],
-            "description": "The PHP Unit Testing framework.",
-            "homepage": "https://phpunit.de/",
-            "keywords": [
-                "phpunit",
-                "testing",
-                "xunit"
-            ],
-            "time": "2018-12-12T07:20:32+00:00"
-        },
-        {
-            "name": "sebastian/code-unit-reverse-lookup",
-            "version": "1.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/code-unit-reverse-lookup.git",
-                "reference": "4419fcdb5eabb9caa61a27c7a1db532a6b55dd18"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/code-unit-reverse-lookup/zipball/4419fcdb5eabb9caa61a27c7a1db532a6b55dd18",
-                "reference": "4419fcdb5eabb9caa61a27c7a1db532a6b55dd18",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^5.6 || ^7.0"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^5.7 || ^6.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.0.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Looks up which function or method a line of code belongs to",
-            "homepage": "https://github.com/sebastianbergmann/code-unit-reverse-lookup/",
-            "time": "2017-03-04T06:30:41+00:00"
-        },
-        {
-            "name": "sebastian/comparator",
-            "version": "3.0.2",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/comparator.git",
-                "reference": "5de4fc177adf9bce8df98d8d141a7559d7ccf6da"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/comparator/zipball/5de4fc177adf9bce8df98d8d141a7559d7ccf6da",
-                "reference": "5de4fc177adf9bce8df98d8d141a7559d7ccf6da",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1",
-                "sebastian/diff": "^3.0",
-                "sebastian/exporter": "^3.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.1"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "3.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Jeff Welch",
-                    "email": "whatthejeff@gmail.com"
-                },
-                {
-                    "name": "Volker Dusch",
-                    "email": "github@wallbash.com"
-                },
-                {
-                    "name": "Bernhard Schussek",
-                    "email": "bschussek@2bepublished.at"
-                },
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Provides the functionality to compare PHP values for equality",
-            "homepage": "https://github.com/sebastianbergmann/comparator",
-            "keywords": [
-                "comparator",
-                "compare",
-                "equality"
-            ],
-            "time": "2018-07-12T15:12:46+00:00"
-        },
-        {
-            "name": "sebastian/diff",
-            "version": "3.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/diff.git",
-                "reference": "366541b989927187c4ca70490a35615d3fef2dce"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/diff/zipball/366541b989927187c4ca70490a35615d3fef2dce",
-                "reference": "366541b989927187c4ca70490a35615d3fef2dce",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.0",
-                "symfony/process": "^2 || ^3.3 || ^4"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "3.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Kore Nordmann",
-                    "email": "mail@kore-nordmann.de"
-                },
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Diff implementation",
-            "homepage": "https://github.com/sebastianbergmann/diff",
-            "keywords": [
-                "diff",
-                "udiff",
-                "unidiff",
-                "unified diff"
-            ],
-            "time": "2018-06-10T07:54:39+00:00"
-        },
-        {
-            "name": "sebastian/environment",
-            "version": "4.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/environment.git",
-                "reference": "febd209a219cea7b56ad799b30ebbea34b71eb8f"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/environment/zipball/febd209a219cea7b56ad799b30ebbea34b71eb8f",
-                "reference": "febd209a219cea7b56ad799b30ebbea34b71eb8f",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^7.4"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "4.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Provides functionality to handle HHVM/PHP environments",
-            "homepage": "http://www.github.com/sebastianbergmann/environment",
-            "keywords": [
-                "Xdebug",
-                "environment",
-                "hhvm"
-            ],
-            "time": "2018-11-25T09:31:21+00:00"
-        },
-        {
-            "name": "sebastian/exporter",
-            "version": "3.1.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/exporter.git",
-                "reference": "234199f4528de6d12aaa58b612e98f7d36adb937"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/exporter/zipball/234199f4528de6d12aaa58b612e98f7d36adb937",
-                "reference": "234199f4528de6d12aaa58b612e98f7d36adb937",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.0",
-                "sebastian/recursion-context": "^3.0"
-            },
-            "require-dev": {
-                "ext-mbstring": "*",
-                "phpunit/phpunit": "^6.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "3.1.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Jeff Welch",
-                    "email": "whatthejeff@gmail.com"
-                },
-                {
-                    "name": "Volker Dusch",
-                    "email": "github@wallbash.com"
-                },
-                {
-                    "name": "Bernhard Schussek",
-                    "email": "bschussek@2bepublished.at"
-                },
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                },
-                {
-                    "name": "Adam Harvey",
-                    "email": "aharvey@php.net"
-                }
-            ],
-            "description": "Provides the functionality to export PHP variables for visualization",
-            "homepage": "http://www.github.com/sebastianbergmann/exporter",
-            "keywords": [
-                "export",
-                "exporter"
-            ],
-            "time": "2017-04-03T13:19:02+00:00"
-        },
-        {
-            "name": "sebastian/global-state",
-            "version": "2.0.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/global-state.git",
-                "reference": "e8ba02eed7bbbb9e59e43dedd3dddeff4a56b0c4"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/global-state/zipball/e8ba02eed7bbbb9e59e43dedd3dddeff4a56b0c4",
-                "reference": "e8ba02eed7bbbb9e59e43dedd3dddeff4a56b0c4",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.0"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^6.0"
-            },
-            "suggest": {
-                "ext-uopz": "*"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "2.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Snapshotting of global state",
-            "homepage": "http://www.github.com/sebastianbergmann/global-state",
-            "keywords": [
-                "global state"
-            ],
-            "time": "2017-04-27T15:39:26+00:00"
-        },
-        {
-            "name": "sebastian/object-enumerator",
-            "version": "3.0.3",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/object-enumerator.git",
-                "reference": "7cfd9e65d11ffb5af41198476395774d4c8a84c5"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/object-enumerator/zipball/7cfd9e65d11ffb5af41198476395774d4c8a84c5",
-                "reference": "7cfd9e65d11ffb5af41198476395774d4c8a84c5",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.0",
-                "sebastian/object-reflector": "^1.1.1",
-                "sebastian/recursion-context": "^3.0"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^6.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "3.0.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Traverses array structures and object graphs to enumerate all referenced objects",
-            "homepage": "https://github.com/sebastianbergmann/object-enumerator/",
-            "time": "2017-08-03T12:35:26+00:00"
-        },
-        {
-            "name": "sebastian/object-reflector",
-            "version": "1.1.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/object-reflector.git",
-                "reference": "773f97c67f28de00d397be301821b06708fca0be"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/object-reflector/zipball/773f97c67f28de00d397be301821b06708fca0be",
-                "reference": "773f97c67f28de00d397be301821b06708fca0be",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.0"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^6.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.1-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Allows reflection of object attributes, including inherited and non-public ones",
-            "homepage": "https://github.com/sebastianbergmann/object-reflector/",
-            "time": "2017-03-29T09:07:27+00:00"
-        },
-        {
-            "name": "sebastian/recursion-context",
-            "version": "3.0.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/recursion-context.git",
-                "reference": "5b0cd723502bac3b006cbf3dbf7a1e3fcefe4fa8"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/recursion-context/zipball/5b0cd723502bac3b006cbf3dbf7a1e3fcefe4fa8",
-                "reference": "5b0cd723502bac3b006cbf3dbf7a1e3fcefe4fa8",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.0"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^6.0"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "3.0.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Jeff Welch",
-                    "email": "whatthejeff@gmail.com"
-                },
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                },
-                {
-                    "name": "Adam Harvey",
-                    "email": "aharvey@php.net"
-                }
-            ],
-            "description": "Provides functionality to recursively process PHP variables",
-            "homepage": "http://www.github.com/sebastianbergmann/recursion-context",
-            "time": "2017-03-03T06:23:57+00:00"
-        },
-        {
-            "name": "sebastian/resource-operations",
-            "version": "2.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/resource-operations.git",
-                "reference": "4d7a795d35b889bf80a0cc04e08d77cedfa917a9"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/resource-operations/zipball/4d7a795d35b889bf80a0cc04e08d77cedfa917a9",
-                "reference": "4d7a795d35b889bf80a0cc04e08d77cedfa917a9",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^7.1"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "2.0-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de"
-                }
-            ],
-            "description": "Provides a list of PHP built-in functions that operate on resources",
-            "homepage": "https://www.github.com/sebastianbergmann/resource-operations",
-            "time": "2018-10-04T04:07:39+00:00"
-        },
-        {
-            "name": "sebastian/version",
-            "version": "2.0.1",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/sebastianbergmann/version.git",
-                "reference": "99732be0ddb3361e16ad77b68ba41efc8e979019"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/sebastianbergmann/version/zipball/99732be0ddb3361e16ad77b68ba41efc8e979019",
-                "reference": "99732be0ddb3361e16ad77b68ba41efc8e979019",
-                "shasum": ""
-            },
-            "require": {
-                "php": ">=5.6"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "2.0.x-dev"
-                }
-            },
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Sebastian Bergmann",
-                    "email": "sebastian@phpunit.de",
-                    "role": "lead"
-                }
-            ],
-            "description": "Library that helps with managing the version number of Git-hosted PHP projects",
-            "homepage": "https://github.com/sebastianbergmann/version",
-            "time": "2016-10-03T07:35:21+00:00"
-        },
-        {
-            "name": "symfony/polyfill-ctype",
-            "version": "v1.10.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/symfony/polyfill-ctype.git",
-                "reference": "e3d826245268269cd66f8326bd8bc066687b4a19"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/symfony/polyfill-ctype/zipball/e3d826245268269cd66f8326bd8bc066687b4a19",
-                "reference": "e3d826245268269cd66f8326bd8bc066687b4a19",
-                "shasum": ""
-            },
-            "require": {
-                "php": ">=5.3.3"
-            },
-            "suggest": {
-                "ext-ctype": "For best performance"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.9-dev"
-                }
-            },
-            "autoload": {
-                "psr-4": {
-                    "Symfony\\Polyfill\\Ctype\\": ""
-                },
-                "files": [
-                    "bootstrap.php"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Symfony Community",
-                    "homepage": "https://symfony.com/contributors"
-                },
-                {
-                    "name": "Gert de Pagter",
-                    "email": "BackEndTea@gmail.com"
-                }
-            ],
-            "description": "Symfony polyfill for ctype functions",
-            "homepage": "https://symfony.com",
-            "keywords": [
-                "compatibility",
-                "ctype",
-                "polyfill",
-                "portable"
-            ],
-            "time": "2018-08-06T14:22:27+00:00"
-        },
-        {
-            "name": "theseer/tokenizer",
-            "version": "1.1.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/theseer/tokenizer.git",
-                "reference": "cb2f008f3f05af2893a87208fe6a6c4985483f8b"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/theseer/tokenizer/zipball/cb2f008f3f05af2893a87208fe6a6c4985483f8b",
-                "reference": "cb2f008f3f05af2893a87208fe6a6c4985483f8b",
-                "shasum": ""
-            },
-            "require": {
-                "ext-dom": "*",
-                "ext-tokenizer": "*",
-                "ext-xmlwriter": "*",
-                "php": "^7.0"
-            },
-            "type": "library",
-            "autoload": {
-                "classmap": [
-                    "src/"
-                ]
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "BSD-3-Clause"
-            ],
-            "authors": [
-                {
-                    "name": "Arne Blankerts",
-                    "email": "arne@blankerts.de",
-                    "role": "Developer"
-                }
-            ],
-            "description": "A small library for converting tokenized PHP source code into XML and potentially other formats",
-            "time": "2017-04-07T12:08:54+00:00"
-        },
-        {
-            "name": "webmozart/assert",
-            "version": "1.4.0",
-            "source": {
-                "type": "git",
-                "url": "https://github.com/webmozart/assert.git",
-                "reference": "83e253c8e0be5b0257b881e1827274667c5c17a9"
-            },
-            "dist": {
-                "type": "zip",
-                "url": "https://api.github.com/repos/webmozart/assert/zipball/83e253c8e0be5b0257b881e1827274667c5c17a9",
-                "reference": "83e253c8e0be5b0257b881e1827274667c5c17a9",
-                "shasum": ""
-            },
-            "require": {
-                "php": "^5.3.3 || ^7.0",
-                "symfony/polyfill-ctype": "^1.8"
-            },
-            "require-dev": {
-                "phpunit/phpunit": "^4.6",
-                "sebastian/version": "^1.0.1"
-            },
-            "type": "library",
-            "extra": {
-                "branch-alias": {
-                    "dev-master": "1.3-dev"
-                }
-            },
-            "autoload": {
-                "psr-4": {
-                    "Webmozart\\Assert\\": "src/"
-                }
-            },
-            "notification-url": "https://packagist.org/downloads/",
-            "license": [
-                "MIT"
-            ],
-            "authors": [
-                {
-                    "name": "Bernhard Schussek",
-                    "email": "bschussek@gmail.com"
-                }
-            ],
-            "description": "Assertions to validate method input/output with nice error messages.",
-            "keywords": [
-                "assert",
-                "check",
-                "validate"
-            ],
-            "time": "2018-12-25T11:19:39+00:00"
-        }
-    ],
-    "aliases": [],
-    "minimum-stability": "stable",
-    "stability-flags": [],
-    "prefer-stable": false,
-    "prefer-lowest": false,
-    "platform": {
-        "php": ">=5.6.4"
-    },
-    "platform-dev": []
-}
diff --git a/db_update.php b/db_update.php
index 2f29075d..6cefcbaf 100644
--- a/db_update.php
+++ b/db_update.php
@@ -9,12 +9,12 @@
 // The FluxBB version this script updates to
 define('UPDATE_TO', '1.5.11');
 
-define('UPDATE_TO_DB_REVISION', 24);
+define('UPDATE_TO_DB_REVISION', 21);
 define('UPDATE_TO_SI_REVISION', 2);
 define('UPDATE_TO_PARSER_REVISION', 2);
 
-define('MIN_PHP_VERSION', '5.6.4');
-define('MIN_MYSQL_VERSION', '5.0.6');
+define('MIN_PHP_VERSION', '4.4.0');
+define('MIN_MYSQL_VERSION', '4.1.2');
 define('MIN_PGSQL_VERSION', '7.0.0');
 define('PUN_SEARCH_MIN_WORD', 3);
 define('PUN_SEARCH_MAX_WORD', 20);
@@ -64,12 +64,33 @@ require PUN_ROOT.'include/utf8/utf8.php';
 // Strip out "bad" UTF-8 characters
 forum_remove_bad_characters();
 
+// Reverse the effect of register_globals
+forum_unregister_globals();
+
 // Turn on full PHP error reporting
 error_reporting(E_ALL);
 
 // Force POSIX locale (to prevent functions such as strtolower() from messing up UTF-8 strings)
 setlocale(LC_CTYPE, 'C');
 
+// Turn off magic_quotes_runtime
+if (get_magic_quotes_runtime())
+	set_magic_quotes_runtime(0);
+
+// Strip slashes from GET/POST/COOKIE (if magic_quotes_gpc is enabled)
+if (get_magic_quotes_gpc())
+{
+	function stripslashes_array($array)
+	{
+		return is_array($array) ? array_map('stripslashes_array', $array) : stripslashes($array);
+	}
+
+	$_GET = stripslashes_array($_GET);
+	$_POST = stripslashes_array($_POST);
+	$_COOKIE = stripslashes_array($_COOKIE);
+	$_REQUEST = stripslashes_array($_REQUEST);
+}
+
 // If a cookie name is not specified in config.php, we use the default (forum_cookie)
 if (empty($cookie_name))
 	$cookie_name = 'pun_cookie';
@@ -97,7 +118,7 @@ $db->start_transaction();
 $old_connection_charset = defined('FORUM_DEFAULT_CHARSET') ? FORUM_DEFAULT_CHARSET : $db->get_names();
 
 // Set the connection to UTF-8 now
-$db->set_names('utf8');
+$db->set_names('utf8mb4');
 
 // Get the forum config
 $result = $db->query('SELECT * FROM '.$db->prefix.'config') or error('Unable to fetch config.', __FILE__, __LINE__, $db->error());
@@ -119,9 +140,6 @@ $cur_version = $pun_config['o_cur_version'];
 if (version_compare($cur_version, '1.2', '<'))
 	error(sprintf($lang_update['Version mismatch error'], $db_name));
 
-if (!isset($password_hash_cost))
-	error(sprintf($lang_update['Password cost missing error']));
-
 // Do some DB type specific checks
 $mysql = false;
 switch ($db_type)
@@ -243,6 +261,10 @@ function convert_to_utf8(&$str, $old_charset)
 
 	$save = $str;
 
+	// Replace literal entities (for non-UTF-8 compliant html_entity_encode)
+	if (version_compare(PHP_VERSION, '5.0.0', '<') && $old_charset == 'ISO-8859-1' || $old_charset == 'ISO-8859-15')
+		$str = html_entity_decode($str, ENT_QUOTES, $old_charset);
+
 	if ($old_charset != 'UTF-8' && !seems_utf8($str))
 	{
 		if (function_exists('iconv'))
@@ -253,8 +275,9 @@ function convert_to_utf8(&$str, $old_charset)
 			$str = utf8_encode($str);
 	}
 
-	// Replace literal entities
-	$str = html_entity_decode($str, ENT_QUOTES, 'UTF-8');
+	// Replace literal entities (for UTF-8 compliant html_entity_encode)
+	if (version_compare(PHP_VERSION, '5.0.0', '>='))
+		$str = html_entity_decode($str, ENT_QUOTES, 'UTF-8');
 
 	// Replace numeric entities
 	$str = preg_replace_callback('%&#([0-9]+);%', 'utf8_callback_1', $str);
@@ -376,7 +399,7 @@ function convert_table_utf8($table, $callback, $old_charset, $key = null, $start
 		if (!is_null($start_at) && $end_at > 0)
 		{
 			$result = $db->query('SELECT 1 FROM '.$table.' WHERE '.$key.'>'.$end_at.' ORDER BY '.$key.' ASC LIMIT 1') or error('Unable to check for next row', __FILE__, __LINE__, $db->error());
-			$finished = !$db->has_rows($result);
+			$finished = $db->num_rows($result) == 0;
 		}
 
 		// Only swap the tables if we are doing this in 1 go, or it's the last go
@@ -414,7 +437,7 @@ function convert_table_utf8($table, $callback, $old_charset, $key = null, $start
 		if (!is_null($start_at) && $end_at > 0)
 		{
 			$result = $db->query('SELECT 1 FROM '.$table.' WHERE '.$key.'>'.$end_at.' ORDER BY '.$key.' ASC LIMIT 1') or error('Unable to check for next row', __FILE__, __LINE__, $db->error());
-			if (!$db->has_rows($result))
+			if ($db->num_rows($result) == 0)
 				return true;
 
 			return $end_at;
@@ -556,7 +579,7 @@ if (empty($stage))
 					<legend><?php echo $lang_update['Charset conversion'] ?></legend>
 					<div class="infldset">
 						<div class="rbox">
-							<label><input type="checkbox" name="convert_charset" value="1" checked="checked" /><?php echo $lang_update['Enable conversion label'] ?><br /></label>
+							<label><input type="checkbox" name="convert_charset" value="1" checked /><?php echo $lang_update['Enable conversion label'] ?><br /></label>
 						</div>
 						<label>
 							<strong><?php echo $lang_update['Current character set label'] ?></strong><br /><?php echo $lang_update['Current character set info'] ?><br />
@@ -707,9 +730,6 @@ switch ($stage)
 		// Drop save_pass column from users table
 		$db->drop_field('users', 'save_pass') or error('Unable to drop save_pass field', __FILE__, __LINE__, $db->error());
 
-		// Drop AOL IM column from users table
-		$db->drop_field('users', 'aim') or error('Unable to drop aim field', __FILE__, __LINE__, $db->error());
-
 		// Drop g_edit_subjects_interval column from groups table
 		$db->drop_field('groups', 'g_edit_subjects_interval');
 
@@ -799,7 +819,7 @@ switch ($stage)
 			$temp_id = $db->result($result);
 
 			$result = $db->query('SELECT g_id FROM '.$db->prefix.'groups WHERE g_moderator = 1 AND g_id > 1 LIMIT 1') or error('Unable to select moderator group', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 				$mod_gid = $db->result($result);
 			else
 			{
@@ -1527,7 +1547,7 @@ switch ($stage)
 
 				$result = $db->query('SELECT username FROM '.$db->prefix.'users WHERE (UPPER(username)=UPPER(\''.$db->escape($username).'\') OR UPPER(username)=UPPER(\''.$db->escape(ucp_preg_replace('%[^\p{L}\p{N}]%u', '', $username)).'\')) AND id>1') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
 
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 				{
 					$busy = $db->result($result);
 					$errors[$id][] = sprintf($lang_update['Username duplicate error'], pun_htmlspecialchars($busy));
@@ -1709,7 +1729,7 @@ foreach ($errors[$id] as $cur_error)
 		{
 			$result = $db->query('SELECT 1 FROM '.$db->prefix.'posts WHERE id > '.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to fetch next ID', __FILE__, __LINE__, $db->error());
 
-			if ($db->has_rows($result))
+			if ($db->num_rows($result) > 0)
 				$query_str = '?stage=preparse_posts&start_at='.$end_at;
 		}
 
@@ -1718,7 +1738,7 @@ foreach ($errors[$id] as $cur_error)
 
 	// Preparse signatures
 	case 'preparse_sigs':
-		$query_str = '?stage=harden_passwords';
+		$query_str = '?stage=rebuild_idx';
 
 		// If we don't need to parse the sigs, skip this stage
 		if (isset($pun_config['o_parser_revision']) && $pun_config['o_parser_revision'] >= UPDATE_TO_PARSER_REVISION)
@@ -1743,58 +1763,13 @@ foreach ($errors[$id] as $cur_error)
 		if ($end_at > 0)
 		{
 			$result = $db->query('SELECT 1 FROM '.$db->prefix.'users WHERE id > '.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to fetch next ID', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
+			if ($db->num_rows($result) > 0)
 				$query_str = '?stage=preparse_sigs&start_at='.$end_at;
 		}
 
 		break;
 
 
-	// Convert legacy passwords
-	case 'harden_passwords':
-		$query_str = '?stage=rebuild_idx';
-
-		// Make password field VARCHAR(255) to support password_hash
-		// 255 is recommended by the PHP manual: http://php.net/manual/en/function.password-hash.php
-		if ($start_at == 0)
-			$db->alter_field('users', 'password', 'VARCHAR(255)', false) or error('Unable to alter password field', __FILE__, __LINE__, $db->error());
-
-		// Fetch passwords in batches
-		$result = $db->query('SELECT * FROM '.$db->prefix.'users WHERE id>'.$start_at.' ORDER BY id ASC LIMIT '.PER_PAGE, false) or error('Unable to fetch user password hashes', __FILE__, __LINE__, $db->error());
-
-		while ($cur_user = $db->fetch_assoc($result))
-		{
-			$old_password = $cur_user['password'];
-			$remove_salt = !empty($cur_user['salt']);
-
-			if (strlen($old_password) == 32) // MD5 from 1.2
-				$new_password_hash = '#MD5#'.flux_password_hash($old_password);
-			else if ($remove_salt) // Salted SHA1 from 1.3
-				$new_password_hash = '#SHA1-S#'.$cur_user['salt'].'#'.flux_password_hash($old_password);
-			else if (strlen($old_password) == 40) // Unsalted SHA1 from 1.4
-				$new_password_hash = '#SHA1#'.flux_password_hash($old_password);
-			else
-				$new_password_hash = $old_password;
-
-			$db->query('UPDATE '.$db->prefix.'users SET '.($remove_salt ? 'salt=NULL,' : '').' password=\''.$db->escape($new_password_hash).'\' WHERE id='.$cur_user['id']) or error('Unable to save updated password', __FILE__, __LINE__, $db->error());
-
-			$end_at = $cur_user['id'];
-		}
-
-		if ($end_at > 0)
-		{
-			$result = $db->query('SELECT 1 FROM '.$db->prefix.'users WHERE id>'.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to check for next row', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
-				$query_str = '?stage=harden_passwords&start_at='.$end_at;
-			else
-				$db->drop_field('users', 'salt');
-		}
-		else
-			$db->drop_field('users', 'salt');
-
-		break;
-
-
 	// Rebuild the search index
 	case 'rebuild_idx':
 		$query_str = '?stage=finish';
@@ -1849,7 +1824,7 @@ foreach ($errors[$id] as $cur_error)
 		{
 			$result = $db->query('SELECT 1 FROM '.$db->prefix.'posts WHERE id > '.$end_at.' ORDER BY id ASC LIMIT 1') or error('Unable to fetch next ID', __FILE__, __LINE__, $db->error());
 
-			if ($db->has_rows($result))
+			if ($db->num_rows($result) > 0)
 				$query_str = '?stage=rebuild_idx&start_at='.$end_at;
 		}
 
diff --git a/delete.php b/delete.php
index 760dd1eb..e253bb40 100644
--- a/delete.php
+++ b/delete.php
@@ -20,7 +20,7 @@ if ($id < 1)
 
 // Fetch some info about the post, the topic and the forum
 $result = $db->query('SELECT f.id AS fid, f.forum_name, f.moderators, f.redirect_url, fp.post_replies, fp.post_topics, t.id AS tid, t.subject, t.first_post_id, t.closed, p.posted, p.poster, p.poster_id, p.message, p.hide_smilies FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.id='.$id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-if (!$db->has_rows($result))
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $cur_post = $db->fetch_assoc($result);
@@ -78,12 +78,6 @@ if (isset($_POST['delete']))
 	}
 }
 
-$crumbs = generate_crumbs(array(
-	array($lang_common['Index'], 'index.php'),
-	array($cur_post['forum_name'], 'viewforum.php?id='.$cur_post['fid']),
-	array($cur_post['subject'], 'viewtopic.php?pid='.$id.'#p'.$id),
-	$lang_delete['Delete post'],
-));
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_delete['Delete post']);
 define ('PUN_ACTIVE_PAGE', 'index');
@@ -95,7 +89,12 @@ $cur_post['message'] = parse_message($cur_post['message'], $cur_post['hide_smili
 ?>
 <div class="linkst">
 	<div class="inbox">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $cur_post['fid'] ?>"><?php echo pun_htmlspecialchars($cur_post['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><a href="viewtopic.php?pid=<?php echo $id ?>#p<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_post['subject']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_delete['Delete post'] ?></strong></li>
+		</ul>
 	</div>
 </div>
 
diff --git a/edit.php b/edit.php
index c087a73e..9d44fc1d 100644
--- a/edit.php
+++ b/edit.php
@@ -20,7 +20,7 @@ if ($id < 1)
 
 // Fetch some info about the post, the topic and the forum
 $result = $db->query('SELECT f.id AS fid, f.forum_name, f.moderators, f.redirect_url, fp.post_replies, fp.post_topics, t.id AS tid, t.subject, t.posted, t.first_post_id, t.sticky, t.closed, p.poster, p.poster_id, p.message, p.hide_smilies FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.id='.$id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-if (!$db->has_rows($result))
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $cur_post = $db->fetch_assoc($result);
@@ -115,7 +115,7 @@ if (isset($_POST['form_sent']))
 		$stick_topic = $cur_post['sticky'];
 
 	// Replace four-byte characters (MySQL cannot handle them)
-	$message = strip_bad_multibyte_chars($message);
+	//$message = strip_bad_multibyte_chars($message);
 
 	// Did everything go according to plan?
 	if (empty($errors) && !isset($_POST['preview']))
@@ -142,12 +142,7 @@ if (isset($_POST['form_sent']))
 	}
 }
 
-$crumbs = generate_crumbs(array(
-	array($lang_common['Index'], 'index.php'),
-	array($cur_post['forum_name'], 'viewforum.php?id='.$cur_post['fid']),
-	array($cur_post['subject'], 'viewtopic.php?id='.$cur_post['tid']),
-	$lang_post['Edit post'],
-));
+
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_post['Edit post']);
 $required_fields = array('req_subject' => $lang_common['Subject'], 'req_message' => $lang_common['Message']);
@@ -160,7 +155,12 @@ $cur_index = 1;
 ?>
 <div class="linkst">
 	<div class="inbox">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $cur_post['fid'] ?>"><?php echo pun_htmlspecialchars($cur_post['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><a href="viewtopic.php?id=<?php echo $cur_post['tid'] ?>"><?php echo pun_htmlspecialchars($cur_post['subject']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_post['Edit post'] ?></strong></li>
+		</ul>
 	</div>
 </div>
 
@@ -197,10 +197,12 @@ else if (isset($_POST['preview']))
 
 ?>
 <div id="postpreview" class="blockpost">
-	<h2><span><?php echo $lang_post['Post preview'] ?></span></h2>
 	<div class="box">
 		<div class="inbox">
 			<div class="postbody">
+				<div class="postleft">
+                    <h2><span><?php echo $lang_post['Post preview'] ?></span></h2>
+				</div>
 				<div class="postright">
 					<div class="postmsg">
 						<?php echo $preview_message."\n" ?>
@@ -226,9 +228,9 @@ else if (isset($_POST['preview']))
 					<input type="hidden" name="form_sent" value="1" />
 					<div class="infldset txtarea">
 <?php if ($can_edit_subject): ?>						<label class="required"><strong><?php echo $lang_common['Subject'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input class="longinput" type="text" name="req_subject" size="80" maxlength="70" tabindex="<?php echo $cur_index++ ?>" value="<?php echo pun_htmlspecialchars(isset($_POST['req_subject']) ? $_POST['req_subject'] : $cur_post['subject']) ?>" /><br /></label>
+						<input class="longinput" type="text" name="req_subject" size="80" maxlength="70" value="<?php echo pun_htmlspecialchars(isset($_POST['req_subject']) ? $_POST['req_subject'] : $cur_post['subject']) ?>" required autofocus /><br /></label>
 <?php endif; ?>						<label class="required"><strong><?php echo $lang_common['Message'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<textarea name="req_message" rows="20" cols="95" tabindex="<?php echo $cur_index++ ?>"><?php echo pun_htmlspecialchars(isset($_POST['req_message']) ? $message : $cur_post['message']) ?></textarea><br /></label>
+						<textarea name="req_message" rows="20" cols="95" required<?php if (!$can_edit_subject): ?> autofocus<?php endif; ?>><?php echo pun_htmlspecialchars(isset($_POST['req_message']) ? $message : $cur_post['message']) ?></textarea><br /></label>
 						<ul class="bblinks">
 							<li><span><a href="help.php#bbcode" onclick="window.open(this.href); return false;"><?php echo $lang_common['BBCode'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>
 							<li><span><a href="help.php#url" onclick="window.open(this.href); return false;"><?php echo $lang_common['url tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_user['g_post_links'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>
@@ -243,25 +245,25 @@ $checkboxes = array();
 if ($can_edit_subject && $is_admmod)
 {
 	if (isset($_POST['stick_topic']) || !isset($_POST['form_sent']) && $cur_post['sticky'] == '1')
-		$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" checked="checked" tabindex="'.($cur_index++).'" />'.$lang_common['Stick topic'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" checked />'.$lang_common['Stick topic'].'<br /></label>';
 	else
-		$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" tabindex="'.($cur_index++).'" />'.$lang_common['Stick topic'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" />'.$lang_common['Stick topic'].'<br /></label>';
 }
 
 if ($pun_config['o_smilies'] == '1')
 {
 	if (isset($_POST['hide_smilies']) || !isset($_POST['form_sent']) && $cur_post['hide_smilies'] == '1')
-		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" checked="checked" tabindex="'.($cur_index++).'" />'.$lang_post['Hide smilies'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" checked />'.$lang_post['Hide smilies'].'<br /></label>';
 	else
-		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" tabindex="'.($cur_index++).'" />'.$lang_post['Hide smilies'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" />'.$lang_post['Hide smilies'].'<br /></label>';
 }
 
 if ($is_admmod)
 {
 	if (isset($_POST['silent']) || !isset($_POST['form_sent']))
-		$checkboxes[] = '<label><input type="checkbox" name="silent" value="1" tabindex="'.($cur_index++).'" checked="checked" />'.$lang_post['Silent edit'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="silent" value="1" checked />'.$lang_post['Silent edit'].'<br /></label>';
 	else
-		$checkboxes[] = '<label><input type="checkbox" name="silent" value="1" tabindex="'.($cur_index++).'" />'.$lang_post['Silent edit'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="silent" value="1" />'.$lang_post['Silent edit'].'<br /></label>';
 }
 
 if (!empty($checkboxes))
@@ -284,7 +286,7 @@ if (!empty($checkboxes))
 
 ?>
 			</div>
-			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_post['Preview'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="p" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
+			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_post['Preview'] ?>" accesskey="p" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
 		</form>
 	</div>
 </div>
diff --git a/extern.php b/extern.php
index 6a372bfd..cfba2187 100644
--- a/extern.php
+++ b/extern.php
@@ -242,7 +242,8 @@ function output_xml($feed)
 			echo "\t\t\t".'<uri>'.pun_htmlspecialchars($item['author']['uri']).'</uri>'."\n";
 
 		echo "\t\t".'</author>'."\n";
-		echo "\t\t".'<posted>'.gmdate('r', $item['pubdate']).'</posted>'."\n";
+		echo "\t\t".'<posted>'.gmdate('d F Y H:i', $item['pubdate']).'</posted>'."\n";
+		echo "\t\t".'<postedutc>'.gmdate('Y-m-d\TH:i:s\Z', $item['pubdate']).'</postedutc>'."\n";
 
 		echo "\t".'</'.$forum_tag.'>'."\n";
 	}
@@ -295,7 +296,7 @@ if ($action == 'feed')
 
 		// Fetch topic subject
 		$result = $db->query('SELECT t.subject, t.first_post_id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.moved_to IS NULL AND t.id='.$tid) or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
+		if (!$db->num_rows($result))
 		{
 			http_authenticate_user();
 			exit($lang_common['Bad request']);
@@ -367,7 +368,7 @@ if ($action == 'feed')
 			{
 				// Fetch forum name
 				$result = $db->query('SELECT f.forum_name FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$fids[0]) or error('Unable to fetch forum name', __FILE__, __LINE__, $db->error());
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 					$forum_name = $lang_common['Title separator'].$db->result($result);
 			}
 		}
diff --git a/footer.php b/footer.php
index f10b24b2..ad666cfe 100644
--- a/footer.php
+++ b/footer.php
@@ -25,10 +25,7 @@ ob_start();
 	<div class="box">
 <?php
 
-// If no footer style has been specified, we use the default (only copyright/debug info)
-$footer_style = isset($footer_style) ? $footer_style : null;
-
-if (($footer_style == 'viewforum' || $footer_style == 'viewtopic') && $is_admmod)
+if (isset($footer_style) && ($footer_style == 'viewforum' || $footer_style == 'viewtopic') && $is_admmod)
 {
 	echo "\t\t".'<div id="modcontrols" class="inbox">'."\n";
 
@@ -93,6 +90,9 @@ echo "\t\t\t".'</div>'."\n";
 			<div class="conr">
 <?php
 
+// If no footer style has been specified, we use the default (only copyright/debug info)
+$footer_style = isset($footer_style) ? $footer_style : NULL;
+
 if ($footer_style == 'index')
 {
 	if ($pun_config['o_feed_type'] == '1')
@@ -116,7 +116,7 @@ else if ($footer_style == 'viewtopic')
 }
 
 ?>
-				<p id="poweredby"><?php printf($lang_common['Powered by'], '<a href="https://fluxbb.org/">FluxBB</a>'.(($pun_config['o_show_version'] == '1') ? ' '.$pun_config['o_cur_version'] : '')) ?></p>
+				<p id="poweredby"><?php printf($lang_common['Powered by'], '<a href="http://fluxbb.org/">FluxBB</a>'.(($pun_config['o_show_version'] == '1') ? ' '.$pun_config['o_cur_version'] : '')) ?></p>
 			</div>
 			<div class="clearer"></div>
 		</div>
@@ -130,7 +130,7 @@ if (defined('PUN_DEBUG'))
 	echo '<p id="debugtime">[ ';
 
 	// Calculate script generation time
-	$time_diff = sprintf('%.3f', microtime(true) - $_SERVER['REQUEST_TIME_FLOAT']);
+	$time_diff = sprintf('%.3f', get_microtime() - $pun_start);
 	echo sprintf($lang_common['Querytime'], $time_diff, $db->get_num_queries());
 
 	if (function_exists('memory_get_usage'))
diff --git a/help.php b/help.php
index e12e1a8e..7ab702cd 100644
--- a/help.php
+++ b/help.php
@@ -37,52 +37,52 @@ require PUN_ROOT.'header.php';
 <div class="box">
 	<div class="inbox">
 		<p><?php echo $lang_help['Text style info'] ?></p>
-		<p><code class="code">[b]<?php echo $lang_help['Bold text'] ?>[/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><?php echo $lang_help['Bold text'] ?></strong></samp></p>
-		<p><code class="code">[u]<?php echo $lang_help['Underlined text'] ?>[/u]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbu"><?php echo $lang_help['Underlined text'] ?></span></samp></p>
-		<p><code class="code">[i]<?php echo $lang_help['Italic text'] ?>[/i]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Italic text'] ?></em></samp></p>
-		<p><code class="code">[s]<?php echo $lang_help['Strike-through text'] ?>[/s]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbs"><?php echo $lang_help['Strike-through text'] ?></span></samp></p>
-		<p><code class="code">[del]<?php echo $lang_help['Deleted text'] ?>[/del]</code> <?php echo $lang_help['produces'] ?> <samp><del><?php echo $lang_help['Deleted text'] ?></del></samp></p>
-		<p><code class="code">[ins]<?php echo $lang_help['Inserted text'] ?>[/ins]</code> <?php echo $lang_help['produces'] ?> <samp><ins><?php echo $lang_help['Inserted text'] ?></ins></samp></p>
-		<p><code class="code">[em]<?php echo $lang_help['Emphasised text'] ?>[/em]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Emphasised text'] ?></em></samp></p>
-		<p><code class="code">[color=#FF0000]<?php echo $lang_help['Red text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: #ff0000"><?php echo $lang_help['Red text'] ?></span></samp></p>
-		<p><code class="code">[color=blue]<?php echo $lang_help['Blue text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: blue"><?php echo $lang_help['Blue text'] ?></span></samp></p>
-		<p><code class="code">[h]<?php echo $lang_help['Heading text'] ?>[/h]</code> <?php echo $lang_help['produces'] ?></p> <div class="postmsg"><h5><?php echo $lang_help['Heading text'] ?></h5></div>
+		<p><code>[b]<?php echo $lang_help['Bold text'] ?>[/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><?php echo $lang_help['Bold text'] ?></strong></samp></p>
+		<p><code>[u]<?php echo $lang_help['Underlined text'] ?>[/u]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbu"><?php echo $lang_help['Underlined text'] ?></span></samp></p>
+		<p><code>[i]<?php echo $lang_help['Italic text'] ?>[/i]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Italic text'] ?></em></samp></p>
+		<p><code>[s]<?php echo $lang_help['Strike-through text'] ?>[/s]</code> <?php echo $lang_help['produces'] ?> <samp><span class="bbs"><?php echo $lang_help['Strike-through text'] ?></span></samp></p>
+		<p><code>[del]<?php echo $lang_help['Deleted text'] ?>[/del]</code> <?php echo $lang_help['produces'] ?> <samp><del><?php echo $lang_help['Deleted text'] ?></del></samp></p>
+		<p><code>[ins]<?php echo $lang_help['Inserted text'] ?>[/ins]</code> <?php echo $lang_help['produces'] ?> <samp><ins><?php echo $lang_help['Inserted text'] ?></ins></samp></p>
+		<p><code>[em]<?php echo $lang_help['Emphasised text'] ?>[/em]</code> <?php echo $lang_help['produces'] ?> <samp><em><?php echo $lang_help['Emphasised text'] ?></em></samp></p>
+		<p><code>[color=#FF0000]<?php echo $lang_help['Red text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: #ff0000"><?php echo $lang_help['Red text'] ?></span></samp></p>
+		<p><code>[color=blue]<?php echo $lang_help['Blue text'] ?>[/color]</code> <?php echo $lang_help['produces'] ?> <samp><span style="color: blue"><?php echo $lang_help['Blue text'] ?></span></samp></p>
+		<p><code>[h]<?php echo $lang_help['Heading text'] ?>[/h]</code> <?php echo $lang_help['produces'] ?></p> <div class="postmsg"><h5><?php echo $lang_help['Heading text'] ?></h5></div>
 	</div>
 </div>
 <h2><span><?php echo $lang_help['Links and images'] ?></span></h2>
 <div class="box">
 	<div class="inbox">
 		<p><?php echo $lang_help['Links info'] ?></p>
-		<p><a name="url"></a><code class="code">[url=<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>]<?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?></a></samp></p>
-		<p><code class="code">[url]<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/') ?></a></samp></p>
-		<p><code class="code">[url=/help.php]<?php echo $lang_help['This help page'] ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/help.php') ?>"><?php echo $lang_help['This help page'] ?></a></samp></p>
-		<p><code class="code">[email]myname@example.com[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com">myname@example.com</a></samp></p>
-		<p><code class="code">[email=myname@example.com]<?php echo $lang_help['My email address'] ?>[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com"><?php echo $lang_help['My email address'] ?></a></samp></p>
-		<p><code class="code">[topic=1]<?php echo $lang_help['Test topic'] ?>[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo $lang_help['Test topic'] ?></a></samp></p>
-		<p><code class="code">[topic]1[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?></a></samp></p>
-		<p><code class="code">[post=1]<?php echo $lang_help['Test post'] ?>[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo $lang_help['Test post'] ?></a></samp></p>
-		<p><code class="code">[post]1[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?></a></samp></p>
-		<p><code class="code">[forum=1]<?php echo $lang_help['Test forum'] ?>[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo $lang_help['Test forum'] ?></a></samp></p>
-		<p><code class="code">[forum]1[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?></a></samp></p>
-		<p><code class="code">[user=2]<?php echo $lang_help['Test user'] ?>[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo $lang_help['Test user'] ?></a></samp></p>
-		<p><code class="code">[user]2[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?></a></samp></p>
+		<p><a name="url"></a><code>[url=<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>]<?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars($pun_config['o_board_title']) ?></a></samp></p>
+		<p><code>[url]<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/') ?></a></samp></p>
+		<p><code>[url=/help.php]<?php echo $lang_help['This help page'] ?>[/url]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/help.php') ?>"><?php echo $lang_help['This help page'] ?></a></samp></p>
+		<p><code>[email]myname@example.com[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com">myname@example.com</a></samp></p>
+		<p><code>[email=myname@example.com]<?php echo $lang_help['My email address'] ?>[/email]</code> <?php echo $lang_help['produces'] ?> <samp><a href="mailto:myname@example.com"><?php echo $lang_help['My email address'] ?></a></samp></p>
+		<p><code>[topic=1]<?php echo $lang_help['Test topic'] ?>[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo $lang_help['Test topic'] ?></a></samp></p>
+		<p><code>[topic]1[/topic]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?id=1') ?></a></samp></p>
+		<p><code>[post=1]<?php echo $lang_help['Test post'] ?>[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo $lang_help['Test post'] ?></a></samp></p>
+		<p><code>[post]1[/post]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewtopic.php?pid=1#p1') ?></a></samp></p>
+		<p><code>[forum=1]<?php echo $lang_help['Test forum'] ?>[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo $lang_help['Test forum'] ?></a></samp></p>
+		<p><code>[forum]1[/forum]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/viewforum.php?id=1') ?></a></samp></p>
+		<p><code>[user=2]<?php echo $lang_help['Test user'] ?>[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo $lang_help['Test user'] ?></a></samp></p>
+		<p><code>[user]2[/user]</code> <?php echo $lang_help['produces'] ?> <samp><a href="<?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?>"><?php echo pun_htmlspecialchars(get_base_url(true).'/profile.php?id=2') ?></a></samp></p>
 	</div>
 	<div class="inbox">
 		<p><a name="img"></a><?php echo $lang_help['Images info'] ?></p>
-		<p><code class="code">[img=<?php echo $lang_help['FluxBB bbcode test'] ?>]<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png[/img]</code> <?php echo $lang_help['produces'] ?> <samp><img style="height: 21px" src="<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png" alt="<?php echo $lang_help['FluxBB bbcode test'] ?>" /></samp></p>
+		<p><code>[img=<?php echo $lang_help['FluxBB bbcode test'] ?>]<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png[/img]</code> <?php echo $lang_help['produces'] ?> <samp><img style="height: 21px" src="<?php echo pun_htmlspecialchars(get_base_url(true)) ?>/img/test.png" alt="<?php echo $lang_help['FluxBB bbcode test'] ?>" /></samp></p>
 	</div>
 </div>
 <h2><span><?php echo $lang_help['Quotes'] ?></span></h2>
 <div class="box">
 	<div class="inbox">
 		<p><?php echo $lang_help['Quotes info'] ?></p>
-		<p><code class="code">[quote=James]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>
+		<p><code>[quote=James]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>
 		<p><?php echo $lang_help['produces quote box'] ?></p>
 		<div class="postmsg">
 			<div class="quotebox"><cite>James <?php echo $lang_common['wrote'] ?></cite><blockquote><div><p><?php echo $lang_help['Quote text'] ?></p></div></blockquote></div>
 		</div>
 		<p><?php echo $lang_help['Quotes info 2'] ?></p>
-		<p><code class="code">[quote]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>
+		<p><code>[quote]<?php echo $lang_help['Quote text'] ?>[/quote]</code></p>
 		<p><?php echo $lang_help['produces quote box'] ?></p>
 		<div class="postmsg">
 			<div class="quotebox"><blockquote><div><p><?php echo $lang_help['Quote text'] ?></p></div></blockquote></div>
@@ -94,29 +94,28 @@ require PUN_ROOT.'header.php';
 <div class="box">
 	<div class="inbox">
 		<p><?php echo $lang_help['Code info'] ?></p>
-		<p><code class="code">[code]<?php echo $lang_help['Code text'] ?>[/code]</code></p>
+		<p><code>[code]<?php echo $lang_help['Code text'] ?>[/code]</code></p>
 		<p><?php echo $lang_help['produces code box'] ?></p>
 		<div class="postmsg">
 			<div class="codebox"><pre><code><?php echo $lang_help['Code text'] ?></code></pre></div>
 		</div>
-		<p><code class="code">[c]<?php echo $lang_help['Code text'] ?>[/c]</code> <?php echo $lang_help['produces'] ?> <code class="code"><?php echo $lang_help['Code text'] ?></code></p>
 	</div>
 </div>
 <h2><span><?php echo $lang_help['Lists'] ?></span></h2>
 <div class="box">
 	<div class="inbox">
 		<p><a name="lists"></a><?php echo $lang_help['List info'] ?></p>
-		<p><code class="code">[list][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>
+		<p><code>[list][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>
 		<br /><span><?php echo $lang_help['produces list'] ?></span></p>
 		<div class="postmsg">
 			<ul><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ul>
 		</div>
-		<p><code class="code">[list=1][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>
+		<p><code>[list=1][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>
 		<br /><span><?php echo $lang_help['produces decimal list'] ?></span></p>
 		<div class="postmsg">
 			<ol class="decimal"><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ol>
 		</div>
-		<p><code class="code">[list=a][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>
+		<p><code>[list=a][*]<?php echo $lang_help['List text 1'] ?>[/*][*]<?php echo $lang_help['List text 2'] ?>[/*][*]<?php echo $lang_help['List text 3'] ?>[/*][/list]</code>
 		<br /><span><?php echo $lang_help['produces alpha list'] ?></span></p>
 		<div class="postmsg">
 			<ol class="alpha"><li><p><?php echo $lang_help['List text 1'] ?></p></li><li><p><?php echo $lang_help['List text 2'] ?></p></li><li><p><?php echo $lang_help['List text 3'] ?></p></li></ol>
@@ -127,7 +126,7 @@ require PUN_ROOT.'header.php';
 <div class="box">
 	<div class="inbox">
 		<p><?php echo $lang_help['Nested tags info'] ?></p>
-		<p><code class="code">[b][u]<?php echo $lang_help['Bold, underlined text'] ?>[/u][/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><span class="bbu"><?php echo $lang_help['Bold, underlined text'] ?></span></strong></samp></p>
+		<p><code>[b][u]<?php echo $lang_help['Bold, underlined text'] ?>[/u][/b]</code> <?php echo $lang_help['produces'] ?> <samp><strong><span class="bbu"><?php echo $lang_help['Bold, underlined text'] ?></span></strong></samp></p>
 	</div>
 </div>
 <h2><span><?php echo $lang_help['Smilies'] ?></span></h2>
@@ -145,7 +144,7 @@ foreach ($smilies as $smiley_text => $smiley_img)
 	$smiley_groups[$smiley_img][] = $smiley_text;
 
 foreach ($smiley_groups as $smiley_img => $smiley_texts)
-	echo "\t\t".'<p><code class="code">'.implode('</code> '.$lang_common['and'].' <code class="code">', $smiley_texts).'</code> <span>'.$lang_help['produces'].'</span> <samp><img src="'.pun_htmlspecialchars(get_base_url(true)).'/img/smilies/'.$smiley_img.'" width="15" height="15" alt="'.$smiley_texts[0].'" /></samp></p>'."\n";
+	echo "\t\t".'<p><code>'.implode('</code> '.$lang_common['and'].' <code>', $smiley_texts).'</code> <span>'.$lang_help['produces'].'</span> <samp><img src="'.pun_htmlspecialchars(get_base_url(true)).'/img/smilies/'.$smiley_img.'" width="15" height="15" alt="'.$smiley_texts[0].'" /></samp></p>'."\n";
 
 ?>
 	</div>
diff --git a/img/smilies/big_smile.png b/img/smilies/big_smile.png
index af11e5f7..1c4ea81f 100644
Binary files a/img/smilies/big_smile.png and b/img/smilies/big_smile.png differ
diff --git a/img/smilies/cool.png b/img/smilies/cool.png
index 052ce8d6..54ec46f6 100644
Binary files a/img/smilies/cool.png and b/img/smilies/cool.png differ
diff --git a/img/smilies/hmm.png b/img/smilies/hmm.png
index 498910ae..47b87b90 100644
Binary files a/img/smilies/hmm.png and b/img/smilies/hmm.png differ
diff --git a/img/smilies/lol.png b/img/smilies/lol.png
index 51e825d3..bad07187 100644
Binary files a/img/smilies/lol.png and b/img/smilies/lol.png differ
diff --git a/img/smilies/mad.png b/img/smilies/mad.png
index b992ba42..d8ffcc61 100644
Binary files a/img/smilies/mad.png and b/img/smilies/mad.png differ
diff --git a/img/smilies/neutral.png b/img/smilies/neutral.png
index e7abe1de..a2e4cb8c 100644
Binary files a/img/smilies/neutral.png and b/img/smilies/neutral.png differ
diff --git a/img/smilies/roll.png b/img/smilies/roll.png
index 00ad2438..1c3bc7e5 100644
Binary files a/img/smilies/roll.png and b/img/smilies/roll.png differ
diff --git a/img/smilies/sad.png b/img/smilies/sad.png
index c9670c83..b6a08993 100644
Binary files a/img/smilies/sad.png and b/img/smilies/sad.png differ
diff --git a/img/smilies/smile.png b/img/smilies/smile.png
index 47138702..77099a0e 100644
Binary files a/img/smilies/smile.png and b/img/smilies/smile.png differ
diff --git a/img/smilies/tongue.png b/img/smilies/tongue.png
index c83bc107..397b98ae 100644
Binary files a/img/smilies/tongue.png and b/img/smilies/tongue.png differ
diff --git a/img/smilies/wink.png b/img/smilies/wink.png
index 643ba4b2..fbc40af4 100644
Binary files a/img/smilies/wink.png and b/img/smilies/wink.png differ
diff --git a/img/smilies/yikes.png b/img/smilies/yikes.png
index 88d5ae2d..ddb055f4 100644
Binary files a/img/smilies/yikes.png and b/img/smilies/yikes.png differ
diff --git a/include/cache.php b/include/cache.php
index 68d2857b..c1947ae9 100644
--- a/include/cache.php
+++ b/include/cache.php
@@ -88,7 +88,7 @@ function generate_quickjump_cache($group_id = false)
 		{
 			$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name, f.redirect_url FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$group_id.') WHERE fp.read_forum IS NULL OR fp.read_forum=1 ORDER BY c.disp_position, c.id, f.disp_position') or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());
 
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 			{
 				$output .= "\t\t\t\t".'<form id="qjump" method="get" action="viewforum.php">'."\n\t\t\t\t\t".'<div><label><span><?php echo $lang_common[\'Jump to\'] ?>'.'<br /></span>'."\n\t\t\t\t\t".'<select name="id" onchange="window.location=(\'viewforum.php?id=\'+this.options[this.selectedIndex].value)">'."\n";
 
@@ -125,7 +125,7 @@ function generate_censoring_cache()
 	global $db;
 
 	$result = $db->query('SELECT search_for, replace_with FROM '.$db->prefix.'censoring') or error('Unable to fetch censoring list', __FILE__, __LINE__, $db->error());
-	$num_words = $db->has_rows($result);
+	$num_words = $db->num_rows($result);
 
 	$search_for = $replace_with = array();
 	for ($i = 0; $i < $num_words; $i++)
diff --git a/include/common.php b/include/common.php
index 4e5f6417..b502c8b9 100644
--- a/include/common.php
+++ b/include/common.php
@@ -12,7 +12,7 @@ if (!defined('PUN_ROOT'))
 // Define the version and database revision that this code was written for
 define('FORUM_VERSION', '1.5.11');
 
-define('FORUM_DB_REVISION', 24);
+define('FORUM_DB_REVISION', 21);
 define('FORUM_SI_REVISION', 2);
 define('FORUM_PARSER_REVISION', 2);
 
@@ -57,17 +57,49 @@ require PUN_ROOT.'include/utf8/utf8.php';
 // Strip out "bad" UTF-8 characters
 forum_remove_bad_characters();
 
+// Reverse the effect of register_globals
+forum_unregister_globals();
+
 // The addon manager is responsible for storing the hook listeners and communicating with the addons
 $flux_addons = new flux_addon_manager();
 
+// Record the start time (will be used to calculate the generation time for the page)
+$pun_start = get_microtime();
+
 // Seed the random number generator for systems where this does not happen automatically
 mt_srand();
+
 // Make sure PHP reports all errors except E_NOTICE. FluxBB supports E_ALL, but a lot of scripts it may interact with, do not
 error_reporting(E_ALL ^ E_NOTICE);
 
 // Force POSIX locale (to prevent functions such as strtolower() from messing up UTF-8 strings)
 setlocale(LC_CTYPE, 'C');
 
+// Turn off magic_quotes_runtime
+if (get_magic_quotes_runtime())
+	set_magic_quotes_runtime(0);
+
+// Strip slashes from GET/POST/COOKIE/REQUEST/FILES (if magic_quotes_gpc is enabled)
+if (!defined('FORUM_DISABLE_STRIPSLASHES') && get_magic_quotes_gpc())
+{
+	function stripslashes_array($array)
+	{
+		return is_array($array) ? array_map('stripslashes_array', $array) : stripslashes($array);
+	}
+
+	$_GET = stripslashes_array($_GET);
+	$_POST = stripslashes_array($_POST);
+	$_COOKIE = stripslashes_array($_COOKIE);
+	$_REQUEST = stripslashes_array($_REQUEST);
+	if (is_array($_FILES))
+	{
+		// Don't strip valid slashes from tmp_name path on Windows
+		foreach ($_FILES AS $key => $value)
+			$_FILES[$key]['tmp_name'] = str_replace('\\', '\\\\', $value['tmp_name']);
+		$_FILES = stripslashes_array($_FILES);
+	}
+}
+
 // If a cookie name is not specified in config.php, we use the default (pun_cookie)
 if (empty($cookie_name))
 	$cookie_name = 'pun_cookie';
diff --git a/include/dblayer/common_db.php b/include/dblayer/common_db.php
index 838b87e6..5b9e67ef 100644
--- a/include/dblayer/common_db.php
+++ b/include/dblayer/common_db.php
@@ -11,32 +11,38 @@ if (!defined('PUN'))
 	exit;
 
 
-// Load and create the appropriate DB adapter (and open/connect to/select db)
+// Load the appropriate DB layer class
 switch ($db_type)
 {
 	case 'mysql':
+		require_once PUN_ROOT.'include/dblayer/mysql.php';
+		break;
+
+	case 'mysql_innodb':
+		require_once PUN_ROOT.'include/dblayer/mysql_innodb.php';
+		break;
+
 	case 'mysqli':
 		require_once PUN_ROOT.'include/dblayer/mysqli.php';
-		$db = new MysqlDBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 		break;
 
-	case 'mysql_innodb':
 	case 'mysqli_innodb':
 		require_once PUN_ROOT.'include/dblayer/mysqli_innodb.php';
-		$db = new MysqlInnodbDBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 		break;
 
 	case 'pgsql':
 		require_once PUN_ROOT.'include/dblayer/pgsql.php';
-		$db = new PgsqlDBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 		break;
 
 	case 'sqlite':
 		require_once PUN_ROOT.'include/dblayer/sqlite.php';
-		$db = new SqliteDBLayer($db_name, $db_prefix, $p_connect);
 		break;
 
 	default:
 		error('\''.$db_type.'\' is not a valid database type. Please check settings in config.php.', __FILE__, __LINE__);
 		break;
 }
+
+
+// Create the database adapter object (and open/connect to/select db)
+$db = new DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
diff --git a/include/dblayer/interface.php b/include/dblayer/interface.php
deleted file mode 100644
index bfd95273..00000000
--- a/include/dblayer/interface.php
+++ /dev/null
@@ -1,70 +0,0 @@
-<?php
-
-/**
- * Copyright (C) 2008-2012 FluxBB
- * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
- * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
- */
-
-interface DBLayer
-{
-	public function start_transaction();
-
-	public function end_transaction();
-
-	public function query($sql, $unbuffered = false);
-
-	public function result($query_id = 0, $row = 0, $col = 0);
-
-	public function fetch_assoc($query_id = 0);
-
-	public function fetch_row($query_id = 0);
-
-	public function has_rows($query_id);
-
-	public function affected_rows();
-
-	public function insert_id();
-
-	public function get_num_queries();
-
-	public function get_saved_queries();
-
-	public function free_result($query_id = false);
-
-	public function escape($str);
-
-	public function error();
-
-	public function close();
-
-	public function get_names();
-
-	public function set_names($names);
-
-	public function get_version();
-
-	public function table_exists($table_name, $no_prefix = false);
-
-	public function field_exists($table_name, $field_name, $no_prefix = false);
-
-	public function index_exists($table_name, $index_name, $no_prefix = false);
-
-	public function create_table($table_name, $schema, $no_prefix = false);
-
-	public function drop_table($table_name, $no_prefix = false);
-
-	public function rename_table($old_table, $new_table, $no_prefix = false);
-
-	public function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false);
-
-	public function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false);
-
-	public function drop_field($table_name, $field_name, $no_prefix = false);
-
-	public function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false);
-
-	public function drop_index($table_name, $index_name, $no_prefix = false);
-
-	public function truncate_table($table_name, $no_prefix = false);
-}
diff --git a/include/dblayer/mysql.php b/include/dblayer/mysql.php
new file mode 100644
index 00000000..2885297c
--- /dev/null
+++ b/include/dblayer/mysql.php
@@ -0,0 +1,378 @@
+<?php
+
+/**
+ * Copyright (C) 2008-2012 FluxBB
+ * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
+ * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
+ */
+
+// Make sure we have built in support for MySQL
+if (!function_exists('mysql_connect'))
+	exit('This PHP environment doesn\'t have MySQL support built in. MySQL support is required if you want to use a MySQL database to run this forum. Consult the PHP documentation for further assistance.');
+
+
+class DBLayer
+{
+	var $prefix;
+	var $link_id;
+	var $query_result;
+
+	var $saved_queries = array();
+	var $num_queries = 0;
+
+	var $error_no = false;
+	var $error_msg = 'Unknown';
+
+	var $datatype_transformations = array(
+		'%^SERIAL$%'	=>	'INT(10) UNSIGNED AUTO_INCREMENT'
+	);
+
+
+	function __construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->prefix = $db_prefix;
+
+		if ($p_connect)
+			$this->link_id = @mysql_pconnect($db_host, $db_username, $db_password);
+		else
+			$this->link_id = @mysql_connect($db_host, $db_username, $db_password);
+
+		if ($this->link_id)
+		{
+			if (!@mysql_select_db($db_name, $this->link_id))
+				error('Unable to select database. MySQL reported: '.mysql_error(), __FILE__, __LINE__);
+		}
+		else
+			error('Unable to connect to MySQL server. MySQL reported: '.mysql_error(), __FILE__, __LINE__);
+
+		// Setup the client-server character set (UTF-8)
+		if (!defined('FORUM_NO_SET_NAMES'))
+			$this->set_names('utf8mb4');
+
+		return $this->link_id;
+	}
+	
+
+	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->__construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
+	}
+
+
+	function start_transaction()
+	{
+		return;
+	}
+
+
+	function end_transaction()
+	{
+		return;
+	}
+
+
+	function query($sql, $unbuffered = false)
+	{
+		if (defined('PUN_SHOW_QUERIES'))
+			$q_start = get_microtime();
+
+		if ($unbuffered)
+			$this->query_result = @mysql_unbuffered_query($sql, $this->link_id);
+		else
+			$this->query_result = @mysql_query($sql, $this->link_id);
+
+		if ($this->query_result)
+		{
+			if (defined('PUN_SHOW_QUERIES'))
+				$this->saved_queries[] = array($sql, sprintf('%.5F', get_microtime() - $q_start));
+
+			++$this->num_queries;
+
+			return $this->query_result;
+		}
+		else
+		{
+			if (defined('PUN_SHOW_QUERIES'))
+				$this->saved_queries[] = array($sql, 0);
+
+			$this->error_no = @mysql_errno($this->link_id);
+			$this->error_msg = @mysql_error($this->link_id);
+
+			return false;
+		}
+	}
+
+
+	function result($query_id = 0, $row = 0, $col = 0)
+	{
+		return ($query_id) ? @mysql_result($query_id, $row, $col) : false;
+	}
+
+
+	function fetch_assoc($query_id = 0)
+	{
+		return ($query_id) ? @mysql_fetch_assoc($query_id) : false;
+	}
+
+
+	function fetch_row($query_id = 0)
+	{
+		return ($query_id) ? @mysql_fetch_row($query_id) : false;
+	}
+
+
+	function num_rows($query_id = 0)
+	{
+		return ($query_id) ? @mysql_num_rows($query_id) : false;
+	}
+
+
+	function affected_rows()
+	{
+		return ($this->link_id) ? @mysql_affected_rows($this->link_id) : false;
+	}
+
+
+	function insert_id()
+	{
+		return ($this->link_id) ? @mysql_insert_id($this->link_id) : false;
+	}
+
+
+	function get_num_queries()
+	{
+		return $this->num_queries;
+	}
+
+
+	function get_saved_queries()
+	{
+		return $this->saved_queries;
+	}
+
+
+	function free_result($query_id = false)
+	{
+		return ($query_id) ? @mysql_free_result($query_id) : false;
+	}
+
+
+	function escape($str)
+	{
+		if (is_array($str))
+			return '';
+		else if (function_exists('mysql_real_escape_string'))
+			return mysql_real_escape_string($str, $this->link_id);
+		else
+			return mysql_escape_string($str);
+	}
+
+
+	function error()
+	{
+		$result['error_sql'] = @current(@end($this->saved_queries));
+		$result['error_no'] = $this->error_no;
+		$result['error_msg'] = $this->error_msg;
+
+		return $result;
+	}
+
+
+	function close()
+	{
+		if ($this->link_id)
+		{
+			if (is_resource($this->query_result))
+				@mysql_free_result($this->query_result);
+
+			return @mysql_close($this->link_id);
+		}
+		else
+			return false;
+	}
+
+	function get_names()
+	{
+		$result = $this->query('SHOW VARIABLES LIKE \'character_set_connection\'');
+		return $this->result($result, 0, 1);
+	}
+
+
+	function set_names($names)
+	{
+		return $this->query('SET NAMES \''.$this->escape($names).'\'');
+	}
+
+
+	function get_version()
+	{
+		$result = $this->query('SELECT VERSION()');
+
+		return array(
+			'name'		=> 'MySQL Standard',
+			'version'	=> preg_replace('%^([^-]+).*$%', '\\1', $this->result($result))
+		);
+	}
+
+
+	function table_exists($table_name, $no_prefix = false)
+	{
+		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');
+		return $this->num_rows($result) > 0;
+	}
+
+
+	function field_exists($table_name, $field_name, $no_prefix = false)
+	{
+		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');
+		return $this->num_rows($result) > 0;
+	}
+
+
+	function index_exists($table_name, $index_name, $no_prefix = false)
+	{
+		$exists = false;
+
+		$result = $this->query('SHOW INDEX FROM '.($no_prefix ? '' : $this->prefix).$table_name);
+		while ($cur_index = $this->fetch_assoc($result))
+		{
+			if (strtolower($cur_index['Key_name']) == strtolower(($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name))
+			{
+				$exists = true;
+				break;
+			}
+		}
+
+		return $exists;
+	}
+
+
+	function create_table($table_name, $schema, $no_prefix = false)
+	{
+		if ($this->table_exists($table_name, $no_prefix))
+			return true;
+
+		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";
+
+		// Go through every schema element and add it to the query
+		foreach ($schema['FIELDS'] as $field_name => $field_data)
+		{
+			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);
+
+			$query .= $field_name.' '.$field_data['datatype'];
+
+			if (isset($field_data['collation']))
+				$query .= 'CHARACTER SET utf8 COLLATE utf8_'.$field_data['collation'];
+
+			if (!$field_data['allow_null'])
+				$query .= ' NOT NULL';
+
+			if (isset($field_data['default']))
+				$query .= ' DEFAULT '.$field_data['default'];
+
+			$query .= ",\n";
+		}
+
+		// If we have a primary key, add it
+		if (isset($schema['PRIMARY KEY']))
+			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";
+
+		// Add unique keys
+		if (isset($schema['UNIQUE KEYS']))
+		{
+			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)
+				$query .= 'UNIQUE KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$key_name.'('.implode(',', $key_fields).'),'."\n";
+		}
+
+		// Add indexes
+		if (isset($schema['INDEXES']))
+		{
+			foreach ($schema['INDEXES'] as $index_name => $index_fields)
+				$query .= 'KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.'('.implode(',', $index_fields).'),'."\n";
+		}
+
+		// We remove the last two characters (a newline and a comma) and add on the ending
+		$query = substr($query, 0, strlen($query) - 2)."\n".') ENGINE = '.(isset($schema['ENGINE']) ? $schema['ENGINE'] : 'MyISAM').' CHARACTER SET utf8';
+
+		return $this->query($query) ? true : false;
+	}
+
+
+	function drop_table($table_name, $no_prefix = false)
+	{
+		if (!$this->table_exists($table_name, $no_prefix))
+			return true;
+
+		return $this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) ? true : false;
+	}
+
+
+	function rename_table($old_table, $new_table, $no_prefix = false)
+	{
+		// If the new table exists and the old one doesn't, then we're happy
+		if ($this->table_exists($new_table, $no_prefix) && !$this->table_exists($old_table, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$old_table.' RENAME TO '.($no_prefix ? '' : $this->prefix).$new_table) ? true : false;
+	}
+
+
+	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)
+	{
+		if ($this->field_exists($table_name, $field_name, $no_prefix))
+			return true;
+
+		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);
+
+		if (!is_null($default_value) && !is_int($default_value) && !is_float($default_value))
+			$default_value = '\''.$this->escape($default_value).'\'';
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type.($allow_null ? '' : ' NOT NULL').(!is_null($default_value) ? ' DEFAULT '.$default_value : '').(!is_null($after_field) ? ' AFTER '.$after_field : '')) ? true : false;
+	}
+
+
+	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)
+	{
+		if (!$this->field_exists($table_name, $field_name, $no_prefix))
+			return true;
+
+		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);
+
+		if (!is_null($default_value) && !is_int($default_value) && !is_float($default_value))
+			$default_value = '\''.$this->escape($default_value).'\'';
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' MODIFY '.$field_name.' '.$field_type.($allow_null ? '' : ' NOT NULL').(!is_null($default_value) ? ' DEFAULT '.$default_value : '').(!is_null($after_field) ? ' AFTER '.$after_field : '')) ? true : false;
+	}
+
+
+	function drop_field($table_name, $field_name, $no_prefix = false)
+	{
+		if (!$this->field_exists($table_name, $field_name, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) ? true : false;
+	}
+
+
+	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)
+	{
+		if ($this->index_exists($table_name, $index_name, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ('.implode(',', $index_fields).')') ? true : false;
+	}
+
+
+	function drop_index($table_name, $index_name, $no_prefix = false)
+	{
+		if (!$this->index_exists($table_name, $index_name, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) ? true : false;
+	}
+
+	function truncate_table($table_name, $no_prefix = false)
+	{
+		return $this->query('TRUNCATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name) ? true : false;
+	}
+}
diff --git a/include/dblayer/mysql_innodb.php b/include/dblayer/mysql_innodb.php
new file mode 100644
index 00000000..cfe70127
--- /dev/null
+++ b/include/dblayer/mysql_innodb.php
@@ -0,0 +1,392 @@
+<?php
+
+/**
+ * Copyright (C) 2008-2012 FluxBB
+ * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
+ * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
+ */
+
+// Make sure we have built in support for MySQL
+if (!function_exists('mysql_connect'))
+	exit('This PHP environment doesn\'t have MySQL support built in. MySQL support is required if you want to use a MySQL database to run this forum. Consult the PHP documentation for further assistance.');
+
+
+class DBLayer
+{
+	var $prefix;
+	var $link_id;
+	var $query_result;
+	var $in_transaction = 0;
+
+	var $saved_queries = array();
+	var $num_queries = 0;
+
+	var $error_no = false;
+	var $error_msg = 'Unknown';
+
+	var $datatype_transformations = array(
+		'%^SERIAL$%'	=>	'INT(10) UNSIGNED AUTO_INCREMENT'
+	);
+
+
+	function __construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->prefix = $db_prefix;
+
+		if ($p_connect)
+			$this->link_id = @mysql_pconnect($db_host, $db_username, $db_password);
+		else
+			$this->link_id = @mysql_connect($db_host, $db_username, $db_password);
+
+		if ($this->link_id)
+		{
+			if (!@mysql_select_db($db_name, $this->link_id))
+				error('Unable to select database. MySQL reported: '.mysql_error(), __FILE__, __LINE__);
+		}
+		else
+			error('Unable to connect to MySQL server. MySQL reported: '.mysql_error(), __FILE__, __LINE__);
+
+		// Setup the client-server character set (UTF-8)
+		if (!defined('FORUM_NO_SET_NAMES'))
+			$this->set_names('utf8mb4');
+
+		return $this->link_id;
+	}
+	
+	
+	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->__construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
+	}
+
+
+	function start_transaction()
+	{
+		++$this->in_transaction;
+
+		mysql_query('START TRANSACTION', $this->link_id);
+		return;
+	}
+
+
+	function end_transaction()
+	{
+		--$this->in_transaction;
+
+		mysql_query('COMMIT', $this->link_id);
+		return;
+	}
+
+
+	function query($sql, $unbuffered = false)
+	{
+		if (defined('PUN_SHOW_QUERIES'))
+			$q_start = get_microtime();
+
+		if ($unbuffered)
+			$this->query_result = @mysql_unbuffered_query($sql, $this->link_id);
+		else
+			$this->query_result = @mysql_query($sql, $this->link_id);
+
+		if ($this->query_result)
+		{
+			if (defined('PUN_SHOW_QUERIES'))
+				$this->saved_queries[] = array($sql, sprintf('%.5F', get_microtime() - $q_start));
+
+			++$this->num_queries;
+
+			return $this->query_result;
+		}
+		else
+		{
+			if (defined('PUN_SHOW_QUERIES'))
+				$this->saved_queries[] = array($sql, 0);
+
+			$this->error_no = @mysql_errno($this->link_id);
+			$this->error_msg = @mysql_error($this->link_id);
+
+			// Rollback transaction
+			if ($this->in_transaction)
+				mysql_query('ROLLBACK', $this->link_id);
+
+			--$this->in_transaction;
+
+			return false;
+		}
+	}
+
+
+	function result($query_id = 0, $row = 0, $col = 0)
+	{
+		return ($query_id) ? @mysql_result($query_id, $row, $col) : false;
+	}
+
+
+	function fetch_assoc($query_id = 0)
+	{
+		return ($query_id) ? @mysql_fetch_assoc($query_id) : false;
+	}
+
+
+	function fetch_row($query_id = 0)
+	{
+		return ($query_id) ? @mysql_fetch_row($query_id) : false;
+	}
+
+
+	function num_rows($query_id = 0)
+	{
+		return ($query_id) ? @mysql_num_rows($query_id) : false;
+	}
+
+
+	function affected_rows()
+	{
+		return ($this->link_id) ? @mysql_affected_rows($this->link_id) : false;
+	}
+
+
+	function insert_id()
+	{
+		return ($this->link_id) ? @mysql_insert_id($this->link_id) : false;
+	}
+
+
+	function get_num_queries()
+	{
+		return $this->num_queries;
+	}
+
+
+	function get_saved_queries()
+	{
+		return $this->saved_queries;
+	}
+
+
+	function free_result($query_id = false)
+	{
+		return ($query_id) ? @mysql_free_result($query_id) : false;
+	}
+
+
+	function escape($str)
+	{
+		if (is_array($str))
+			return '';
+		else if (function_exists('mysql_real_escape_string'))
+			return mysql_real_escape_string($str, $this->link_id);
+		else
+			return mysql_escape_string($str);
+	}
+
+
+	function error()
+	{
+		$result['error_sql'] = @current(@end($this->saved_queries));
+		$result['error_no'] = $this->error_no;
+		$result['error_msg'] = $this->error_msg;
+
+		return $result;
+	}
+
+
+	function close()
+	{
+		if ($this->link_id)
+		{
+			if (is_resource($this->query_result))
+				@mysql_free_result($this->query_result);
+
+			return @mysql_close($this->link_id);
+		}
+		else
+			return false;
+	}
+
+
+	function get_names()
+	{
+		$result = $this->query('SHOW VARIABLES LIKE \'character_set_connection\'');
+		return $this->result($result, 0, 1);
+	}
+
+
+	function set_names($names)
+	{
+		return $this->query('SET NAMES \''.$this->escape($names).'\'');
+	}
+
+
+	function get_version()
+	{
+		$result = $this->query('SELECT VERSION()');
+
+		return array(
+			'name'		=> 'MySQL Standard (InnoDB)',
+			'version'	=> preg_replace('%^([^-]+).*$%', '\\1', $this->result($result))
+		);
+	}
+
+
+	function table_exists($table_name, $no_prefix = false)
+	{
+		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');
+		return $this->num_rows($result) > 0;
+	}
+
+
+	function field_exists($table_name, $field_name, $no_prefix = false)
+	{
+		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');
+		return $this->num_rows($result) > 0;
+	}
+
+
+	function index_exists($table_name, $index_name, $no_prefix = false)
+	{
+		$exists = false;
+
+		$result = $this->query('SHOW INDEX FROM '.($no_prefix ? '' : $this->prefix).$table_name);
+		while ($cur_index = $this->fetch_assoc($result))
+		{
+			if (strtolower($cur_index['Key_name']) == strtolower(($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name))
+			{
+				$exists = true;
+				break;
+			}
+		}
+
+		return $exists;
+	}
+
+
+	function create_table($table_name, $schema, $no_prefix = false)
+	{
+		if ($this->table_exists($table_name, $no_prefix))
+			return true;
+
+		$query = 'CREATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name." (\n";
+
+		// Go through every schema element and add it to the query
+		foreach ($schema['FIELDS'] as $field_name => $field_data)
+		{
+			$field_data['datatype'] = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_data['datatype']);
+
+			$query .= $field_name.' '.$field_data['datatype'];
+
+			if (isset($field_data['collation']))
+				$query .= 'CHARACTER SET utf8 COLLATE utf8_'.$field_data['collation'];
+
+			if (!$field_data['allow_null'])
+				$query .= ' NOT NULL';
+
+			if (isset($field_data['default']))
+				$query .= ' DEFAULT '.$field_data['default'];
+
+			$query .= ",\n";
+		}
+
+		// If we have a primary key, add it
+		if (isset($schema['PRIMARY KEY']))
+			$query .= 'PRIMARY KEY ('.implode(',', $schema['PRIMARY KEY']).'),'."\n";
+
+		// Add unique keys
+		if (isset($schema['UNIQUE KEYS']))
+		{
+			foreach ($schema['UNIQUE KEYS'] as $key_name => $key_fields)
+				$query .= 'UNIQUE KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$key_name.'('.implode(',', $key_fields).'),'."\n";
+		}
+
+		// Add indexes
+		if (isset($schema['INDEXES']))
+		{
+			foreach ($schema['INDEXES'] as $index_name => $index_fields)
+				$query .= 'KEY '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.'('.implode(',', $index_fields).'),'."\n";
+		}
+
+		// We remove the last two characters (a newline and a comma) and add on the ending
+		$query = substr($query, 0, strlen($query) - 2)."\n".') ENGINE = '.(isset($schema['ENGINE']) ? $schema['ENGINE'] : 'InnoDB').' CHARACTER SET utf8';
+
+		return $this->query($query) ? true : false;
+	}
+
+
+	function drop_table($table_name, $no_prefix = false)
+	{
+		if (!$this->table_exists($table_name, $no_prefix))
+			return true;
+
+		return $this->query('DROP TABLE '.($no_prefix ? '' : $this->prefix).$table_name) ? true : false;
+	}
+
+
+	function rename_table($old_table, $new_table, $no_prefix = false)
+	{
+		// If the new table exists and the old one doesn't, then we're happy
+		if ($this->table_exists($new_table, $no_prefix) && !$this->table_exists($old_table, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$old_table.' RENAME TO '.($no_prefix ? '' : $this->prefix).$new_table) ? true : false;
+	}
+
+
+	function add_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)
+	{
+		if ($this->field_exists($table_name, $field_name, $no_prefix))
+			return true;
+
+		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);
+
+		if (!is_null($default_value) && !is_int($default_value) && !is_float($default_value))
+			$default_value = '\''.$this->escape($default_value).'\'';
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.$field_name.' '.$field_type.($allow_null ? '' : ' NOT NULL').(!is_null($default_value) ? ' DEFAULT '.$default_value : '').(!is_null($after_field) ? ' AFTER '.$after_field : '')) ? true : false;
+	}
+
+
+	function alter_field($table_name, $field_name, $field_type, $allow_null, $default_value = null, $after_field = null, $no_prefix = false)
+	{
+		if (!$this->field_exists($table_name, $field_name, $no_prefix))
+			return true;
+
+		$field_type = preg_replace(array_keys($this->datatype_transformations), array_values($this->datatype_transformations), $field_type);
+
+		if (!is_null($default_value) && !is_int($default_value) && !is_float($default_value))
+			$default_value = '\''.$this->escape($default_value).'\'';
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' MODIFY '.$field_name.' '.$field_type.($allow_null ? '' : ' NOT NULL').(!is_null($default_value) ? ' DEFAULT '.$default_value : '').(!is_null($after_field) ? ' AFTER '.$after_field : '')) ? true : false;
+	}
+
+
+	function drop_field($table_name, $field_name, $no_prefix = false)
+	{
+		if (!$this->field_exists($table_name, $field_name, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP '.$field_name) ? true : false;
+	}
+
+
+	function add_index($table_name, $index_name, $index_fields, $unique = false, $no_prefix = false)
+	{
+		if ($this->index_exists($table_name, $index_name, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' ADD '.($unique ? 'UNIQUE ' : '').'INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name.' ('.implode(',', $index_fields).')') ? true : false;
+	}
+
+
+	function drop_index($table_name, $index_name, $no_prefix = false)
+	{
+		if (!$this->index_exists($table_name, $index_name, $no_prefix))
+			return true;
+
+		return $this->query('ALTER TABLE '.($no_prefix ? '' : $this->prefix).$table_name.' DROP INDEX '.($no_prefix ? '' : $this->prefix).$table_name.'_'.$index_name) ? true : false;
+	}
+
+	function truncate_table($table_name, $no_prefix = false)
+	{
+		return $this->query('TRUNCATE TABLE '.($no_prefix ? '' : $this->prefix).$table_name) ? true : false;
+	}
+}
diff --git a/include/dblayer/mysqli.php b/include/dblayer/mysqli.php
index 96fd6adf..834e635f 100644
--- a/include/dblayer/mysqli.php
+++ b/include/dblayer/mysqli.php
@@ -11,10 +11,7 @@ if (!function_exists('mysqli_connect'))
 	exit('This PHP environment doesn\'t have Improved MySQL (mysqli) support built in. Improved MySQL support is required if you want to use a MySQL 4.1 (or later) database to run this forum. Consult the PHP documentation for further assistance.');
 
 
-require_once PUN_ROOT.'include/dblayer/interface.php';
-
-
-class MysqlDBLayer implements DBLayer
+class DBLayer
 {
 	var $prefix;
 	var $link_id;
@@ -39,7 +36,8 @@ class MysqlDBLayer implements DBLayer
 		if (strpos($db_host, ':') !== false)
 			list($db_host, $db_port) = explode(':', $db_host);
 
-		$p_connect = $p_connect ? 'p:' : '';
+		// Persistent connection in MySQLi are only available in PHP 5.3 and later releases
+		$p_connect = $p_connect && version_compare(PHP_VERSION, '5.3.0', '>=') ? 'p:' : '';
 
 		if (isset($db_port))
 			$this->link_id = @mysqli_connect($p_connect.$db_host, $db_username, $db_password, $db_name, $db_port);
@@ -51,7 +49,15 @@ class MysqlDBLayer implements DBLayer
 
 		// Setup the client-server character set (UTF-8)
 		if (!defined('FORUM_NO_SET_NAMES'))
-			$this->set_names('utf8');
+			$this->set_names('utf8mb4');
+
+		return $this->link_id;
+	}
+	
+	
+	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->__construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 	}
 
 
@@ -70,14 +76,14 @@ class MysqlDBLayer implements DBLayer
 	function query($sql, $unbuffered = false)
 	{
 		if (defined('PUN_SHOW_QUERIES'))
-			$q_start = microtime(true);
+			$q_start = get_microtime();
 
 		$this->query_result = @mysqli_query($this->link_id, $sql);
 
 		if ($this->query_result)
 		{
 			if (defined('PUN_SHOW_QUERIES'))
-				$this->saved_queries[] = array($sql, sprintf('%.5F', microtime(true) - $q_start));
+				$this->saved_queries[] = array($sql, sprintf('%.5F', get_microtime() - $q_start));
 
 			++$this->num_queries;
 
@@ -126,9 +132,9 @@ class MysqlDBLayer implements DBLayer
 	}
 
 
-	function has_rows($query_id)
+	function num_rows($query_id = 0)
 	{
-		return $query_id ? mysqli_num_rows($query_id) > 0 : false;
+		return ($query_id) ? @mysqli_num_rows($query_id) : false;
 	}
 
 
@@ -201,7 +207,7 @@ class MysqlDBLayer implements DBLayer
 
 	function set_names($names)
 	{
-		return mysqli_set_charset($this->link_id, $names);
+		return $this->query('SET NAMES \''.$this->escape($names).'\'');
 	}
 
 
@@ -219,14 +225,14 @@ class MysqlDBLayer implements DBLayer
 	function table_exists($table_name, $no_prefix = false)
 	{
 		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
 	function field_exists($table_name, $field_name, $no_prefix = false)
 	{
 		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
diff --git a/include/dblayer/mysqli_innodb.php b/include/dblayer/mysqli_innodb.php
index ac13a5c2..ec787125 100644
--- a/include/dblayer/mysqli_innodb.php
+++ b/include/dblayer/mysqli_innodb.php
@@ -11,10 +11,7 @@ if (!function_exists('mysqli_connect'))
 	exit('This PHP environment doesn\'t have Improved MySQL (mysqli) support built in. Improved MySQL support is required if you want to use a MySQL 4.1 (or later) database to run this forum. Consult the PHP documentation for further assistance.');
 
 
-require_once PUN_ROOT.'include/dblayer/interface.php';
-
-
-class MysqlInnodbDBLayer implements DBLayer
+class DBLayer
 {
 	var $prefix;
 	var $link_id;
@@ -40,7 +37,8 @@ class MysqlInnodbDBLayer implements DBLayer
 		if (strpos($db_host, ':') !== false)
 			list($db_host, $db_port) = explode(':', $db_host);
 
-		$p_connect = $p_connect ? 'p:' : '';
+		// Persistent connection in MySQLi are only available in PHP 5.3 and later releases
+		$p_connect = $p_connect && version_compare(PHP_VERSION, '5.3.0', '>=') ? 'p:' : '';
 
 		if (isset($db_port))
 			$this->link_id = @mysqli_connect($p_connect.$db_host, $db_username, $db_password, $db_name, $db_port);
@@ -52,7 +50,15 @@ class MysqlInnodbDBLayer implements DBLayer
 
 		// Setup the client-server character set (UTF-8)
 		if (!defined('FORUM_NO_SET_NAMES'))
-			$this->set_names('utf8');
+			$this->set_names('utf8mb4');
+
+		return $this->link_id;
+	}
+
+
+	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->__construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 	}
 
 
@@ -77,14 +83,14 @@ class MysqlInnodbDBLayer implements DBLayer
 	function query($sql, $unbuffered = false)
 	{
 		if (defined('PUN_SHOW_QUERIES'))
-			$q_start = microtime(true);
+			$q_start = get_microtime();
 
 		$this->query_result = @mysqli_query($this->link_id, $sql);
 
 		if ($this->query_result)
 		{
 			if (defined('PUN_SHOW_QUERIES'))
-				$this->saved_queries[] = array($sql, sprintf('%.5F', microtime(true) - $q_start));
+				$this->saved_queries[] = array($sql, sprintf('%.5F', get_microtime() - $q_start));
 
 			++$this->num_queries;
 
@@ -139,9 +145,9 @@ class MysqlInnodbDBLayer implements DBLayer
 	}
 
 
-	function has_rows($query_id)
+	function num_rows($query_id = 0)
 	{
-		return $query_id ? mysqli_num_rows($query_id) > 0 : false;
+		return ($query_id) ? @mysqli_num_rows($query_id) : false;
 	}
 
 
@@ -214,7 +220,7 @@ class MysqlInnodbDBLayer implements DBLayer
 
 	function set_names($names)
 	{
-		return mysqli_set_charset($this->link_id, $names);
+		return $this->query('SET NAMES \''.$this->escape($names).'\'');
 	}
 
 
@@ -232,14 +238,14 @@ class MysqlInnodbDBLayer implements DBLayer
 	function table_exists($table_name, $no_prefix = false)
 	{
 		$result = $this->query('SHOW TABLES LIKE \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
 	function field_exists($table_name, $field_name, $no_prefix = false)
 	{
 		$result = $this->query('SHOW COLUMNS FROM '.($no_prefix ? '' : $this->prefix).$table_name.' LIKE \''.$this->escape($field_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
diff --git a/include/dblayer/pgsql.php b/include/dblayer/pgsql.php
index 006ca9aa..6a1f7260 100644
--- a/include/dblayer/pgsql.php
+++ b/include/dblayer/pgsql.php
@@ -11,10 +11,7 @@ if (!function_exists('pg_connect'))
 	exit('This PHP environment doesn\'t have PostgreSQL support built in. PostgreSQL support is required if you want to use a PostgreSQL database to run this forum. Consult the PHP documentation for further assistance.');
 
 
-require_once PUN_ROOT.'include/dblayer/interface.php';
-
-
-class PgsqlDBLayer implements DBLayer
+class DBLayer
 {
 	var $prefix;
 	var $link_id;
@@ -72,7 +69,15 @@ class PgsqlDBLayer implements DBLayer
 
 		// Setup the client-server character set (UTF-8)
 		if (!defined('FORUM_NO_SET_NAMES'))
-			$this->set_names('utf8');
+			$this->set_names('utf8mb4');
+
+		return $this->link_id;
+	}
+	
+
+	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->__construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 	}
 
 
@@ -104,7 +109,7 @@ class PgsqlDBLayer implements DBLayer
 			$sql = preg_replace('%LIMIT ([0-9]+),([ 0-9]+)%', 'LIMIT \\2 OFFSET \\1', $sql);
 
 		if (defined('PUN_SHOW_QUERIES'))
-			$q_start = microtime(true);
+			$q_start = get_microtime();
 
 		@pg_send_query($this->link_id, $sql);
 		$this->query_result = @pg_get_result($this->link_id);
@@ -112,7 +117,7 @@ class PgsqlDBLayer implements DBLayer
 		if (pg_result_status($this->query_result) != PGSQL_FATAL_ERROR)
 		{
 			if (defined('PUN_SHOW_QUERIES'))
-				$this->saved_queries[] = array($sql, sprintf('%.5F', microtime(true) - $q_start));
+				$this->saved_queries[] = array($sql, sprintf('%.5F', get_microtime() - $q_start));
 
 			++$this->num_queries;
 
@@ -156,9 +161,9 @@ class PgsqlDBLayer implements DBLayer
 	}
 
 
-	function has_rows($query_id)
+	function num_rows($query_id = 0)
 	{
-		return $query_id ? pg_num_rows($query_id) > 0 : false;
+		return ($query_id) ? @pg_num_rows($query_id) : false;
 	}
 
 
@@ -275,21 +280,21 @@ class PgsqlDBLayer implements DBLayer
 	function table_exists($table_name, $no_prefix = false)
 	{
 		$result = $this->query('SELECT 1 FROM pg_class WHERE relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
 	function field_exists($table_name, $field_name, $no_prefix = false)
 	{
 		$result = $this->query('SELECT 1 FROM pg_class c INNER JOIN pg_attribute a ON a.attrelid = c.oid WHERE c.relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND a.attname = \''.$this->escape($field_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
 	function index_exists($table_name, $index_name, $no_prefix = false)
 	{
 		$result = $this->query('SELECT 1 FROM pg_index i INNER JOIN pg_class c1 ON c1.oid = i.indrelid INNER JOIN pg_class c2 ON c2.oid = i.indexrelid WHERE c1.relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND c2.relname = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_'.$this->escape($index_name).'\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
diff --git a/include/dblayer/sqlite.php b/include/dblayer/sqlite.php
index 8a4a2993..f9164fac 100644
--- a/include/dblayer/sqlite.php
+++ b/include/dblayer/sqlite.php
@@ -11,10 +11,7 @@ if (!function_exists('sqlite_open'))
 	exit('This PHP environment doesn\'t have SQLite support built in. SQLite support is required if you want to use a SQLite database to run this forum. Consult the PHP documentation for further assistance.');
 
 
-require_once PUN_ROOT.'include/dblayer/interface.php';
-
-
-class SqliteDBLayer implements DBLayer
+class DBLayer
 {
 	var $prefix;
 	var $link_id;
@@ -34,7 +31,7 @@ class SqliteDBLayer implements DBLayer
 	);
 
 
-	function __construct($db_name, $db_prefix, $p_connect)
+	function __construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
 	{
 		// Prepend $db_name with the path to the forum root directory
 		$db_name = PUN_ROOT.$db_name;
@@ -62,6 +59,14 @@ class SqliteDBLayer implements DBLayer
 
 		if (!$this->link_id)
 			error('Unable to open database \''.$db_name.'\'. SQLite reported: '.$sqlite_error, __FILE__, __LINE__);
+		else
+			return $this->link_id;
+	}
+	
+	
+	function DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect)
+	{
+		$this->__construct($db_host, $db_username, $db_password, $db_name, $db_prefix, $p_connect);
 	}
 
 
@@ -90,7 +95,7 @@ class SqliteDBLayer implements DBLayer
 	function query($sql, $unbuffered = false)
 	{
 		if (defined('PUN_SHOW_QUERIES'))
-			$q_start = microtime(true);
+			$q_start = get_microtime();
 
 		if ($unbuffered)
 			$this->query_result = @sqlite_unbuffered_query($this->link_id, $sql);
@@ -100,7 +105,7 @@ class SqliteDBLayer implements DBLayer
 		if ($this->query_result)
 		{
 			if (defined('PUN_SHOW_QUERIES'))
-				$this->saved_queries[] = array($sql, sprintf('%.5F', microtime(true) - $q_start));
+				$this->saved_queries[] = array($sql, sprintf('%.5F', get_microtime() - $q_start));
 
 			++$this->num_queries;
 
@@ -175,9 +180,9 @@ class SqliteDBLayer implements DBLayer
 	}
 
 
-	function has_rows($query_id)
+	function num_rows($query_id = 0)
 	{
-		return $query_id ? sqlite_num_rows($query_id) > 0 : false;
+		return ($query_id) ? @sqlite_num_rows($query_id) : false;
 	}
 
 
@@ -270,14 +275,14 @@ class SqliteDBLayer implements DBLayer
 	function table_exists($table_name, $no_prefix = false)
 	{
 		$result = $this->query('SELECT 1 FROM sqlite_master WHERE name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND type=\'table\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
 	function field_exists($table_name, $field_name, $no_prefix = false)
 	{
 		$result = $this->query('SELECT sql FROM sqlite_master WHERE name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND type=\'table\'');
-		if (!$this->has_rows($result))
+		if (!$this->num_rows($result))
 			return false;
 
 		return preg_match('%[\r\n]'.preg_quote($field_name, '%').' %', $this->result($result));
@@ -287,7 +292,7 @@ class SqliteDBLayer implements DBLayer
 	function index_exists($table_name, $index_name, $no_prefix = false)
 	{
 		$result = $this->query('SELECT 1 FROM sqlite_master WHERE tbl_name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' AND name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'_'.$this->escape($index_name).'\' AND type=\'index\'');
-		return $this->has_rows($result);
+		return $this->num_rows($result) > 0;
 	}
 
 
@@ -394,7 +399,9 @@ class SqliteDBLayer implements DBLayer
 	{
 		// Grab table info
 		$result = $this->query('SELECT sql FROM sqlite_master WHERE tbl_name = \''.($no_prefix ? '' : $this->prefix).$this->escape($table_name).'\' ORDER BY type DESC') or error('Unable to fetch table information', __FILE__, __LINE__, $this->error());
-		if (!$this->has_rows($result))
+		$num_rows = $this->num_rows($result);
+
+		if ($num_rows == 0)
 			return;
 
 		$table = array();
diff --git a/include/email.php b/include/email.php
index b66b5844..4ef2ffa5 100644
--- a/include/email.php
+++ b/include/email.php
@@ -64,149 +64,7 @@ function encode_mail_text($str)
 //
 function bbcode2email($text, $wrap_length = 72)
 {
-	static $base_url;
-
-	if (!isset($base_url))
-		$base_url = get_base_url();
-
-	$text = pun_trim($text, "\t\n ");
-
-	$shortcut_urls = array(
-		'topic' => '/viewtopic.php?id=$1',
-		'post' => '/viewtopic.php?pid=$1#p$1',
-		'forum' => '/viewforum.php?id=$1',
-		'user' => '/profile.php?id=$1',
-	);
-
-	// Split code blocks and text so BBcode in codeblocks won't be touched
-	list($code, $text) = extract_blocks($text, '[code]', '[/code]');
-
-	// Strip all bbcodes, except the quote, url, img, email, code and list items bbcodes
-	$text = preg_replace(array(
-		'%\[/?(?!(?:quote|url|topic|post|user|forum|img|email|code|list|\*))[a-z]+(?:=[^\]]+)?\]%i',
-		'%\n\[/?list(?:=[^\]]+)?\]%i' // A separate regex for the list tags to get rid of some whitespace
-	), '', $text);
-
-	// Match the deepest nested bbcode
-	// An adapted example from Mastering Regular Expressions
-	$match_quote_regex = '%
-		\[(quote|\*|url|img|email|topic|post|user|forum)(?:=([^\]]+))?\]
-		(
-			(?>[^\[]*)
-			(?>
-				(?!\[/?\1(?:=[^\]]+)?\])
-				\[
-				[^\[]*
-			)*
-		)
-		\[/\1\]
-	%ix';
-
-	$url_index = 1;
-	$url_stack = array();
-	while (preg_match($match_quote_regex, $text, $matches))
-	{
-		// Quotes
-		if ($matches[1] == 'quote')
-		{
-			// Put '>' or '> ' at the start of a line
-			$replacement = preg_replace(
-				array('%^(?=\>)%m', '%^(?!\>)%m'),
-				array('>', '> '),
-				$matches[2].":\n".$matches[3]);
-		}
-
-		// List items
-		elseif ($matches[1] == '*')
-		{
-			$replacement = ' * '.$matches[3];
-		}
-
-		// URLs and emails
-		elseif (in_array($matches[1], array('url', 'email')))
-		{
-			if (!empty($matches[2]))
-			{
-				$replacement = '['.$matches[3].']['.$url_index.']';
-				$url_stack[$url_index] = $matches[2];
-				$url_index++;
-			}
-			else
-				$replacement = '['.$matches[3].']';
-		}
-
-		// Images
-		elseif ($matches[1] == 'img')
-		{
-			if (!empty($matches[2]))
-				$replacement = '['.$matches[2].']['.$url_index.']';
-			else
-				$replacement = '['.basename($matches[3]).']['.$url_index.']';
-
-			$url_stack[$url_index] = $matches[3];
-			$url_index++;
-		}
-
-		// Topic, post, forum and user URLs
-		elseif (in_array($matches[1], array('topic', 'post', 'forum', 'user')))
-		{
-			$url = isset($shortcut_urls[$matches[1]]) ? $base_url.$shortcut_urls[$matches[1]] : '';
-
-			if (!empty($matches[2]))
-			{
-				$replacement = '['.$matches[3].']['.$url_index.']';
-				$url_stack[$url_index] = str_replace('$1', $matches[2], $url);
-				$url_index++;
-			}
-			else
-				$replacement = '['.str_replace('$1', $matches[3], $url).']';
-		}
-
-		// Update the main text if there is a replacement
-		if (!is_null($replacement))
-		{
-			$text = str_replace($matches[0], $replacement, $text);
-			$replacement = null;
-		}
-	}
-
-	// Put code blocks and text together
-	if (isset($code))
-	{
-		$parts = explode("\1", $text);
-		$text = '';
-		foreach ($parts as $i => $part)
-		{
-			$text .= $part;
-			if (isset($code[$i]))
-				$text .= trim($code[$i], "\n\r");
-		}
-	}
-
-	// Put URLs at the bottom
-	if ($url_stack)
-	{
-		$text .= "\n\n";
-		foreach ($url_stack as $i => $url)
-			$text .= "\n".' ['.$i.']: '.$url;
-	}
-
-	// Wrap lines if $wrap_length is higher than -1
-	if ($wrap_length > -1)
-	{
-		// Split all lines and wrap them individually
-		$parts = explode("\n", $text);
-		foreach ($parts as $k => $part)
-		{
-			preg_match('%^(>+ )?(.*)%', $part, $matches);
-			$parts[$k] = wordwrap($matches[1].$matches[2], $wrap_length -
-				strlen($matches[1]), "\n".$matches[1]);
-		}
-
-		return implode("\n", $parts);
-	}
-	else
-		return $text;
+	return wordwrap($text, 72);
 }
 
 
diff --git a/include/functions.php b/include/functions.php
index 62544cbf..ace29349 100644
--- a/include/functions.php
+++ b/include/functions.php
@@ -8,6 +8,15 @@
 
 
 
+//
+// Return current timestamp (with microseconds) as a float
+//
+function get_microtime()
+{
+	list($usec, $sec) = explode(' ', microtime());
+	return ((float)$usec + (float)$sec);
+}
+
 //
 // Cookie stuff!
 //
@@ -32,7 +41,7 @@ function check_cookie(&$pun_user)
 	if (isset($cookie) && $cookie['user_id'] > 1 && $cookie['expiration_time'] > $now)
 	{
 		// If the cookie has been tampered with
-		$is_authorized = hash_equals(forum_hmac($cookie['user_id'].'|'.$cookie['expiration_time'], $cookie_seed.'_cookie_hash'), $cookie['cookie_hash']);
+		$is_authorized = pun_hash_equals(forum_hmac($cookie['user_id'].'|'.$cookie['expiration_time'], $cookie_seed.'_cookie_hash'), $cookie['cookie_hash']);
 		if (!$is_authorized)
 		{
 			$expire = $now + 31536000; // The cookie expires after a year
@@ -47,7 +56,7 @@ function check_cookie(&$pun_user)
 		$pun_user = $db->fetch_assoc($result);
 
 		// If user authorisation failed
-		$is_authorized = hash_equals(forum_hmac($pun_user['password'], $cookie_seed.'_password_hash'), $cookie['password_hash']);
+		$is_authorized = pun_hash_equals(forum_hmac($pun_user['password'], $cookie_seed.'_password_hash'), $cookie['password_hash']);
 		if (!isset($pun_user['id']) || !$is_authorized)
 		{
 			$expire = $now + 31536000; // The cookie expires after a year
@@ -154,8 +163,8 @@ function authenticate_user($user, $password, $password_is_hash = false)
 	$result = $db->query('SELECT u.*, g.*, o.logged, o.idle FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id LEFT JOIN '.$db->prefix.'online AS o ON o.user_id=u.id WHERE '.(is_int($user) ? 'u.id='.intval($user) : 'u.username=\''.$db->escape($user).'\'')) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
 	$pun_user = $db->fetch_assoc($result);
 
-	$is_password_authorized = hash_equals($password, $pun_user['password']);
-	$is_hash_authorized = flux_password_verify($password, $pun_user['password']);
+	$is_password_authorized = pun_hash_equals($password, $pun_user['password']);
+	$is_hash_authorized = pun_hash_equals(pun_hash($password), $pun_user['password']);
 
 	if (!isset($pun_user['id']) ||
 		($password_is_hash && !$is_password_authorized ||
@@ -264,7 +273,7 @@ function set_default_user()
 
 	// Fetch guest user
 	$result = $db->query('SELECT u.*, g.*, o.logged, o.last_post, o.last_search FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'groups AS g ON u.group_id=g.g_id LEFT JOIN '.$db->prefix.'online AS o ON o.ident=\''.$db->escape($remote_addr).'\' WHERE u.id=1') or error('Unable to fetch guest information', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
+	if (!$db->num_rows($result))
 		exit('Unable to fetch guest information. Your database must contain both a guest user and a guest user group.');
 
 	$pun_user = $db->fetch_assoc($result);
@@ -305,11 +314,37 @@ function set_default_user()
 
 
 //
-// SHA1 HMAC
+// SHA1 HMAC with PHP 4 fallback
 //
 function forum_hmac($data, $key, $raw_output = false)
 {
-	return hash_hmac('sha1', $data, $key, $raw_output);
+	if (function_exists('hash_hmac'))
+		return hash_hmac('sha1', $data, $key, $raw_output);
+
+	// If key size more than blocksize then we hash it once
+	if (strlen($key) > 64)
+		$key = pack('H*', sha1($key)); // we have to use raw output here to match the standard
+
+	// Ensure we're padded to exactly one block boundary
+	$key = str_pad($key, 64, chr(0x00));
+
+	$hmac_opad = str_repeat(chr(0x5C), 64);
+	$hmac_ipad = str_repeat(chr(0x36), 64);
+
+	// Do inner and outer padding
+	for ($i = 0;$i < 64;$i++) {
+		$hmac_opad[$i] = $hmac_opad[$i] ^ $key[$i];
+		$hmac_ipad[$i] = $hmac_ipad[$i] ^ $key[$i];
+	}
+
+	// Finally, calculate the HMAC
+	$hash = sha1($hmac_opad.pack('H*', sha1($hmac_ipad.$data)));
+
+	// If we want raw output then we need to pack the final result
+	if ($raw_output)
+		$hash = pack('H*', $hash);
+
+	return $hash;
 }
 
 
@@ -338,7 +373,10 @@ function forum_setcookie($name, $value, $expire)
 	// Enable sending of a P3P header
 	header('P3P: CP="CUR ADM"');
 
-	setcookie($name, $value, $expire, $cookie_path, $cookie_domain, $cookie_secure, true);
+	if (version_compare(PHP_VERSION, '5.2.0', '>='))
+		setcookie($name, $value, $expire, $cookie_path, $cookie_domain, $cookie_secure, true);
+	else
+		setcookie($name, $value, $expire, $cookie_path.'; HttpOnly', $cookie_domain, $cookie_secure);
 }
 
 
@@ -449,7 +487,7 @@ function check_username($username, $exclude_id = null)
 
 	$result = $db->query('SELECT username FROM '.$db->prefix.'users WHERE (UPPER(username)=UPPER(\''.$db->escape($username).'\') OR UPPER(username)=UPPER(\''.$db->escape(ucp_preg_replace('%[^\p{L}\p{N}]%u', '', $username)).'\')) AND id>1'.$query) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
 
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 	{
 		$busy = $db->result($result);
 		$errors[] = $lang_register['Username dupe 1'].' '.pun_htmlspecialchars($busy).'. '.$lang_register['Username dupe 2'];
@@ -574,27 +612,6 @@ function generate_page_title($page_title, $p = null)
 }
 
 
-//
-// Generate breadcrumb navigation
-//
-function generate_crumbs($crumbs)
-{
-	$last_key = end(array_keys($crumbs));
-
-	$crumbs_markup = '<ol class="crumbs">';
-	foreach ($crumbs as $idx => $crumb)
-	{
-		$crumbs_markup .= '<li>'.($idx ? '<span>»&#160;</span>' : '');
-		$item = is_array($crumb) ? '<a href="'.$crumb[1].'">'.pun_htmlspecialchars($crumb[0]).'</a>' : pun_htmlspecialchars($crumb);
-		$crumbs_markup .= ($idx == $last_key) ? '<strong>'.$item.'</strong>' : $item;
-		$crumbs_markup .= '</li>';
-	}
-	$crumbs_markup .= '</ol>';
-
-	return $crumbs_markup;
-}
-
-
 //
 // Save array of tracked topics in cookie
 //
@@ -682,7 +699,7 @@ function update_forum($forum_id)
 	$num_posts = $num_posts + $num_topics; // $num_posts is only the sum of all replies (we have to add the topic posts)
 
 	$result = $db->query('SELECT last_post, last_post_id, last_poster FROM '.$db->prefix.'topics WHERE forum_id='.$forum_id.' AND moved_to IS NULL ORDER BY last_post DESC LIMIT 1') or error('Unable to fetch last_post/last_post_id/last_poster', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result)) // There are topics in the forum
+	if ($db->num_rows($result)) // There are topics in the forum
 	{
 		list($last_post, $last_post_id, $last_poster) = $db->fetch_row($result);
 
@@ -833,7 +850,7 @@ function get_title($user)
 	static $ban_list;
 
 	// If not already built in a previous call, build an array of lowercase banned usernames
-	if (!isset($ban_list))
+	if (empty($ban_list))
 	{
 		$ban_list = array();
 
@@ -927,7 +944,7 @@ function paginate($num_pages, $cur_page, $link)
 //
 function message($message, $no_back_link = false, $http_status = null)
 {
-	global $db, $lang_common, $pun_config, $tpl_main, $pun_user;
+	global $db, $lang_common, $pun_config, $pun_start, $tpl_main, $pun_user;
 
 	// Did we receive a custom header?
 	if(!is_null($http_status)) {
@@ -1113,71 +1130,6 @@ function validate_redirect($redirect_url, $fallback_url)
 }
 
 
-//
-// Compute the hash of a password
-// using a secure password hashing algorithm, if available
-// As of PHP 7.2, this is BLOWFISH.
-//
-function flux_password_hash($pass)
-{
-	global $password_hash_cost;
-
-	return password_hash($pass, PASSWORD_DEFAULT, array('cost' => $password_hash_cost));
-}
-
-
-//
-// Verify that $pass and $hash match
-// This supports any password hashing algorithm
-// used by flux_password_hash, but is also
-// backwards-compatible with older versions of this software.
-//
-function flux_password_verify($pass, $hash)
-{
-	if ($hash[0] == '#')
-	{
-		// MD5 from 1.2
-		if (substr($hash, 0, 5) == '#MD5#')
-		{
-			$pass = md5($pass);
-			$hash = substr($hash, 5);
-		}
-		// SHA1-With-Salt from 1.3
-		else if (substr($hash, 0, 8) == '#SHA1-S#')
-		{
-			preg_match('/^#SHA1-S#(.+)#(.+)$/', $hash, $matches);
-			list(, $salt, $hash) = $matches;
-			$pass = sha1($salt.sha1($pass));
-		}
-		// SHA1-Without-Salt from 1.4
-		else if (substr($hash, 0, 6) == '#SHA1#')
-		{
-			$pass = sha1($pass);
-			$hash = substr($hash, 6);
-		}
-	}
-
-	// Support current password standard
-	return password_verify($pass, $hash);
-}
-
-
-//
-// Check if $hash is outdated and needs to be rehashed
-//
-function flux_password_needs_rehash($hash)
-{
-	global $password_hash_cost;
-
-	// Check for legacy password (md5 or sha1 hash)
-	if ($hash[0] === '#')
-		return true;
-
-	// Check for out-of-date hash type or cost
-	return password_needs_rehash($hash, PASSWORD_DEFAULT, array('cost' => $password_hash_cost));
-}
-
-
 //
 // Generate a random password of length $len
 // Compatibility wrapper for random_key
@@ -1200,11 +1152,24 @@ function pun_hash($str)
 //
 // Compare two strings in constant time
 // Inspired by WordPress
-// @deprecated
 //
 function pun_hash_equals($a, $b)
 {
-	return hash_equals((string) $a, (string) $b);
+	if (function_exists('hash_equals'))
+		return hash_equals((string) $a, (string) $b);
+
+	$a_length = strlen($a);
+
+	if ($a_length !== strlen($b))
+		return false;
+
+	$result = 0;
+
+	// Do not attempt to "optimize" this.
+	for ($i = 0; $i < $a_length; $i++)
+		$result |= ord($a[$i]) ^ ord($b[$i]);
+
+	return $result === 0;
 }
 
 
@@ -1229,7 +1194,7 @@ function check_csrf($token)
 {
 	global $lang_common;
 
-	$is_hash_authorized = hash_equals($token, pun_csrf_token());
+	$is_hash_authorized = pun_hash_equals($token, pun_csrf_token());
 
 	if (!isset($token) || !$is_hash_authorized)
 		message($lang_common['Bad csrf hash'], false, '404 Not Found');
@@ -1278,7 +1243,18 @@ function pun_htmlspecialchars($str)
 //
 function pun_htmlspecialchars_decode($str)
 {
-	return htmlspecialchars_decode($str, ENT_QUOTES);
+	if (function_exists('htmlspecialchars_decode'))
+		return htmlspecialchars_decode($str, ENT_QUOTES);
+
+	static $translations;
+	if (!isset($translations))
+	{
+		$translations = get_html_translation_table(HTML_SPECIALCHARS, ENT_QUOTES);
+		$translations['&#039;'] = '\''; // get_html_translation_table doesn't include &#039; which is what htmlspecialchars translates ' to, but apparently that is okay?! http://bugs.php.net/bug.php?id=25927
+		$translations = array_flip($translations);
+	}
+
+	return strtr($str, $translations);
 }
 
 
@@ -1694,6 +1670,35 @@ H2 {MARGIN: 0; COLOR: #FFFFFF; BACKGROUND-COLOR: #B84623; FONT-SIZE: 1.1em; PADD
 }
 
 
+//
+// Unset any variables instantiated as a result of register_globals being enabled
+//
+function forum_unregister_globals()
+{
+	$register_globals = ini_get('register_globals');
+	if ($register_globals === '' || $register_globals === '0' || strtolower($register_globals) === 'off')
+		return;
+
+	// Prevent script.php?GLOBALS[foo]=bar
+	if (isset($_REQUEST['GLOBALS']) || isset($_FILES['GLOBALS']))
+		exit('I\'ll have a steak sandwich and... a steak sandwich.');
+
+	// Variables that shouldn't be unset
+	$no_unset = array('GLOBALS', '_GET', '_POST', '_COOKIE', '_REQUEST', '_SERVER', '_ENV', '_FILES');
+
+	// Remove elements in $GLOBALS that are present in any of the superglobals
+	$input = array_merge($_GET, $_POST, $_COOKIE, $_SERVER, $_ENV, $_FILES, isset($_SESSION) && is_array($_SESSION) ? $_SESSION : array());
+	foreach ($input as $k => $v)
+	{
+		if (!in_array($k, $no_unset) && isset($GLOBALS[$k]))
+		{
+			unset($GLOBALS[$k]);
+			unset($GLOBALS[$k]); // Double unset to circumvent the zend_hash_del_key_or_index hole in PHP <4.4.3 and <5.1.4
+		}
+	}
+}
+
+
 //
 // Removes any "bad" characters (characters which mess with the display of a page, are invisible, etc) from user input
 //
@@ -2057,8 +2062,8 @@ function url_valid($url)
 //
 function ucp_preg_replace($pattern, $replace, $subject, $callback = false)
 {
-	if ($callback)
-		$replaced = preg_replace_callback($pattern, $replace, $subject);
+	if($callback)
+		$replaced = preg_replace_callback($pattern, create_function('$matches', 'return '.$replace.';'), $subject);
 	else
 		$replaced = preg_replace($pattern, $replace, $subject);
 
diff --git a/include/parser.php b/include/parser.php
index fd852dda..3d0f9f4b 100644
--- a/include/parser.php
+++ b/include/parser.php
@@ -64,6 +64,7 @@ $smilies = array(
 //
 function preparse_bbcode($text, &$errors, $is_signature = false)
 {
+	return $text;
 	global $pun_config, $lang_common, $lang_post, $re_list;
 
 	// Remove empty tags
@@ -95,11 +96,7 @@ function preparse_bbcode($text, &$errors, $is_signature = false)
 		list($inside, $text) = extract_blocks($text, '[code]', '[/code]');
 
 	// Tidy up lists
-	$temp = preg_replace_callback(
-		$re_list,
-		function ($match) { return preparse_list_tag($match[2], $match[1]); },
-		$text
-	);
+	$temp = preg_replace_callback($re_list, create_function('$matches', 'return preparse_list_tag($matches[2], $matches[1]);'), $text);
 
 	// If the regex failed
 	if (is_null($temp))
@@ -164,7 +161,7 @@ function strip_empty_bbcode($text)
 		list($inside, $text) = extract_blocks($text, '[code]', '[/code]');
 
 	// Remove empty tags
-	while (!is_null($new_text = preg_replace('%\[(b|u|s|c|ins|del|em|i|h|colou?r|quote|img|url|email|list|topic|post|forum|user)(?:\=[^\]]*)?\]\s*\[/\1\]%', '', $text)))
+	while (!is_null($new_text = preg_replace('%\[(b|u|s|ins|del|em|i|h|colou?r|quote|img|url|email|list|topic|post|forum|user)(?:\=[^\]]*)?\]\s*\[/\1\]%', '', $text)))
 	{
 		if ($new_text != $text)
 			$text = $new_text;
@@ -208,7 +205,7 @@ function preparse_tags($text, &$errors, $is_signature = false)
 	// Start off by making some arrays of bbcode tags and what we need to do with each one
 
 	// List of all the tags
-	$tags = array('quote', 'code', 'c', 'b', 'i', 'u', 's', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'img', 'list', '*', 'h', 'topic', 'post', 'forum', 'user');
+	$tags = array('quote', 'code', 'b', 'i', 'u', 's', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'img', 'list', '*', 'h', 'topic', 'post', 'forum', 'user');
 	// List of tags that we need to check are open (You could not put b,i,u in here then illegal nesting like [b][i][/b][/i] would be allowed)
 	$tags_opened = $tags;
 	// and tags we need to check are closed (the same as above, added it just in case)
@@ -216,7 +213,7 @@ function preparse_tags($text, &$errors, $is_signature = false)
 	// Tags we can nest and the depth they can be nested to
 	$tags_nested = array('quote' => $pun_config['o_quote_depth'], 'list' => 5, '*' => 5);
 	// Tags to ignore the contents of completely (just code)
-	$tags_ignore = array('code', 'c');
+	$tags_ignore = array('code');
 	// Tags not allowed
 	$tags_forbidden = array();
 	// Block tags, block tags can only go within another block tag, they cannot be in a normal tag
@@ -229,7 +226,7 @@ function preparse_tags($text, &$errors, $is_signature = false)
 	$tags_quotes = array('url', 'email', 'img', 'topic', 'post', 'forum', 'user');
 	// Tags we limit bbcode in
 	$tags_limit_bbcode = array(
-		'*' 	=> array('b', 'i', 'u', 's', 'c', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'list', 'img', 'code', 'topic', 'post', 'forum', 'user'),
+		'*' 	=> array('b', 'i', 'u', 's', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'list', 'img', 'code', 'topic', 'post', 'forum', 'user'),
 		'list' 	=> array('*'),
 		'url' 	=> array('img'),
 		'email' => array('img'),
@@ -238,7 +235,7 @@ function preparse_tags($text, &$errors, $is_signature = false)
 		'forum' => array('img'),
 		'user'  => array('img'),
 		'img' 	=> array(),
-		'h'		=> array('b', 'i', 'u', 's', 'c', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'topic', 'post', 'forum', 'user'),
+		'h'		=> array('b', 'i', 'u', 's', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'topic', 'post', 'forum', 'user'),
 	);
 	// Tags we can automatically fix bad nesting
 	$tags_fix = array('quote', 'b', 'i', 'u', 's', 'ins', 'del', 'em', 'color', 'colour', 'url', 'email', 'h', 'topic', 'post', 'forum', 'user');
@@ -644,11 +641,7 @@ function preparse_list_tag($content, $type = '*')
 
 	if (strpos($content,'[list') !== false)
 	{
-		$content = preg_replace_callback(
-			$re_list,
-			function ($match) { return preparse_list_tag($match[2], $match[1]); },
-			$content
-		);
+		$content = preg_replace_callback($re_list, create_function('$matches', 'return preparse_list_tag($matches[2], $matches[1]);'), $content);
 	}
 
 	$items = explode('[*]', str_replace('\"', '"', $content));
@@ -742,11 +735,7 @@ function handle_list_tag($content, $type = '*')
 
 	if (strpos($content,'[list') !== false)
 	{
-		$content = preg_replace_callback(
-			$re_list,
-			function ($match) { return handle_list_tag($match[2], $match[1]); },
-			$content
-		);
+		$content = preg_replace_callback($re_list, create_function('$matches', 'return handle_list_tag($matches[2], $matches[1]);'), $content);
 	}
 
 	$content = preg_replace('#\s*\[\*\](.*?)\[/\*\]\s*#s', '<li><p>$1</p></li>', pun_trim($content));
@@ -773,28 +762,19 @@ function do_bbcode($text, $is_signature = false)
 	if (strpos($text, '[quote') !== false)
 	{
 		$text = preg_replace('%\[quote\]\s*%', '</p><div class="quotebox"><blockquote><div><p>', $text);
-		$text = preg_replace_callback(
-			'%\[quote=(&quot;|&\#039;|"|\'|)([^\r\n]*?)\\1\]%s',
-			function ($match) use ($lang_common) {
-				return '</p><div class="quotebox"><cite>'.
-					str_replace(array('[', '\"'), array('&#91;', '"'), $match[2]).
-					' '.$lang_common['wrote'].'</cite><blockquote><div><p>';
-			},
-			$text
-		);
+		$text = preg_replace_callback('%\[quote=(&quot;|&\#039;|"|\'|)([^\r\n]*?)\\1\]%s', create_function('$matches', 'global $lang_common; return "</p><div class=\"quotebox\"><cite>".str_replace(array(\'[\', \'\\"\'), array(\'&#91;\', \'"\'), $matches[2])." ".$lang_common[\'wrote\']."</cite><blockquote><div><p>";'), $text);
 		$text = preg_replace('%\s*\[\/quote\]%S', '</p></div></blockquote></div><p>', $text);
 	}
 	if (!$is_signature)
 	{
 		$pattern_callback[] = $re_list;
-		$replace_callback[] = function ($matches) { return handle_list_tag($matches[2], $matches[1]); };
+		$replace_callback[] = 'handle_list_tag($matches[2], $matches[1])';
 	}
 
 	$pattern[] = '%\[b\](.*?)\[/b\]%ms';
 	$pattern[] = '%\[i\](.*?)\[/i\]%ms';
 	$pattern[] = '%\[u\](.*?)\[/u\]%ms';
 	$pattern[] = '%\[s\](.*?)\[/s\]%ms';
-	$pattern[] = '%\[c\](.*?)\[/c\]%ms';
 	$pattern[] = '%\[del\](.*?)\[/del\]%ms';
 	$pattern[] = '%\[ins\](.*?)\[/ins\]%ms';
 	$pattern[] = '%\[em\](.*?)\[/em\]%ms';
@@ -805,7 +785,6 @@ function do_bbcode($text, $is_signature = false)
 	$replace[] = '<em>$1</em>';
 	$replace[] = '<span class="bbu">$1</span>';
 	$replace[] = '<span class="bbs">$1</span>';
-	$replace[] = '<code class="code">$1</code>';
 	$replace[] = '<del>$1</del>';
 	$replace[] = '<ins>$1</ins>';
 	$replace[] = '<em>$1</em>';
@@ -818,13 +797,13 @@ function do_bbcode($text, $is_signature = false)
 		$pattern_callback[] = '%\[img=([^\[]*?)\]((ht|f)tps?://)([^\s<"]*?)\[/img\]%';
 		if ($is_signature)
 		{
-			$replace_callback[] = function ($matches) { return handle_img_tag($matches[1].$matches[3], true); };
-			$replace_callback[] = function ($matches) { return handle_img_tag($matches[2].$matches[4], true, $matches[1]); };
+			$replace_callback[] = 'handle_img_tag($matches[1].$matches[3], true)';
+			$replace_callback[] = 'handle_img_tag($matches[2].$matches[4], true, $matches[1])';
 		}
 		else
 		{
-			$replace_callback[] = function ($matches) { return handle_img_tag($matches[1].$matches[3], false); };
-			$replace_callback[] = function ($matches) { return handle_img_tag($matches[2].$matches[4], false, $matches[1]); };
+			$replace_callback[] = 'handle_img_tag($matches[1].$matches[3], false)';
+			$replace_callback[] = 'handle_img_tag($matches[2].$matches[4], false, $matches[1])';
 		}
 	}
 
@@ -841,25 +820,25 @@ function do_bbcode($text, $is_signature = false)
 	$pattern_callback[] = '%\[user\]([1-9]\d*)\[/user\]%';
 	$pattern_callback[] = '%\[user=([1-9]\d*)\](.*?)\[/user\]%';
 
-	$replace_callback[] = function ($matches) { return handle_url_tag($matches[1]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag($matches[1], $matches[2]); };
+	$replace_callback[] = 'handle_url_tag($matches[1])';
+	$replace_callback[] = 'handle_url_tag($matches[1], $matches[2])';
 	$replace[] = '<a href="mailto:$1">$1</a>';
 	$replace[] = '<a href="mailto:$1">$2</a>';
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/viewtopic.php?id='.$matches[1]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/viewtopic.php?id='.$matches[1], $matches[2]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/viewtopic.php?pid='.$matches[1].'#p'.$matches[1]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/viewtopic.php?pid='.$matches[1].'#p'.$matches[1], $matches[2]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/viewforum.php?id='.$matches[1]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/viewforum.php?id='.$matches[1], $matches[2]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/profile.php?id='.$matches[1]); };
-	$replace_callback[] = function ($matches) { return handle_url_tag(get_base_url(true).'/profile.php?id='.$matches[1], $matches[2]); };
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/viewtopic.php?id=\'.$matches[1])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/viewtopic.php?id=\'.$matches[1], $matches[2])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/viewtopic.php?pid=\'.$matches[1].\'#p\'.$matches[1])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/viewtopic.php?pid=\'.$matches[1].\'#p\'.$matches[1], $matches[2])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/viewforum.php?id=\'.$matches[1])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/viewforum.php?id=\'.$matches[1], $matches[2])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/profile.php?id=\'.$matches[1])';
+	$replace_callback[] = 'handle_url_tag(\''.get_base_url(true).'/profile.php?id=\'.$matches[1], $matches[2])';
 
 	// This thing takes a while! :)
 	$text = preg_replace($pattern, $replace, $text);
 	$count = count($pattern_callback);
 	for($i = 0 ; $i < $count ; $i++)
 	{
-		$text = preg_replace_callback($pattern_callback[$i], $replace_callback[$i], $text);
+		$text = preg_replace_callback($pattern_callback[$i], create_function('$matches', 'return '.$replace_callback[$i].';'), $text);
 	}
 	return $text;
 }
@@ -871,16 +850,8 @@ function do_bbcode($text, $is_signature = false)
 function do_clickable($text)
 {
 	$text = ' '.$text;
-	$text = ucp_preg_replace_callback(
-		'%(?<=[\s\]\)])(<)?(\[)?(\()?([\'"]?)(https?|ftp|news){1}://([\p{L}\p{N}\-]+\.([\p{L}\p{N}\-]+\.)*[\p{L}\p{N}]+(:[0-9]+)?(/(?:[^\s\[]*[^\s.,?!\[;:-])?)?)\4(?(3)(\)))(?(2)(\]))(?(1)(>))(?![^\s]*\[/(?:url|img)\])%ui',
-		function ($matches) { return stripslashes($matches[1].$matches[2].$matches[3].$matches[4]).handle_url_tag($matches[5].'://'.$matches[6], $matches[5].'://'.$matches[6], true).stripslashes($matches[4].forum_array_key($matches, 10).forum_array_key($matches, 11).forum_array_key($matches, 12)); },
-		$text
-	);
-	$text = ucp_preg_replace_callback(
-		'%(?<=[\s\]\)])(<)?(\[)?(\()?([\'"]?)(www|ftp)\.(([\p{L}\p{N}\-]+\.)+[\p{L}\p{N}]+(:[0-9]+)?(/(?:[^\s\[]*[^\s.,?!\[;:-])?)?)\4(?(3)(\)))(?(2)(\]))(?(1)(>))(?![^\s]*\[/(?:url|img)\])%ui',
-		function ($matches) { return stripslashes($matches[1].$matches[2].$matches[3].$matches[4]).handle_url_tag($matches[5].'.'.$matches[6], $matches[5].'.'.$matches[6], true).stripslashes($matches[4].forum_array_key($matches, 10).forum_array_key($matches, 11).forum_array_key($matches, 12)); },
-		$text
-	);
+	$text = ucp_preg_replace_callback('%(?<=[\s\]\)])(<)?(\[)?(\()?([\'"]?)(https?|ftp|news){1}://([\p{L}\p{N}\-]+\.([\p{L}\p{N}\-]+\.)*[\p{L}\p{N}]+(:[0-9]+)?(/(?:[^\s\[]*[^\s.,?!\[;:-])?)?)\4(?(3)(\)))(?(2)(\]))(?(1)(>))(?![^\s]*\[/(?:url|img)\])%ui', 'stripslashes($matches[1].$matches[2].$matches[3].$matches[4]).handle_url_tag($matches[5]."://".$matches[6], $matches[5]."://".$matches[6], true).stripslashes($matches[4].forum_array_key($matches, 10).forum_array_key($matches, 11).forum_array_key($matches, 12))', $text);
+	$text = ucp_preg_replace_callback('%(?<=[\s\]\)])(<)?(\[)?(\()?([\'"]?)(www|ftp)\.(([\p{L}\p{N}\-]+\.)+[\p{L}\p{N}]+(:[0-9]+)?(/(?:[^\s\[]*[^\s.,?!\[;:-])?)?)\4(?(3)(\)))(?(2)(\]))(?(1)(>))(?![^\s]*\[/(?:url|img)\])%ui','stripslashes($matches[1].$matches[2].$matches[3].$matches[4]).handle_url_tag($matches[5].".".$matches[6], $matches[5].".".$matches[6], true).stripslashes($matches[4].forum_array_key($matches, 10).forum_array_key($matches, 11).forum_array_key($matches, 12))', $text);
 
 	return substr($text, 1);
 }
@@ -919,46 +890,25 @@ function do_smilies($text)
 //
 function parse_message($text, $hide_smilies)
 {
-	global $pun_config, $lang_common, $pun_user;
+	global $pun_config, $cur_post;
+	static $textile = null;
 
 	if ($pun_config['o_censoring'] == '1')
+	{
 		$text = censor_words($text);
+	}
 
-	// Convert applicable characters to HTML entities
-	$text = pun_htmlspecialchars($text);
-
-	// If the message contains a code tag we have to split it up (text within [code][/code] shouldn't be touched)
-	if (strpos($text, '[code]') !== false && strpos($text, '[/code]') !== false)
-		list($inside, $text) = extract_blocks($text, '[code]', '[/code]');
-
-	if ($pun_config['p_message_bbcode'] == '1' && strpos($text, '[') !== false && strpos($text, ']') !== false)
-		$text = do_bbcode($text);
-
-	if ($pun_config['o_smilies'] == '1' && $pun_user['show_smilies'] == '1' && $hide_smilies == '0')
-		$text = do_smilies($text);
-
-	// Deal with newlines, tabs and multiple spaces
-	$pattern = array("\n", "\t", '  ', '  ');
-	$replace = array('<br />', '&#160; &#160; ', '&#160; ', ' &#160;');
-	$text = str_replace($pattern, $replace, $text);
+	if ($textile === null)
+    {
+		$textile = new Textpattern\Fluxbb\Textile\Parser();
+    }
 
-	// If we split up the message before we have to concatenate it together again (code tags)
-	if (isset($inside))
+	if (defined('PUN_NEW_MEMBER') && $cur_post['group_id'] == PUN_NEW_MEMBER)
 	{
-		$parts = explode("\1", $text);
-		$text = '';
-		foreach ($parts as $i => $part)
-		{
-			$text .= $part;
-			if (isset($inside[$i]))
-			{
-				$num_lines = (substr_count($inside[$i], "\n"));
-				$text .= '</p><div class="codebox"><pre'.(($num_lines > 28) ? ' class="vscroll"' : '').'><code>'.pun_trim($inside[$i], "\n\r").'</code></pre></div><p>';
-			}
-		}
+		return $textile->setImages(false)->parse($text);
 	}
 
-	return clean_paragraphs($text);
+	return $textile->setImages(true)->parse($text);
 }
 
 
@@ -993,25 +943,23 @@ function clean_paragraphs($text)
 //
 function parse_signature($text)
 {
-	global $pun_config, $lang_common, $pun_user;
+	global $pun_config, $cur_post;
+	static $textile = null;
 
 	if ($pun_config['o_censoring'] == '1')
+	{
 		$text = censor_words($text);
+	}
 
-	// Convert applicable characters to HTML entities
-	$text = pun_htmlspecialchars($text);
-
-	if ($pun_config['p_sig_bbcode'] == '1' && strpos($text, '[') !== false && strpos($text, ']') !== false)
-		$text = do_bbcode($text, true);
-
-	if ($pun_config['o_smilies_sig'] == '1' && $pun_user['show_smilies'] == '1')
-		$text = do_smilies($text);
-
+	if ($textile === null)
+	{
+		$textile = new Textpattern\Fluxbb\Textile\Parser();
+	}
 
-	// Deal with newlines, tabs and multiple spaces
-	$pattern = array("\n", "\t", '  ', '  ');
-	$replace = array('<br />', '&#160; &#160; ', '&#160; ', ' &#160;');
-	$text = str_replace($pattern, $replace, $text);
+	if (defined('PUN_NEW_MEMBER') && $cur_post['group_id'] == PUN_NEW_MEMBER)
+	{
+		return $textile->setImages(false)->parse($text);
+	}
 
-	return clean_paragraphs($text);
+	return $textile->setImages(true)->parse($text);
 }
diff --git a/include/search_idx.php b/include/search_idx.php
index 6ada8ef6..49fe2572 100644
--- a/include/search_idx.php
+++ b/include/search_idx.php
@@ -286,7 +286,7 @@ function strip_search_index($post_ids)
 		{
 			$result = $db->query('SELECT word_id FROM '.$db->prefix.'search_matches WHERE post_id IN('.$post_ids.') GROUP BY word_id') or error('Unable to fetch search index word match', __FILE__, __LINE__, $db->error());
 
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 			{
 				$word_ids = '';
 				while ($row = $db->fetch_row($result))
@@ -294,7 +294,7 @@ function strip_search_index($post_ids)
 
 				$result = $db->query('SELECT word_id FROM '.$db->prefix.'search_matches WHERE word_id IN('.$word_ids.') GROUP BY word_id HAVING COUNT(word_id)=1') or error('Unable to fetch search index word match', __FILE__, __LINE__, $db->error());
 
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 				{
 					$word_ids = '';
 					while ($row = $db->fetch_row($result))
diff --git a/include/spambarrier.php b/include/spambarrier.php
new file mode 100644
index 00000000..31eaa2cb
--- /dev/null
+++ b/include/spambarrier.php
@@ -0,0 +1,366 @@
+<?php
+/*
+// *********************************
+// Based on code originally written by Smurf_Minions (http://guildwarsholland.nl/)
+// Modified by sklerder (sklerder -at- orange.fr)
+// Last Modified: 2012/11/26
+// Version 1.0.6
+// *********************************
+*/
+define('NOT_SPAM', 0);
+define('HONEYPOT_SPAM', 1);
+define('BLACKLIST_SPAM', 2);
+define('DNSBL_SPAM', 3);
+
+
+//
+// Log registration details
+//
+function log_register_details($email, $membersIP, $req_username, $spam, $botcheck, $info)
+{
+	/*
+	This function log the details on the registration attempt (details concerning the user)
+	*/
+
+	global $db;
+	global $timezone;
+	global $email_setting;
+	global $errors;
+
+
+
+
+
+
+
+	// Log the register attempt
+ 	$db->query('INSERT INTO '.$db->prefix.'test_registrations (username, email, email_setting, timezone, ip, referer, user_agent, date, spam, s_errors, count_errors, botcheck, infos) VALUES(\''.$db->escape($req_username).'\', \''.$db->escape($email).'\', '.$email_setting.', '.$timezone.', \''.get_remote_address().'\', \''.$db->escape($_SERVER['HTTP_REFERER']).'\', \''.$db->escape($_SERVER['HTTP_USER_AGENT']).'\', '.time().', '.$spam.', \''.$db->escape($s_errors).'\', '.count($errors).', '.$botcheck.', \''.$db->escape($info).'\')') or error('Unable to log user registration', __FILE__, __LINE__, $db->error());
+
+
+}
+//
+// End Log registration details
+//
+
+
+
+
+//
+// BEGIN check DNSBL
+//
+
+function sb_check_dnsbl($ipAddress, $username)
+{
+/*
+// It might be interesting to weight the results based on the number of servers surveyed
+*/
+	// $dnsbl = 'sbl.spamhaus.org, xbl.spamhaus.org, b.barracudacentral.org, opm.tornevall.org';
+	global $pun_config;
+	$email = '';
+	$dnsbl = $pun_config['o_sb_dnsbl_names'];
+	$dnsbl_lists = explode(",", preg_replace('/\s+/', '', $dnsbl));
+	$reverse_ip = implode(".", array_reverse(explode(".", $ipAddress)));
+	$check = 0;
+	$count = 0;
+	$attempt = '(';
+
+	foreach($dnsbl_lists as $list)
+	{
+		if (checkdnsrr($reverse_ip.".".$list.".", "A"))
+		{
+			$check = 11;
+			$ckdnsflag = 1;
+		}
+		else
+		{
+			$ckdnsflag = 0;
+		}
+		$count += 1;
+		($count > 1) ? $attempt .= ',' : '';
+		$attempt .= $list.':'.$ckdnsflag;
+	}
+
+	$attempt .= ')';
+	$result=array('check' => $check, 'attempt' => $attempt);
+	return $result;
+}
+
+//
+// END check DNSBL
+//
+
+//
+// CheckStopForumSpam BEGIN
+//
+
+function sb_stopforumspam_check($emailAddress, $ipAddress, $user_Name)
+{
+/*
+// ReturnCodes :
+// 0 : Not flagged as spam
+// 1 : IP registered at SFS
+// 2 : Email registered at SFS
+// 3 : Username registered at SFS (not used)
+// 4 : Service unavailable
+// 5 : IP & Email not set
+// 6 : Undefined result
+*/
+
+  // Initiate and declare spambot as value 0 - as we are just getting started
+  $spambot = 0;
+	if ((!$ipAddress == "" ) || (!$emailAddress == ""))
+	{
+		$url = 'https://www.stopforumspam.com/api?ip='. $ipAddress .'&email='. $emailAddress .'&username=' . $user_Name .'&f=json';
+		$data1 = @file_get_contents($url);
+		$data = json_decode($data1);
+
+		// First, check if SFS server is up
+		if((isset($data->error)) or ($data == Null))
+		{
+			if($data == Null)
+			{
+				$spambot = 4;
+				$error = 'StopForumSpam.com could not be reached';
+			}
+			else
+			{
+				$spambot = 6;
+				$error = $data->error;
+			}
+		}
+		else
+		{
+			// Verify IP, and Email if necessary (Username won't be verified, too many false positive)
+			if(($data->ip->appears)){
+				$spambot = 1;
+				$error=$data1;
+			}
+			else if(($data->email->appears)){
+				$spambot = 2;
+				$error=$data1;
+			}
+		}
+	}
+	else
+	{
+		$spambot = 5;
+		$error='Neither IP nor Email are set, unable to perform check!';
+	}
+	$result=array('check' => $spambot, 'attempt' => $error);
+	return $result; // Return test results as value
+
+}
+
+//
+// CheckStopForumSpam END
+//
+
+//
+// Report a spammer to stopforumspam database
+//
+function sb_stopforumspam_report($ip, $email, $user_Name, $evidence)
+{
+	global $pun_config;
+	$evidency = 'Spammer manually detected, but automatically reported.';
+
+	// Do not report if there is no StopForumSpam API key
+	if ($pun_config['o_sb_sfs_api_key'] == '')
+		return false;
+
+	if (empty($evidence))
+	$evidence = $evidency ;
+
+	$context = stream_context_create(array('http' => array(
+		'method'	=> 'POST',
+		'header'	=> 'Content-type: application/x-www-form-urlencoded',
+		'content'	=> http_build_query(array(
+			'ip_addr'	=> $ip,
+			'email'		=> $email,
+			'username'	=> $user_Name,
+			'evidence'	=> $evidence,
+			'api_key'	=> $pun_config['o_sb_sfs_api_key'],
+		)),
+	)));
+
+	return @file_get_contents('https://www.stopforumspam.com/add', false, $context) ? true : false;
+}
+
+// Check registration attempt
+function sb_check_spam_registration($req_username,$email)
+{
+	global $pun_config;
+	global $pun_user;
+	global $timezone;
+	global $email_setting;
+	global $db;
+	$botcheck = 0;
+	$membersIP = get_remote_address();
+	$spam = NOT_SPAM;
+	$status = '';
+
+	if (!empty($_POST['req_user']) && ($pun_config['o_sb_check_hp'] == '1'))
+	{
+		$spam = HONEYPOT_SPAM;
+		$botcheck = 3;
+		$evidence = 'Automated registration detected.';
+		$status = serialize($_POST);
+	}
+
+	if ($botcheck == 0)
+	{
+		if ($pun_config['o_sb_check_sfs_register'] == '1')
+		{
+			$result = sb_stopforumspam_check($email, $membersIP, $req_username);
+			$botcheck=$result['check'];
+			$status=$result['attempt'];
+
+			if ($botcheck == 1 || $botcheck == 2)
+			{
+				$spam = BLACKLIST_SPAM;
+
+				$evidence = "";
+			}
+		}
+	}
+
+	if ((($pun_config['o_sb_check_sfs_register'] == '0') && ($botcheck == 0)) || ($botcheck > 3))
+	{
+		if ($pun_config['o_sb_check_dnsbl_register'] == '1')
+		{
+			$result= sb_check_dnsbl($membersIP, $req_username);
+			$botcheck=$result['check'];
+			if ($botcheck == 11)
+			{
+				$spam = DNSBL_SPAM;
+				$status=$result['attempt'];
+				$evidence = ""; // We do not report, because DNSBL have latency that could interfere with "whitelisting".
+			}
+		}
+	}
+
+	// Add detailed members info in  PUN_ROOT.spam/{date}_register.log
+	log_register_details($email, pun_htmlspecialchars($membersIP), $req_username, $spam, $botcheck, $status);
+
+  	if ($spam != NOT_SPAM)
+  	{
+   		// Since we found a spammer, lets report him to SFS !
+		if (!empty($evidence) && ($pun_config['o_sb_sfs_report'] == '1'))
+		{
+			sb_stopforumspam_report($membersIP, $email, $req_username, $evidence);
+		}
+
+
+		if (file_exists(PUN_ROOT.'lang/'.$pun_user['language'].'/spambarrier.php'))
+			require PUN_ROOT.'lang/'.$pun_user['language'].'/spambarrier.php';
+		else
+			require PUN_ROOT.'lang/English/spambarrier.php';
+
+
+
+
+		switch ($botcheck)
+		{
+			case 1:
+			case 11:
+				message($lang_spambarrier['potentiallyUnwantedPeople'].' RC : 1');
+				break;
+			case 2:
+				message($lang_spambarrier['potentiallyUnwantedPeople'].' RC : 2');
+				break;
+			case 3:
+				 message($lang_spambarrier['potentiallyUnwantedPeople'].' RC : 3');
+				break;
+/* 			case 4:
+				// message($lang_spambarrier['serverProblem']);
+				break;
+			case 5:
+				// message($lang_spambarrier['technicalProblem']);
+				break;
+			case 6:
+				// message($lang_spambarrier['Undefined conditions']);
+				break; */
+		}
+  		message($lang_spambarrier['Spam_catch'].' <a href="mailto:'.$pun_config['o_admin_email'].'">'.$pun_config['o_admin_email'].'</a>.');
+  	}
+}
+
+// Check login attempt
+// Login will not be accepted if the user or his IP is listed at SFS or DNSBL, but authorized if no answer from the SFS and DNSBL services.
+function sb_check_spam_login($membersIP,$username,$email)
+{
+	global $pun_config;
+	global $pun_user;
+	$spam = NOT_SPAM;
+	$botcheck = 0;
+
+	if ($pun_config['o_sb_check_sfs_login'] == '1')
+	{
+		$result = sb_stopforumspam_check($email, $membersIP, $username);
+
+		$botcheck=$result['check'];
+		$status=$result['attempt'];
+	}
+
+	if (($botcheck == 1) || ($botcheck == 2))
+	{
+		$spam = BLACKLIST_SPAM;
+	}
+	else
+	{
+		if ($pun_config['o_sb_check_dnsbl_login'] == '1')
+		{
+			$result = sb_check_dnsbl($membersIP, $username);
+			$botcheck=$result['check'];
+
+			if ($botcheck == 11)
+			{
+				$spam = DNSBL_SPAM;
+				$status=$result['attempt'];
+			}
+		}
+	}
+
+		if (file_exists(PUN_ROOT.'lang/'.$pun_user['language'].'/spambarrier.php'))
+			require PUN_ROOT.'lang/'.$pun_user['language'].'/spambarrier.php';
+		else
+			require PUN_ROOT.'lang/English/spambarrier.php';
+
+		switch ($botcheck)
+		{
+			case 1:
+			case 11:
+				message($lang_spambarrier['potentiallyUnwantedPeople'].' RC : 1');
+				break;
+			case 2:
+				message($lang_spambarrier['potentiallyUnwantedPeople'].' RC : 2');
+				break;
+			case 3:
+				// message($lang_spambarrier['potentiallyUnwantedPeople'].' RC : 3');
+				break;
+			case 4:
+				// message($lang_spambarrier['serverProblem']);
+				break;
+			case 5:
+				// message($lang_spambarrier['technicalProblem']);
+				break;
+			case 6:
+				// message($lang_spambarrier['Undefined conditions']);
+				break;
+		}
+}
+
+//
+// Check if a string is contained in another string
+//
+function contains($str, $content, $ignorecase = true)
+{
+	if ($ignorecase)
+	{
+		$str = strtolower($str);
+		$content = strtolower($content);
+	}
+
+	return (strpos($content, $str) !== false) ? true : false;
+}
+
+?>
diff --git a/include/srand.php b/include/srand.php
index a6561359..cb7985f1 100644
--- a/include/srand.php
+++ b/include/srand.php
@@ -36,17 +36,11 @@
  * The execution time should be at most 10-20 ms in any system.
  */
 function secure_random_bytes($len = 10)
-{
-   /*
-    * On PHP 7 and above, the native random_bytes should be available.
-    */
-   if (function_exists('random_bytes')) {
-      return random_bytes($len);
-   }
+{  
  
    /*
-    * On older versions of PHP, our primary choice for a cryptographic strong
-    * randomness function is openssl_random_pseudo_bytes.
+    * Our primary choice for a cryptographic strong randomness function is
+    * openssl_random_pseudo_bytes. 
     */
    $SSLstr = '4'; // http://xkcd.com/221/
    if (function_exists('openssl_random_pseudo_bytes') &&
@@ -118,12 +112,12 @@ function secure_random_bytes($len = 10)
          // Measure the time that the operations will take on average
          for ($i = 0; $i < 3; $i++) 
          {
-            $c1 = microtime(true);
+            $c1 = get_microtime();
             $var = sha1(mt_rand());
             for ($j = 0; $j < 50; $j++) {
                $var = sha1($var);
             }
-            $c2 = microtime(true);
+            $c2 = get_microtime();
             $entropy .= $c1 . $c2;
          }
 
@@ -136,12 +130,12 @@ function secure_random_bytes($len = 10)
          $iter = $bytes * (int) (ceil(8 / $bits_per_round));
          for ($i = 0; $i < $iter; $i++)
          {
-            $c1 = microtime(true);
+            $c1 = get_microtime();
             $var = sha1(mt_rand());
             for ($j = 0; $j < $rounds; $j++) {
                $var = sha1($var);
             }
-            $c2 = microtime(true);
+            $c2 = get_microtime();
             $entropy .= $c1 . $c2;
          }
 
diff --git a/include/utf8/ord.php b/include/utf8/ord.php
index 2ac71975..a333f960 100644
--- a/include/utf8/ord.php
+++ b/include/utf8/ord.php
@@ -68,7 +68,7 @@ function utf8_ord($chr)
 	}
 
 	if ($ord0>=252 && $ord0<=253)
-		return ($ord0-252) * 1073741824 + ($ord1-128)*16777216 + ($ord2-128)*262144 + ($ord3-128)*4096  + ($ord4-128)*64 + (ord($chr{5})-128);
+		return ($ord0-252) * 1073741824 + ($ord1-128)*16777216 + ($ord2-128)*262144 + ($ord3-128)*4096  + ($ord4-128)*64 + (ord($c{5})-128);
 
 	if ($ord0 >= 254 && $ord0 <= 255)
 	{
diff --git a/index.php b/index.php
index d25199d4..b8d0a3b9 100644
--- a/index.php
+++ b/index.php
@@ -22,7 +22,7 @@ if (!$pun_user['is_guest'])
 {
 	$result = $db->query('SELECT f.id, f.last_post FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.last_post>'.$pun_user['last_visit']) or error('Unable to fetch forum list', __FILE__, __LINE__, $db->error());
 
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 	{
 		$forums = $new_topics = array();
 		$tracked_topics = get_tracked_topics();
@@ -62,6 +62,31 @@ $forum_actions = array();
 if (!$pun_user['is_guest'])
 	$forum_actions[] = '<a href="misc.php?action=markread&amp;csrf_token='.pun_csrf_token().'">'.$lang_common['Mark all as read'].'</a>';
 
+$page_head['meta_robots'] = '<meta name="robots" content="index, follow">';
+$page_head['meta_desc'] = '<meta name="description" content="'.pun_htmlspecialchars($pun_config['o_board_desc']).'">';
+$page_head['twitter-card'] = '<meta name="twitter:card" content="summary">';
+$page_head['twitter-site'] = '<meta name="twitter:site" content="@txpforum">';
+$page_head['twitter-title'] = '<meta name="twitter:title" content="Textpattern CMS support forum">';
+$page_head['twitter-description'] = '<meta name="twitter:description" content="'.pun_htmlspecialchars($pun_config['o_board_desc']).'">';
+$page_head['twitter-image'] = '<meta name="twitter:image:src" content="https://forum.textpattern.com/apple-touch-icon-180x180.png">';
+$page_head['twitter-url'] = '<meta name="twitter:url" content="https://forum.textpattern.com/">';
+$page_head['og-site'] = '<meta property="og:site_name" content="Textpattern CMS support forum">';
+$page_head['og-type'] = '<meta property="og:type" content="website">';
+$page_head['og-title'] = '<meta property="og:title" content="Textpattern CMS support forum">';
+$page_head['og-description'] = '<meta property="og:description" content="'.pun_htmlspecialchars($pun_config['o_board_desc']).'">';
+$page_head['og-image'] = '<meta property="og:image" content="https://textpattern.com/assets/img/branding/textpattern/textpattern-og.png">';
+$page_head['og-image-width'] = '<meta property="og:image:width" content="1200">';
+$page_head['og-image-height'] = '<meta property="og:image:height" content="1200">';
+$page_head['og-image-alt'] = '<meta property="og:image:alt" content="Textpattern logo">';
+$page_head['og-url'] = '<meta property="og:url" content="https://forum.textpattern.com/">';
+$page_head['json-ld'] = '<script type="application/ld+json">'."\n".
+'{"@context": "https://schema.org",'."\n".
+'"@type": "WebSite",'."\n".
+'"headline": "Textpattern CMS support forum",'."\n".
+'"description": '.json_encode(pun_htmlspecialchars($pun_config['o_board_desc'])).','."\n".
+'"url": "https://forum.textpattern.com/"}'."\n".
+'</script>';
+$page_head['canonical'] = '<link rel="canonical" href="https://forum.textpattern.com/">';
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']));
 define('PUN_ALLOW_INDEX', 1);
 define('PUN_ACTIVE_PAGE', 'index');
diff --git a/install.php b/install.php
index e154e67f..979caf99 100644
--- a/install.php
+++ b/install.php
@@ -9,12 +9,12 @@
 // The FluxBB version this script installs
 define('FORUM_VERSION', '1.5.11');
 
-define('FORUM_DB_REVISION', 24);
+define('FORUM_DB_REVISION', 21);
 define('FORUM_SI_REVISION', 2);
 define('FORUM_PARSER_REVISION', 2);
 
-define('MIN_PHP_VERSION', '5.6.4');
-define('MIN_MYSQL_VERSION', '5.0.6');
+define('MIN_PHP_VERSION', '4.4.0');
+define('MIN_MYSQL_VERSION', '4.1.2');
 define('MIN_PGSQL_VERSION', '7.0.0');
 define('PUN_SEARCH_MIN_WORD', 3);
 define('PUN_SEARCH_MAX_WORD', 20);
@@ -34,12 +34,33 @@ require PUN_ROOT.'include/utf8/utf8.php';
 // Strip out "bad" UTF-8 characters
 forum_remove_bad_characters();
 
+// Reverse the effect of register_globals
+forum_unregister_globals();
+
 // Disable error reporting for uninitialized variables
 error_reporting(E_ALL);
 
 // Force POSIX locale (to prevent functions such as strtolower() from messing up UTF-8 strings)
 setlocale(LC_CTYPE, 'C');
 
+// Turn off magic_quotes_runtime
+if (get_magic_quotes_runtime())
+	set_magic_quotes_runtime(0);
+
+// Strip slashes from GET/POST/COOKIE (if magic_quotes_gpc is enabled)
+if (get_magic_quotes_gpc())
+{
+	function stripslashes_array($array)
+	{
+		return is_array($array) ? array_map('stripslashes_array', $array) : stripslashes($array);
+	}
+
+	$_GET = stripslashes_array($_GET);
+	$_POST = stripslashes_array($_POST);
+	$_COOKIE = stripslashes_array($_COOKIE);
+	$_REQUEST = stripslashes_array($_REQUEST);
+}
+
 // Turn off PHP time limit
 @set_time_limit(0);
 
@@ -89,7 +110,7 @@ function generate_config_file()
 {
 	global $db_type, $db_host, $db_name, $db_username, $db_password, $db_prefix, $cookie_name, $cookie_seed;
 
-	return '<?php'."\n\n".'$db_type = \''.$db_type."';\n".'$db_host = \''.$db_host."';\n".'$db_name = \''.addslashes($db_name)."';\n".'$db_username = \''.addslashes($db_username)."';\n".'$db_password = \''.addslashes($db_password)."';\n".'$db_prefix = \''.addslashes($db_prefix)."';\n".'$p_connect = false;'."\n\n".'$cookie_name = '."'".$cookie_name."';\n".'$cookie_domain = '."'';\n".'$cookie_path = '."'/';\n".'$cookie_secure = 0;'."\n".'$cookie_seed = \''.random_key(16, false, true)."';\n\n".'$password_hash_cost = 10;'."\n\ndefine('PUN', 1);\n";
+	return '<?php'."\n\n".'$db_type = \''.$db_type."';\n".'$db_host = \''.$db_host."';\n".'$db_name = \''.addslashes($db_name)."';\n".'$db_username = \''.addslashes($db_username)."';\n".'$db_password = \''.addslashes($db_password)."';\n".'$db_prefix = \''.addslashes($db_prefix)."';\n".'$p_connect = false;'."\n\n".'$cookie_name = '."'".$cookie_name."';\n".'$cookie_domain = '."'';\n".'$cookie_path = '."'/';\n".'$cookie_secure = 0;'."\n".'$cookie_seed = \''.random_key(16, false, true)."';\n\ndefine('PUN', 1);\n";
 }
 
 
@@ -166,7 +187,7 @@ else
 	else if (preg_match('%(?:\[/?(?:b|u|i|h|colou?r|quote|code|img|url|email|list)\]|\[(?:code|quote|list)=)%i', $username))
 		$alerts[] = $lang_install['Username 6'];
 
-	if (pun_strlen($password1) < 9)
+	if (pun_strlen($password1) < 6)
 		$alerts[] = $lang_install['Short password'];
 	else if ($password1 != $password2)
 		$alerts[] = $lang_install['Passwords not match'];
@@ -200,6 +221,7 @@ if (!forum_is_writable(PUN_ROOT.'img/avatars/'))
 if (!isset($_POST['form_sent']) || !empty($alerts))
 {
 	// Determine available database extensions
+	$dual_mysql = false;
 	$db_extensions = array();
 	$mysql_innodb = false;
 	if (function_exists('mysqli_connect'))
@@ -208,6 +230,15 @@ if (!isset($_POST['form_sent']) || !empty($alerts))
 		$db_extensions[] = array('mysqli_innodb', 'MySQL Improved (InnoDB)');
 		$mysql_innodb = true;
 	}
+	if (function_exists('mysql_connect'))
+	{
+		$db_extensions[] = array('mysql', 'MySQL Standard');
+		$db_extensions[] = array('mysql_innodb', 'MySQL Standard (InnoDB)');
+		$mysql_innodb = true;
+
+		if (count($db_extensions) > 2)
+			$dual_mysql = true;
+	}
 	if (function_exists('sqlite_open'))
 		$db_extensions[] = array('sqlite', 'SQLite');
 	if (function_exists('pg_connect'))
@@ -474,33 +505,40 @@ foreach ($alerts as $cur_alert)
 }
 else
 {
-	// Load and create the appropriate DB adapter (and open/connect to/select db)
+	// Load the appropriate DB layer class
 	switch ($db_type)
 	{
+		case 'mysql':
+			require PUN_ROOT.'include/dblayer/mysql.php';
+			break;
+
+		case 'mysql_innodb':
+			require PUN_ROOT.'include/dblayer/mysql_innodb.php';
+			break;
+
 		case 'mysqli':
 			require PUN_ROOT.'include/dblayer/mysqli.php';
-			$db = new MysqlDBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, false);
 			break;
 
 		case 'mysqli_innodb':
 			require PUN_ROOT.'include/dblayer/mysqli_innodb.php';
-			$db = new MysqlInnodbDBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, false);
 			break;
 
 		case 'pgsql':
 			require PUN_ROOT.'include/dblayer/pgsql.php';
-			$db = new PgsqlDBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, false);
 			break;
 
 		case 'sqlite':
 			require PUN_ROOT.'include/dblayer/sqlite.php';
-			$db = new SqliteDBLayer($db_name, $db_prefix, false);
 			break;
 
 		default:
 			error(sprintf($lang_install['DB type not valid'], $db_type));
 	}
 
+	// Create the database object (and connect/select db)
+	$db = new DBLayer($db_host, $db_username, $db_password, $db_name, $db_prefix, false);
+
 	// Validate prefix
 	if (strlen($db_prefix) > 0 && (!preg_match('%^[a-zA-Z_][a-zA-Z0-9_]*$%', $db_prefix) || strlen($db_prefix) > 40))
 		error(sprintf($lang_install['Table prefix error'], $db->prefix));
@@ -508,7 +546,9 @@ else
 	// Do some DB type specific checks
 	switch ($db_type)
 	{
+		case 'mysql':
 		case 'mysqli':
+		case 'mysql_innodb':
 		case 'mysqli_innodb':
 			$mysql_info = $db->get_version();
 			if (version_compare($mysql_info['version'], MIN_MYSQL_VERSION, '<'))
@@ -530,11 +570,11 @@ else
 
 	// Make sure FluxBB isn't already installed
 	$result = $db->query('SELECT 1 FROM '.$db_prefix.'users WHERE id=1');
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 		error(sprintf($lang_install['Existing table error'], $db_prefix, $db_name));
 
 	// Check if InnoDB is available
-	if ($db_type == 'mysqli_innodb')
+	if ($db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb')
 	{
 		$result = $db->query('SELECT SUPPORT FROM INFORMATION_SCHEMA.ENGINES WHERE ENGINE=\'InnoDB\'');
 		$result = $db->result($result);
@@ -586,7 +626,7 @@ else
 		)
 	);
 
-	if ($db_type == 'mysqli' || $db_type == 'mysqli_innodb')
+	if ($db_type == 'mysql' || $db_type == 'mysqli' || $db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb')
 		$schema['INDEXES']['username_idx'] = array('username(25)');
 
 	$db->create_table('bans', $schema) or error('Unable to create bans table', __FILE__, __LINE__, $db->error());
@@ -939,13 +979,13 @@ else
 		)
 	);
 
-	if ($db_type == 'mysqli' || $db_type == 'mysqli_innodb')
+	if ($db_type == 'mysql' || $db_type == 'mysqli' || $db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb')
 	{
 		$schema['UNIQUE KEYS']['user_id_ident_idx'] = array('user_id', 'ident(25)');
 		$schema['INDEXES']['ident_idx'] = array('ident(25)');
 	}
 
-	if ($db_type == 'mysqli_innodb')
+	if ($db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb')
 		$schema['ENGINE'] = 'InnoDB';
 
 	$db->create_table('online', $schema) or error('Unable to create online table', __FILE__, __LINE__, $db->error());
@@ -1089,7 +1129,7 @@ else
 		)
 	);
 
-	if ($db_type == 'mysqli' || $db_type == 'mysqli_innodb')
+	if ($db_type == 'mysql' || $db_type == 'mysqli' || $db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb')
 		$schema['INDEXES']['ident_idx'] = array('ident(8)');
 
 	$db->create_table('search_cache', $schema) or error('Unable to create search_cache table', __FILE__, __LINE__, $db->error());
@@ -1287,7 +1327,7 @@ else
 				'default'		=> '\'\''
 			),
 			'password'			=> array(
-				'datatype'		=> 'VARCHAR(255)',
+				'datatype'		=> 'VARCHAR(40)',
 				'allow_null'	=> false,
 				'default'		=> '\'\''
 			),
@@ -1320,6 +1360,10 @@ else
 				'datatype'		=> 'VARCHAR(80)',
 				'allow_null'	=> true
 			),
+			'aim'				=> array(
+				'datatype'		=> 'VARCHAR(30)',
+				'allow_null'	=> true
+			),
 			'yahoo'				=> array(
 				'datatype'		=> 'VARCHAR(30)',
 				'allow_null'	=> true
@@ -1468,7 +1512,7 @@ else
 		)
 	);
 
-	if ($db_type == 'mysqli' || $db_type == 'mysqli_innodb')
+	if ($db_type == 'mysql' || $db_type == 'mysqli' || $db_type == 'mysql_innodb' || $db_type == 'mysqli_innodb')
 		$schema['UNIQUE KEYS']['username_idx'] = array('username(25)');
 
 	$db->create_table('users', $schema) or error('Unable to create users table', __FILE__, __LINE__, $db->error());
@@ -1489,8 +1533,7 @@ else
 	$db->query('INSERT INTO '.$db_prefix.'users (group_id, username, password, email) VALUES(3, \''.$db->escape($lang_install['Guest']).'\', \''.$db->escape($lang_install['Guest']).'\', \''.$db->escape($lang_install['Guest']).'\')')
 		or error('Unable to add guest user. Please check your configuration and try again', __FILE__, __LINE__, $db->error());
 
-	$password_hash_cost = 10;
-	$db->query('INSERT INTO '.$db_prefix.'users (group_id, username, password, email, language, style, num_posts, last_post, registered, registration_ip, last_visit) VALUES(1, \''.$db->escape($username).'\', \''.$db->escape(flux_password_hash($password1)).'\', \''.$email.'\', \''.$db->escape($default_lang).'\', \''.$db->escape($default_style).'\', 1, '.$now.', '.$now.', \''.$db->escape(get_remote_address()).'\', '.$now.')')
+	$db->query('INSERT INTO '.$db_prefix.'users (group_id, username, password, email, language, style, num_posts, last_post, registered, registration_ip, last_visit) VALUES(1, \''.$db->escape($username).'\', \''.pun_hash($password1).'\', \''.$email.'\', \''.$db->escape($default_lang).'\', \''.$db->escape($default_style).'\', 1, '.$now.', '.$now.', \''.$db->escape(get_remote_address()).'\', '.$now.')')
 		or error('Unable to add administrator user. Please check your configuration and try again', __FILE__, __LINE__, $db->error());
 
 	// Enable/disable avatars depending on file_uploads setting in PHP configuration
diff --git a/lang/English/AP_SpamBarrier.php b/lang/English/AP_SpamBarrier.php
new file mode 100644
index 00000000..9a66bbc7
--- /dev/null
+++ b/lang/English/AP_SpamBarrier.php
@@ -0,0 +1,57 @@
+<?php
+// Language definitions for AP_SpamBarrier.php
+$lang_ap_spambarrier = array(
+'Redirect message'					=> 'Options updated. Redirecting …',
+'SB_users'							=> 'Users',
+'Col_Username'						=> 'Username',
+'Col_Email'							=> 'Email',
+'Col_Posts'							=> 'Posts',
+'Col_Website'						=> 'Website',
+'Col_Signature'						=> 'Signature',
+'Col_Registered'					=> 'Registered',
+'Go_back'							=> 'Go back',
+'Description'						=> 'This plugin is used to control the settings for the SpamBarrier mod.',
+'Options'							=> 'Options',
+'Settings'							=> 'Settings',
+'HP_check'							=> 'HoneyPot check',
+'HP_custom_field'					=> 'Custom HoneyPot field',
+'HP_custom_field_description'		=> 'Do we use a custom HoneyPot field name (If "Yes", fill in the field below) ?',
+'HP_custom_field_name'				=> 'Custom HoneyPot field name',
+'HP_custom_field_name_description'	=> 'It’s a good idea to have a custom HoneyPot field name. If not set, "req_honeypot" will be used as default value.',
+'Yes'								=> 'Yes',
+'No'								=> 'No',
+'HP_description'					=> 'The HoneyPot is the first barrier against spammers. It permits to verify if the registration is (poorly) "automated" or not. It is strongly recommended to enable this check, because it takes care of almost 100% of bots.',
+'SFS_reg_check'						=> 'StopForumSpam registration check',
+'SFS_reg_descrition'				=> 'If the user attempting to register passes the honeypot check, check the user’s IP and email address (not username) against the StopForumSpam blacklist database. While honeypot takes care of almost 100% of bots, the StopForumSpam service is used as a second barrier against human spammers.',
+'SFS_login_check'					=> 'StopForumSpam login check',
+'SFS_log_description'				=> 'Check the user’s IP only (neither the username, nor the email) against the StopForumSpam blacklist database. The StopForumSpam service, at login phase, is used as a first barrier against spammers/bad guys.',
+'Enable_SFS_report'					=> 'Enable StopForumSpam report',
+'SFS_report_description'			=> 'Do we report spammers to StopForumSpam? Please read <a href="https://www.stopforumspam.com/legal">"Acceptable use Policy"</a> before using. Requires an API key.',
+'SFS_API'							=> 'StopForumSpam API',
+'SFS_api_description'				=> 'Your StopForumSpam API key. If left blank blocked spam registration attempts will not be reported to the StopForumSpam blacklist service.',
+'DNSBL_login_check'					=> 'DNSBL login check',
+'DNSBL_login_description'			=> 'Check the user’s IP only (neither the username, nor the email) against the DNSBL (DNS BlackList) at login. The DNSBL service is used here as a second barrier against spammers/bad guys. It may help to catch some more spammers.',
+'DNSBL_reg_check'					=> 'DNSBL registration check',
+'DNSBL_reg_description'				=> 'Check the user’s IP only (neither the username, nor the email) against the DNSBL (DNS BlackList) at registration. The DNSBL service is used here as a third barrier against spammers/bad guys. It may help to catch some more spammers.',
+'DNSBL_list'						=> 'DNSBL servers list',
+'DNSBL_list_description'			=> 'The list of DNSBL servers to check (comma separated values). Be careful when using them (latency in the lists, false positives).',
+'Save'								=> 'Save changes',
+'Search_users'						=> 'Search users',
+'Search_description'				=> 'This feature allows you to search for users with URLs in their signatures but 0 posts. This is for finding spammers who have succeeded in passing through the Honeypot and StopForumSpam checks. Search results will be limited to the latest 50 registered users meeting these criteria.',
+'Go!'								=> 'Go!',
+'No_match'							=> 'No match.',
+'Registration_stats'				=> 'Registration statistics',
+'Collecting_since'					=> 'Collecting stats since',
+'N_A'								=> 'Not available',
+'Total'								=> 'Total',
+'NS'								=> 'Not spam: ',
+'BBH'								=> 'Blocked by Honeypot: ',
+'BBS'								=> 'Blocked by SFS: ',
+'BBD'								=> 'Blocked by DNSBL: ',
+'per_day'							=> 'per day',
+'Avg_7d'							=> 'Average last 7 days',
+'Max_day'							=> 'Maximum day',
+'Block_14d'							=> 'Blocked last 14 days',
+'Unable_14d'						=> 'Unable to fetch 14 day log',
+);
+?>
diff --git a/lang/English/admin_options.php b/lang/English/admin_options.php
index e973f29c..bed8177c 100644
--- a/lang/English/admin_options.php
+++ b/lang/English/admin_options.php
@@ -51,28 +51,28 @@ $lang_admin_options = array(
 'UTC-01:00'							=>	'(UTC-01:00) Azores, Cape Verde, Eastern Greenland',
 'UTC'								=>	'(UTC) Western European, Greenwich',
 'UTC+01:00'							=>	'(UTC+01:00) Central European, West African',
-'UTC+02:00'							=>	'(UTC+02:00) Eastern European, Central African, Kaliningrad',
-'UTC+03:00'							=>	'(UTC+03:00) Eastern African, Moscow',
+'UTC+02:00'							=>	'(UTC+02:00) Eastern European, Central African',
+'UTC+03:00'							=>	'(UTC+03:00) Eastern African',
 'UTC+03:30'							=>	'(UTC+03:30) Iran',
-'UTC+04:00'							=>	'(UTC+04:00) Gulf, Samara',
+'UTC+04:00'							=>	'(UTC+04:00) Moscow, Gulf, Samara',
 'UTC+04:30'							=>	'(UTC+04:30) Afghanistan',
-'UTC+05:00'							=>	'(UTC+05:00) Pakistan, Yekaterinburg',
+'UTC+05:00'							=>	'(UTC+05:00) Pakistan',
 'UTC+05:30'							=>	'(UTC+05:30) India, Sri Lanka',
 'UTC+05:45'							=>	'(UTC+05:45) Nepal',
-'UTC+06:00'							=>	'(UTC+06:00) Bangladesh, Bhutan, Omsk',
+'UTC+06:00'							=>	'(UTC+06:00) Bangladesh, Bhutan, Yekaterinburg',
 'UTC+06:30'							=>	'(UTC+06:30) Cocos Islands, Myanmar',
-'UTC+07:00'							=>	'(UTC+07:00) Indochina, Novosibirsk, Krasnoyarsk',
-'UTC+08:00'							=>	'(UTC+08:00) Greater China, Australian Western, Irkutsk',
+'UTC+07:00'							=>	'(UTC+07:00) Indochina, Novosibirsk',
+'UTC+08:00'							=>	'(UTC+08:00) Greater China, Australian Western, Krasnoyarsk',
 'UTC+08:45'							=>	'(UTC+08:45) Southeastern Western Australia',
-'UTC+09:00'							=>	'(UTC+09:00) Japan, Korea, Chita, Yakutsk',
+'UTC+09:00'							=>	'(UTC+09:00) Japan, Korea, Chita, Irkutsk',
 'UTC+09:30'							=>	'(UTC+09:30) Australian Central',
-'UTC+10:00'							=>	'(UTC+10:00) Australian Eastern, Vladivostok',
+'UTC+10:00'							=>	'(UTC+10:00) Australian Eastern',
 'UTC+10:30'							=>	'(UTC+10:30) Lord Howe',
-'UTC+11:00'							=>	'(UTC+11:00) Solomon Island, Magadan',
+'UTC+11:00'							=>	'(UTC+11:00) Solomon Island, Vladivostok',
 'UTC+11:30'							=>	'(UTC+11:30) Norfolk Island',
-'UTC+12:00'							=>	'(UTC+12:00) New Zealand, Fiji, Kamchatka',
+'UTC+12:00'							=>	'(UTC+12:00) New Zealand, Fiji, Magadan',
 'UTC+12:45'							=>	'(UTC+12:45) Chatham Islands',
-'UTC+13:00'							=>	'(UTC+13:00) Tonga, Phoenix Islands',
+'UTC+13:00'							=>	'(UTC+13:00) Tonga, Phoenix Islands, Kamchatka',
 'UTC+14:00'							=>	'(UTC+14:00) Line Islands',
 
 // Timeout Section
diff --git a/lang/English/admin_users.php b/lang/English/admin_users.php
index 311b0be0..66280b7c 100644
--- a/lang/English/admin_users.php
+++ b/lang/English/admin_users.php
@@ -48,6 +48,7 @@ $lang_admin_users = array(
 'Jabber label'				=>	'Jabber',
 'ICQ label'					=>	'ICQ',
 'MSN label'					=>	'Microsoft Account',
+'AOL label'					=>	'AOL IM',
 'Yahoo label'				=>	'Yahoo Messenger',
 'Location label'			=>	'Location',
 'Signature label'			=>	'Signature',
diff --git a/lang/English/index.php b/lang/English/index.php
index 7427c1ac..0ed222a5 100644
--- a/lang/English/index.php
+++ b/lang/English/index.php
@@ -4,7 +4,7 @@
 $lang_index = array(
 
 'Topics'		=>	'Topics',
-'Link to'		=>	'Link to:', // As in "Link to: https://fluxbb.org/"
+'Link to'		=>	'Link to:', // As in "Link to: http://fluxbb.org/"
 'Empty board'	=>	'Board is empty.',
 'Newest user'	=>	'Newest registered user: %s',
 'Users online'	=>	'Registered users online: %s',
diff --git a/lang/English/install.php b/lang/English/install.php
index d78a2c89..70941110 100644
--- a/lang/English/install.php
+++ b/lang/English/install.php
@@ -18,7 +18,7 @@ $lang_install = array(
 'Username 4'					=>	'Usernames may not be in the form of an IP address.',
 'Username 5'					=>	'Usernames may not contain all the characters \', " and [ or ] at once.',
 'Username 6'					=>	'Usernames may not contain any of the text formatting tags (BBCode) that the forum uses.',
-'Short password'				=>	'Passwords must be at least 9 characters long.',
+'Short password'				=>	'Passwords must be at least 6 characters long.',
 'Passwords not match'			=>	'Passwords do not match.',
 'Wrong email'					=>	'The administrator email address you entered is invalid.',
 'No board title'				=>	'You must enter a board title.',
@@ -55,7 +55,7 @@ $lang_install = array(
 'Table prefix'					=>	'Table prefix',
 'Administration setup'			=>	'Administration setup',
 'Info 7'						=>	'Create the very first account on your board.',
-'Info 8'						=>	'Your username should be between 2 and 25 characters long. Your password must be at least 9 characters long. Remember that passwords are case-sensitive.',
+'Info 8'						=>	'Your username should be between 2 and 25 characters long. Your password must be at least 6 characters long. Remember that passwords are case-sensitive.',
 'Password'						=>	'Password',
 'Confirm password'				=>	'Confirm password',
 'Board setup'					=>	'Board setup',
@@ -84,9 +84,9 @@ $lang_install = array(
 'Maintenance message'			=>	'The forums are temporarily down for maintenance. Please try again in a few minutes.',
 'Test post'						=>	'Test topic',
 'Message'						=>	'If you are looking at this (which I guess you are), the install of FluxBB appears to have worked! Now log in and head over to the administration control panel to configure your forum.',
-'Test category'					=>	'General',
-'Test forum'					=>	'Announcements',
-'This is just a test forum'		=>	'News from the community',
+'Test category'					=>	'Test category',
+'Test forum'					=>	'Test forum',
+'This is just a test forum'		=>	'This is just a test forum',
 'Alert cache'					=>	'<strong>The cache directory is currently not writable!</strong> In order for FluxBB to function properly, the directory <em>%s</em> must be writable by PHP. Use chmod to set the appropriate directory permissions. If in doubt, chmod to 0777.',
 'Alert avatar'					=>	'<strong>The avatar directory is currently not writable!</strong> If you want users to be able to upload their own avatar images you must see to it that the directory <em>%s</em> is writable by PHP. You can later choose to save avatar images in a different directory (see Admin/Options). Use chmod to set the appropriate directory permissions. If in doubt, chmod to 0777.',
 'Alert upload'					=>	'<strong>File uploads appear to be disallowed on this server!</strong> If you want users to be able to upload their own avatar images you must enable the file_uploads configuration setting in PHP. Once file uploads have been enabled, avatar uploads can be enabled in Administration/Options/Features.',
diff --git a/lang/English/login.php b/lang/English/login.php
index fab1faeb..3b6b9b65 100644
--- a/lang/English/login.php
+++ b/lang/English/login.php
@@ -16,7 +16,7 @@ $lang_login = array(
 'Request pass info'			=>	'A new password together with a link to activate the new password will be sent to that address.',
 'Not registered'			=>	'Not registered yet?',
 'Login legend'				=>	'Enter your username and password below',
-'Remember me'				=>	'Log me in automatically each time I visit.',
+'Remember me'				=>	'Log me in automatically each time I visit (using a cookie).',
 'Login info'				=>	'If you have not registered or have forgotten your password click on the appropriate link below.',
 'New password errors'		=>	'Password request error',
 'New passworderrors info'	=>	'The following error needs to be corrected before a new password can be sent:',
diff --git a/lang/English/prof_reg.php b/lang/English/prof_reg.php
index 815567c2..b3714efe 100644
--- a/lang/English/prof_reg.php
+++ b/lang/English/prof_reg.php
@@ -52,28 +52,28 @@ $lang_prof_reg = array(
 'UTC-01:00'					=>	'(UTC-01:00) Azores, Cape Verde, Eastern Greenland',
 'UTC'						=>	'(UTC) Western European, Greenwich',
 'UTC+01:00'					=>	'(UTC+01:00) Central European, West African',
-'UTC+02:00'					=>	'(UTC+02:00) Eastern European, Central African, Kaliningrad',
-'UTC+03:00'					=>	'(UTC+03:00) Eastern African, Moscow',
+'UTC+02:00'					=>	'(UTC+02:00) Eastern European, Central African',
+'UTC+03:00'					=>	'(UTC+03:00) Eastern African',
 'UTC+03:30'					=>	'(UTC+03:30) Iran',
-'UTC+04:00'					=>	'(UTC+04:00) Gulf, Samara',
+'UTC+04:00'					=>	'(UTC+04:00) Moscow, Gulf, Samara',
 'UTC+04:30'					=>	'(UTC+04:30) Afghanistan',
-'UTC+05:00'					=>	'(UTC+05:00) Pakistan, Yekaterinburg',
+'UTC+05:00'					=>	'(UTC+05:00) Pakistan',
 'UTC+05:30'					=>	'(UTC+05:30) India, Sri Lanka',
 'UTC+05:45'					=>	'(UTC+05:45) Nepal',
-'UTC+06:00'					=>	'(UTC+06:00) Bangladesh, Bhutan, Omsk',
+'UTC+06:00'					=>	'(UTC+06:00) Bangladesh, Bhutan, Yekaterinburg',
 'UTC+06:30'					=>	'(UTC+06:30) Cocos Islands, Myanmar',
-'UTC+07:00'					=>	'(UTC+07:00) Indochina, Novosibirsk, Krasnoyarsk',
-'UTC+08:00'					=>	'(UTC+08:00) Greater China, Australian Western, Irkutsk',
+'UTC+07:00'					=>	'(UTC+07:00) Indochina, Novosibirsk',
+'UTC+08:00'					=>	'(UTC+08:00) Greater China, Australian Western, Krasnoyarsk',
 'UTC+08:45'					=>	'(UTC+08:45) Southeastern Western Australia',
-'UTC+09:00'					=>	'(UTC+09:00) Japan, Korea, Chita, Yakutsk',
+'UTC+09:00'					=>	'(UTC+09:00) Japan, Korea, Chita, Irkutsk',
 'UTC+09:30'					=>	'(UTC+09:30) Australian Central',
-'UTC+10:00'					=>	'(UTC+10:00) Australian Eastern, Vladivostok',
+'UTC+10:00'					=>	'(UTC+10:00) Australian Eastern',
 'UTC+10:30'					=>	'(UTC+10:30) Lord Howe',
-'UTC+11:00'					=>	'(UTC+11:00) Solomon Island, Magadan',
+'UTC+11:00'					=>	'(UTC+11:00) Solomon Island, Vladivostok',
 'UTC+11:30'					=>	'(UTC+11:30) Norfolk Island',
-'UTC+12:00'					=>	'(UTC+12:00) New Zealand, Fiji, Kamchatka',
+'UTC+12:00'					=>	'(UTC+12:00) New Zealand, Fiji, Magadan',
 'UTC+12:45'					=>	'(UTC+12:45) Chatham Islands',
-'UTC+13:00'					=>	'(UTC+13:00) Tonga, Phoenix Islands',
+'UTC+13:00'					=>	'(UTC+13:00) Tonga, Phoenix Islands, Kamchatka',
 'UTC+14:00'					=>	'(UTC+14:00) Line Islands'
 
 );
diff --git a/lang/English/profile.php b/lang/English/profile.php
index 052da1cf..4957f5bb 100644
--- a/lang/English/profile.php
+++ b/lang/English/profile.php
@@ -30,7 +30,7 @@ $lang_profile = array(
 'Old pass'						=>	'Old password',
 'New pass'						=>	'New password',
 'Confirm new pass'				=>	'Confirm new password',
-'Pass info'						=>	'Passwords must be at least 9 characters long. Passwords are case sensitive.',
+'Pass info'						=>	'Passwords must be at least 6 characters long. Passwords are case sensitive.',
 
 // Email stuff
 'Email key bad'					=>	'The specified email activation key was incorrect or has expired. Please re-request change of email address. If that fails, contact the forum administrator at',
@@ -85,8 +85,9 @@ $lang_profile = array(
 'Website not allowed'			=>	'You are not allowed to add a website to your profile yet.',
 'Jabber'						=>	'Jabber',
 'ICQ'							=>	'ICQ',
-'MSN'							=>	'Microsoft Account',
-'Yahoo'							=>	'Yahoo! Messenger',
+'MSN'							=>	'Mastodon',
+'AOL IM'						=>	'AOL IM',
+'Yahoo'							=>	'Twitter',
 'Avatar'						=>	'Avatar',
 'Signature'						=>	'Signature',
 'Sig max size'					=>	'Max length: %s characters / Max lines: %s',
@@ -94,7 +95,7 @@ $lang_profile = array(
 'Avatar info'					=>	'An avatar is a small image that will be displayed with all your posts. You can upload an avatar by clicking the link below.',
 'Change avatar'					=>	'Change avatar',
 'Signature legend'				=>	'Compose your signature',
-'Signature info'				=>	'A signature is a small piece of text that is attached to your posts. In it, you can enter just about anything you like. Perhaps you would like to enter your favourite quote or your star sign. It\'s up to you! In your signature you can use BBCode if it is allowed in this particular forum. You can see the features that are allowed/enabled listed below whenever you edit your signature.',
+'Signature info'				=>	'A signature is a small piece of text that is attached to your posts. In it, you can enter just about anything you like. Perhaps you would like to enter your favourite quote or your star sign. It\'s up to you!',
 'Sig preview'					=>	'Current signature preview:',
 'No sig'						=>	'No signature currently stored in profile.',
 'Signature quote/code/list/h'	=>	'The quote, code, list, and heading BBCodes are not allowed in signatures.',
@@ -125,6 +126,9 @@ $lang_profile = array(
 'Update forums'					=>	'Update forums',
 'Delete ban legend'				=>	'Delete (administrators only) or ban user',
 'Delete user'					=>	'Delete user',
+'Delete spammer'				=>	'Delete user &amp; report spam',
+'Delete spammer note'			=>	'After deletion this user will be reported as a spammer. This is intended for reporting spam bots, <strong>not</strong> annoying users!',
+'Spammer delete redirect'		=>	'User deleted and reported. Redirecting …',
 'Ban user'						=>	'Ban user',
 'Confirm delete legend'			=>	'Important: read before deleting user',
 'Confirm delete user'			=>	'Confirm delete user',
diff --git a/lang/English/recaptcha_addon.php b/lang/English/recaptcha_addon.php
new file mode 100644
index 00000000..032cdee4
--- /dev/null
+++ b/lang/English/recaptcha_addon.php
@@ -0,0 +1,20 @@
+<?php
+
+$GLOBALS['lang_recaptcha'] = array(
+	'Human'                 => 'Are you a human?',
+	'Prove'                 => 'Please prove that you’re a human being.',
+	'Error'                 => 'Please prove that you are human.',
+	'API error'             => 'Cannot validate reCAPTCHA submission.',
+	'General'               => 'Set up reCAPTCHA integration',
+	'General description'   => 'Configure reCAPTCHA with your account credentials as provided by Google.',
+	'Enable'                => 'Enable reCAPTCHA',
+	'Site key'              => 'Site key',
+	'Secret key'            => 'Secret key',
+	'Locations'             => 'Locations',
+	'Locations description' => 'Where do you want reCAPTCHA to show up?',
+	'Register'              => 'On the registration page',
+	'Login'                 => 'On the login page',
+	'Guest post'            => 'When guests make a post',
+	'Save'                  => 'Save',
+	'Settings saved'        => 'Settings saved successfully. Redirecting…',
+);
diff --git a/lang/English/register.php b/lang/English/register.php
index 55fabdca..6571fd11 100644
--- a/lang/English/register.php
+++ b/lang/English/register.php
@@ -30,8 +30,9 @@ $lang_register = array(
 'Desc 2'					=>	'Below is a form you must fill out in order to register. Once you are registered you should visit your profile and review the different settings you can change. The fields below only make up a small part of all the settings you can alter in your profile.',
 'Username legend'			=>	'Please enter a username between 2 and 25 characters long',
 'Pass legend'				=>	'Please enter and confirm your chosen password',
-'Pass info'					=>	'Passwords must be at least 9 characters long. Passwords are case sensitive.',
+'Pass info'					=>	'Passwords must be at least 6 characters long. Passwords are case sensitive.',
 'Email info'				=>	'You must enter a valid email address as your randomly generated password will be sent to that address.',
 'Confirm email'				=>	'Confirm email address',
+'If human'					=>	'If you want to be reported as a spammer, please fill in this field!',
 
 );
diff --git a/lang/English/spambarrier.php b/lang/English/spambarrier.php
new file mode 100644
index 00000000..e920222c
--- /dev/null
+++ b/lang/English/spambarrier.php
@@ -0,0 +1,9 @@
+<?php
+// Language definitions used by FluxBB CheckStopForumSpam
+$lang_spambarrier = array(
+'potentiallyUnwantedPeople'			=> 'You are identified as undesirable.',
+'serverProblem'						=> 'The IP check server doesn’t answer.',
+'technicalProblem'					=> 'Due to a technical problem, registering is temporarily disabled. We apologize for this incident.',
+'Spam_catch'						=> 'The antispam control has encountered a problem. You should retry later, or direct your inquiries to the forum administrator at',
+);
+?>
diff --git a/lang/English/update.php b/lang/English/update.php
index 683ad16f..1a98f77c 100644
--- a/lang/English/update.php
+++ b/lang/English/update.php
@@ -18,7 +18,6 @@ $lang_update = array(
 
 'You are running error'			=>	'You are running %1$s version %2$s. FluxBB %3$s requires at least %1$s %4$s to run properly. You must upgrade your %1$s installation before you can continue.',
 'Version mismatch error'		=>	'Version mismatch. The database \'%s\' doesn\'t seem to be running a FluxBB database schema supported by this update script.',
-'Password cost missing error'	=>	'Update cannot proceed before you add a line containing <code>$password_hash_cost = 10;</code> to your config.php file in the FluxBB root directory',
 'Invalid file error'			=>	'Invalid database file name. When using SQLite the database file name must be entered exactly as it appears in your \'%s\'',
 'Invalid password error'		=>	'Invalid database password. To upgrade FluxBB you must enter your database password exactly as it appears in your \'%s\'',
 'No password error'				=>	'No database password provided',
diff --git a/login.php b/login.php
index ed858358..d45754c9 100644
--- a/login.php
+++ b/login.php
@@ -38,21 +38,33 @@ if (isset($_POST['form_sent']) && $action == 'in')
 
 	if (!empty($cur_user['password']))
 	{
-		// Represents the hash of the user's password
-		// If it's transparently changed in this function,
-		// this allows the cookie token to reflect the new hash
-		$user_password = $cur_user['password'];
+		$form_password_hash = pun_hash($form_password); // Will result in a SHA-1 hash
 
-		if (flux_password_verify($form_password, $user_password))
+		// If there is a salt in the database we have upgraded from 1.3-legacy though haven't yet logged in
+		if (!empty($cur_user['salt']))
 		{
-			$authorized = true;
+			$is_salt_authorized = pun_hash_equals(sha1($cur_user['salt'].sha1($form_password)), $cur_user['password']);
+			if ($is_salt_authorized) // 1.3 used sha1(salt.sha1(pass))
+ 			{
+				$authorized = true;
 
-			if (flux_password_needs_rehash($user_password))
+				$db->query('UPDATE '.$db->prefix.'users SET password=\''.$form_password_hash.'\', salt=NULL WHERE id='.$cur_user['id']) or error('Unable to update user password', __FILE__, __LINE__, $db->error());
+			}
+		}
+		// If the length isn't 40 then the password isn't using sha1, so it must be md5 from 1.2
+		else if (strlen($cur_user['password']) != 40)
+		{
+			$is_md5_authorized = pun_hash_equals(md5($form_password), $cur_user['password']);
+			if ($is_md5_authorized)
 			{
-				$user_password = flux_password_hash($form_password);
-				$db->query('UPDATE '.$db->prefix.'users SET password=\''.$db->escape($user_password).'\' WHERE id='.$cur_user['id']) or error('Unable to update user password', __FILE__, __LINE__, $db->error());
+				$authorized = true;
+
+				$db->query('UPDATE '.$db->prefix.'users SET password=\''.$form_password_hash.'\' WHERE id='.$cur_user['id']) or error('Unable to update user password', __FILE__, __LINE__, $db->error());
 			}
 		}
+		// Otherwise we should have a normal sha1 password
+		else
+			$authorized = pun_hash_equals($cur_user['password'], $form_password_hash);
 	}
 
 	if (!$authorized)
@@ -75,11 +87,26 @@ if (isset($_POST['form_sent']) && $action == 'in')
 			generate_users_info_cache();
 		}
 
+
+//
+// SpamBarrier BEGIN
+//
+	// Include the antispam library
+  	require PUN_ROOT.'include/spambarrier.php';
+
+	$membersIP= get_remote_address();
+
+	sb_check_spam_login($membersIP,$form_username,$cur_user['email']);
+
+//
+// SpamBarrier END
+//
+
 		// Remove this user's guest entry from the online list
 		$db->query('DELETE FROM '.$db->prefix.'online WHERE ident=\''.$db->escape(get_remote_address()).'\'') or error('Unable to delete from online list', __FILE__, __LINE__, $db->error());
 
 		$expire = ($save_pass == '1') ? time() + 1209600 : time() + $pun_config['o_timeout_visit'];
-		pun_setcookie($cur_user['id'], $user_password, $expire);
+		pun_setcookie($cur_user['id'], $form_password_hash, $expire);
 
 		// Reset tracked topics
 		set_tracked_topics(null);
@@ -141,7 +168,7 @@ else if ($action == 'forget' || $action == 'forget_2')
 		{
 			$result = $db->query('SELECT id, username, last_email_sent FROM '.$db->prefix.'users WHERE email=\''.$db->escape($email).'\'') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
 
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 			{
 				// Load the "activate password" template
 				$mail_tpl = trim(file_get_contents(PUN_ROOT.'lang/'.$pun_user['language'].'/mail_templates/activate_password.tpl'));
@@ -225,7 +252,7 @@ if (!empty($errors))
 					<legend><?php echo $lang_login['Request pass legend'] ?></legend>
 					<div class="infldset">
 						<input type="hidden" name="form_sent" value="1" />
-						<label class="required"><strong><?php echo $lang_common['Email'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input id="req_email" type="text" name="req_email" value="<?php if (isset($_POST['req_email'])) echo pun_htmlspecialchars($_POST['req_email']); ?>" size="50" maxlength="80" /><br /></label>
+						<label class="required"><strong><?php echo $lang_common['Email'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input id="req_email" type="email" name="req_email" value="<?php if (isset($_POST['req_email'])) echo pun_htmlspecialchars($_POST['req_email']); ?>" size="50" maxlength="80" autocomplete="email" required /><br /></label>
 						<p><?php echo $lang_login['Request pass info'] ?></p>
 					</div>
 				</fieldset>
@@ -301,20 +328,20 @@ if (!empty($errors))
 						<input type="hidden" name="form_sent" value="1" />
 						<input type="hidden" name="redirect_url" value="<?php echo pun_htmlspecialchars($redirect_url) ?>" />
 						<input type="hidden" name="csrf_token" value="<?php echo pun_csrf_token() ?>" />
-						<label class="conl required"><strong><?php echo $lang_common['Username'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" value="<?php if (isset($_POST['req_username'])) echo pun_htmlspecialchars($_POST['req_username']); ?>" size="25" maxlength="25" tabindex="1" /><br /></label>
-						<label class="conl required"><strong><?php echo $lang_common['Password'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password" size="25" tabindex="2" /><br /></label>
+						<label class="conl required"><strong><?php echo $lang_common['Username'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" value="<?php if (isset($_POST['req_username'])) echo pun_htmlspecialchars($_POST['req_username']); ?>" size="25" maxlength="25" autocomplete="username" autofocus required /><br /></label>
+						<label class="conl required"><strong><?php echo $lang_common['Password'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password" size="25" autocomplete="current-password" required /><br /></label>
 
 						<div class="rbox clearb">
-							<label><input type="checkbox" name="save_pass" value="1"<?php if (isset($_POST['save_pass'])) echo ' checked="checked"'; ?> tabindex="3" /><?php echo $lang_login['Remember me'] ?><br /></label>
+							<label><input type="checkbox" name="save_pass" value="1"<?php if (isset($_POST['save_pass'])) echo ' checked'; ?> /><?php echo $lang_login['Remember me'] ?><br /></label>
 						</div>
 
 						<p class="clearb"><?php echo $lang_login['Login info'] ?></p>
-						<p class="actions"><span><a href="register.php" tabindex="5"><?php echo $lang_login['Not registered'] ?></a></span> <span><a href="login.php?action=forget" tabindex="6"><?php echo $lang_login['Forgotten pass'] ?></a></span></p>
+						<p class="actions"><span><a href="register.php"><?php echo $lang_login['Not registered'] ?></a></span> <span><a href="login.php?action=forget"><?php echo $lang_login['Forgotten pass'] ?></a></span></p>
 					</div>
 				</fieldset>
 			</div>
 <?php flux_hook('login_before_submit') ?>
-			<p class="buttons"><input type="submit" name="login" value="<?php echo $lang_common['Login'] ?>" tabindex="4" /></p>
+			<p class="buttons"><input type="submit" name="login" value="<?php echo $lang_common['Login'] ?>" /></p>
 		</form>
 	</div>
 </div>
diff --git a/misc.php b/misc.php
index a0569e4c..f15d1c30 100644
--- a/misc.php
+++ b/misc.php
@@ -1,416 +1,414 @@
-<?php
-
-/**
- * Copyright (C) 2008-2012 FluxBB
- * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
- * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
- */
-
-if (isset($_GET['action']))
-	define('PUN_QUIET_VISIT', 1);
-
-define('PUN_ROOT', dirname(__FILE__).'/');
-require PUN_ROOT.'include/common.php';
-
-
-// Load the misc.php language file
-require PUN_ROOT.'lang/'.$pun_user['language'].'/misc.php';
-
-$action = isset($_GET['action']) ? $_GET['action'] : null;
-
-
-if ($action == 'rules')
-{
-	if ($pun_config['o_rules'] == '0' || ($pun_user['is_guest'] && $pun_user['g_read_board'] == '0' && $pun_config['o_regs_allow'] == '0'))
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	// Load the register.php language file
-	require PUN_ROOT.'lang/'.$pun_user['language'].'/register.php';
-
-	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_register['Forum rules']);
-	define('PUN_ACTIVE_PAGE', 'rules');
-	require PUN_ROOT.'header.php';
-
-?>
-<div id="rules" class="block">
-	<div class="hd"><h2><span><?php echo $lang_register['Forum rules'] ?></span></h2></div>
-	<div class="box">
-		<div id="rules-block" class="inbox">
-			<div class="usercontent"><?php echo $pun_config['o_rules_message'] ?></div>
-		</div>
-	</div>
-</div>
-<?php
-
-	require PUN_ROOT.'footer.php';
-}
-
-
-else if ($action == 'markread')
-{
-	if ($pun_user['is_guest'])
-		message($lang_common['No permission'], false, '403 Forbidden');
-
-	check_csrf($_GET['csrf_token']);
-
-	$db->query('UPDATE '.$db->prefix.'users SET last_visit='.$pun_user['logged'].' WHERE id='.$pun_user['id']) or error('Unable to update user last visit data', __FILE__, __LINE__, $db->error());
-
-	// Reset tracked topics
-	set_tracked_topics(null);
-
-	redirect('index.php', $lang_misc['Mark read redirect']);
-}
-
-
-// Mark the topics/posts in a forum as read?
-else if ($action == 'markforumread')
-{
-	if ($pun_user['is_guest'])
-		message($lang_common['No permission'], false, '403 Forbidden');
-
-	check_csrf($_GET['csrf_token']);
-
-	$fid = isset($_GET['fid']) ? intval($_GET['fid']) : 0;
-	if ($fid < 1)
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	$tracked_topics = get_tracked_topics();
-	$tracked_topics['forums'][$fid] = time();
-	set_tracked_topics($tracked_topics);
-
-	redirect('viewforum.php?id='.$fid, $lang_misc['Mark forum read redirect']);
-}
-
-
-else if (isset($_GET['email']))
-{
-	if ($pun_user['is_guest'] || $pun_user['g_send_email'] == '0')
-		message($lang_common['No permission'], false, '403 Forbidden');
-
-	$recipient_id = intval($_GET['email']);
-	if ($recipient_id < 2)
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	$result = $db->query('SELECT username, email, email_setting FROM '.$db->prefix.'users WHERE id='.$recipient_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	list($recipient, $recipient_email, $email_setting) = $db->fetch_row($result);
-
-	if ($email_setting == 2 && !$pun_user['is_admmod'])
-		message($lang_misc['Form email disabled']);
-
-
-	if (isset($_POST['form_sent']))
-	{
-		confirm_referrer('misc.php');
-
-		// Clean up message and subject from POST
-		$subject = pun_trim($_POST['req_subject']);
-		$message = pun_trim($_POST['req_message']);
-
-		if ($subject == '')
-			message($lang_misc['No email subject']);
-		else if ($message == '')
-			message($lang_misc['No email message']);
-		// Here we use strlen() not pun_strlen() as we want to limit the post to PUN_MAX_POSTSIZE bytes, not characters
-		else if (strlen($message) > PUN_MAX_POSTSIZE)
-			message($lang_misc['Too long email message']);
-
-		if ($pun_user['last_email_sent'] != '' && (time() - $pun_user['last_email_sent']) < $pun_user['g_email_flood'] && (time() - $pun_user['last_email_sent']) >= 0)
-			message(sprintf($lang_misc['Email flood'], $pun_user['g_email_flood'], $pun_user['g_email_flood'] - (time() - $pun_user['last_email_sent'])));
-
-		// Load the "form email" template
-		$mail_tpl = trim(file_get_contents(PUN_ROOT.'lang/'.$pun_user['language'].'/mail_templates/form_email.tpl'));
-
-		// The first row contains the subject
-		$first_crlf = strpos($mail_tpl, "\n");
-		$mail_subject = pun_trim(substr($mail_tpl, 8, $first_crlf-8));
-		$mail_message = pun_trim(substr($mail_tpl, $first_crlf));
-
-		$mail_subject = str_replace('<mail_subject>', $subject, $mail_subject);
-		$mail_message = str_replace('<sender>', $pun_user['username'], $mail_message);
-		$mail_message = str_replace('<board_title>', $pun_config['o_board_title'], $mail_message);
-		$mail_message = str_replace('<mail_message>', $message, $mail_message);
-		$mail_message = str_replace('<board_mailer>', $pun_config['o_board_title'], $mail_message);
-
-		require_once PUN_ROOT.'include/email.php';
-
-		pun_mail($recipient_email, $mail_subject, $mail_message, $pun_user['email'], $pun_user['username']);
-
-		$db->query('UPDATE '.$db->prefix.'users SET last_email_sent='.time().' WHERE id='.$pun_user['id']) or error('Unable to update user', __FILE__, __LINE__, $db->error());
-
-		// Try to determine if the data in redirect_url is valid (if not, we redirect to index.php after the email is sent)
-		$redirect_url = validate_redirect($_POST['redirect_url'], 'index.php');
-
-		redirect(pun_htmlspecialchars($redirect_url), $lang_misc['Email sent redirect']);
-	}
-
-
-	// Try to determine if the data in HTTP_REFERER is valid (if not, we redirect to the user's profile after the email is sent)
-	if (!empty($_SERVER['HTTP_REFERER']))
-		$redirect_url = validate_redirect($_SERVER['HTTP_REFERER'], null);
-
-	if (!isset($redirect_url))
-		$redirect_url = get_base_url(true).'/profile.php?id='.$recipient_id;
-	else if (preg_match('%viewtopic\.php\?pid=(\d+)$%', $redirect_url, $matches))
-		$redirect_url .= '#p'.$matches[1];
-
-	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_misc['Send email to'].' '.pun_htmlspecialchars($recipient));
-	$required_fields = array('req_subject' => $lang_misc['Email subject'], 'req_message' => $lang_misc['Email message']);
-	$focus_element = array('email', 'req_subject');
-	define('PUN_ACTIVE_PAGE', 'index');
-	require PUN_ROOT.'header.php';
-
-?>
-<div id="emailform" class="blockform">
-	<h2><span><?php echo $lang_misc['Send email to'] ?> <?php echo pun_htmlspecialchars($recipient) ?></span></h2>
-	<div class="box">
-		<form id="email" method="post" action="misc.php?email=<?php echo $recipient_id ?>" onsubmit="this.submit.disabled=true;if(process_form(this)){return true;}else{this.submit.disabled=false;return false;}">
-			<div class="inform">
-				<fieldset>
-					<legend><?php echo $lang_misc['Write email'] ?></legend>
-					<div class="infldset txtarea">
-						<input type="hidden" name="form_sent" value="1" />
-						<input type="hidden" name="redirect_url" value="<?php echo pun_htmlspecialchars($redirect_url) ?>" />
-						<label class="required"><strong><?php echo $lang_misc['Email subject'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input class="longinput" type="text" name="req_subject" size="75" maxlength="70" tabindex="1" /><br /></label>
-						<label class="required"><strong><?php echo $lang_misc['Email message'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<textarea name="req_message" rows="10" cols="75" tabindex="2"></textarea><br /></label>
-						<p><?php echo $lang_misc['Email disclosure note'] ?></p>
-					</div>
-				</fieldset>
-			</div>
-			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" tabindex="3" accesskey="s" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
-		</form>
-	</div>
-</div>
-<?php
-
-	require PUN_ROOT.'footer.php';
-}
-
-
-else if (isset($_GET['report']))
-{
-	if ($pun_user['is_guest'])
-		message($lang_common['No permission'], false, '403 Forbidden');
-
-	$post_id = intval($_GET['report']);
-	if ($post_id < 1)
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	if (isset($_POST['form_sent']))
-	{
-		// Make sure they got here from the site
-		confirm_referrer('misc.php');
-
-		// Clean up reason from POST
-		$reason = pun_linebreaks(pun_trim($_POST['req_reason']));
-		if ($reason == '')
-			message($lang_misc['No reason']);
-		else if (strlen($reason) > 65535) // TEXT field can only hold 65535 bytes
-			message($lang_misc['Reason too long']);
-
-		if ($pun_user['last_report_sent'] != '' && (time() - $pun_user['last_report_sent']) < $pun_user['g_report_flood'] && (time() - $pun_user['last_report_sent']) >= 0)
-			message(sprintf($lang_misc['Report flood'], $pun_user['g_report_flood'], $pun_user['g_report_flood'] - (time() - $pun_user['last_report_sent'])));
-
-		// Get the topic ID
-		$result = $db->query('SELECT topic_id FROM '.$db->prefix.'posts WHERE id='.$post_id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
-			message($lang_common['Bad request'], false, '404 Not Found');
-
-		$topic_id = $db->result($result);
-
-		// Get the subject and forum ID
-		$result = $db->query('SELECT subject, forum_id FROM '.$db->prefix.'topics WHERE id='.$topic_id) or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
-			message($lang_common['Bad request'], false, '404 Not Found');
-
-		list($subject, $forum_id) = $db->fetch_row($result);
-
-		// Should we use the internal report handling?
-		if ($pun_config['o_report_method'] == '0' || $pun_config['o_report_method'] == '2')
-			$db->query('INSERT INTO '.$db->prefix.'reports (post_id, topic_id, forum_id, reported_by, created, message) VALUES('.$post_id.', '.$topic_id.', '.$forum_id.', '.$pun_user['id'].', '.time().', \''.$db->escape($reason).'\')' ) or error('Unable to create report', __FILE__, __LINE__, $db->error());
-
-		// Should we email the report?
-		if ($pun_config['o_report_method'] == '1' || $pun_config['o_report_method'] == '2')
-		{
-			// We send it to the complete mailing-list in one swoop
-			if ($pun_config['o_mailing_list'] != '')
-			{
-				// Load the "new report" template
-				$mail_tpl = trim(file_get_contents(PUN_ROOT.'lang/'.$pun_user['language'].'/mail_templates/new_report.tpl'));
-
-				// The first row contains the subject
-				$first_crlf = strpos($mail_tpl, "\n");
-				$mail_subject = trim(substr($mail_tpl, 8, $first_crlf-8));
-				$mail_message = trim(substr($mail_tpl, $first_crlf));
-
-				$mail_subject = str_replace('<forum_id>', $forum_id, $mail_subject);
-				$mail_subject = str_replace('<topic_subject>', $subject, $mail_subject);
-				$mail_message = str_replace('<username>', $pun_user['username'], $mail_message);
-				$mail_message = str_replace('<post_url>', get_base_url().'/viewtopic.php?pid='.$post_id.'#p'.$post_id, $mail_message);
-				$mail_message = str_replace('<reason>', $reason, $mail_message);
-				$mail_message = str_replace('<board_mailer>', $pun_config['o_board_title'], $mail_message);
-
-				require PUN_ROOT.'include/email.php';
-
-				pun_mail($pun_config['o_mailing_list'], $mail_subject, $mail_message);
-			}
-		}
-
-		$db->query('UPDATE '.$db->prefix.'users SET last_report_sent='.time().' WHERE id='.$pun_user['id']) or error('Unable to update user', __FILE__, __LINE__, $db->error());
-
-		redirect('viewforum.php?id='.$forum_id, $lang_misc['Report redirect']);
-	}
-
-	// Fetch some info about the post, the topic and the forum
-	$result = $db->query('SELECT f.id AS fid, f.forum_name, t.id AS tid, t.subject FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.id='.$post_id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	$cur_post = $db->fetch_assoc($result);
-
-	if ($pun_config['o_censoring'] == '1')
-		$cur_post['subject'] = censor_words($cur_post['subject']);
-
-	$crumbs = generate_crumbs(array(
-		array($lang_common['Index'], 'index.php'),
-		array($cur_post['forum_name'], 'viewforum.php?id='.$cur_post['fid']),
-		array($cur_post['subject'], 'viewtopic.php?pid='.$post_id.'#p'.$post_id),
-		$lang_misc['Report post'],
-	));
-
-	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_misc['Report post']);
-	$required_fields = array('req_reason' => $lang_misc['Reason']);
-	$focus_element = array('report', 'req_reason');
-	define('PUN_ACTIVE_PAGE', 'index');
-	require PUN_ROOT.'header.php';
-
-?>
-<div class="linkst">
-	<div class="inbox">
-		<?php echo $crumbs ?>
-	</div>
-</div>
-
-<div id="reportform" class="blockform">
-	<h2><span><?php echo $lang_misc['Report post'] ?></span></h2>
-	<div class="box">
-		<form id="report" method="post" action="misc.php?report=<?php echo $post_id ?>" onsubmit="this.submit.disabled=true;if(process_form(this)){return true;}else{this.submit.disabled=false;return false;}">
-			<div class="inform">
-				<fieldset>
-					<legend><?php echo $lang_misc['Reason desc'] ?></legend>
-					<div class="infldset txtarea">
-						<input type="hidden" name="form_sent" value="1" />
-						<label class="required"><strong><?php echo $lang_misc['Reason'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><textarea name="req_reason" rows="5" cols="60"></textarea><br /></label>
-					</div>
-				</fieldset>
-			</div>
-			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
-		</form>
-	</div>
-</div>
-<?php
-
-	require PUN_ROOT.'footer.php';
-}
-
-
-else if ($action == 'subscribe')
-{
-	if ($pun_user['is_guest'])
-		message($lang_common['No permission'], false, '403 Forbidden');
-
-	check_csrf($_GET['csrf_token']);
-
-	$topic_id = isset($_GET['tid']) ? intval($_GET['tid']) : 0;
-	$forum_id = isset($_GET['fid']) ? intval($_GET['fid']) : 0;
-	if ($topic_id < 1 && $forum_id < 1)
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	if ($topic_id)
-	{
-		if ($pun_config['o_topic_subscriptions'] != '1')
-			message($lang_common['No permission'], false, '403 Forbidden');
-
-		// Make sure the user can view the topic
-		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.id='.$topic_id.' AND t.moved_to IS NULL') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
-			message($lang_common['Bad request'], false, '404 Not Found');
-
-		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topic_subscriptions WHERE user_id='.$pun_user['id'].' AND topic_id='.$topic_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
-			message($lang_misc['Already subscribed topic']);
-
-		$db->query('INSERT INTO '.$db->prefix.'topic_subscriptions (user_id, topic_id) VALUES('.$pun_user['id'].' ,'.$topic_id.')') or error('Unable to add subscription', __FILE__, __LINE__, $db->error());
-
-		redirect('viewtopic.php?id='.$topic_id, $lang_misc['Subscribe redirect']);
-	}
-
-	if ($forum_id)
-	{
-		if ($pun_config['o_forum_subscriptions'] != '1')
-			message($lang_common['No permission'], false, '403 Forbidden');
-
-		// Make sure the user can view the forum
-		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$forum_id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
-			message($lang_common['Bad request'], false, '404 Not Found');
-
-		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forum_subscriptions WHERE user_id='.$pun_user['id'].' AND forum_id='.$forum_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
-			message($lang_misc['Already subscribed forum']);
-
-		$db->query('INSERT INTO '.$db->prefix.'forum_subscriptions (user_id, forum_id) VALUES('.$pun_user['id'].' ,'.$forum_id.')') or error('Unable to add subscription', __FILE__, __LINE__, $db->error());
-
-		redirect('viewforum.php?id='.$forum_id, $lang_misc['Subscribe redirect']);
-	}
-}
-
-
-else if ($action == 'unsubscribe')
-{
-	if ($pun_user['is_guest'])
-		message($lang_common['No permission'], false, '403 Forbidden');
-
-	check_csrf($_GET['csrf_token']);
-
-	$topic_id = isset($_GET['tid']) ? intval($_GET['tid']) : 0;
-	$forum_id = isset($_GET['fid']) ? intval($_GET['fid']) : 0;
-	if ($topic_id < 1 && $forum_id < 1)
-		message($lang_common['Bad request'], false, '404 Not Found');
-
-	if ($topic_id)
-	{
-		if ($pun_config['o_topic_subscriptions'] != '1')
-			message($lang_common['No permission'], false, '403 Forbidden');
-
-		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topic_subscriptions WHERE user_id='.$pun_user['id'].' AND topic_id='.$topic_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
-			message($lang_misc['Not subscribed topic']);
-
-		$db->query('DELETE FROM '.$db->prefix.'topic_subscriptions WHERE user_id='.$pun_user['id'].' AND topic_id='.$topic_id) or error('Unable to remove subscription', __FILE__, __LINE__, $db->error());
-
-		redirect('viewtopic.php?id='.$topic_id, $lang_misc['Unsubscribe redirect']);
-	}
-
-	if ($forum_id)
-	{
-		if ($pun_config['o_forum_subscriptions'] != '1')
-			message($lang_common['No permission'], false, '403 Forbidden');
-
-		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forum_subscriptions WHERE user_id='.$pun_user['id'].' AND forum_id='.$forum_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
-			message($lang_misc['Not subscribed forum']);
-
-		$db->query('DELETE FROM '.$db->prefix.'forum_subscriptions WHERE user_id='.$pun_user['id'].' AND forum_id='.$forum_id) or error('Unable to remove subscription', __FILE__, __LINE__, $db->error());
-
-		redirect('viewforum.php?id='.$forum_id, $lang_misc['Unsubscribe redirect']);
-	}
-}
-
-
-else
-	message($lang_common['Bad request'], false, '404 Not Found');
+<?php
+
+/**
+ * Copyright (C) 2008-2012 FluxBB
+ * based on code by Rickard Andersson copyright (C) 2002-2008 PunBB
+ * License: http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
+ */
+
+if (isset($_GET['action']))
+	define('PUN_QUIET_VISIT', 1);
+
+define('PUN_ROOT', dirname(__FILE__).'/');
+require PUN_ROOT.'include/common.php';
+
+
+// Load the misc.php language file
+require PUN_ROOT.'lang/'.$pun_user['language'].'/misc.php';
+
+$action = isset($_GET['action']) ? $_GET['action'] : null;
+
+
+if ($action == 'rules')
+{
+	if ($pun_config['o_rules'] == '0' || ($pun_user['is_guest'] && $pun_user['g_read_board'] == '0' && $pun_config['o_regs_allow'] == '0'))
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	// Load the register.php language file
+	require PUN_ROOT.'lang/'.$pun_user['language'].'/register.php';
+
+	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_register['Forum rules']);
+	define('PUN_ACTIVE_PAGE', 'rules');
+	require PUN_ROOT.'header.php';
+
+?>
+<div id="rules" class="block">
+	<div class="hd"><h2><span><?php echo $lang_register['Forum rules'] ?></span></h2></div>
+	<div class="box">
+		<div id="rules-block" class="inbox">
+			<div class="usercontent"><?php echo $pun_config['o_rules_message'] ?></div>
+		</div>
+	</div>
+</div>
+<?php
+
+	require PUN_ROOT.'footer.php';
+}
+
+
+else if ($action == 'markread')
+{
+	if ($pun_user['is_guest'])
+		message($lang_common['No permission'], false, '403 Forbidden');
+
+	check_csrf($_GET['csrf_token']);
+
+	$db->query('UPDATE '.$db->prefix.'users SET last_visit='.$pun_user['logged'].' WHERE id='.$pun_user['id']) or error('Unable to update user last visit data', __FILE__, __LINE__, $db->error());
+
+	// Reset tracked topics
+	set_tracked_topics(null);
+
+	redirect('index.php', $lang_misc['Mark read redirect']);
+}
+
+
+// Mark the topics/posts in a forum as read?
+else if ($action == 'markforumread')
+{
+	if ($pun_user['is_guest'])
+		message($lang_common['No permission'], false, '403 Forbidden');
+
+	check_csrf($_GET['csrf_token']);
+
+	$fid = isset($_GET['fid']) ? intval($_GET['fid']) : 0;
+	if ($fid < 1)
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	$tracked_topics = get_tracked_topics();
+	$tracked_topics['forums'][$fid] = time();
+	set_tracked_topics($tracked_topics);
+
+	redirect('viewforum.php?id='.$fid, $lang_misc['Mark forum read redirect']);
+}
+
+
+else if (isset($_GET['email']))
+{
+	if ($pun_user['is_guest'] || $pun_user['g_send_email'] == '0')
+		message($lang_common['No permission'], false, '403 Forbidden');
+
+	$recipient_id = intval($_GET['email']);
+	if ($recipient_id < 2)
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	$result = $db->query('SELECT username, email, email_setting FROM '.$db->prefix.'users WHERE id='.$recipient_id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+	if (!$db->num_rows($result))
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	list($recipient, $recipient_email, $email_setting) = $db->fetch_row($result);
+
+	if ($email_setting == 2 && !$pun_user['is_admmod'])
+		message($lang_misc['Form email disabled']);
+
+
+	if (isset($_POST['form_sent']))
+	{
+		confirm_referrer('misc.php');
+
+		// Clean up message and subject from POST
+		$subject = pun_trim($_POST['req_subject']);
+		$message = pun_trim($_POST['req_message']);
+
+		if ($subject == '')
+			message($lang_misc['No email subject']);
+		else if ($message == '')
+			message($lang_misc['No email message']);
+		// Here we use strlen() not pun_strlen() as we want to limit the post to PUN_MAX_POSTSIZE bytes, not characters
+		else if (strlen($message) > PUN_MAX_POSTSIZE)
+			message($lang_misc['Too long email message']);
+
+		if ($pun_user['last_email_sent'] != '' && (time() - $pun_user['last_email_sent']) < $pun_user['g_email_flood'] && (time() - $pun_user['last_email_sent']) >= 0)
+			message(sprintf($lang_misc['Email flood'], $pun_user['g_email_flood'], $pun_user['g_email_flood'] - (time() - $pun_user['last_email_sent'])));
+
+		// Load the "form email" template
+		$mail_tpl = trim(file_get_contents(PUN_ROOT.'lang/'.$pun_user['language'].'/mail_templates/form_email.tpl'));
+
+		// The first row contains the subject
+		$first_crlf = strpos($mail_tpl, "\n");
+		$mail_subject = pun_trim(substr($mail_tpl, 8, $first_crlf-8));
+		$mail_message = pun_trim(substr($mail_tpl, $first_crlf));
+
+		$mail_subject = str_replace('<mail_subject>', $subject, $mail_subject);
+		$mail_message = str_replace('<sender>', $pun_user['username'], $mail_message);
+		$mail_message = str_replace('<board_title>', $pun_config['o_board_title'], $mail_message);
+		$mail_message = str_replace('<mail_message>', $message, $mail_message);
+		$mail_message = str_replace('<board_mailer>', $pun_config['o_board_title'], $mail_message);
+
+		require_once PUN_ROOT.'include/email.php';
+
+		pun_mail($recipient_email, $mail_subject, $mail_message, $pun_user['email'], $pun_user['username']);
+
+		$db->query('UPDATE '.$db->prefix.'users SET last_email_sent='.time().' WHERE id='.$pun_user['id']) or error('Unable to update user', __FILE__, __LINE__, $db->error());
+
+		// Try to determine if the data in redirect_url is valid (if not, we redirect to index.php after the email is sent)
+		$redirect_url = validate_redirect($_POST['redirect_url'], 'index.php');
+
+		redirect(pun_htmlspecialchars($redirect_url), $lang_misc['Email sent redirect']);
+	}
+
+
+	// Try to determine if the data in HTTP_REFERER is valid (if not, we redirect to the user's profile after the email is sent)
+	if (!empty($_SERVER['HTTP_REFERER']))
+		$redirect_url = validate_redirect($_SERVER['HTTP_REFERER'], null);
+
+	if (!isset($redirect_url))
+		$redirect_url = get_base_url(true).'/profile.php?id='.$recipient_id;
+	else if (preg_match('%viewtopic\.php\?pid=(\d+)$%', $redirect_url, $matches))
+		$redirect_url .= '#p'.$matches[1];
+
+	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_misc['Send email to'].' '.pun_htmlspecialchars($recipient));
+	$required_fields = array('req_subject' => $lang_misc['Email subject'], 'req_message' => $lang_misc['Email message']);
+	$focus_element = array('email', 'req_subject');
+	define('PUN_ACTIVE_PAGE', 'index');
+	require PUN_ROOT.'header.php';
+
+?>
+<div id="emailform" class="blockform">
+	<h2><span><?php echo $lang_misc['Send email to'] ?> <?php echo pun_htmlspecialchars($recipient) ?></span></h2>
+	<div class="box">
+		<form id="email" method="post" action="misc.php?email=<?php echo $recipient_id ?>" onsubmit="this.submit.disabled=true;if(process_form(this)){return true;}else{this.submit.disabled=false;return false;}">
+			<div class="inform">
+				<fieldset>
+					<legend><?php echo $lang_misc['Write email'] ?></legend>
+					<div class="infldset txtarea">
+						<input type="hidden" name="form_sent" value="1" />
+						<input type="hidden" name="redirect_url" value="<?php echo pun_htmlspecialchars($redirect_url) ?>" />
+						<label class="required"><strong><?php echo $lang_misc['Email subject'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
+						<input class="longinput" type="text" name="req_subject" size="75" maxlength="70" required /><br /></label>
+						<label class="required"><strong><?php echo $lang_misc['Email message'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
+						<textarea name="req_message" rows="10" cols="75" required></textarea><br /></label>
+						<p><?php echo $lang_misc['Email disclosure note'] ?></p>
+					</div>
+				</fieldset>
+			</div>
+			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
+		</form>
+	</div>
+</div>
+<?php
+
+	require PUN_ROOT.'footer.php';
+}
+
+
+else if (isset($_GET['report']))
+{
+	if ($pun_user['is_guest'])
+		message($lang_common['No permission'], false, '403 Forbidden');
+
+	$post_id = intval($_GET['report']);
+	if ($post_id < 1)
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	if (isset($_POST['form_sent']))
+	{
+		// Make sure they got here from the site
+		confirm_referrer('misc.php');
+
+		// Clean up reason from POST
+		$reason = pun_linebreaks(pun_trim($_POST['req_reason']));
+		if ($reason == '')
+			message($lang_misc['No reason']);
+		else if (strlen($reason) > 65535) // TEXT field can only hold 65535 bytes
+			message($lang_misc['Reason too long']);
+
+		if ($pun_user['last_report_sent'] != '' && (time() - $pun_user['last_report_sent']) < $pun_user['g_report_flood'] && (time() - $pun_user['last_report_sent']) >= 0)
+			message(sprintf($lang_misc['Report flood'], $pun_user['g_report_flood'], $pun_user['g_report_flood'] - (time() - $pun_user['last_report_sent'])));
+
+		// Get the topic ID
+		$result = $db->query('SELECT topic_id FROM '.$db->prefix.'posts WHERE id='.$post_id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
+		if (!$db->num_rows($result))
+			message($lang_common['Bad request'], false, '404 Not Found');
+
+		$topic_id = $db->result($result);
+
+		// Get the subject and forum ID
+		$result = $db->query('SELECT subject, forum_id FROM '.$db->prefix.'topics WHERE id='.$topic_id) or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
+		if (!$db->num_rows($result))
+			message($lang_common['Bad request'], false, '404 Not Found');
+
+		list($subject, $forum_id) = $db->fetch_row($result);
+
+		// Should we use the internal report handling?
+		if ($pun_config['o_report_method'] == '0' || $pun_config['o_report_method'] == '2')
+			$db->query('INSERT INTO '.$db->prefix.'reports (post_id, topic_id, forum_id, reported_by, created, message) VALUES('.$post_id.', '.$topic_id.', '.$forum_id.', '.$pun_user['id'].', '.time().', \''.$db->escape($reason).'\')' ) or error('Unable to create report', __FILE__, __LINE__, $db->error());
+
+		// Should we email the report?
+		if ($pun_config['o_report_method'] == '1' || $pun_config['o_report_method'] == '2')
+		{
+			// We send it to the complete mailing-list in one swoop
+			if ($pun_config['o_mailing_list'] != '')
+			{
+				// Load the "new report" template
+				$mail_tpl = trim(file_get_contents(PUN_ROOT.'lang/'.$pun_user['language'].'/mail_templates/new_report.tpl'));
+
+				// The first row contains the subject
+				$first_crlf = strpos($mail_tpl, "\n");
+				$mail_subject = trim(substr($mail_tpl, 8, $first_crlf-8));
+				$mail_message = trim(substr($mail_tpl, $first_crlf));
+
+				$mail_subject = str_replace('<forum_id>', $forum_id, $mail_subject);
+				$mail_subject = str_replace('<topic_subject>', $subject, $mail_subject);
+				$mail_message = str_replace('<username>', $pun_user['username'], $mail_message);
+				$mail_message = str_replace('<post_url>', get_base_url().'/viewtopic.php?pid='.$post_id.'#p'.$post_id, $mail_message);
+				$mail_message = str_replace('<reason>', $reason, $mail_message);
+				$mail_message = str_replace('<board_mailer>', $pun_config['o_board_title'], $mail_message);
+
+				require PUN_ROOT.'include/email.php';
+
+				pun_mail($pun_config['o_mailing_list'], $mail_subject, $mail_message);
+			}
+		}
+
+		$db->query('UPDATE '.$db->prefix.'users SET last_report_sent='.time().' WHERE id='.$pun_user['id']) or error('Unable to update user', __FILE__, __LINE__, $db->error());
+
+		redirect('viewforum.php?id='.$forum_id, $lang_misc['Report redirect']);
+	}
+
+	// Fetch some info about the post, the topic and the forum
+	$result = $db->query('SELECT f.id AS fid, f.forum_name, t.id AS tid, t.subject FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.id='.$post_id) or error('Unable to fetch post info', __FILE__, __LINE__, $db->error());
+	if (!$db->num_rows($result))
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	$cur_post = $db->fetch_assoc($result);
+
+	if ($pun_config['o_censoring'] == '1')
+		$cur_post['subject'] = censor_words($cur_post['subject']);
+
+	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_misc['Report post']);
+	$required_fields = array('req_reason' => $lang_misc['Reason']);
+	$focus_element = array('report', 'req_reason');
+	define('PUN_ACTIVE_PAGE', 'index');
+	require PUN_ROOT.'header.php';
+
+?>
+<div class="linkst">
+	<div class="inbox">
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $cur_post['fid'] ?>"><?php echo pun_htmlspecialchars($cur_post['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><a href="viewtopic.php?pid=<?php echo $post_id ?>#p<?php echo $post_id ?>"><?php echo pun_htmlspecialchars($cur_post['subject']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_misc['Report post'] ?></strong></li>
+		</ul>
+	</div>
+</div>
+
+<div id="reportform" class="blockform">
+	<h2><span><?php echo $lang_misc['Report post'] ?></span></h2>
+	<div class="box">
+		<form id="report" method="post" action="misc.php?report=<?php echo $post_id ?>" onsubmit="this.submit.disabled=true;if(process_form(this)){return true;}else{this.submit.disabled=false;return false;}">
+			<div class="inform">
+				<fieldset>
+					<legend><?php echo $lang_misc['Reason desc'] ?></legend>
+					<div class="infldset txtarea">
+						<input type="hidden" name="form_sent" value="1" />
+						<label class="required"><strong><?php echo $lang_misc['Reason'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><textarea name="req_reason" rows="5" cols="60" required></textarea><br /></label>
+					</div>
+				</fieldset>
+			</div>
+			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
+		</form>
+	</div>
+</div>
+<?php
+
+	require PUN_ROOT.'footer.php';
+}
+
+
+else if ($action == 'subscribe')
+{
+	if ($pun_user['is_guest'])
+		message($lang_common['No permission'], false, '403 Forbidden');
+
+	check_csrf($_GET['csrf_token']);
+
+	$topic_id = isset($_GET['tid']) ? intval($_GET['tid']) : 0;
+	$forum_id = isset($_GET['fid']) ? intval($_GET['fid']) : 0;
+	if ($topic_id < 1 && $forum_id < 1)
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	if ($topic_id)
+	{
+		if ($pun_config['o_topic_subscriptions'] != '1')
+			message($lang_common['No permission'], false, '403 Forbidden');
+
+		// Make sure the user can view the topic
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.id='.$topic_id.' AND t.moved_to IS NULL') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
+		if (!$db->num_rows($result))
+			message($lang_common['Bad request'], false, '404 Not Found');
+
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topic_subscriptions WHERE user_id='.$pun_user['id'].' AND topic_id='.$topic_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
+		if ($db->num_rows($result))
+			message($lang_misc['Already subscribed topic']);
+
+		$db->query('INSERT INTO '.$db->prefix.'topic_subscriptions (user_id, topic_id) VALUES('.$pun_user['id'].' ,'.$topic_id.')') or error('Unable to add subscription', __FILE__, __LINE__, $db->error());
+
+		redirect('viewtopic.php?id='.$topic_id, $lang_misc['Subscribe redirect']);
+	}
+
+	if ($forum_id)
+	{
+		if ($pun_config['o_forum_subscriptions'] != '1')
+			message($lang_common['No permission'], false, '403 Forbidden');
+
+		// Make sure the user can view the forum
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$forum_id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());
+		if (!$db->num_rows($result))
+			message($lang_common['Bad request'], false, '404 Not Found');
+
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forum_subscriptions WHERE user_id='.$pun_user['id'].' AND forum_id='.$forum_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
+		if ($db->num_rows($result))
+			message($lang_misc['Already subscribed forum']);
+
+		$db->query('INSERT INTO '.$db->prefix.'forum_subscriptions (user_id, forum_id) VALUES('.$pun_user['id'].' ,'.$forum_id.')') or error('Unable to add subscription', __FILE__, __LINE__, $db->error());
+
+		redirect('viewforum.php?id='.$forum_id, $lang_misc['Subscribe redirect']);
+	}
+}
+
+
+else if ($action == 'unsubscribe')
+{
+	if ($pun_user['is_guest'])
+		message($lang_common['No permission'], false, '403 Forbidden');
+
+	check_csrf($_GET['csrf_token']);
+
+	$topic_id = isset($_GET['tid']) ? intval($_GET['tid']) : 0;
+	$forum_id = isset($_GET['fid']) ? intval($_GET['fid']) : 0;
+	if ($topic_id < 1 && $forum_id < 1)
+		message($lang_common['Bad request'], false, '404 Not Found');
+
+	if ($topic_id)
+	{
+		if ($pun_config['o_topic_subscriptions'] != '1')
+			message($lang_common['No permission'], false, '403 Forbidden');
+
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topic_subscriptions WHERE user_id='.$pun_user['id'].' AND topic_id='.$topic_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
+		if (!$db->num_rows($result))
+			message($lang_misc['Not subscribed topic']);
+
+		$db->query('DELETE FROM '.$db->prefix.'topic_subscriptions WHERE user_id='.$pun_user['id'].' AND topic_id='.$topic_id) or error('Unable to remove subscription', __FILE__, __LINE__, $db->error());
+
+		redirect('viewtopic.php?id='.$topic_id, $lang_misc['Unsubscribe redirect']);
+	}
+
+	if ($forum_id)
+	{
+		if ($pun_config['o_forum_subscriptions'] != '1')
+			message($lang_common['No permission'], false, '403 Forbidden');
+
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forum_subscriptions WHERE user_id='.$pun_user['id'].' AND forum_id='.$forum_id) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
+		if (!$db->num_rows($result))
+			message($lang_misc['Not subscribed forum']);
+
+		$db->query('DELETE FROM '.$db->prefix.'forum_subscriptions WHERE user_id='.$pun_user['id'].' AND forum_id='.$forum_id) or error('Unable to remove subscription', __FILE__, __LINE__, $db->error());
+
+		redirect('viewforum.php?id='.$forum_id, $lang_misc['Unsubscribe redirect']);
+	}
+}
+
+
+else
+	message($lang_common['Bad request'], false, '404 Not Found');
diff --git a/moderate.php b/moderate.php
index 3f9f6e03..08cb8364 100644
--- a/moderate.php
+++ b/moderate.php
@@ -27,7 +27,7 @@ if (isset($_GET['get_host']))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		$result = $db->query('SELECT poster_ip FROM '.$db->prefix.'posts WHERE id='.$get_host) or error('Unable to fetch post IP address', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
+		if (!$db->num_rows($result))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		$ip = $db->result($result);
@@ -70,7 +70,7 @@ if (isset($_GET['tid']))
 
 	// Fetch some info about the topic
 	$result = $db->query('SELECT t.subject, t.num_replies, t.first_post_id, f.id AS forum_id, forum_name FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$fid.' AND t.id='.$tid.' AND t.moved_to IS NULL') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
+	if (!$db->num_rows($result))
 		message($lang_common['Bad request'], false, '404 Not Found');
 
 	$cur_topic = $db->fetch_assoc($result);
@@ -91,9 +91,9 @@ if (isset($_GET['tid']))
 
 			// Verify that the post IDs are valid
 			$admins_sql = ($pun_user['g_id'] != PUN_ADMIN) ? ' AND poster_id NOT IN('.implode(',', get_admin_ids()).')' : '';
-			$result = $db->query('SELECT COUNT(*) FROM '.$db->prefix.'posts WHERE id IN('.$posts.') AND topic_id='.$tid.$admins_sql) or error('Unable to check posts', __FILE__, __LINE__, $db->error());
+			$result = $db->query('SELECT 1 FROM '.$db->prefix.'posts WHERE id IN('.$posts.') AND topic_id='.$tid.$admins_sql) or error('Unable to check posts', __FILE__, __LINE__, $db->error());
 
-			if ($db->result($result) != substr_count($posts, ',') + 1)
+			if ($db->num_rows($result) != substr_count($posts, ',') + 1)
 				message($lang_common['Bad request'], false, '404 Not Found');
 
 			// Delete the posts
@@ -165,13 +165,13 @@ if (isset($_GET['tid']))
 			$num_posts_splitted = substr_count($posts, ',') + 1;
 
 			// Verify that the post IDs are valid
-			$result = $db->query('SELECT COUNT(*) FROM '.$db->prefix.'posts WHERE id IN('.$posts.') AND topic_id='.$tid) or error('Unable to check posts', __FILE__, __LINE__, $db->error());
-			if ($db->result($result) != $num_posts_splitted)
+			$result = $db->query('SELECT 1 FROM '.$db->prefix.'posts WHERE id IN('.$posts.') AND topic_id='.$tid) or error('Unable to check posts', __FILE__, __LINE__, $db->error());
+			if ($db->num_rows($result) != $num_posts_splitted)
 				message($lang_common['Bad request'], false, '404 Not Found');
 
 			// Verify that the move to forum ID is valid
 			$result = $db->query('SELECT 1 FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.group_id='.$pun_user['g_id'].' AND fp.forum_id='.$move_to_forum.') WHERE f.redirect_url IS NULL AND (fp.post_topics IS NULL OR fp.post_topics=1)') or error('Unable to fetch forum permissions', __FILE__, __LINE__, $db->error());
-			if (!$db->has_rows($result))
+			if (!$db->num_rows($result))
 				message($lang_common['Bad request'], false, '404 Not Found');
 
 			// Load the post.php language file
@@ -276,7 +276,7 @@ if (isset($_GET['tid']))
 	require PUN_ROOT.'lang/'.$pun_user['language'].'/topic.php';
 
 	// Used to disable the Move and Delete buttons if there are no replies to this topic
-	$button_status = ($cur_topic['num_replies'] == 0) ? ' disabled="disabled"' : '';
+	$button_status = ($cur_topic['num_replies'] == 0) ? ' disabled' : '';
 
 	if (isset($_GET['action']) && $_GET['action'] == 'all')
 		$pun_user['disp_posts'] = $cur_topic['num_replies'] + 1;
@@ -294,12 +294,6 @@ if (isset($_GET['tid']))
 	if ($pun_config['o_censoring'] == '1')
 		$cur_topic['subject'] = censor_words($cur_topic['subject']);
 
-	$crumbs = generate_crumbs(array(
-		array($lang_common['Index'], 'index.php'),
-		array($cur_topic['forum_name'], 'viewforum.php?id='.$fid),
-		array($cur_topic['subject'], 'viewtopic.php?id='.$tid),
-		$lang_misc['Moderate'],
-	));
 
 	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), pun_htmlspecialchars($cur_topic['forum_name']), pun_htmlspecialchars($cur_topic['subject']));
 	define('PUN_ACTIVE_PAGE', 'index');
@@ -308,7 +302,12 @@ if (isset($_GET['tid']))
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $fid ?>"><?php echo pun_htmlspecialchars($cur_topic['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><a href="viewtopic.php?id=<?php echo $tid ?>"><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_misc['Moderate'] ?></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink conl"><?php echo $paging_links ?></p>
 		</div>
@@ -365,11 +364,11 @@ if (isset($_GET['tid']))
 ?>
 
 <div id="p<?php echo $cur_post['id'] ?>" class="blockpost<?php if($cur_post['id'] == $cur_topic['first_post_id']) echo ' firstpost' ?><?php echo ($post_count % 2 == 0) ? ' roweven' : ' rowodd' ?><?php if ($post_count == 1) echo ' blockpost1' ?>">
-	<h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <a href="viewtopic.php?pid=<?php echo $cur_post['id'].'#p'.$cur_post['id'] ?>"><?php echo format_time($cur_post['posted']) ?></a></span></h2>
 	<div class="box">
 		<div class="inbox">
 			<div class="postbody">
 				<div class="postleft">
+                    <h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <a href="viewtopic.php?pid=<?php echo $cur_post['id'].'#p'.$cur_post['id'] ?>"><?php echo format_time($cur_post['posted']) ?></a></span></h2>
 					<dl>
 						<dt><strong><?php echo $poster ?></strong></dt>
 						<dd class="usertitle"><strong><?php echo $user_title ?></strong></dd>
@@ -404,7 +403,12 @@ if (isset($_GET['tid']))
 			<p class="conr modbuttons"><input type="submit" name="split_posts" value="<?php echo $lang_misc['Split'] ?>"<?php echo $button_status ?> /> <input type="submit" name="delete_posts" value="<?php echo $lang_misc['Delete'] ?>"<?php echo $button_status ?> /></p>
 			<div class="clearer"></div>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $fid ?>"><?php echo pun_htmlspecialchars($cur_topic['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><a href="viewtopic.php?id=<?php echo $tid ?>"><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_misc['Moderate'] ?></strong></li>
+		</ul>
 		<div class="clearer"></div>
 	</div>
 </div>
@@ -431,14 +435,14 @@ if (isset($_REQUEST['move_topics']) || isset($_POST['move_topics_to']))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		// Verify that the topic IDs are valid
-		$result = $db->query('SELECT COUNT(*) FROM '.$db->prefix.'topics WHERE id IN('.implode(',',$topics).') AND forum_id='.$fid) or error('Unable to check topics', __FILE__, __LINE__, $db->error());
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topics WHERE id IN('.implode(',',$topics).') AND forum_id='.$fid) or error('Unable to check topics', __FILE__, __LINE__, $db->error());
 
-		if ($db->result($result) != count($topics))
+		if ($db->num_rows($result) != count($topics))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		// Verify that the move to forum ID is valid
 		$result = $db->query('SELECT 1 FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.group_id='.$pun_user['g_id'].' AND fp.forum_id='.$move_to_forum.') WHERE f.redirect_url IS NULL AND (fp.post_topics IS NULL OR fp.post_topics=1)') or error('Unable to fetch forum permissions', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
+		if (!$db->num_rows($result))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		// Delete any redirect topics if there are any (only if we moved/copied the topic back to where it was once moved from)
@@ -487,12 +491,7 @@ if (isset($_REQUEST['move_topics']) || isset($_POST['move_topics_to']))
 	}
 
 	$result = $db->query('SELECT c.id AS cid, c.cat_name, f.id AS fid, f.forum_name FROM '.$db->prefix.'categories AS c INNER JOIN '.$db->prefix.'forums AS f ON c.id=f.cat_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.post_topics IS NULL OR fp.post_topics=1) AND f.redirect_url IS NULL ORDER BY c.disp_position, c.id, f.disp_position') or error('Unable to fetch category/forum list', __FILE__, __LINE__, $db->error());
-
-	$forums = array();
-	while ($row = $db->fetch_assoc($result))
-		$forums[] = $row;
-
-	if (count($forums) < 2)
+	if ($db->num_rows($result) < 2)
 		message($lang_misc['Nowhere to move']);
 
 	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_misc['Moderate']);
@@ -514,7 +513,7 @@ if (isset($_REQUEST['move_topics']) || isset($_POST['move_topics_to']))
 <?php
 
 	$cur_category = 0;
-	foreach ($forums as $cur_forum)
+	while ($cur_forum = $db->fetch_assoc($result))
 	{
 		if ($cur_forum['cid'] != $cur_category) // A new category since last iteration?
 		{
@@ -534,7 +533,7 @@ if (isset($_REQUEST['move_topics']) || isset($_POST['move_topics_to']))
 						</select>
 						<br /></label>
 						<div class="rbox">
-							<label><input type="checkbox" name="with_redirect" value="1"<?php if ($action == 'single') echo ' checked="checked"' ?> /><?php echo $lang_misc['Leave redirect'] ?><br /></label>
+							<label><input type="checkbox" name="with_redirect" value="1"<?php if ($action == 'single') echo ' checked' ?> /><?php echo $lang_misc['Leave redirect'] ?><br /></label>
 						</div>
 					</div>
 				</fieldset>
@@ -564,16 +563,11 @@ else if (isset($_POST['merge_topics']) || isset($_POST['merge_topics_comply']))
 
 		// Verify that the topic IDs are valid (redirect links will point to the merged topic after the merge)
 		$result = $db->query('SELECT id FROM '.$db->prefix.'topics WHERE id IN('.implode(',', $topics).') AND forum_id='.$fid.' ORDER BY id ASC') or error('Unable to check topics', __FILE__, __LINE__, $db->error());
-
-		$tids = array();
-		while ($cur_tid = $db->result($result))
-			$tids[] = $cur_tid;
-
-		if (count($tids) != count($topics))
+		if ($db->num_rows($result) != count($topics))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		// The topic that we are merging into is the one with the smallest ID
-		$merge_to_tid = $tids[0];
+		$merge_to_tid = $db->result($result);
 
 		// Make any redirect topics point to our new, merged topic
 		$query = 'UPDATE '.$db->prefix.'topics SET moved_to='.$merge_to_tid.' WHERE moved_to IN('.implode(',', $topics).')';
@@ -669,16 +663,16 @@ else if (isset($_POST['delete_topics']) || isset($_POST['delete_topics_comply'])
 		require PUN_ROOT.'include/search_idx.php';
 
 		// Verify that the topic IDs are valid
-		$result = $db->query('SELECT COUNT(*) FROM '.$db->prefix.'topics WHERE id IN('.$topics.') AND forum_id='.$fid) or error('Unable to check topics', __FILE__, __LINE__, $db->error());
+		$result = $db->query('SELECT 1 FROM '.$db->prefix.'topics WHERE id IN('.$topics.') AND forum_id='.$fid) or error('Unable to check topics', __FILE__, __LINE__, $db->error());
 
-		if ($db->result($result) != substr_count($topics, ',') + 1)
+		if ($db->num_rows($result) != substr_count($topics, ',') + 1)
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		// Verify that the posts are not by admins
 		if ($pun_user['g_id'] != PUN_ADMIN)
 		{
 			$result = $db->query('SELECT 1 FROM '.$db->prefix.'posts WHERE topic_id IN('.$topics.') AND poster_id IN('.implode(',', get_admin_ids()).')') or error('Unable to check posts', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 				message($lang_common['No permission'], false, '403 Forbidden');
 		}
 
@@ -815,7 +809,7 @@ require PUN_ROOT.'lang/'.$pun_user['language'].'/forum.php';
 
 // Fetch some info about the forum
 $result = $db->query('SELECT f.forum_name, f.redirect_url, f.num_topics, f.sort_by FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$fid) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());
-if (!$db->has_rows($result))
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $cur_forum = $db->fetch_assoc($result);
@@ -849,12 +843,6 @@ $start_from = $pun_user['disp_topics'] * ($p - 1);
 // Generate paging links
 $paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.paginate($num_pages, $p, 'moderate.php?fid='.$fid);
 
-$crumbs = generate_crumbs(array(
-	array($lang_common['Index'], 'index.php'),
-	array($cur_forum['forum_name'], 'viewforum.php?id='.$fid),
-	$lang_misc['Moderate'],
-));
-
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), pun_htmlspecialchars($cur_forum['forum_name']));
 define('PUN_ACTIVE_PAGE', 'index');
 require PUN_ROOT.'header.php';
@@ -862,7 +850,11 @@ require PUN_ROOT.'header.php';
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $fid ?>"><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_misc['Moderate'] ?></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink conl"><?php echo $paging_links ?></p>
 		</div>
@@ -893,7 +885,7 @@ require PUN_ROOT.'header.php';
 $result = $db->query('SELECT id FROM '.$db->prefix.'topics WHERE forum_id='.$fid.' ORDER BY sticky DESC, '.$sort_by.', id DESC LIMIT '.$start_from.', '.$pun_user['disp_topics']) or error('Unable to fetch topic IDs', __FILE__, __LINE__, $db->error());
 
 // If there are topics in this forum
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 {
 	$topic_ids = array();
 	for ($i = 0;$cur_topic_id = $db->result($result, $i);$i++)
@@ -996,7 +988,7 @@ if ($db->has_rows($result))
 else
 {
 	$colspan = ($pun_config['o_topic_views'] == '1') ? 5 : 4;
-	$button_status = ' disabled="disabled"';
+	$button_status = ' disabled';
 	echo "\t\t\t\t\t".'<tr><td class="tcl" colspan="'.$colspan.'">'.$lang_forum['Empty forum'].'</td></tr>'."\n";
 }
 
@@ -1014,7 +1006,11 @@ else
 			<p class="conr modbuttons"><input type="submit" name="move_topics" value="<?php echo $lang_misc['Move'] ?>"<?php echo $button_status ?> /> <input type="submit" name="delete_topics" value="<?php echo $lang_misc['Delete'] ?>"<?php echo $button_status ?> /> <input type="submit" name="merge_topics" value="<?php echo $lang_misc['Merge'] ?>"<?php echo $button_status ?> /> <input type="submit" name="open" value="<?php echo $lang_misc['Open'] ?>"<?php echo $button_status ?> /> <input type="submit" name="close" value="<?php echo $lang_misc['Close'] ?>"<?php echo $button_status ?> /></p>
 			<div class="clearer"></div>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $fid ?>"><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $lang_misc['Moderate'] ?></strong></li>
+		</ul>
 		<div class="clearer"></div>
 	</div>
 </div>
diff --git a/plugins/AP_SpamBarrier.php b/plugins/AP_SpamBarrier.php
new file mode 100644
index 00000000..cacdf753
--- /dev/null
+++ b/plugins/AP_SpamBarrier.php
@@ -0,0 +1,354 @@
+<?php
+/***********************************************************************
+
+  This software is free software; you can redistribute it and/or modify it
+  under the terms of the GNU General Public License as published
+  by the Free Software Foundation; either version 2 of the License,
+  or (at your option) any later version.
+
+  This software is distributed in the hope that it will be useful, but
+  WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 59 Temple Place, Suite 330, Boston,
+  MA  02111-1307  USA
+
+************************************************************************/
+// Make sure no one attempts to run this script "directly"
+if (!defined('PUN'))
+    exit;
+
+// Tell admin_loader.php that this is indeed a plugin and that it is loaded
+define('PUN_PLUGIN_LOADED', 1);
+define('PLUGIN_VERSION', '1.0.6');
+
+// Load the AP_SpamBarrier.php language file
+if (file_exists(PUN_ROOT.'lang/'.$pun_user['language'].'/AP_SpamBarrier.php'))
+	$langPatcher = require PUN_ROOT.'lang/'.$pun_user['language'].'/AP_SpamBarrier.php';
+else
+	$langPatcher = require PUN_ROOT.'lang/English/AP_SpamBarrier.php';
+
+if (isset($_POST['form_sent']))
+{
+	// Lazy referer check (in case base_url isn't correct)
+	if (!preg_match('#/admin_loader\.php#i', $_SERVER['HTTP_REFERER']))
+		message($lang_common['Bad referrer']);
+
+	$form = array_map('trim', $_POST['form']);
+
+	while (list($key, $input) = @each($form))
+	{
+		// Only update values that have changed
+		if ((isset($pun_config['o_'.$key])) || ($pun_config['o_'.$key] == NULL))
+		{
+			if ($pun_config['o_'.$key] != $input)
+			{
+				if ($input != '' || is_int($input))
+					$value = '\''.$db->escape($input).'\'';
+				else
+					$value = 'NULL';
+
+				$db->query('UPDATE '.$db->prefix.'config SET conf_value='.$value.' WHERE conf_name=\'o_'.$db->escape($key).'\'') or error('Unable to update board config', __FILE__, __LINE__, $db->error());
+			}
+		}
+	}
+
+	// Regenerate the config cache
+	require_once PUN_ROOT.'include/cache.php';
+	generate_config_cache();
+
+	redirect('admin_loader.php?plugin=AP_SpamBarrier.php', $lang_ap_spambarrier['Redirect message']);
+}
+else if (isset($_POST['search_users']))
+{
+	// Display the admin navigation menu
+?>
+<div class="linkst">
+	<div class="inbox">
+		<div><a href="javascript:history.go(-1)"><?php echo $lang_ap_spambarrier['Go_back'] ?></a></div>
+	</div>
+</div>
+
+<div id="users2" class="blocktable">
+	<h2><span><?php echo $lang_ap_spambarrier['SB_users'] ?></span></h2>
+	<div class="box">
+		<div class="inbox">
+			<table cellspacing="0">
+			<thead>
+				<tr>
+					<th class="tcl" scope="col"><?php echo $lang_ap_spambarrier['Col_Username'] ?></th>
+					<th class="tc2" scope="col"><?php echo $lang_ap_spambarrier['Col_Email'] ?></th>
+					<th class="tc3" scope="col"><?php echo $lang_ap_spambarrier['Col_Posts'] ?></th>
+					<th class="tc4" scope="col"><?php echo $lang_ap_spambarrier['Col_Website'] ?></th>
+					<th class="tc5" scope="col"><?php echo $lang_ap_spambarrier['Col_Signature'] ?></th>
+					<th class="tcr" scope="col"><?php echo $lang_ap_spambarrier['Col_Registered'] ?></th>
+				</tr>
+			</thead>
+			<tbody>
+<?php
+$result = $db->query('SELECT * FROM '.$db->prefix.'users WHERE id > 1 AND num_posts=0 AND signature IS NOT NULL ORDER BY registered DESC LIMIT 50') or error('Unable to fetch users', __FILE__, __LINE__, $db->error());
+
+// If there are users with URLs in their signatures but 0 posts
+if ($db->num_rows($result))
+{
+	while ($cur_user = $db->fetch_assoc($result))
+	{
+		if (isset($signature_cache[$cur_post['poster_id']]))
+			$signature = $signature_cache[$cur_post['poster_id']];
+		else
+		{
+			$signature = parse_signature($cur_post['signature']);
+			$signature_cache[$cur_post['poster_id']] = $signature;
+		}
+		echo "\t\t\t\t\t\t".'<tr><td class="tcl"><a href="profile.php?id='.$cur_user['id'].'">'.pun_htmlspecialchars($cur_user['username']).'</a></td><td class="tc2">'.$cur_user['email'].'</td><td class="tc3">'.forum_number_format($cur_post['num_posts']).'</td><td class="tc4">'.pun_htmlspecialchars($cur_user['url']).'</td><td class="tc5">'.$signature.'</td><td class="tcr">'.format_time($cur_user['registered'], true).'</td></tr>'."\n";
+	}
+}
+	else
+		echo "\t\t\t\t".'<tr><td class="tcl" colspan="6">'.$lang_ap_spambarrier['No_match'].'</td></tr>'."\n";
+?>
+			</tbody>
+			</table>
+		</div>
+	</div>
+</div>
+
+<div class="linksb">
+	<div class="inbox">
+		<div><a href="javascript:history.go(-1)"><?php echo $lang_ap_spambarrier['Go_back'] ?></a></div>
+	</div>
+
+
+<?php
+}
+else
+{
+	// Collect some statistics from the database
+	$stats = array();
+	
+	$result = $db->query('SELECT MIN(date) FROM '.$db->prefix.'test_registrations') or error('Error1', __FILE__, __LINE__, $db->error());
+	$stats['collecting_since'] = $db->result($result);
+
+	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'test_registrations WHERE spam=0') or error('Error2', __FILE__, __LINE__, $db->error());
+	$stats['num_nospam'] = $db->result($result);
+	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'test_registrations WHERE spam=1') or error('Error3', __FILE__, __LINE__, $db->error());
+	$stats['num_honeypot'] = $db->result($result);
+	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'test_registrations WHERE spam=2') or error('Error4', __FILE__, __LINE__, $db->error());
+	$stats['num_blacklist'] = $db->result($result);
+	$result = $db->query('SELECT COUNT(id) FROM '.$db->prefix.'test_registrations WHERE spam=3') or error('Error4', __FILE__, __LINE__, $db->error());
+	$stats['num_dnsbl'] = $db->result($result);
+	
+	$result = $db->query('SELECT COUNT(id)/7 FROM '.$db->prefix.'test_registrations WHERE spam=0 AND date > '.(time() - 7*24*60*60)) or error('Error5', __FILE__, __LINE__, $db->error());
+	$stats['avg_nospam'] = $db->result($result);
+	$result = $db->query('SELECT COUNT(id)/7 FROM '.$db->prefix.'test_registrations WHERE spam=1 AND date > '.(time() - 7*24*60*60)) or error('Error6', __FILE__, __LINE__, $db->error());
+	$stats['avg_honeypot'] = $db->result($result);
+	$result = $db->query('SELECT COUNT(id)/7 FROM '.$db->prefix.'test_registrations WHERE spam=2 AND date > '.(time() - 7*24*60*60)) or error('Error7', __FILE__, __LINE__, $db->error());
+	$stats['avg_blacklist'] = $db->result($result);
+	$result = $db->query('SELECT COUNT(id)/7 FROM '.$db->prefix.'test_registrations WHERE spam=3 AND date > '.(time() - 7*24*60*60)) or error('Error7', __FILE__, __LINE__, $db->error());
+	$stats['avg_dnsbl'] = $db->result($result);
+
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 0 AND date GROUP BY DATE(FROM_UNIXTIME(date)) ORDER BY num_blocked DESC LIMIT 1') or error('Error8', __FILE__, __LINE__, $db->error());
+	list($stats['most_nospam_date'], $stats['most_nospam_num']) = $db->fetch_row($result);
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 1 AND date GROUP BY DATE(FROM_UNIXTIME(date)) ORDER BY num_blocked DESC LIMIT 1') or error('Error9', __FILE__, __LINE__, $db->error());
+	list($stats['most_honeypot_date'], $stats['most_honeypot_num']) = $db->fetch_row($result);
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 2 AND date GROUP BY DATE(FROM_UNIXTIME(date)) ORDER BY num_blocked DESC LIMIT 1') or error('Error10', __FILE__, __LINE__, $db->error());
+	list($stats['most_blacklist_date'], $stats['most_blacklist_num']) = $db->fetch_row($result);
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 3 AND date GROUP BY DATE(FROM_UNIXTIME(date)) ORDER BY num_blocked DESC LIMIT 1') or error('Error10', __FILE__, __LINE__, $db->error());
+	list($stats['most_dnsbl_date'], $stats['most_dnsbl_num']) = $db->fetch_row($result);
+
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 1 AND date > '.(time()-14*24*60*60).' GROUP BY DATE(FROM_UNIXTIME(date))') or error('Unable to fetch honeypot 14 day log', __FILE__, __LINE__, $db->error());
+	while ($cur_date = $db->fetch_assoc($result))
+		$stats['last_14days_honeypot'][$cur_date['day']] = $cur_date['num_blocked'];
+	
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 2 AND date > '.(time()-14*24*60*60).' GROUP BY DATE(FROM_UNIXTIME(date))') or error('Unable to fetch sfs 14 day log', __FILE__, __LINE__, $db->error());
+	while ($cur_date = $db->fetch_assoc($result))
+		$stats['last_14days_sfs'][$cur_date['day']] = $cur_date['num_blocked'];
+	
+	$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam = 3 AND date > '.(time()-14*24*60*60).' GROUP BY DATE(FROM_UNIXTIME(date))') or error('Unable to fetch dnsbl 14 day log', __FILE__, __LINE__, $db->error());
+	while ($cur_date = $db->fetch_assoc($result))
+		$stats['last_14days_dnsbl'][$cur_date['day']] = $cur_date['num_blocked'];
+
+
+	// Display the admin navigation menu
+	generate_admin_menu($plugin);
+?>
+	<div class="block">
+		<h2><span>SpamBarrier - v<?php echo PLUGIN_VERSION ?></span></h2>
+		<div class="box">
+			<div class="inbox">
+				<p><?php echo $lang_ap_spambarrier['Description'] ?></p>
+			</div>
+		</div>
+	</div>
+	<div class="blockform">
+		<h2 class="block2"><span><?php echo $lang_ap_spambarrier['Options'] ?></span></h2>
+		<div class="box">
+			<form method="post" action="admin_loader.php?plugin=AP_SpamBarrier.php">
+				<p class="submittop"><input type="submit" name="save" value="<?php echo $lang_ap_spambarrier['Save'] ?>" /></p>
+				<div class="inform">
+					<input type="hidden" name="form_sent" value="1" />
+					<fieldset>
+						<legend><?php echo $lang_ap_spambarrier['Settings'] ?></legend>
+						<div class="infldset">
+						<table class="aligntop" cellspacing="0">
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['HP_check'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_check_hp]" value="1"<?php if ($pun_config['o_sb_check_hp'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_check_hp]" value="0"<?php if ($pun_config['o_sb_check_hp'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['HP_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['HP_custom_field'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_custom_field]" value="1"<?php if ($pun_config['o_sb_custom_field'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_custom_field]" value="0"<?php if ($pun_config['o_sb_custom_field'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['HP_custom_field_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['HP_custom_field_name'] ?></th>
+								<td>
+									<input type="text" name="form[sb_custom_field_name]" size="20" maxlength="30" value="<?php echo pun_htmlspecialchars($pun_config['o_sb_custom_field_name']) ?>" />
+									<span><?php echo $lang_ap_spambarrier['HP_custom_field_name_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['SFS_reg_check'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_check_sfs_register]" value="1"<?php if ($pun_config['o_sb_check_sfs_register'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_check_sfs_register]" value="0"<?php if ($pun_config['o_sb_check_sfs_register'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['SFS_reg_descrition'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['SFS_login_check'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_check_sfs_login]" value="1"<?php if ($pun_config['o_sb_check_sfs_login'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_check_sfs_login]" value="0"<?php if ($pun_config['o_sb_check_sfs_login'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['SFS_log_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['Enable_SFS_report'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_sfs_report]" value="1"<?php if ($pun_config['o_sb_sfs_report'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_sfs_report]" value="0"<?php if ($pun_config['o_sb_sfs_report'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['SFS_report_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['SFS_API'] ?></th>
+								<td>
+									<input type="text" name="form[sb_sfs_api_key]" size="20" maxlength="30" value="<?php echo pun_htmlspecialchars($pun_config['o_sb_sfs_api_key']) ?>" />
+									<span><?php echo $lang_ap_spambarrier['SFS_api_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['DNSBL_login_check'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_check_dnsbl_login]" value="1"<?php if ($pun_config['o_sb_check_dnsbl_login'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_check_dnsbl_login]" value="0"<?php if ($pun_config['o_sb_check_dnsbl_login'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['DNSBL_login_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['DNSBL_reg_check'] ?></th>
+								<td>
+									<input type="radio" name="form[sb_check_dnsbl_register]" value="1"<?php if ($pun_config['o_sb_check_dnsbl_register'] == '1') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['Yes'] ?></strong>&nbsp;&nbsp;&nbsp;<input type="radio" name="form[sb_check_dnsbl_register]" value="0"<?php if ($pun_config['o_sb_check_dnsbl_register'] == '0') echo ' checked="checked"' ?> />&nbsp;<strong><?php echo $lang_ap_spambarrier['No'] ?></strong>
+									<span><?php echo $lang_ap_spambarrier['DNSBL_reg_description'] ?></span>
+								</td>
+							</tr>
+							<tr>
+								<th scope="row"><?php echo $lang_ap_spambarrier['DNSBL_list'] ?></th>
+								<td>
+									<span><?php echo $lang_ap_spambarrier['DNSBL_list_description'] ?></span><br />
+									<textarea name="form[sb_dnsbl_names]" rows="5" cols="55"><?php echo pun_htmlspecialchars($pun_config['o_sb_dnsbl_names']) ?></textarea>
+								</td>
+							</tr>
+						</table>
+						</div>
+					</fieldset>
+				</div>
+			<p class="submitend"><input type="submit" name="save" value="<?php echo $lang_ap_spambarrier['Save'] ?>" /></p>
+			</form>
+		</div>
+	</div>
+
+	<div class="blockform block2">
+		<h2><span><?php echo $lang_ap_spambarrier['Search_users'] ?></span></h2>
+		<div class="box">
+			<form method="post" action="admin_loader.php?plugin=AP_SpamBarrier.php">
+				<div class="inbox">
+					<p><?php echo $lang_ap_spambarrier['Search_description'] ?>
+					</p>
+				</div>
+				<p class="submitend">
+					<input type="submit" name="search_users" value="<?php echo $lang_ap_spambarrier['Go!'] ?>" />
+				</p>
+			</form>
+		</div>
+	</div>
+
+	<div class="blockform block2">
+		<h2><span><?php echo $lang_ap_spambarrier['Registration_stats'] ?></span></h2>
+		<div id="adstats" class="box">
+			<div class="inbox">
+				<dl>
+					<dt><?php echo $lang_ap_spambarrier['Collecting_since'] ?></dt>
+					<dd>
+						<?php echo ($stats['collecting_since'] != '') ? date($pun_config['o_date_format'], $stats['collecting_since']).' ('.floor((time()-$stats['collecting_since'])/(60*60*24)).' days)' : $lang_ap_spambarrier['N_A'] ?>
+					</dd>
+					<dt><?php echo $lang_ap_spambarrier['Total'] ?></dt>
+					<dd>
+						<?php echo $lang_ap_spambarrier['NS'] ?> <?php echo $stats['num_nospam'] ?><br />
+						<?php echo $lang_ap_spambarrier['BBH'] ?> <?php echo $stats['num_honeypot'] ?><br />
+						<?php echo $lang_ap_spambarrier['BBS'] ?> <?php echo $stats['num_blacklist'] ?><br />
+						<?php echo $lang_ap_spambarrier['BBD'] ?> <?php echo $stats['num_dnsbl']."\n" ?>
+					</dd>
+					<dt><?php echo $lang_ap_spambarrier['Avg_7d'] ?></dt>
+					<dd>
+						<?php echo $lang_ap_spambarrier['NS'] ?><?php echo round($stats['avg_nospam'], 2) ?> <?php echo $lang_ap_spambarrier['per_day'] ?><br />
+						<?php echo $lang_ap_spambarrier['BBH'] ?><?php echo round($stats['avg_honeypot'], 2) ?> <?php echo $lang_ap_spambarrier['per_day'] ?><br />
+						<?php echo $lang_ap_spambarrier['BBS'] ?><?php echo round($stats['avg_blacklist'], 2) ?> <?php echo $lang_ap_spambarrier['per_day'] ?><br />
+						<?php echo $lang_ap_spambarrier['BBD'] ?><?php echo round($stats['avg_dnsbl'], 2) ?> <?php echo $lang_ap_spambarrier['per_day'] ?>
+					</dd>
+					<dt><?php echo $lang_ap_spambarrier['Max_day'] ?></dt>
+					<dd>
+						<?php echo $lang_ap_spambarrier['NS'] ?><?php echo ($stats['most_nospam_num'] > 0) ? $stats['most_nospam_num'].' ('.$stats['most_nospam_date'].')' : '0' ?><br />
+						<?php echo $lang_ap_spambarrier['BBH'] ?><?php echo ($stats['most_honeypot_num'] > 0) ? $stats['most_honeypot_num'].' ('.$stats['most_honeypot_date'].')' : '0' ?><br />
+						<?php echo $lang_ap_spambarrier['BBS'] ?><?php echo ($stats['most_blacklist_num'] > 0) ? $stats['most_blacklist_num'].' ('.$stats['most_blacklist_date'].')'."\n" : '0' ?><br />
+						<?php echo $lang_ap_spambarrier['BBD'] ?><?php echo ($stats['most_dnsbl_num'] > 0) ? $stats['most_dnsbl_num'].' ('.$stats['most_dnsbl_date'].')'."\n" : '0'."\n" ?>
+					</dd>
+                    <dt><?php echo $lang_ap_spambarrier['Block_14d'] ?></dt>
+					<dd>
+<?php
+$result = $db->query('SELECT DATE(FROM_UNIXTIME(date)) AS day, COUNT(date) AS num_blocked FROM '.$db->prefix.'test_registrations WHERE spam > 0 AND date > '.(time()-14*24*60*60).' GROUP BY DATE(FROM_UNIXTIME(date))
+') or error($lang_ap_spambarrier['Unable_14d'], __FILE__, __LINE__, $db->error());
+
+// If there are topics in this forum.
+if ($db->num_rows($result))
+{
+	echo "\t\t\t\t\t\t".'<table>'."\n";
+	echo "\t\t\t\t\t\t".'<tr><td style="padding: 0; border: 0; width:20%">Date</td><td style="padding: 0; border: 0; width:20%">Total</td><td style="padding: 0; border: 0; width:20%">HoneyPot</td><td style="padding: 0; border: 0; width:20%">SFS</td><td style="padding: 0; border: 0; width:20%">DNSBL</td></tr>'."\n";
+
+	while ($cur_date = $db->fetch_assoc($result))
+	{
+		$day_honeypot = ($stats['last_14days_honeypot'][$cur_date['day']] != '') ? $stats['last_14days_honeypot'][$cur_date['day']] : '0';
+		$day_sfs = ($stats['last_14days_sfs'][$cur_date['day']] != '') ? $stats['last_14days_sfs'][$cur_date['day']] : '0';
+		$day_dnsbl = ($stats['last_14days_dnsbl'][$cur_date['day']] != '') ? $stats['last_14days_dnsbl'][$cur_date['day']] : '0';
+		echo "\t\t\t\t\t\t".'<tr><td style="padding: 0; border: 0">'.$cur_date['day'].'</td><td style="padding: 0; border: 0">'.$cur_date['num_blocked'].'</td><td style="padding: 0; border: 0">'.$day_honeypot.'</td><td style="padding: 0; border: 0">'.$day_sfs.'</td><td style="padding: 0; border: 0">'.$day_dnsbl.'</td></tr>'."\n";
+	}
+
+	echo "\t\t\t\t\t\t".'</table>'."\n";
+}
+else
+	echo $lang_ap_spambarrier['N_A'];
+?>
+					</dd>
+				</dl>
+			</div>
+		</div>
+	</div>
+
+
+<?php
+}
+?>
\ No newline at end of file
diff --git a/plugins/AP_reCAPTCHA.php b/plugins/AP_reCAPTCHA.php
new file mode 100644
index 00000000..2a56e047
--- /dev/null
+++ b/plugins/AP_reCAPTCHA.php
@@ -0,0 +1,123 @@
+<?php
+
+/**
+ * New reCAPTCHA plugin for FluxBB
+ *
+ * Created by Franz Liedke
+ */
+
+// Make sure no one attempts to run this script "directly"
+if (!defined('PUN'))
+    exit;
+
+// Tell admin_loader.php that this is indeed a plugin and that it is loaded
+define('PUN_PLUGIN_LOADED', 1);
+
+// Load language file
+if (file_exists(PUN_ROOT.'lang/'.$pun_user['language'].'/recaptcha_addon.php'))
+    require PUN_ROOT.'lang/'.$pun_user['language'].'/recaptcha_addon.php';
+else
+    require PUN_ROOT.'lang/English/recaptcha_addon.php';
+
+// Store the config
+if (isset($_POST['process_form']))
+{
+    $enabled = isset($_POST['recaptcha_enabled']) ? 1 : 0;
+    $site_key = isset($_POST['recaptcha_site_key']) ? pun_trim($_POST['recaptcha_site_key']) : '';
+    $secret_key = isset($_POST['recaptcha_secret_key']) ? pun_trim($_POST['recaptcha_secret_key']) : '';
+    $location_register = isset($_POST['recaptcha_location_register']) ? 1 : 0;
+    $location_login = isset($_POST['recaptcha_location_login']) ? 1 : 0;
+    $location_guestpost = isset($_POST['recaptcha_location_guestpost']) ? 1 : 0;
+
+    foreach (compact('enabled', 'site_key', 'secret_key', 'location_register', 'location_login', 'location_guestpost') as $key => $value)
+    {
+        $key = 'recaptcha_'.$key;
+
+        if (isset($pun_config[$key]))
+            $db->query('UPDATE '.$db->prefix.'config SET conf_value = \''.$db->escape($value).'\' WHERE conf_name = \''.$db->escape($key).'\'') or error('Unable to update config value for '.$key, __FILE__, __LINE__, $db->error());
+        else
+            $db->query('INSERT INTO '.$db->prefix.'config (conf_name, conf_value) VALUES (\''.$db->escape($key).'\', \''.$db->escape($value).'\')') or error('Unable to store config value for '.$key, __FILE__, __LINE__, $db->error());
+    }
+
+    // Regenerate the config cache
+    if (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))
+        require PUN_ROOT.'include/cache.php';
+
+    generate_config_cache();
+
+    redirect('admin_loader.php?plugin=AP_reCAPTCHA.php', $lang_recaptcha['Settings saved']);
+}
+
+
+// Display the admin navigation menu
+generate_admin_menu($plugin);
+
+?>
+
+<div class="blockform">
+    <h2><span><?= $lang_recaptcha['reCAPTCHA'] ?></span></h2>
+    <div class="box">
+        <form id="recaptcha" method="post" action="<?php echo $_SERVER['REQUEST_URI'] ?>">
+            <div class="inform">
+                <fieldset>
+                    <legend><?= $lang_recaptcha['General']; ?></legend>
+                    <div class="infldset">
+                        <p>
+                            <?= $lang_recaptcha['General description']; ?>
+                        </p>
+                        <table class="aligntop" cellspacing="0">
+                            <tr>
+                                <th scope="row"><?= $lang_recaptcha['Enable']; ?></th>
+                                <td>
+                                    <input type="checkbox" name="recaptcha_enabled" <?= empty($pun_config['recaptcha_enabled']) ? '' : 'checked' ?> />
+                                </td>
+                            </tr>
+                            <tr>
+                                <th scope="row"><?= $lang_recaptcha['Site key']; ?></th>
+                                <td>
+                                    <input type="text" name="recaptcha_site_key" size="40" value="<?php if (!empty($pun_config['recaptcha_site_key'])) echo pun_htmlspecialchars($pun_config['recaptcha_site_key']); ?>" />
+                                </td>
+                            </tr>
+                            <tr>
+                                <th scope="row"><?= $lang_recaptcha['Secret key']; ?></th>
+                                <td>
+                                    <input type="text" name="recaptcha_secret_key" size="40" value="<?php if (!empty($pun_config['recaptcha_secret_key'])) echo pun_htmlspecialchars($pun_config['recaptcha_secret_key']); ?>" />
+                                </td>
+                            </tr>
+                        </table>
+                    </div>
+                </fieldset>
+
+                <fieldset>
+                    <legend><?= $lang_recaptcha['Locations']; ?></legend>
+                    <div class="infldset">
+                        <p>
+                            <?= $lang_recaptcha['Locations description']; ?>
+                        </p>
+                        <table class="aligntop" cellspacing="0">
+                            <tr>
+                                <th scope="row"><?= $lang_recaptcha['Register']; ?></th>
+                                <td>
+                                    <input type="checkbox" name="recaptcha_location_register" <?= empty($pun_config['recaptcha_location_register']) ? '' : 'checked' ?> />
+                                </td>
+                            </tr>
+                            <tr>
+                                <th scope="row"><?= $lang_recaptcha['Login']; ?></th>
+                                <td>
+                                    <input type="checkbox" name="recaptcha_location_login" <?= empty($pun_config['recaptcha_location_login']) ? '' : 'checked' ?> />
+                                </td>
+                            </tr>
+                            <tr>
+                                <th scope="row"><?= $lang_recaptcha['Guest post']; ?></th>
+                                <td>
+                                    <input type="checkbox" name="recaptcha_location_guestpost" <?= empty($pun_config['recaptcha_location_guestpost']) ? '' : 'checked' ?> />
+                                </td>
+                            </tr>
+                        </table>
+                    </div>
+                </fieldset>
+            </div>
+            <p class="submitend"><input type="submit" name="process_form" value="<?= $lang_recaptcha['Save'] ?>" /></p>
+        </form>
+    </div>
+</div>
diff --git a/post.php b/post.php
index ce68667b..7690150d 100644
--- a/post.php
+++ b/post.php
@@ -25,7 +25,7 @@ if ($tid)
 else
 	$result = $db->query('SELECT f.id, f.forum_name, f.moderators, f.redirect_url, fp.post_replies, fp.post_topics FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$fid) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());
 
-if (!$db->has_rows($result))
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $cur_posting = $db->fetch_assoc($result);
@@ -168,7 +168,7 @@ if (isset($_POST['form_sent']))
 	$stick_topic = isset($_POST['stick_topic']) && $is_admmod ? '1' : '0';
 
 	// Replace four-byte characters (MySQL cannot handle them)
-	$message = strip_bad_multibyte_chars($message);
+	//$message = strip_bad_multibyte_chars($message);
 
 	$now = time();
 
@@ -223,7 +223,7 @@ if (isset($_POST['form_sent']))
 
 				// Get any subscribed users that should be notified (banned users are excluded)
 				$result = $db->query('SELECT u.id, u.email, u.notify_with_post, u.language FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'topic_subscriptions AS s ON u.id=s.user_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id='.$cur_posting['id'].' AND fp.group_id=u.group_id) LEFT JOIN '.$db->prefix.'online AS o ON u.id=o.user_id LEFT JOIN '.$db->prefix.'bans AS b ON u.username=b.username WHERE b.username IS NULL AND COALESCE(o.logged, u.last_visit)>'.$previous_post_time.' AND (fp.read_forum IS NULL OR fp.read_forum=1) AND s.topic_id='.$tid.' AND u.id!='.$pun_user['id']) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 				{
 					require_once PUN_ROOT.'include/email.php';
 
@@ -332,7 +332,7 @@ if (isset($_POST['form_sent']))
 			{
 				// Get any subscribed users that should be notified (banned users are excluded)
 				$result = $db->query('SELECT u.id, u.email, u.notify_with_post, u.language FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'forum_subscriptions AS s ON u.id=s.user_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id='.$cur_posting['id'].' AND fp.group_id=u.group_id) LEFT JOIN '.$db->prefix.'bans AS b ON u.username=b.username WHERE b.username IS NULL AND (fp.read_forum IS NULL OR fp.read_forum=1) AND s.forum_id='.$cur_posting['id'].' AND u.id!='.$pun_user['id']) or error('Unable to fetch subscription info', __FILE__, __LINE__, $db->error());
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 				{
 					require_once PUN_ROOT.'include/email.php';
 
@@ -468,7 +468,7 @@ if ($tid)
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		$result = $db->query('SELECT poster, message FROM '.$db->prefix.'posts WHERE id='.$qid.' AND topic_id='.$tid) or error('Unable to fetch quote info', __FILE__, __LINE__, $db->error());
-		if (!$db->has_rows($result))
+		if (!$db->num_rows($result))
 			message($lang_common['Bad request'], false, '404 Not Found');
 
 		list($q_poster, $q_message) = $db->fetch_row($result);
@@ -543,19 +543,6 @@ else if ($fid)
 else
 	message($lang_common['Bad request'], false, '404 Not Found');
 
-if (isset($_POST['req_subject']))
-	$subject_crumb = $_POST['req_subject'];
-else if (isset($cur_posting['subject']))
-	$subject_crumb = array($cur_posting['subject'], 'viewtopic.php?id='.$tid);
-else
-	$subject_crumb = '';
-
-$crumbs = generate_crumbs(array_filter(array(
-	array($lang_common['Index'], 'index.php'),
-	array($cur_posting['forum_name'], 'viewforum.php?id='.$cur_posting['id']),
-	$subject_crumb,
-	$action,
-)));
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $action);
 $required_fields = array('req_email' => $lang_common['Email'], 'req_subject' => $lang_common['Subject'], 'req_message' => $lang_common['Message']);
@@ -577,7 +564,14 @@ require PUN_ROOT.'header.php';
 ?>
 <div class="linkst">
 	<div class="inbox">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $cur_posting['id'] ?>"><?php echo pun_htmlspecialchars($cur_posting['forum_name']) ?></a></li>
+<?php if (isset($_POST['req_subject'])): ?>			<li><span>»&#160;</span><?php echo pun_htmlspecialchars($_POST['req_subject']) ?></li>
+<?php endif; ?>
+<?php if (isset($cur_posting['subject'])): ?>			<li><span>»&#160;</span><a href="viewtopic.php?id=<?php echo $tid ?>"><?php echo pun_htmlspecialchars($cur_posting['subject']) ?></a></li>
+<?php endif; ?>			<li><span>»&#160;</span><strong><?php echo $action ?></strong></li>
+		</ul>
 	</div>
 </div>
 
@@ -614,10 +608,12 @@ else if (isset($_POST['preview']))
 
 ?>
 <div id="postpreview" class="blockpost">
-	<h2><span><?php echo $lang_post['Post preview'] ?></span></h2>
 	<div class="box">
 		<div class="inbox">
 			<div class="postbody">
+				<div class="postleft">
+                    <h2><span><?php echo $lang_post['Post preview'] ?></span></h2>
+				</div>
 				<div class="postright">
 					<div class="postmsg">
 						<?php echo $preview_message."\n" ?>
@@ -653,17 +649,17 @@ if ($pun_user['is_guest'])
 	$email_form_name = ($pun_config['p_force_guest_email'] == '1') ? 'req_email' : 'email';
 
 ?>
-						<label class="conl required"><strong><?php echo $lang_post['Guest name'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" value="<?php if (isset($_POST['req_username'])) echo pun_htmlspecialchars($username); ?>" size="25" maxlength="25" tabindex="<?php echo $cur_index++ ?>" /><br /></label>
-						<label class="conl<?php echo ($pun_config['p_force_guest_email'] == '1') ? ' required' : '' ?>"><?php echo $email_label ?><br /><input type="text" name="<?php echo $email_form_name ?>" value="<?php if (isset($_POST[$email_form_name])) echo pun_htmlspecialchars($email); ?>" size="50" maxlength="80" tabindex="<?php echo $cur_index++ ?>" /><br /></label>
+						<label class="conl required"><strong><?php echo $lang_post['Guest name'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" value="<?php if (isset($_POST['req_username'])) echo pun_htmlspecialchars($username); ?>" size="25" maxlength="25" autocomplete="username" required /><br /></label>
+						<label class="conl<?php echo ($pun_config['p_force_guest_email'] == '1') ? ' required' : '' ?>"><?php echo $email_label ?><br /><input type="email" name="<?php echo $email_form_name ?>" value="<?php if (isset($_POST[$email_form_name])) echo pun_htmlspecialchars($email); ?>" size="50" maxlength="80" autocomplete="email" /><br /></label>
 						<div class="clearer"></div>
 <?php
 
 }
 
 if ($fid): ?>
-						<label class="required"><strong><?php echo $lang_common['Subject'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input class="longinput" type="text" name="req_subject" value="<?php if (isset($_POST['req_subject'])) echo pun_htmlspecialchars($_POST['req_subject']); ?>" size="80" maxlength="70" tabindex="<?php echo $cur_index++ ?>" /><br /></label>
+						<label class="required"><strong><?php echo $lang_common['Subject'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input class="longinput" type="text" name="req_subject" value="<?php if (isset($_POST['req_subject'])) echo pun_htmlspecialchars($_POST['req_subject']); ?>" size="80" maxlength="70" required /><br /></label>
 <?php endif; ?>						<label class="required"><strong><?php echo $lang_common['Message'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<textarea name="req_message" rows="20" cols="95" tabindex="<?php echo $cur_index++ ?>"><?php echo isset($_POST['req_message']) ? pun_htmlspecialchars($orig_message) : (isset($quote) ? $quote : ''); ?></textarea><br /></label>
+						<textarea name="req_message" rows="20" cols="95" required><?php echo isset($_POST['req_message']) ? pun_htmlspecialchars($orig_message) : (isset($quote) ? $quote : ''); ?></textarea><br /></label>
 						<ul class="bblinks">
 							<li><span><a href="help.php#bbcode" onclick="window.open(this.href); return false;"><?php echo $lang_common['BBCode'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>
 							<li><span><a href="help.php#url" onclick="window.open(this.href); return false;"><?php echo $lang_common['url tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_user['g_post_links'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>
@@ -676,12 +672,12 @@ if ($fid): ?>
 
 $checkboxes = array();
 if ($fid && $is_admmod)
-	$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1" tabindex="'.($cur_index++).'"'.(isset($_POST['stick_topic']) ? ' checked="checked"' : '').' />'.$lang_common['Stick topic'].'<br /></label>';
+	$checkboxes[] = '<label><input type="checkbox" name="stick_topic" value="1"'.(isset($_POST['stick_topic']) ? ' checked' : '').' />'.$lang_common['Stick topic'].'<br /></label>';
 
 if (!$pun_user['is_guest'])
 {
 	if ($pun_config['o_smilies'] == '1')
-		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" tabindex="'.($cur_index++).'"'.(isset($_POST['hide_smilies']) ? ' checked="checked"' : '').' />'.$lang_post['Hide smilies'].'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1"'.(isset($_POST['hide_smilies']) ? ' checked' : '').' />'.$lang_post['Hide smilies'].'<br /></label>';
 
 	if ($pun_config['o_topic_subscriptions'] == '1')
 	{
@@ -697,11 +693,11 @@ if (!$pun_user['is_guest'])
 		else if ($is_subscribed)
 			$subscr_checked = true;
 
-		$checkboxes[] = '<label><input type="checkbox" name="subscribe" value="1" tabindex="'.($cur_index++).'"'.($subscr_checked ? ' checked="checked"' : '').' />'.($is_subscribed ? $lang_post['Stay subscribed'] : $lang_post['Subscribe']).'<br /></label>';
+		$checkboxes[] = '<label><input type="checkbox" name="subscribe" value="1"'.($subscr_checked ? ' checked' : '').' />'.($is_subscribed ? $lang_post['Stay subscribed'] : $lang_post['Subscribe']).'<br /></label>';
 	}
 }
 else if ($pun_config['o_smilies'] == '1')
-	$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1" tabindex="'.($cur_index++).'"'.(isset($_POST['hide_smilies']) ? ' checked="checked"' : '').' />'.$lang_post['Hide smilies'].'<br /></label>';
+	$checkboxes[] = '<label><input type="checkbox" name="hide_smilies" value="1"'.(isset($_POST['hide_smilies']) ? ' checked' : '').' />'.$lang_post['Hide smilies'].'<br /></label>';
 
 if (!empty($checkboxes))
 {
@@ -724,7 +720,7 @@ if (!empty($checkboxes))
 ?>
 			</div>
 <?php flux_hook('post_before_submit') ?>
-			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_post['Preview'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="p" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
+			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_post['Preview'] ?>" accesskey="p" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
 		</form>
 	</div>
 </div>
diff --git a/profile.php b/profile.php
index 642a8853..9ac3fa18 100644
--- a/profile.php
+++ b/profile.php
@@ -55,7 +55,7 @@ if ($action == 'change_pass')
 			message($lang_profile['Pass key bad'].' <a href="mailto:'.pun_htmlspecialchars($pun_config['o_admin_email']).'">'.pun_htmlspecialchars($pun_config['o_admin_email']).'</a>.');
 		else
 		{
-			$db->query('UPDATE '.$db->prefix.'users SET password=\''.$db->escape($cur_user['activate_string']).'\', activate_string=NULL, activate_key=NULL WHERE id='.$id) or error('Unable to update password', __FILE__, __LINE__, $db->error());
+			$db->query('UPDATE '.$db->prefix.'users SET password=\''.$db->escape($cur_user['activate_string']).'\', activate_string=NULL, activate_key=NULL'.(!empty($cur_user['salt']) ? ', salt=NULL' : '').' WHERE id='.$id) or error('Unable to update password', __FILE__, __LINE__, $db->error());
 
 			message($lang_profile['Pass updated'], true);
 		}
@@ -69,7 +69,7 @@ if ($action == 'change_pass')
 		else if ($pun_user['g_moderator'] == '1') // A moderator trying to change a user's password?
 		{
 			$result = $db->query('SELECT u.group_id, g.g_moderator FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'groups AS g ON (g.g_id=u.group_id) WHERE u.id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-			if (!$db->has_rows($result))
+			if (!$db->num_rows($result))
 				message($lang_common['Bad request'], false, '404 Not Found');
 
 			list($group_id, $is_moderator) = $db->fetch_row($result);
@@ -102,16 +102,16 @@ if ($action == 'change_pass')
 		{
 			$old_password_hash = pun_hash($old_password);
 
-			if (flux_password_verify($old_password, $cur_user['password']) || $pun_user['is_admmod'])
+			if ($cur_user['password'] == $old_password_hash || $pun_user['is_admmod'])
 				$authorized = true;
 		}
 
 		if (!$authorized)
 			message($lang_profile['Wrong pass']);
 
-		$new_password_hash = flux_password_hash($new_password1);
+		$new_password_hash = pun_hash($new_password1);
 
-		$db->query('UPDATE '.$db->prefix.'users SET password=\''.$db->escape($new_password_hash).'\' WHERE id='.$id) or error('Unable to update password', __FILE__, __LINE__, $db->error());
+		$db->query('UPDATE '.$db->prefix.'users SET password=\''.$new_password_hash.'\''.(!empty($cur_user['salt']) ? ', salt=NULL' : '').' WHERE id='.$id) or error('Unable to update password', __FILE__, __LINE__, $db->error());
 
 		if ($pun_user['id'] == $id)
 			pun_setcookie($pun_user['id'], $new_password_hash, time() + $pun_config['o_timeout_visit']);
@@ -136,11 +136,11 @@ if ($action == 'change_pass')
 					<legend><?php echo $lang_profile['Change pass legend'] ?></legend>
 					<div class="infldset">
 <?php if (!$pun_user['is_admmod']): ?>						<label class="required"><strong><?php echo $lang_profile['Old pass'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input type="password" name="req_old_password" size="16" /><br /></label>
+						<input type="password" name="req_old_password" size="16" required /><br /></label>
 <?php endif; ?>						<label class="conl required"><strong><?php echo $lang_profile['New pass'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input type="password" name="req_new_password1" size="16" /><br /></label>
+						<input type="password" name="req_new_password1" size="16" required /><br /></label>
 						<label class="conl required"><strong><?php echo $lang_profile['Confirm new pass'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input type="password" name="req_new_password2" size="16" /><br /></label>
+						<input type="password" name="req_new_password2" size="16" required /><br /></label>
 						<p class="clearb"><?php echo $lang_profile['Pass info'] ?></p>
 					</div>
 				</fieldset>
@@ -165,7 +165,7 @@ else if ($action == 'change_email')
 		else if ($pun_user['g_moderator'] == '1') // A moderator trying to change a user's email?
 		{
 			$result = $db->query('SELECT u.group_id, g.g_moderator FROM '.$db->prefix.'users AS u INNER JOIN '.$db->prefix.'groups AS g ON (g.g_id=u.group_id) WHERE u.id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-			if (!$db->has_rows($result))
+			if (!$db->num_rows($result))
 				message($lang_common['Bad request'], false, '404 Not Found');
 
 			list($group_id, $is_moderator) = $db->fetch_row($result);
@@ -193,7 +193,7 @@ else if ($action == 'change_email')
 	}
 	else if (isset($_POST['form_sent']))
 	{
-		if (!flux_password_verify($_POST['req_password'], $pun_user['password']))
+		if (pun_hash($_POST['req_password']) !== $pun_user['password'])
 			message($lang_profile['Wrong pass']);
 
 		// Make sure they got here from the site
@@ -232,7 +232,7 @@ else if ($action == 'change_email')
 
 		// Check if someone else already has registered with that email address
 		$result = $db->query('SELECT id, username FROM '.$db->prefix.'users WHERE email=\''.$db->escape($new_email).'\'') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-		if ($db->has_rows($result))
+		if ($db->num_rows($result))
 		{
 			if ($pun_config['p_allow_dupe_email'] == '0')
 				message($lang_prof_reg['Dupe email']);
@@ -297,8 +297,8 @@ else if ($action == 'change_email')
 					<legend><?php echo $lang_profile['Email legend'] ?></legend>
 					<div class="infldset">
 						<input type="hidden" name="form_sent" value="1" />
-						<label class="required"><strong><?php echo $lang_profile['New email'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_new_email" size="50" maxlength="80" /><br /></label>
-						<label class="required"><strong><?php echo $lang_common['Password'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password" size="16" /><br /></label>
+						<label class="required"><strong><?php echo $lang_profile['New email'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_new_email" size="50" maxlength="80" autocomplete="email" required /><br /></label>
+						<label class="required"><strong><?php echo $lang_common['Password'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password" size="16" autocomplete="current-password" required /><br /></label>
 						<p><?php echo $lang_profile['Email instructions'] ?></p>
 					</div>
 				</fieldset>
@@ -427,7 +427,7 @@ else if ($action == 'upload_avatar' || $action == 'upload_avatar2')
 					<div class="infldset">
 						<input type="hidden" name="form_sent" value="1" />
 						<input type="hidden" name="MAX_FILE_SIZE" value="<?php echo $pun_config['o_avatars_size'] ?>" />
-						<label class="required"><strong><?php echo $lang_profile['File'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input name="req_file" type="file" size="40" /><br /></label>
+						<label class="required"><strong><?php echo $lang_profile['File'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input name="req_file" type="file" size="40" required /><br /></label>
 						<p><?php echo $lang_profile['Avatar desc'].' '.$pun_config['o_avatars_width'].' x '.$pun_config['o_avatars_height'].' '.$lang_profile['pixels'].' '.$lang_common['and'].' '.forum_number_format($pun_config['o_avatars_size']).' '.$lang_profile['bytes'].' ('.file_size($pun_config['o_avatars_size']).').' ?></p>
 					</div>
 				</fieldset>
@@ -559,7 +559,7 @@ else if (isset($_POST['ban']))
 
 	// Check whether user is already banned
 	$result = $db->query('SELECT id FROM '.$db->prefix.'bans WHERE username = \''.$db->escape($username).'\' ORDER BY expire IS NULL DESC, expire DESC LIMIT 1') or error('Unable to fetch ban ID', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 	{
 		$ban_id = $db->result($result);
 		redirect('admin_bans.php?edit_ban='.$ban_id.'&amp;exists', $lang_profile['Ban redirect']);
@@ -583,7 +583,7 @@ else if ($action == 'promote')
 	$sql = 'SELECT g.g_promote_next_group FROM '.$db->prefix.'groups AS g INNER JOIN '.$db->prefix.'users AS u ON u.group_id=g.g_id WHERE u.id='.$id.' AND g.g_promote_next_group>0';
 	$result = $db->query($sql) or error('Unable to fetch promotion information', __FILE__, __LINE__, $db->error());
 
-	if (!$db->has_rows($result))
+	if (!$db->num_rows($result))
 		message($lang_common['Bad request'], false, '404 Not Found');
 
 	$next_group_id = $db->result($result);
@@ -593,7 +593,7 @@ else if ($action == 'promote')
 }
 
 
-else if (isset($_POST['delete_user']) || isset($_POST['delete_user_comply']))
+else if (isset($_POST['delete_user']) || isset($_POST['delete_spammer']) || isset($_POST['delete_user_comply']) || isset($_POST['delete_spammer_comply']))
 {
 	if ($pun_user['g_id'] > PUN_ADMIN)
 		message($lang_common['No permission'], false, '403 Forbidden');
@@ -601,14 +601,22 @@ else if (isset($_POST['delete_user']) || isset($_POST['delete_user_comply']))
 	confirm_referrer('profile.php');
 
 	// Get the username and group of the user we are deleting
-	$result = $db->query('SELECT group_id, username FROM '.$db->prefix.'users WHERE id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-	list($group_id, $username) = $db->fetch_row($result);
+	$result = $db->query('SELECT group_id, username, email, registration_ip FROM '.$db->prefix.'users WHERE id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+	list($group_id, $username, $email, $registration_ip) = $db->fetch_row($result);
 
 	if ($group_id == PUN_ADMIN)
 		message($lang_profile['No delete admin message']);
 
-	if (isset($_POST['delete_user_comply']))
+	if (isset($_POST['delete_user_comply']) || isset($_POST['delete_spammer_comply']))
 	{
+		if (isset($_POST['delete_spammer_comply']))
+		{
+			// Include the antispam library
+			require PUN_ROOT.'include/spambarrier.php';
+
+  			// Lets report the bastard!
+  			sb_stopforumspam_report($registration_ip, $email, $username, '');
+		}
 		// If the user is a moderator or an administrator, we remove him/her from the moderator list in all forums as well
 		$result = $db->query('SELECT g_moderator FROM '.$db->prefix.'groups WHERE g_id='.$group_id) or error('Unable to fetch group', __FILE__, __LINE__, $db->error());
 		$group_mod = $db->result($result);
@@ -646,7 +654,7 @@ else if (isset($_POST['delete_user']) || isset($_POST['delete_user_comply']))
 
 			// Find all posts made by this user
 			$result = $db->query('SELECT p.id, p.topic_id, t.forum_id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON t.id=p.topic_id INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id WHERE p.poster_id='.$id) or error('Unable to fetch posts', __FILE__, __LINE__, $db->error());
-			if ($db->has_rows($result))
+			if ($db->num_rows($result))
 			{
 				while ($cur_post = $db->fetch_assoc($result))
 				{
@@ -681,7 +689,7 @@ else if (isset($_POST['delete_user']) || isset($_POST['delete_user_comply']))
 		if ($group_id == PUN_ADMIN)
 			generate_admins_cache();
 
-		redirect('index.php', $lang_profile['User delete redirect']);
+		redirect('index.php', isset($_POST['delete_spammer_comply']) ? $lang_profile['Spammer delete redirect'] : $lang_profile['User delete redirect']);
 	}
 
 	$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_common['Profile'], $lang_profile['Confirm delete user']);
@@ -699,13 +707,14 @@ else if (isset($_POST['delete_user']) || isset($_POST['delete_user_comply']))
 					<div class="infldset">
 						<p><?php echo $lang_profile['Confirmation info'].' <strong>'.pun_htmlspecialchars($username).'</strong>.' ?></p>
 						<div class="rbox">
-							<label><input type="checkbox" name="delete_posts" value="1" checked="checked" /><?php echo $lang_profile['Delete posts'] ?><br /></label>
+							<label><input type="checkbox" name="delete_posts" value="1" checked /><?php echo $lang_profile['Delete posts'] ?><br /></label>
 						</div>
+						<?php if (isset($_POST['delete_spammer'])): ?><p><?php echo $lang_profile['Delete spammer note'] ?></p><?php endif; ?>
 						<p class="warntext"><strong><?php echo $lang_profile['Delete warning'] ?></strong></p>
 					</div>
 				</fieldset>
 			</div>
-			<p class="buttons"><input type="submit" name="delete_user_comply" value="<?php echo $lang_profile['Delete'] ?>" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
+			<p class="buttons"><input type="submit" name="<?php echo (isset($_POST['delete_spammer']) ? 'delete_spammer_comply' : 'delete_user_comply'); ?>" value="<?php echo $lang_profile['Delete'] ?>" /> <a href="javascript:history.go(-1)"><?php echo $lang_common['Go back'] ?></a></p>
 		</form>
 	</div>
 </div>
@@ -719,7 +728,7 @@ else if (isset($_POST['form_sent']))
 {
 	// Fetch the user group of the user we are editing
 	$result = $db->query('SELECT u.username, u.group_id, g.g_moderator FROM '.$db->prefix.'users AS u LEFT JOIN '.$db->prefix.'groups AS g ON (g.g_id=u.group_id) WHERE u.id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
+	if (!$db->num_rows($result))
 		message($lang_common['Bad request'], false, '404 Not Found');
 
 	list($old_username, $group_id, $is_moderator) = $db->fetch_row($result);
@@ -856,6 +865,7 @@ else if (isset($_POST['form_sent']))
 				'jabber'		=> pun_trim($_POST['form']['jabber']),
 				'icq'			=> pun_trim($_POST['form']['icq']),
 				'msn'			=> pun_trim($_POST['form']['msn']),
+				'aim'			=> pun_trim($_POST['form']['aim']),
 				'yahoo'			=> pun_trim($_POST['form']['yahoo']),
 			);
 
@@ -1043,8 +1053,8 @@ else if (isset($_POST['form_sent']))
 flux_hook('profile_after_form_handling');
 
 
-$result = $db->query('SELECT u.username, u.email, u.title, u.realname, u.url, u.jabber, u.icq, u.msn, u.yahoo, u.location, u.signature, u.disp_topics, u.disp_posts, u.email_setting, u.notify_with_post, u.auto_notify, u.show_smilies, u.show_img, u.show_img_sig, u.show_avatars, u.show_sig, u.timezone, u.dst, u.language, u.style, u.num_posts, u.last_post, u.registered, u.registration_ip, u.admin_note, u.date_format, u.time_format, u.last_visit, g.g_id, g.g_user_title, g.g_moderator FROM '.$db->prefix.'users AS u LEFT JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id WHERE u.id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-if (!$db->has_rows($result))
+$result = $db->query('SELECT u.username, u.email, u.title, u.realname, u.url, u.jabber, u.icq, u.msn, u.aim, u.yahoo, u.location, u.signature, u.disp_topics, u.disp_posts, u.email_setting, u.notify_with_post, u.auto_notify, u.show_smilies, u.show_img, u.show_img_sig, u.show_avatars, u.show_sig, u.timezone, u.dst, u.language, u.style, u.num_posts, u.last_post, u.registered, u.registration_ip, u.admin_note, u.date_format, u.time_format, u.last_visit, g.g_id, g.g_user_title, g.g_moderator FROM '.$db->prefix.'users AS u LEFT JOIN '.$db->prefix.'groups AS g ON g.g_id=u.group_id WHERE u.id='.$id) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $user = $db->fetch_assoc($result);
@@ -1126,6 +1136,12 @@ if ($pun_user['id'] != $id &&																	// If we aren't the user (i.e. edi
 		$user_messaging[] = '<dd>'.pun_htmlspecialchars(($pun_config['o_censoring'] == '1') ? censor_words($user['msn']) : $user['msn']).'</dd>';
 	}
 
+	if ($user['aim'] != '')
+	{
+		$user_messaging[] = '<dt>'.$lang_profile['AOL IM'].'</dt>';
+		$user_messaging[] = '<dd>'.pun_htmlspecialchars(($pun_config['o_censoring'] == '1') ? censor_words($user['aim']) : $user['aim']).'</dd>';
+	}
+
 	if ($user['yahoo'] != '')
 	{
 		$user_messaging[] = '<dt>'.$lang_profile['Yahoo'].'</dt>';
@@ -1256,11 +1272,11 @@ else
 		if ($pun_user['is_admmod'])
 		{
 			if ($pun_user['g_id'] == PUN_ADMIN || $pun_user['g_mod_rename_users'] == '1')
-				$username_field = '<label class="required"><strong>'.$lang_common['Username'].' <span>'.$lang_common['Required'].'</span></strong><br /><input type="text" name="req_username" value="'.pun_htmlspecialchars($user['username']).'" size="25" maxlength="25" /><br /></label>'."\n";
+				$username_field = '<label class="required"><strong>'.$lang_common['Username'].' <span>'.$lang_common['Required'].'</span></strong><br /><input type="text" name="req_username" value="'.pun_htmlspecialchars($user['username']).'" size="25" maxlength="25" autocomplete="username" required /><br /></label>'."\n";
 			else
 				$username_field = '<p>'.sprintf($lang_profile['Username info'], pun_htmlspecialchars($user['username'])).'</p>'."\n";
 
-			$email_field = '<label class="required"><strong>'.$lang_common['Email'].' <span>'.$lang_common['Required'].'</span></strong><br /><input type="text" name="req_email" value="'.pun_htmlspecialchars($user['email']).'" size="40" maxlength="80" /><br /></label><p><span class="email"><a href="misc.php?email='.$id.'">'.$lang_common['Send email'].'</a></span></p>'."\n";
+			$email_field = '<label class="required"><strong>'.$lang_common['Email'].' <span>'.$lang_common['Required'].'</span></strong><br /><input type="email" name="req_email" value="'.pun_htmlspecialchars($user['email']).'" size="40" maxlength="80" autocomplete="email" required /><br /></label><p><span class="email"><a href="misc.php?email='.$id.'">'.$lang_common['Send email'].'</a></span></p>'."\n";
 		}
 		else
 		{
@@ -1269,7 +1285,7 @@ else
 			if ($pun_config['o_regs_verify'] == '1')
 				$email_field = '<p>'.sprintf($lang_profile['Email info'], pun_htmlspecialchars($user['email']).' - <a href="profile.php?action=change_email&amp;id='.$id.'">'.$lang_profile['Change email'].'</a>').'</p>'."\n";
 			else
-				$email_field = '<label class="required"><strong>'.$lang_common['Email'].' <span>'.$lang_common['Required'].'</span></strong><br /><input type="text" name="req_email" value="'.$user['email'].'" size="40" maxlength="80" /><br /></label>'."\n";
+				$email_field = '<label class="required"><strong>'.$lang_common['Email'].' <span>'.$lang_common['Required'].'</span></strong><br /><input type="email" name="req_email" value="'.$user['email'].'" size="40" maxlength="80" autocomplete="email" required /><br /></label>'."\n";
 		}
 
 		$posts_field = '';
@@ -1372,7 +1388,7 @@ else
 							</select>
 							<br /></label>
 							<div class="rbox">
-								<label><input type="checkbox" name="form[dst]" value="1"<?php if ($user['dst'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['DST'] ?><br /></label>
+								<label><input type="checkbox" name="form[dst]" value="1"<?php if ($user['dst'] == '1') echo ' checked' ?> /><?php echo $lang_prof_reg['DST'] ?><br /></label>
 							</div>
 							<label><?php echo $lang_prof_reg['Time format'] ?>
 
@@ -1482,10 +1498,10 @@ else
 						<legend><?php echo $lang_profile['Personal details legend'] ?></legend>
 						<div class="infldset">
 							<input type="hidden" name="form_sent" value="1" />
-							<label><?php echo $lang_profile['Realname'] ?><br /><input type="text" name="form[realname]" value="<?php echo pun_htmlspecialchars($user['realname']) ?>" size="40" maxlength="40" /><br /></label>
+							<label><?php echo $lang_profile['Realname'] ?><br /><input type="text" name="form[realname]" value="<?php echo pun_htmlspecialchars($user['realname']) ?>" size="40" maxlength="40" autocomplete="name" /><br /></label>
 <?php if (isset($title_field)): ?>							<?php echo $title_field ?>
 <?php endif; ?>							<label><?php echo $lang_profile['Location'] ?><br /><input type="text" name="form[location]" value="<?php echo pun_htmlspecialchars($user['location']) ?>" size="30" maxlength="30" /><br /></label>
-<?php if ($pun_user['g_post_links'] == '1' || $pun_user['g_id'] == PUN_ADMIN) : ?>							<label><?php echo $lang_profile['Website'] ?><br /><input type="text" name="form[url]" value="<?php echo pun_htmlspecialchars($user['url']) ?>" size="50" maxlength="80" /><br /></label>
+<?php if ($pun_user['g_post_links'] == '1' || $pun_user['g_id'] == PUN_ADMIN) : ?>							<label><?php echo $lang_profile['Website'] ?><br /><input type="url" name="form[url]" value="<?php echo pun_htmlspecialchars($user['url']) ?>" size="50" maxlength="80" placeholder="http(s)://" autocomplete="url" /><br /></label>
 <?php endif; ?>
 						</div>
 					</fieldset>
@@ -1519,6 +1535,7 @@ else
 							<label><?php echo $lang_profile['Jabber'] ?><br /><input id="jabber" type="text" name="form[jabber]" value="<?php echo pun_htmlspecialchars($user['jabber']) ?>" size="40" maxlength="75" /><br /></label>
 							<label><?php echo $lang_profile['ICQ'] ?><br /><input id="icq" type="text" name="form[icq]" value="<?php echo $user['icq'] ?>" size="12" maxlength="12" /><br /></label>
 							<label><?php echo $lang_profile['MSN'] ?><br /><input id="msn" type="text" name="form[msn]" value="<?php echo pun_htmlspecialchars($user['msn']) ?>" size="40" maxlength="50" /><br /></label>
+							<label><?php echo $lang_profile['AOL IM'] ?><br /><input id="aim" type="text" name="form[aim]" value="<?php echo pun_htmlspecialchars($user['aim']) ?>" size="20" maxlength="30" /><br /></label>
 							<label><?php echo $lang_profile['Yahoo'] ?><br /><input id="yahoo" type="text" name="form[yahoo]" value="<?php echo pun_htmlspecialchars($user['yahoo']) ?>" size="20" maxlength="30" /><br /></label>
 						</div>
 					</fieldset>
@@ -1656,11 +1673,11 @@ else
 						<div class="infldset">
 							<p><?php echo $lang_profile['Post display info'] ?></p>
 							<div class="rbox">
-<?php if ($pun_config['o_smilies'] == '1' || $pun_config['o_smilies_sig'] == '1'): ?>								<label><input type="checkbox" name="form[show_smilies]" value="1"<?php if ($user['show_smilies'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Show smilies'] ?><br /></label>
-<?php endif; if ($pun_config['o_signatures'] == '1'): ?>								<label><input type="checkbox" name="form[show_sig]" value="1"<?php if ($user['show_sig'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Show sigs'] ?><br /></label>
-<?php endif; if ($pun_config['o_avatars'] == '1'): ?>								<label><input type="checkbox" name="form[show_avatars]" value="1"<?php if ($user['show_avatars'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Show avatars'] ?><br /></label>
-<?php endif; if ($pun_config['p_message_bbcode'] == '1' && $pun_config['p_message_img_tag'] == '1'): ?>								<label><input type="checkbox" name="form[show_img]" value="1"<?php if ($user['show_img'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Show images'] ?><br /></label>
-<?php endif; if ($pun_config['o_signatures'] == '1' && $pun_config['p_sig_bbcode'] == '1' && $pun_config['p_sig_img_tag'] == '1'): ?>								<label><input type="checkbox" name="form[show_img_sig]" value="1"<?php if ($user['show_img_sig'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Show images sigs'] ?><br /></label>
+<?php if ($pun_config['o_smilies'] == '1' || $pun_config['o_smilies_sig'] == '1'): ?>								<label><input type="checkbox" name="form[show_smilies]" value="1"<?php if ($user['show_smilies'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Show smilies'] ?><br /></label>
+<?php endif; if ($pun_config['o_signatures'] == '1'): ?>								<label><input type="checkbox" name="form[show_sig]" value="1"<?php if ($user['show_sig'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Show sigs'] ?><br /></label>
+<?php endif; if ($pun_config['o_avatars'] == '1'): ?>								<label><input type="checkbox" name="form[show_avatars]" value="1"<?php if ($user['show_avatars'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Show avatars'] ?><br /></label>
+<?php endif; if ($pun_config['p_message_bbcode'] == '1' && $pun_config['p_message_img_tag'] == '1'): ?>								<label><input type="checkbox" name="form[show_img]" value="1"<?php if ($user['show_img'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Show images'] ?><br /></label>
+<?php endif; if ($pun_config['o_signatures'] == '1' && $pun_config['p_sig_bbcode'] == '1' && $pun_config['p_sig_img_tag'] == '1'): ?>								<label><input type="checkbox" name="form[show_img_sig]" value="1"<?php if ($user['show_img_sig'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Show images sigs'] ?><br /></label>
 <?php endif; ?>
 							</div>
 						</div>
@@ -1704,9 +1721,9 @@ else
 							<input type="hidden" name="form_sent" value="1" />
 							<p><?php echo $lang_prof_reg['Email setting info'] ?></p>
 							<div class="rbox">
-								<label><input type="radio" name="form[email_setting]" value="0"<?php if ($user['email_setting'] == '0') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['Email setting 1'] ?><br /></label>
-								<label><input type="radio" name="form[email_setting]" value="1"<?php if ($user['email_setting'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['Email setting 2'] ?><br /></label>
-								<label><input type="radio" name="form[email_setting]" value="2"<?php if ($user['email_setting'] == '2') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['Email setting 3'] ?><br /></label>
+								<label><input type="radio" name="form[email_setting]" value="0"<?php if ($user['email_setting'] == '0') echo ' checked' ?> /><?php echo $lang_prof_reg['Email setting 1'] ?><br /></label>
+								<label><input type="radio" name="form[email_setting]" value="1"<?php if ($user['email_setting'] == '1') echo ' checked' ?> /><?php echo $lang_prof_reg['Email setting 2'] ?><br /></label>
+								<label><input type="radio" name="form[email_setting]" value="2"<?php if ($user['email_setting'] == '2') echo ' checked' ?> /><?php echo $lang_prof_reg['Email setting 3'] ?><br /></label>
 							</div>
 						</div>
 					</fieldset>
@@ -1716,8 +1733,8 @@ else
 						<legend><?php echo $lang_profile['Subscription legend'] ?></legend>
 						<div class="infldset">
 							<div class="rbox">
-								<label><input type="checkbox" name="form[notify_with_post]" value="1"<?php if ($user['notify_with_post'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Notify full'] ?><br /></label>
-<?php if ($pun_config['o_topic_subscriptions'] == '1'): ?>								<label><input type="checkbox" name="form[auto_notify]" value="1"<?php if ($user['auto_notify'] == '1') echo ' checked="checked"' ?> /><?php echo $lang_profile['Auto notify full'] ?><br /></label>
+								<label><input type="checkbox" name="form[notify_with_post]" value="1"<?php if ($user['notify_with_post'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Notify full'] ?><br /></label>
+<?php if ($pun_config['o_topic_subscriptions'] == '1'): ?>								<label><input type="checkbox" name="form[auto_notify]" value="1"<?php if ($user['auto_notify'] == '1') echo ' checked' ?> /><?php echo $lang_profile['Auto notify full'] ?><br /></label>
 <?php endif; ?>
 							</div>
 						</div>
@@ -1803,7 +1820,7 @@ else
 ?>
 						<legend><?php echo $lang_profile['Delete ban legend'] ?></legend>
 						<div class="infldset">
-							<input type="submit" name="delete_user" value="<?php echo $lang_profile['Delete user'] ?>" /> <input type="submit" name="ban" value="<?php echo $lang_profile['Ban user'] ?>" />
+							<input type="submit" name="delete_user" value="<?php echo $lang_profile['Delete user'] ?>" /> <input type="submit" name="delete_spammer" value="<?php echo $lang_profile['Delete spammer'] ?>" /> <input type="submit" name="ban" value="<?php echo $lang_profile['Ban user'] ?>" />
 						</div>
 					</fieldset>
 				</div>
@@ -1839,7 +1856,7 @@ else
 
 					$moderators = ($cur_forum['moderators'] != '') ? unserialize($cur_forum['moderators']) : array();
 
-					echo "\n\t\t\t\t\t\t\t\t\t".'<label><input type="checkbox" name="moderator_in['.$cur_forum['fid'].']" value="1"'.((in_array($id, $moderators)) ? ' checked="checked"' : '').' />'.pun_htmlspecialchars($cur_forum['forum_name']).'<br /></label>'."\n";
+					echo "\n\t\t\t\t\t\t\t\t\t".'<label><input type="checkbox" name="moderator_in['.$cur_forum['fid'].']" value="1"'.((in_array($id, $moderators)) ? ' checked' : '').' />'.pun_htmlspecialchars($cur_forum['forum_name']).'<br /></label>'."\n";
 				}
 
 ?>
diff --git a/readme.md b/readme.md
index acdcf8fd..bf844de9 100644
--- a/readme.md
+++ b/readme.md
@@ -10,8 +10,8 @@ of the other forums have whilst not sacrificing essential functionality or usabi
 ## Requirements
 
 * A webserver
-* PHP 5.6.4 or later
-* A database such as MySQL 5.0.6 or later, PostgreSQL 7.0 or later, or SQLite 2
+* PHP 4.4.0 or later
+* A database such as MySQL 4.1.2 or later, PostgreSQL 7.0 or later, or SQLite 2
 
 ## Recommendations
 
@@ -20,9 +20,9 @@ of the other forums have whilst not sacrificing essential functionality or usabi
 
 ## Links
 
-* Homepage: https://fluxbb.org
-* Documentation: https://fluxbb.org/docs/v1.5
-* Community: https://fluxbb.org/forums/
-* Resources: https://fluxbb.org/resources/
+* Homepage: http://fluxbb.org
+* Documentation: http://fluxbb.org/docs/v1.5
+* Community: http://fluxbb.org/forums/
+* Resources: http://fluxbb.org/resources/
 * IRC: irc://irc.freenode.net/fluxbb
-* Development: https://github.com/fluxbb/fluxbb
+* Development: http://github.com/fluxbb/fluxbb
\ No newline at end of file
diff --git a/register.php b/register.php
index 91337846..90cea3c9 100644
--- a/register.php
+++ b/register.php
@@ -26,6 +26,12 @@ require PUN_ROOT.'lang/'.$pun_user['language'].'/prof_reg.php';
 if ($pun_config['o_regs_allow'] == '0')
 	message($lang_register['No new regs']);
 
+// HoneyPot Field Name
+	if (($pun_config['o_sb_custom_field'] == 0))
+		$reqfield = 'req_honeypot';
+	else
+		$reqfield=(!empty($pun_config['o_sb_custom_field_name'])) ? $pun_config['o_sb_custom_field_name'] : 'req_honeypot';
+//End of HoneyPot Field Name
 
 // User pressed the cancel button
 if (isset($_GET['cancel']))
@@ -70,11 +76,11 @@ if (isset($_POST['form_sent']))
 	// Check that someone from this IP didn't register a user within the last hour (DoS prevention)
 	$result = $db->query('SELECT 1 FROM '.$db->prefix.'users WHERE registration_ip=\''.$db->escape(get_remote_address()).'\' AND registered>'.(time() - 3600)) or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
 
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 		message($lang_register['Registration flood']);
 
 
-	$username = pun_trim($_POST['req_user']);
+	$username = pun_trim($_POST[$reqfield]);
 	$email1 = strtolower(pun_trim($_POST['req_email1']));
 
 	if ($pun_config['o_regs_verify'] == '1')
@@ -121,7 +127,7 @@ if (isset($_POST['form_sent']))
 	$dupe_list = array();
 
 	$result = $db->query('SELECT username FROM '.$db->prefix.'users WHERE email=\''.$db->escape($email1).'\'') or error('Unable to fetch user info', __FILE__, __LINE__, $db->error());
-	if ($db->has_rows($result))
+	if ($db->num_rows($result))
 	{
 		if ($pun_config['p_allow_dupe_email'] == '0')
 			$errors[] = $lang_prof_reg['Dupe email'];
@@ -150,6 +156,21 @@ if (isset($_POST['form_sent']))
 
 	flux_hook('register_after_validation');
 
+//
+// Begin of SpamBarrier check
+//
+
+	// Include the antispam library
+	require PUN_ROOT.'include/spambarrier.php';
+
+	$req_username = empty($username) ? pun_trim($_POST['req_user']) : $username;
+
+	sb_check_spam_registration($req_username,$email1);
+
+//
+// End of SpamBarrier check
+//
+
 	// Did everything go according to plan?
 	if (empty($errors))
 	{
@@ -157,10 +178,10 @@ if (isset($_POST['form_sent']))
 		$now = time();
 
 		$intial_group_id = ($pun_config['o_regs_verify'] == '0') ? $pun_config['o_default_user_group'] : PUN_UNVERIFIED;
-		$password_hash = flux_password_hash($password1);
+		$password_hash = pun_hash($password1);
 
 		// Add the user
-		$db->query('INSERT INTO '.$db->prefix.'users (username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit) VALUES(\''.$db->escape($username).'\', '.$intial_group_id.', \''.$db->escape($password_hash).'\', \''.$db->escape($email1).'\', '.$email_setting.', '.$timezone.' , '.$dst.', \''.$db->escape($language).'\', \''.$pun_config['o_default_style'].'\', '.$now.', \''.$db->escape(get_remote_address()).'\', '.$now.')') or error('Unable to create user', __FILE__, __LINE__, $db->error());
+		$db->query('INSERT INTO '.$db->prefix.'users (username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit) VALUES(\''.$db->escape($username).'\', '.$intial_group_id.', \''.$password_hash.'\', \''.$db->escape($email1).'\', '.$email_setting.', '.$timezone.' , '.$dst.', \''.$db->escape($language).'\', \''.$pun_config['o_default_style'].'\', '.$now.', \''.$db->escape(get_remote_address()).'\', '.$now.')') or error('Unable to create user', __FILE__, __LINE__, $db->error());
 		$new_uid = $db->insert_id();
 
 		if ($pun_config['o_regs_verify'] == '0')
@@ -265,8 +286,8 @@ if (isset($_POST['form_sent']))
 
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_register['Register']);
-$required_fields = array('req_user' => $lang_common['Username'], 'req_password1' => $lang_common['Password'], 'req_password2' => $lang_prof_reg['Confirm pass'], 'req_email1' => $lang_common['Email'], 'req_email2' => $lang_common['Email'].' 2');
-$focus_element = array('register', 'req_user');
+$required_fields = array($reqfield => $lang_common['Username'], 'req_password1' => $lang_common['Password'], 'req_password2' => $lang_prof_reg['Confirm pass'], 'req_email1' => $lang_common['Email'], 'req_email2' => $lang_common['Email'].' 2');
+$focus_element = array('register', $reqfield);
 
 flux_hook('register_before_header');
 
@@ -316,7 +337,9 @@ if (!empty($errors))
 					<legend><?php echo $lang_register['Username legend'] ?></legend>
 					<div class="infldset">
 						<input type="hidden" name="form_sent" value="1" />
-						<label class="required"><strong><?php echo $lang_common['Username'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_user" value="<?php if (isset($_POST['req_user'])) echo pun_htmlspecialchars($_POST['req_user']); ?>" size="25" maxlength="25" /><br /></label>
+						<label class="required usernamefield"><strong><?php echo $lang_register['If human'] ?></strong><br /><input type="text" name="req_user" value="" size="25" maxlength="25" /><br /></label>
+						<label class="required"><strong><?php echo $lang_common['Username'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="<?php echo $reqfield ?>" value="<?php if (isset($_POST[$reqfield])) echo pun_htmlspecialchars($_POST[$reqfield]); ?>" size="25" maxlength="25" autocomplete="username" required /><br /></label>
+
 					</div>
 				</fieldset>
 			</div>
@@ -324,8 +347,8 @@ if (!empty($errors))
 				<fieldset>
 					<legend><?php echo $lang_register['Pass legend'] ?></legend>
 					<div class="infldset">
-						<label class="conl required"><strong><?php echo $lang_common['Password'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password1" value="<?php if (isset($_POST['req_password1'])) echo pun_htmlspecialchars($_POST['req_password1']); ?>" size="16" /><br /></label>
-						<label class="conl required"><strong><?php echo $lang_prof_reg['Confirm pass'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password2" value="<?php if (isset($_POST['req_password2'])) echo pun_htmlspecialchars($_POST['req_password2']); ?>" size="16" /><br /></label>
+						<label class="conl required"><strong><?php echo $lang_common['Password'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password1" value="<?php if (isset($_POST['req_password1'])) echo pun_htmlspecialchars($_POST['req_password1']); ?>" size="16" autocomplete="new-password" required /><br /></label>
+						<label class="conl required"><strong><?php echo $lang_prof_reg['Confirm pass'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="password" name="req_password2" value="<?php if (isset($_POST['req_password2'])) echo pun_htmlspecialchars($_POST['req_password2']); ?>" size="16" autocomplete="new-password" required /><br /></label>
 						<p class="clearb"><?php echo $lang_register['Pass info'] ?></p>
 					</div>
 				</fieldset>
@@ -336,9 +359,9 @@ if (!empty($errors))
 					<div class="infldset">
 <?php if ($pun_config['o_regs_verify'] == '1'): ?>						<p><?php echo $lang_register['Email info'] ?></p>
 <?php endif; ?>						<label class="required"><strong><?php echo $lang_common['Email'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input type="text" name="req_email1" value="<?php if (isset($_POST['req_email1'])) echo pun_htmlspecialchars($_POST['req_email1']); ?>" size="50" maxlength="80" /><br /></label>
+						<input type="email" name="req_email1" value="<?php if (isset($_POST['req_email1'])) echo pun_htmlspecialchars($_POST['req_email1']); ?>" size="50" maxlength="80" autocomplete="email" required /><br /></label>
 <?php if ($pun_config['o_regs_verify'] == '1'): ?>						<label class="required"><strong><?php echo $lang_register['Confirm email'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br />
-						<input type="text" name="req_email2" value="<?php if (isset($_POST['req_email2'])) echo pun_htmlspecialchars($_POST['req_email2']); ?>" size="50" maxlength="80" /><br /></label>
+						<input type="email" name="req_email2" value="<?php if (isset($_POST['req_email2'])) echo pun_htmlspecialchars($_POST['req_email2']); ?>" size="50" maxlength="80" autocomplete="email" required /><br /></label>
 <?php endif; ?>					</div>
 				</fieldset>
 			</div>
@@ -392,7 +415,7 @@ if (!empty($errors))
 						</select>
 						<br /></label>
 						<div class="rbox">
-							<label><input type="checkbox" name="dst" value="1"<?php if ($dst == '1') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['DST'] ?><br /></label>
+							<label><input type="checkbox" name="dst" value="1"<?php if ($dst == '1') echo ' checked' ?> /><?php echo $lang_prof_reg['DST'] ?><br /></label>
 						</div>
 <?php
 
@@ -431,9 +454,9 @@ if (!empty($errors))
 					<div class="infldset">
 						<p><?php echo $lang_prof_reg['Email setting info'] ?></p>
 						<div class="rbox">
-							<label><input type="radio" name="email_setting" value="0"<?php if ($email_setting == '0') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['Email setting 1'] ?><br /></label>
-							<label><input type="radio" name="email_setting" value="1"<?php if ($email_setting == '1') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['Email setting 2'] ?><br /></label>
-							<label><input type="radio" name="email_setting" value="2"<?php if ($email_setting == '2') echo ' checked="checked"' ?> /><?php echo $lang_prof_reg['Email setting 3'] ?><br /></label>
+							<label><input type="radio" name="email_setting" value="0"<?php if ($email_setting == '0') echo ' checked' ?> /><?php echo $lang_prof_reg['Email setting 1'] ?><br /></label>
+							<label><input type="radio" name="email_setting" value="1"<?php if ($email_setting == '1') echo ' checked' ?> /><?php echo $lang_prof_reg['Email setting 2'] ?><br /></label>
+							<label><input type="radio" name="email_setting" value="2"<?php if ($email_setting == '2') echo ' checked' ?> /><?php echo $lang_prof_reg['Email setting 3'] ?><br /></label>
 						</div>
 					</div>
 				</fieldset>
diff --git a/search.php b/search.php
index 6d622664..58fc9cb6 100644
--- a/search.php
+++ b/search.php
@@ -267,7 +267,7 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 						break;
 				}
 
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 				{
 					$user_ids = array();
 					while ($row = $db->fetch_row($result))
@@ -326,24 +326,27 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 					message($lang_common['No permission'], false, '403 Forbidden');
 
 				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.$pun_user['last_visit'].' AND t.moved_to IS NULL'.(isset($_GET['fid']) ? ' AND t.forum_id='.intval($_GET['fid']) : '').' ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No new posts']);
 			}
 			// If it's a search for recent posts (in a certain time interval)
 			else if ($action == 'show_recent')
 			{
 				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.last_post>'.(time() - $interval).' AND t.moved_to IS NULL'.(isset($_GET['fid']) ? ' AND t.forum_id='.intval($_GET['fid']) : '').' ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No recent posts']);
 			}
 			// If it's a search for topics in which the user has posted
 			else if ($action == 'show_replies')
 			{
 				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'posts AS p ON t.id=p.topic_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id='.$pun_user['id'].' GROUP BY t.id'.($db_type == 'pgsql' ? ', t.last_post' : '').' ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No user posts']);
 			}
 			// If it's a search for posts by a specific user ID
@@ -352,8 +355,9 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 				$show_as = 'posts';
 
 				$result = $db->query('SELECT p.id FROM '.$db->prefix.'posts AS p INNER JOIN '.$db->prefix.'topics AS t ON p.topic_id=t.id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id='.$user_id.' ORDER BY p.posted DESC') or error('Unable to fetch user posts', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No user posts']);
 
 				// Pass on the user ID so that we can later know whose posts we're searching for
@@ -363,8 +367,9 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 			else if ($action == 'show_user_topics')
 			{
 				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'posts AS p ON t.first_post_id=p.id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND p.poster_id='.$user_id.' ORDER BY t.last_post DESC') or error('Unable to fetch user topics', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No user topics']);
 
 				// Pass on the user ID so that we can later know whose topics we're searching for
@@ -377,8 +382,9 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 					message($lang_common['Bad request'], false, '404 Not Found');
 
 				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'topic_subscriptions AS s ON (t.id=s.topic_id AND s.user_id='.$user_id.') LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No subscriptions']);
 
 				// Pass on user ID so that we can later know whose subscriptions we're searching for
@@ -388,8 +394,9 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 			else
 			{
 				$result = $db->query('SELECT t.id FROM '.$db->prefix.'topics AS t LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=t.forum_id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.num_replies=0 AND t.moved_to IS NULL ORDER BY t.last_post DESC') or error('Unable to fetch topic list', __FILE__, __LINE__, $db->error());
+				$num_hits = $db->num_rows($result);
 
-				if (!$db->has_rows($result))
+				if (!$num_hits)
 					message($lang_search['No unanswered']);
 			}
 
@@ -397,8 +404,6 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 			while ($row = $db->fetch_row($result))
 				$search_ids[] = $row[0];
 
-			$num_hits = count($search_ids);
-
 			$db->free_result($result);
 		}
 		else
@@ -409,7 +414,7 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 		$old_searches = array();
 		$result = $db->query('SELECT ident FROM '.$db->prefix.'online') or error('Unable to fetch online list', __FILE__, __LINE__, $db->error());
 
-		if ($db->has_rows($result))
+		if ($db->num_rows($result))
 		{
 			while ($row = $db->fetch_row($result))
 				$old_searches[] = '\''.$db->escape($row[0]).'\'';
@@ -500,24 +505,24 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 		if ($search_type[0] == 'action')
 		{
 			if ($search_type[1] == 'show_user_topics')
-				$crumbs_text['search_type'] = array(sprintf($lang_search['Quick search show_user_topics'], $search_set[0]['poster']), 'search.php?action=show_user_topics&amp;user_id='.$search_type[2]);
+				$crumbs_text['search_type'] = '<a href="search.php?action=show_user_topics&amp;user_id='.$search_type[2].'">'.sprintf($lang_search['Quick search show_user_topics'], pun_htmlspecialchars($search_set[0]['poster'])).'</a>';
 			else if ($search_type[1] == 'show_user_posts')
-				$crumbs_text['search_type'] = array(sprintf($lang_search['Quick search show_user_posts'], $search_set[0]['pposter']), 'search.php?action=show_user_posts&amp;user_id='.$search_type[2]);
+				$crumbs_text['search_type'] = '<a href="search.php?action=show_user_posts&amp;user_id='.$search_type[2].'">'.sprintf($lang_search['Quick search show_user_posts'], pun_htmlspecialchars($search_set[0]['pposter'])).'</a>';
 			else if ($search_type[1] == 'show_subscriptions')
 			{
 				// Fetch username of subscriber
 				$subscriber_id = $search_type[2];
 				$result = $db->query('SELECT username FROM '.$db->prefix.'users WHERE id='.$subscriber_id) or error('Unable to fetch username of subscriber', __FILE__, __LINE__, $db->error());
 
-				if ($db->has_rows($result))
+				if ($db->num_rows($result))
 					$subscriber_name = $db->result($result);
 				else
 					message($lang_common['Bad request'], false, '404 Not Found');
 
-				$crumbs_text['search_type'] = array(sprintf($lang_search['Quick search show_subscriptions'], $subscriber_name), 'search.php?action=show_subscriptions&amp;user_id='.$subscriber_id);
+				$crumbs_text['search_type'] = '<a href="search.php?action=show_subscriptions&amp;user_id='.$subscriber_id.'">'.sprintf($lang_search['Quick search show_subscriptions'], pun_htmlspecialchars($subscriber_name)).'</a>';
 			}
 			else
-				$crumbs_text['search_type'] = array($lang_search['Quick search '.$search_type[1]], 'search.php?action='.$search_type[1]);
+				$crumbs_text['search_type'] = '<a href="search.php?action='.$search_type[1].'">'.$lang_search['Quick search '.$search_type[1]].'</a>';
 		}
 		else
 		{
@@ -526,28 +531,22 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 			if ($search_type[0] == 'both')
 			{
 				list ($keywords, $author) = $search_type[1];
-				$crumbs_text['search_type'] = sprintf($lang_search['By both show as '.$show_as], $keywords, $author);
+				$crumbs_text['search_type'] = sprintf($lang_search['By both show as '.$show_as], pun_htmlspecialchars($keywords), pun_htmlspecialchars($author));
 			}
 			else if ($search_type[0] == 'keywords')
 			{
 				$keywords = $search_type[1];
-				$crumbs_text['search_type'] = sprintf($lang_search['By keywords show as '.$show_as], $keywords);
+				$crumbs_text['search_type'] = sprintf($lang_search['By keywords show as '.$show_as], pun_htmlspecialchars($keywords));
 			}
 			else if ($search_type[0] == 'author')
 			{
 				$author = $search_type[1];
-				$crumbs_text['search_type'] = sprintf($lang_search['By user show as '.$show_as], $author);
+				$crumbs_text['search_type'] = sprintf($lang_search['By user show as '.$show_as], pun_htmlspecialchars($author));
 			}
 
-			$crumbs_text['search_type'] = array($crumbs_text['search_type'], 'search.php?action=search&amp;keywords='.urlencode($keywords).'&amp;author='.urlencode($author).'&amp;forums='.$search_type[2].'&amp;search_in='.$search_type[3].'&amp;sort_by='.$sort_by.'&amp;sort_dir='.$sort_dir.'&amp;show_as='.$show_as);
+			$crumbs_text['search_type'] = '<a href="search.php?action=search&amp;keywords='.urlencode($keywords).'&amp;author='.urlencode($author).'&amp;forums='.$search_type[2].'&amp;search_in='.$search_type[3].'&amp;sort_by='.$sort_by.'&amp;sort_dir='.$sort_dir.'&amp;show_as='.$show_as.'">'.$crumbs_text['search_type'].'</a>';
 		}
 
-		$crumbs = generate_crumbs(array(
-			array($lang_common['Index'], 'index.php'),
-			array($crumbs_text['show_as'], 'search.php'),
-			$crumbs_text['search_type'],
-		));
-
 		$page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), $lang_search['Search results']);
 		define('PUN_ACTIVE_PAGE', 'search');
 		require PUN_ROOT.'header.php';
@@ -555,7 +554,11 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="search.php"><?php echo $crumbs_text['show_as'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $crumbs_text['search_type'] ?></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
@@ -641,11 +644,11 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 
 ?>
 <div class="blockpost<?php echo ($post_count % 2 == 0) ? ' roweven' : ' rowodd' ?><?php if ($cur_search['pid'] == $cur_search['first_post_id']) echo ' firstpost' ?><?php if ($post_count == 1) echo ' blockpost1' ?><?php if ($item_status != '') echo ' '.$item_status ?>">
-	<h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <span><?php if ($cur_search['pid'] != $cur_search['first_post_id']) echo $lang_topic['Re'].' ' ?><?php echo $forum ?></span> <span>»&#160;<a href="viewtopic.php?id=<?php echo $cur_search['tid'] ?>"><?php echo pun_htmlspecialchars($cur_search['subject']) ?></a></span> <span>»&#160;<a href="viewtopic.php?pid=<?php echo $cur_search['pid'].'#p'.$cur_search['pid'] ?>"><?php echo format_time($cur_search['pposted']) ?></a></span></span></h2>
 	<div class="box">
 		<div class="inbox">
 			<div class="postbody">
 				<div class="postleft">
+                    <h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <span><?php if ($cur_search['pid'] != $cur_search['first_post_id']) echo $lang_topic['Re'].' ' ?><?php echo $forum ?></span> <span>»&#160;<a href="viewtopic.php?id=<?php echo $cur_search['tid'] ?>"><?php echo pun_htmlspecialchars($cur_search['subject']) ?></a></span> <span>»&#160;<a href="viewtopic.php?pid=<?php echo $cur_search['pid'].'#p'.$cur_search['pid'] ?>"><?php echo format_time($cur_search['pposted']) ?></a></span></span></h2>
 					<dl>
 						<dt><?php echo $pposter ?></dt>
 <?php if ($cur_search['pid'] == $cur_search['first_post_id']) : ?>						<dd><span><?php echo $lang_topic['Replies'].' '.forum_number_format($cur_search['num_replies']) ?></span></dd>
@@ -752,7 +755,11 @@ if (isset($_GET['action']) || isset($_GET['search_id']))
 		<div class="pagepost">
 			<p class="pagelink"><?php echo $paging_links ?></p>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="search.php"><?php echo $crumbs_text['show_as'] ?></a></li>
+			<li><span>»&#160;</span><strong><?php echo $crumbs_text['search_type'] ?></strong></li>
+		</ul>
 <?php echo (!empty($forum_actions) ? "\t\t".'<p class="subscribelink clearb">'.implode(' - ', $forum_actions).'</p>'."\n" : '') ?>
 		<div class="clearer"></div>
 	</div>
diff --git a/style/Air.css b/style/Air.css
index f7283c5e..d872d44e 100644
--- a/style/Air.css
+++ b/style/Air.css
@@ -46,10 +46,6 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	font-size: 1em;
 }
 
-.pun .code {
-    padding: 2px 4px;
-}
-
 .pun table {
 	border-collapse: collapse;
 	border-spacing: 0;
@@ -134,6 +130,14 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	min-height: 1px;
 }
 
+* html .pun .inbox, * html .pun #brdmain, * html .pun .infldset, * html .pun .crumbs, * html .pun .pagepost, * html .pun .block2col {
+	display: inline-block;
+}
+
+* html .pun .inbox, * html .pun #bdrdmain, * html .pun .infldset, * html .pun .crumbs, * html .pun .pagepost, * html .pun .block2col {
+	display: block;
+}
+
 .pun .inbox:after, .pun #brdmain:after, .pun .crumbs:after, .pun .pagepost:after, .pun .block2col:after {
 	content: " ";
 	display: block;
@@ -526,6 +530,10 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	position: relative;
 }
 
+* html .pun .blocktable .box {
+	display: inline-block;
+}
+
 .pun .blocktable table {
 	table-layout: fixed;
 	margin-bottom: -1px;
@@ -687,6 +695,10 @@ MAIN POSTS
 	position: relative;
 }
 
+* html .pun .blockpost {
+	display: inline-block;
+}
+
 .pun .blockpost h2 {
 	font: 1em/1.462em Arial, Helvetica, sans-serif;
 	white-space: nowrap;
@@ -940,6 +952,14 @@ MAIN POSTS
 	text-align: left;
 }
 
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
+*:first-child+html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
 .pun .codebox pre code {
 	padding: 0.5em;
 	white-space: pre;
@@ -949,6 +969,10 @@ MAIN POSTS
 	display: inline-block;
 }
 
+* html .pun .codebox pre code {
+	display: block;
+}
+
 .pun .codebox pre.vscroll {
 	height: 32em;
 	overflow: auto;
@@ -1012,6 +1036,10 @@ MAIN FORMS
 	padding: 0 18px 12px 18px;
 }
 
+* html .pun .blockform .box, * html .pun #posterror {
+	display: inline-block;
+}
+
 .pun .blockform .forminfo, .pun .error-info {
 	padding: 12px 18px;
 	border-style: solid;
@@ -1045,6 +1073,14 @@ MAIN FORMS
 	padding: 10px 19px 4px 19px;
 }
 
+* html .pun legend {
+	margin-left: -7px;
+}
+
+*:first-child+html .pun legend {
+	margin-left: -7px;
+}
+
 .pun .infldset {
 	border-style: solid;
 	border-width: 1px;
@@ -1111,6 +1147,11 @@ MAIN FORMS
 	min-height: 1px;
 }
 
+* html .pun .rbox label {
+	text-indent: -3px;
+	height: 1%;
+}
+
 .pun .rbox input {
 	margin: 3px 0.75em 3px -1.75em;
 	float: left;
@@ -1290,6 +1331,10 @@ PROFILES (+ ADMIN MENU)
 	text-decoration: none;
 }
 
+* html .pun .blockmenu a:link,  * html .pun .blockmenu a:visited {
+	height: 1%;
+}
+
 .pun .blockmenu a:hover, .pun .blockmenu a:active, .pun .blockmenu a:focus {
 	text-decoration: none;
 }
@@ -1388,11 +1433,6 @@ html, body, .pun {
 	border-color: #b50000;
 }
 
-.pun .code {
-    color: #257ec7;
-    background-color: #f1f5f9;
-}
-
 /* Primary Navigation
 ----------------------------------------------------------------*/
 
@@ -1470,6 +1510,10 @@ html, body, .pun {
 	color: #fcfdfe;
 }
 
+.pun .postmsg, #punhelp code, #punhelp samp {
+	color: #333;
+}
+
 .pun .postsignature, .pun .postmsg .postedit {
 	color: #566579;
 }
diff --git a/style/Cobalt.css b/style/Cobalt.css
new file mode 100644
index 00000000..aff10914
--- /dev/null
+++ b/style/Cobalt.css
@@ -0,0 +1,1150 @@
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+	}
+
+.pun ul, .pun ol {
+	list-style: none
+	}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+	}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+	}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+	}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+	}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+	}
+
+.clearl {
+	clear: left;
+	}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3, span.closedtext,
+.pun .required strong span {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+	}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 68.75%/1.4545em Verdana, Helvetica, Arial, sans-serif;
+	line-height: normal;
+	}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: verdana, helvetica, arial, sans-serif;
+	}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+	}
+
+.pun pre code {
+	font-size: 1em;
+	}
+
+.pun strong {
+	font-weight: bold;
+	}
+
+.pun em {
+	font-style: italic;
+	}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+	}
+
+.pun h2 {
+	font-size: 1em;
+	font-weight: normal;
+	padding: 4px 6px;
+	}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+	}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+	}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+	}
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.75em 0
+	}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+	}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+	}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+	}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+	}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+	}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+	}
+
+.pun span.bbu {
+	text-decoration: underline
+	}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+	}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+	}
+
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+html, body {
+	margin: 0;
+	padding: 0
+	}
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+	}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%
+	}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+	}
+
+#brdtitle p {
+	padding-top: 0px
+	}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+	}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+	}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+	}
+
+#postreview .blockpost {
+	margin-bottom: -1px;
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+	}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+	}
+
+.pun .postlinksb {
+	margin-top: -6px
+	}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+	}
+
+#brdheader .box {
+	border-top-width: 4px;
+	}
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+	}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 3px 0 0 0;
+	}
+
+#brdmenu li {
+	display: inline;
+	margin-right: 12px;
+	}
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none
+	}
+
+#brdmenu a:hover, #brdmenu a:active {
+	text-decoration: underline
+	}
+
+#brdwelcome .conl {
+	float: left;
+	}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+	}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+	}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+	}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+	}
+
+.pun .pagelink {
+	float: left;
+	white-space: nowrap;
+	}
+
+.pun .postlink {
+	font-weight: bold;
+	white-space: nowrap;
+	}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+	}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+	}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+	}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	text-decoration: none
+	}
+
+.pun .postlink a:hover, .pun .postlink a:active {
+	text-decoration: underline;
+	}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+	}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter .conl {
+	float: left;
+	}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+	}
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+	}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin:0 6px;
+	}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+	}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+	}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+	}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+	}
+
+.pun .blocktable table {
+	table-layout: fixed;
+	}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	text-align: left;
+	font-weight: normal;
+	}
+
+.pun td, .pun th {
+	border-style: solid none none solid;
+	border-width: 1px;
+	}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+	}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+	}
+
+.pun .tcr {
+	width: 30%;
+	}
+
+.pun .tcl h3 {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .tcl h3 span.newtext {
+	font-size: 0.917em;
+	}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap;
+	font-weight: normal;
+	}
+
+.pun td span.byuser {
+	white-space: nowrap;
+	}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+	}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#users1 .tcr {
+	width: 25%
+	}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#debug .tcl {
+	width: 10%
+	}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+	}
+
+#punindex .tcr .byuser {
+	display: block
+	}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+	}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .icon {
+	margin: 0.1em 0 0 0.2em;
+	border-width: 0.6em;
+	border-style: solid;
+	height: 0;
+	width: 0;
+	overflow: hidden;
+	float: left;
+	}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+	}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+	}
+
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+.pun .blockform form, .pun .fakeform {
+	PADDING: 20px 20px 15px 20px
+	}
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+	}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+	}
+
+.pun .inform {
+	padding-bottom: 12px
+	}
+
+.pun fieldset {
+	padding: 0px 12px 0px 12px;
+	border-style: solid;
+	border-width: 1px
+	}
+
+.pun legend {
+	padding: 0px 6px
+	}
+
+.pun .infldset {
+	padding: 9px 0px 12px 0
+	}
+
+.pun label {
+	display: block;
+	padding: 3px 0
+	}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+	}
+
+.pun fieldset .rbox br {
+	display: none;
+	}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun .txtarea {
+	width: 75%
+	}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+	}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+	}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+	}
+
+.pun .blockform .buttons {
+	padding-left: 12px;
+	}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+	}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+	}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+	}
+
+.pun p.actions span {
+	margin-right: 12px;
+	}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+	}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.3em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+	}
+
+.pun .checklist fieldset {
+	border: 0;
+	padding: 0;
+	}
+
+.pun .checklist legend {
+	padding: 0;
+	}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+	}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+	}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+	}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+	}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+	}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+	}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+	}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+	}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+	}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+	}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+	}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+	}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+	}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+	}
+
+.pun .blockpost .box {
+	overflow: hidden;
+	}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	position: relative;
+	overflow: hidden;
+	}
+
+.pun .postleft dl {
+	padding: 6px;
+	}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+	}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+	}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+	}
+
+#postpreview .postright {
+	border-left: 0
+	}
+
+.pun .postright {
+	padding: 0 6px;
+	}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+	}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+	}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 10px 6px 5px 6px;
+	}
+
+.pun .postfootright li {
+	display: inline;
+	}
+
+.pun .postfootright li:before {
+	content: " | ";
+	}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+	}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+	}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+	}
+
+.pun .codebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0;
+	}
+
+.pun .quotebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+	}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+	}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+	}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+	}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+	}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+	}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+	}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+	}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+	}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+	}
+
+.pun .postmsg .postimg img {
+	max-width: 98%;
+	vertical-align: middle;
+	margin: 7px 0.5em 7px 0;
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-style: solid;
+	border-width: 2px;
+	}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+	}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+	}
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+	}
+
+#punhelp div.box {
+	padding: 10px
+	}
+
+#debugtime {
+	margin-top: -12px;
+	text-align: center;
+	}
+
+#brdwelcome, #brdfooter dl a, div.blockmenu li, div.rbox input {
+	line-height: 1.4em
+	}
+
+#announce div.inbox div {
+	padding: 3px 0
+	}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #2a2a2a;
+	color: #d4d4d4
+	}
+
+.pun {
+	color: #d4d4d4
+	}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #383838
+	}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#brdfooter #modcontrols, #adminconsole fieldset td, .pun .blockmenu .box, #adstats dd {
+	background-color: #424242
+	}
+
+.pun h2, #brdmenu {
+	background-color: #565656;
+	color: #d4d4d4
+	}
+
+.pun th {
+	background-color: #484848
+	}
+
+.pun legend {
+	color: #60a0dc
+	}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #d4d4d4
+	}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #d4d4d4
+	}
+
+.pun textarea, .pun input, .pun select {
+	background-color: #2a2a2a;
+	color: #d4d4d4
+	}
+
+.pun .multiselect, .pun .checklist {
+	color: #D4D4D4;
+	}
+
+.pun .checklist {
+	border-color: #666;
+	}
+
+/* Posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #383838
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #424242
+	}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #424242
+	}
+
+.pun .blockpost h2 {
+	background-color: #565656
+	}
+
+.pun .blockpost h2 span.conr {
+	color: #a19e96
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+	}
+
+.pun hr {
+	background-color: #606060;
+	color: #606060
+	}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-color:#565656
+	}
+
+.pun td, #brdfooter #modcontrols {
+	border-color: #565656
+	}
+
+.pun th {
+	border-color: #484848
+	}
+
+.pun fieldset {
+	border-color: #606060
+	}
+
+#adminconsole td, #adminconsole th {
+	border-color: #383838
+	}
+
+.pun .quotebox, .pun .codebox, .pun .forminfo,
+.pun .blockpost label, .pun .deletemsg {
+	border-color: #606060
+	}
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #60a0dc
+	}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #80d6ff
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-color: #60a0dc;
+	}
+
+.pun .postmsg .postimg a:hover img, .pun .postmsg .postimg a:active img, .pun .postmsg .postimg a:focus img {
+	border-color: #80d6ff;
+	}
+
+.pun h2 a:link, .pun h2 a:visited,
+#brdmenu a:link, #brdmenu a:visited {
+	color: #d4d4d4
+	}
+
+.pun h2 a:hover, .pun h2 a:active,
+#brdmenu a:hover, #brdmenu a:active {
+	color: #d4d4d4
+	}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+	}
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+	}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #ff4000
+	}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #ff5010
+	}
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	border-color: #484848 #404040 #3c3c3c #444444
+	}
+
+.pun .iredirect .icon {
+	border-color: #383838 #383838 #383838 #383838
+	}
+
+.pun .inew .icon {
+	border-color: #5496d8 #4b85c0 #4377ac #4f8dcb
+	}
diff --git a/style/Earth.css b/style/Earth.css
index 4b06639e..2590c99d 100644
--- a/style/Earth.css
+++ b/style/Earth.css
@@ -46,10 +46,6 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	font-size: 1em;
 }
 
-.pun .code {
-    padding: 2px 4px;
-}
-
 .pun table {
 	border-collapse: collapse;
 	border-spacing: 0;
@@ -134,6 +130,14 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	min-height: 1px;
 }
 
+* html .pun .inbox, * html .pun #brdmain, * html .pun .infldset, * html .pun .crumbs, * html .pun .pagepost, * html .pun .block2col {
+	display: inline-block;
+}
+
+* html .pun .inbox, * html .pun #bdrdmain, * html .pun .infldset, * html .pun .crumbs, * html .pun .pagepost, * html .pun .block2col {
+	display: block;
+}
+
 .pun .inbox:after, .pun #brdmain:after, .pun .crumbs:after, .pun .pagepost:after, .pun .block2col:after {
 	content: " ";
 	display: block;
@@ -525,6 +529,10 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	position: relative;
 }
 
+* html .pun .blocktable .box {
+	display: inline-block;
+}
+
 .pun .blocktable table {
 	table-layout: fixed;
 	margin-bottom: -1px;
@@ -686,6 +694,10 @@ MAIN POSTS
 	position: relative;
 }
 
+* html .pun .blockpost {
+	display: inline-block;
+}
+
 .pun .blockpost h2 {
 	font: 1em/1.462em Arial, Helvetica, sans-serif;
 	white-space: nowrap;
@@ -939,6 +951,14 @@ MAIN POSTS
 	text-align: left;
 }
 
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
+*:first-child+html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
 .pun .codebox pre code {
 	padding: 0.5em;
 	white-space: pre;
@@ -948,6 +968,10 @@ MAIN POSTS
 	display: inline-block;
 }
 
+* html .pun .codebox pre code {
+	display: block;
+}
+
 .pun .codebox pre.vscroll {
 	height: 32em;
 	overflow: auto;
@@ -1011,6 +1035,10 @@ MAIN FORMS
 	padding: 0 18px 12px 18px;
 }
 
+* html .pun .blockform .box, * html .pun #posterror {
+	display: inline-block;
+}
+
 .pun .blockform .forminfo, .pun .error-info {
 	padding: 12px 18px;
 	border-style: solid;
@@ -1044,6 +1072,14 @@ MAIN FORMS
 	padding: 10px 19px 4px 19px;
 }
 
+* html .pun legend {
+	margin-left: -7px;
+}
+
+*:first-child+html .pun legend {
+	margin-left: -7px;
+}
+
 .pun .infldset {
 	border-style: solid;
 	border-width: 1px;
@@ -1110,6 +1146,11 @@ MAIN FORMS
 	min-height: 1px;
 }
 
+* html .pun .rbox label {
+	text-indent: -3px;
+	height: 1%;
+}
+
 .pun .rbox input {
 	margin: 3px 0.75em 3px -1.75em;
 	float: left;
@@ -1289,6 +1330,10 @@ PROFILES (+ ADMIN MENU)
 	text-decoration: none;
 }
 
+* html .pun .blockmenu a:link,  * html .pun .blockmenu a:visited {
+	height: 1%;
+}
+
 .pun .blockmenu a:hover, .pun .blockmenu a:active, .pun .blockmenu a:focus {
 	text-decoration: none;
 }
@@ -1387,11 +1432,6 @@ html, body, .pun {
 	border-color: #73A900;
 }
 
-.pun .code {
-    color: #257ec7;
-    background-color: #f1f5f9;
-}
-
 /* Primary Navigation
 ----------------------------------------------------------------*/
 
@@ -1469,6 +1509,10 @@ html, body, .pun {
 	color: #fcfcf4;
 }
 
+.pun .postmsg, #punhelp code, #punhelp samp {
+	color: #333;
+}
+
 .pun .postsignature, .pun .postmsg .postedit {
 	color: #526550;
 }
diff --git a/style/Fire.css b/style/Fire.css
index cf10cb3f..217c0481 100644
--- a/style/Fire.css
+++ b/style/Fire.css
@@ -46,10 +46,6 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	font-size: 1em;
 }
 
-.pun .code {
-    padding: 2px 4px;
-}
-
 .pun table {
 	border-collapse: collapse;
 	border-spacing: 0;
@@ -134,6 +130,14 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	min-height: 1px;
 }
 
+* html .pun .inbox, * html .pun #brdmain, * html .pun .infldset, * html .pun .crumbs, * html .pun .pagepost, * html .pun .block2col {
+	display: inline-block;
+}
+
+* html .pun .inbox, * html .pun #bdrdmain, * html .pun .infldset, * html .pun .crumbs, * html .pun .pagepost, * html .pun .block2col {
+	display: block;
+}
+
 .pun .inbox:after, .pun #brdmain:after, .pun .crumbs:after, .pun .pagepost:after, .pun .block2col:after {
 	content: " ";
 	display: block;
@@ -525,6 +529,10 @@ html, body, .pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
 	position: relative;
 }
 
+* html .pun .blocktable .box {
+	display: inline-block;
+}
+
 .pun .blocktable table {
 	table-layout: fixed;
 	margin-bottom: -1px;
@@ -686,6 +694,10 @@ MAIN POSTS
 	position: relative;
 }
 
+* html .pun .blockpost {
+	display: inline-block;
+}
+
 .pun .blockpost h2 {
 	font: 1em/1.462em Arial, Helvetica, sans-serif;
 	white-space: nowrap;
@@ -939,6 +951,14 @@ MAIN POSTS
 	text-align: left;
 }
 
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
+*:first-child+html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
 .pun .codebox pre code {
 	padding: 0.5em;
 	white-space: pre;
@@ -948,6 +968,10 @@ MAIN POSTS
 	display: inline-block;
 }
 
+* html .pun .codebox pre code {
+	display: block;
+}
+
 .pun .codebox pre.vscroll {
 	height: 32em;
 	overflow: auto;
@@ -1011,6 +1035,10 @@ MAIN FORMS
 	padding: 0 18px 12px 18px;
 }
 
+* html .pun .blockform .box, * html .pun #posterror {
+	display: inline-block;
+}
+
 .pun .blockform .forminfo, .pun .error-info {
 	padding: 12px 18px;
 	border-style: solid;
@@ -1044,6 +1072,14 @@ MAIN FORMS
 	padding: 10px 19px 4px 19px;
 }
 
+* html .pun legend {
+	margin-left: -7px;
+}
+
+*:first-child+html .pun legend {
+	margin-left: -7px;
+}
+
 .pun .infldset {
 	border-style: solid;
 	border-width: 1px;
@@ -1110,6 +1146,11 @@ MAIN FORMS
 	min-height: 1px;
 }
 
+* html .pun .rbox label {
+	text-indent: -3px;
+	height: 1%;
+}
+
 .pun .rbox input {
 	margin: 3px 0.75em 3px -1.75em;
 	float: left;
@@ -1289,6 +1330,10 @@ PROFILES (+ ADMIN MENU)
 	text-decoration: none;
 }
 
+* html .pun .blockmenu a:link,  * html .pun .blockmenu a:visited {
+	height: 1%;
+}
+
 .pun .blockmenu a:hover, .pun .blockmenu a:active, .pun .blockmenu a:focus {
 	text-decoration: none;
 }
@@ -1387,11 +1432,6 @@ html, body, .pun {
 	border-color: #f60;
 }
 
-.pun .code {
-    color: #257ec7;
-    background-color: #f1f5f9;
-}
-
 /* Primary Navigation
 ----------------------------------------------------------------*/
 
@@ -1469,6 +1509,10 @@ html, body, .pun {
 	color: #fbfaf5;
 }
 
+.pun .postmsg, #punhelp code, #punhelp samp {
+	color: #333;
+}
+
 .pun .postsignature, .pun .postmsg .postedit {
 	color: #665858;
 }
diff --git a/style/Lithium.css b/style/Lithium.css
new file mode 100644
index 00000000..10955a62
--- /dev/null
+++ b/style/Lithium.css
@@ -0,0 +1,1149 @@
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+	}
+
+.pun ul, .pun ol {
+	list-style: none
+	}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+	}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+	}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+	}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+	}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+	}
+
+.clearl {
+	clear: left;
+	}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3, span.closedtext,
+.pun .required strong span {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+	}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 68.75%/1.4545em Verdana, Helvetica, Arial, sans-serif;
+	line-height: normal;
+	}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: verdana, helvetica, arial, sans-serif;
+	}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+	}
+
+.pun pre code {
+	font-size: 1em;
+	}
+
+.pun strong {
+	font-weight: bold;
+	}
+
+.pun em {
+	font-style: italic;
+	}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+	}
+
+.pun h2 {
+	font-size: 1em;
+	font-weight: normal;
+	padding: 4px 6px;
+	}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+	}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+	}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+	}
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.75em 0
+	}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+	}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+	}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+	}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+	}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+	}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+	}
+
+.pun span.bbu {
+	text-decoration: underline
+	}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+	}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+	}
+
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+html, body {
+	margin: 0;
+	padding: 0
+	}
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+	}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%
+	}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+	}
+
+#brdtitle p {
+	padding-top: 0px
+	}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+	}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+	}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+	}
+
+#postreview .blockpost {
+	margin-bottom: -1px;
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+	}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+	}
+
+.pun .postlinksb {
+	margin-top: -6px
+	}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+	}
+
+#brdheader .box {
+	border-top-width: 4px;
+	}
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+	}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 3px 0 0 0;
+	}
+
+#brdmenu li {
+	display: inline;
+	margin-right: 12px;
+	}
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none
+	}
+
+#brdmenu a:hover, #brdmenu a:active {
+	text-decoration: underline
+	}
+
+#brdwelcome .conl {
+	float: left;
+	}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+	}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+	}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+	}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+	}
+
+.pun .pagelink {
+	float: left;
+	white-space: nowrap;
+	}
+
+.pun .postlink {
+	font-weight: bold;
+	white-space: nowrap;
+	}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+	}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+	}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+	}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	text-decoration: none
+	}
+
+.pun .postlink a:hover, .pun .postlink a:active {
+	text-decoration: underline;
+	}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+	}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter .conl {
+	float: left;
+	}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+	}
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+	}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin:0 6px;
+	}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+	}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+	}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+	}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+	}
+
+.pun .blocktable table {
+	table-layout: fixed;
+	}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	text-align: left;
+	font-weight: normal;
+	}
+
+.pun td, .pun th {
+	border-style: solid none none solid;
+	border-width: 1px;
+	}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+	}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+	}
+
+.pun .tcr {
+	width: 30%;
+	}
+
+.pun .tcl h3 {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .tcl h3 span.newtext {
+	font-size: 0.917em;
+	}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap;
+	font-weight: normal;
+	}
+
+.pun td span.byuser {
+	white-space: nowrap;
+	}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+	}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#users1 .tcr {
+	width: 25%
+	}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#debug .tcl {
+	width: 10%
+	}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+	}
+
+#punindex .tcr .byuser {
+	display: block
+	}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+	}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .icon {
+	margin: 0.1em 0 0 0.2em;
+	border-width: 0.6em;
+	border-style: solid;
+	height: 0;
+	width: 0;
+	overflow: hidden;
+	float: left;
+	}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+	}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+	}
+
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+.pun .blockform form, .pun .fakeform {
+	PADDING: 20px 20px 15px 20px
+	}
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+	}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+	}
+
+.pun .inform {
+	padding-bottom: 12px
+	}
+
+.pun fieldset {
+	padding: 0px 12px 0px 12px;
+	border-style: solid;
+	border-width: 1px
+	}
+
+.pun legend {
+	padding: 0px 6px
+	}
+
+.pun .infldset {
+	padding: 9px 0px 12px 0
+	}
+
+.pun label {
+	display: block;
+	padding: 3px 0
+	}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+	}
+
+.pun fieldset .rbox br {
+	display: none;
+	}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun .txtarea {
+	width: 75%
+	}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+	}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+	}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+	}
+
+.pun .blockform .buttons {
+	padding-left: 12px;
+	}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+	}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+	}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+	}
+
+.pun p.actions span {
+	margin-right: 12px;
+	}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+	}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.3em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+	}
+
+.pun .checklist fieldset {
+	border: 0;
+	padding: 0;
+	}
+
+.pun .checklist legend {
+	padding: 0;
+	}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+	}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+	}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+	}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+	}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+	}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+	}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+	}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+	}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+	}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+	}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+	}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+	}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+	}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+	}
+
+.pun .blockpost .box {
+	overflow: hidden;
+	}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	position: relative;
+	overflow: hidden;
+	}
+
+.pun .postleft dl {
+	padding: 6px;
+	}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+	}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+	}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+	}
+
+#postpreview .postright {
+	border-left: 0
+	}
+
+.pun .postright {
+	padding: 0 6px;
+	}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+	}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+	}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 10px 6px 5px 6px;
+	}
+
+.pun .postfootright li {
+	display: inline;
+	}
+
+.pun .postfootright li:before {
+	content: " | ";
+	}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+	}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+	}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+	}
+
+.pun .codebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0;
+	}
+
+.pun .quotebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+	}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+	}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+	}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+	}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+	}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+	}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+	}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+	}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+	}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+	}
+
+.pun .postmsg .postimg img {
+	max-width: 98%;
+	vertical-align: middle;
+	margin: 7px 0.5em 7px 0;
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-style: solid;
+	border-width: 2px;
+	}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+	}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+	}
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+	}
+
+#punhelp div.box {
+	padding: 10px
+	}
+
+#debugtime {
+	margin-top: -12px;
+	text-align: center;
+	}
+
+#brdwelcome, #brdfooter dl a, div.blockmenu li, div.rbox input {
+	line-height: 1.4em
+	}
+
+#announce div.inbox div {
+	padding: 3px 0
+	}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #fff;
+	color: #333
+	}
+
+.pun {
+	color: #333
+	}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #f1f1f1
+	}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#brdfooter #modcontrols, #adminconsole fieldset td, .pun .blockmenu .box, #adstats dd {
+	background-color: #dedfdf
+	}
+
+.pun h2, #brdmenu {
+	background-color: #6c8a3f;
+	color: #fff
+	}
+
+.pun th {
+	background-color: #d1d1d1
+	}
+
+.pun legend {
+	color: #6c8a3f
+	}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #333
+	}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #333
+	}
+
+.pun .multiselect, .pun .checklist {
+	color: #333;
+	}
+
+.pun .checklist {
+	border-color: #ACA899;
+	}
+
+/* posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #dedfdf
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #f1f1f1
+	}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #f1f1f1
+	}
+
+#punhelp .codebox, #punhelp .quotebox {
+	background-color: #f9f9f9;
+	}
+
+.pun .blockpost h2 {
+	background-color: #7ea34b
+	}
+
+.pun .blockpost h2 span.conr {
+	color: #b7d094
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+	}
+
+.pun hr {
+	background-color: #333;
+	color: #333
+	}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-color: #6c8a3f
+	}
+
+.pun td, #brdfooter #modcontrols {
+	border-color: #cedeb9
+	}
+
+.pun th {
+	border-color: #d1d1d1
+	}
+
+.pun fieldset {
+	border-color: #aca899
+	}
+
+#adminconsole td, #adminconsole th {
+	border-color: #f1f1f1
+	}
+
+.pun .quotebox, .pun .codebox, .pun .forminfo,
+.pun .blockpost label, .pun .deletemsg {
+	border-color: #aca899 #fff #fff #aca899
+	}
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #638137
+	}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #8eb653
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-color: #638137;
+	}
+
+.pun .postmsg .postimg a:hover img, .pun .postmsg .postimg a:active img, .pun .postmsg .postimg a:focus img {
+	border-color: #8eb653;
+	}
+
+.pun h2 a:link, .pun h2 a:visited,
+#brdmenu a:link, #brdmenu a:visited {
+	color: #fff
+	}
+
+.pun h2 a:hover, .pun h2 a:active,
+#brdmenu a:hover, #brdmenu a:active {
+	color: #fff
+	}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+	}
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+	}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #b42000
+	}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #b42000
+	}
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	border-color: #e6e6e6 #dedede #dadada #e2e2e2
+	}
+
+.pun .iredirect .icon {
+	border-color: #f1f1f1 #f1f1f1 #f1f1f1 #f1f1f1
+	}
+
+.pun .inew .icon {
+	border-color: #8bb453 #7a9e48 #709142 #799c47
+	}
diff --git a/style/Mercury.css b/style/Mercury.css
new file mode 100644
index 00000000..51cf48d8
--- /dev/null
+++ b/style/Mercury.css
@@ -0,0 +1,1150 @@
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+	}
+
+.pun ul, .pun ol {
+	list-style: none
+	}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+	}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+	}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+	}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+	}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+	}
+
+.clearl {
+	clear: left;
+	}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3, span.closedtext,
+.pun .required strong span {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+	}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 68.75%/1.4545em Verdana, Helvetica, Arial, sans-serif;
+	line-height: normal;
+	}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: verdana, helvetica, arial, sans-serif;
+	}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+	}
+
+.pun pre code {
+	font-size: 1em;
+	}
+
+.pun strong {
+	font-weight: bold;
+	}
+
+.pun em {
+	font-style: italic;
+	}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+	}
+
+.pun h2 {
+	font-size: 1em;
+	font-weight: normal;
+	padding: 4px 6px;
+	}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+	}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+	}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+	}
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.75em 0
+	}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+	}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+	}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+	}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+	}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+	}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+	}
+
+.pun span.bbu {
+	text-decoration: underline
+	}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+	}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+	}
+
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+html, body {
+	margin: 0;
+	padding: 0
+	}
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+	}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%
+	}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+	}
+
+#brdtitle p {
+	padding-top: 0px
+	}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+	}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+	}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+	}
+
+#postreview .blockpost {
+	margin-bottom: -1px;
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+	}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+	}
+
+.pun .postlinksb {
+	margin-top: -6px
+	}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+	}
+
+#brdheader .box {
+	border-top-width: 4px;
+	}
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+	}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 3px 0 0 0;
+	}
+
+#brdmenu li {
+	display: inline;
+	margin-right: 12px;
+	}
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none
+	}
+
+#brdmenu a:hover, #brdmenu a:active {
+	text-decoration: underline
+	}
+
+#brdwelcome .conl {
+	float: left;
+	}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+	}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+	}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+	}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+	}
+
+.pun .pagelink {
+	float: left;
+	white-space: nowrap;
+	}
+
+.pun .postlink {
+	font-weight: bold;
+	white-space: nowrap;
+	}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+	}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+	}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+	}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	text-decoration: none
+	}
+
+.pun .postlink a:hover, .pun .postlink a:active {
+	text-decoration: underline;
+	}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+	}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter .conl {
+	float: left;
+	}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+	}
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+	}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin:0 6px;
+	}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+	}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+	}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+	}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+	}
+
+.pun .blocktable table {
+	table-layout: fixed;
+	}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	text-align: left;
+	font-weight: normal;
+	}
+
+.pun td, .pun th {
+	border-style: solid none none solid;
+	border-width: 1px;
+	}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+	}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+	}
+
+.pun .tcr {
+	width: 30%;
+	}
+
+.pun .tcl h3 {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .tcl h3 span.newtext {
+	font-size: 0.917em;
+	}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap;
+	font-weight: normal;
+	}
+
+.pun td span.byuser {
+	white-space: nowrap;
+	}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+	}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#users1 .tcr {
+	width: 25%
+	}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#debug .tcl {
+	width: 10%
+	}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+	}
+
+#punindex .tcr .byuser {
+	display: block
+	}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+	}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .icon {
+	margin: 0.1em 0 0 0.2em;
+	border-width: 0.6em;
+	border-style: solid;
+	height: 0;
+	width: 0;
+	overflow: hidden;
+	float: left;
+	}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+	}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+	}
+
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+.pun .blockform form, .pun .fakeform {
+	PADDING: 20px 20px 15px 20px
+	}
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+	}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+	}
+
+.pun .inform {
+	padding-bottom: 12px
+	}
+
+.pun fieldset {
+	padding: 0px 12px 0px 12px;
+	border-style: solid;
+	border-width: 1px
+	}
+
+.pun legend {
+	padding: 0px 6px
+	}
+
+.pun .infldset {
+	padding: 9px 0px 12px 0
+	}
+
+.pun label {
+	display: block;
+	padding: 3px 0
+	}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+	}
+
+.pun fieldset .rbox br {
+	display: none;
+	}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun .txtarea {
+	width: 75%
+	}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+	}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+	}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+	}
+
+.pun .blockform .buttons {
+	padding-left: 12px;
+	}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+	}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+	}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+	}
+
+.pun p.actions span {
+	margin-right: 12px;
+	}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+	}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.3em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+	}
+
+.pun .checklist fieldset {
+	border: 0;
+	padding: 0;
+	}
+
+.pun .checklist legend {
+	padding: 0;
+	}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+	}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+	}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+	}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+	}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+	}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+	}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+	}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+	}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+	}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+	}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+	}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+	}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+	}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+	}
+
+.pun .blockpost .box {
+	overflow: hidden;
+	}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	position: relative;
+	overflow: hidden;
+	}
+
+.pun .postleft dl {
+	padding: 6px;
+	}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+	}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+	}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+	}
+
+#postpreview .postright {
+	border-left: 0
+	}
+
+.pun .postright {
+	padding: 0 6px;
+	}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+	}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+	}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 10px 6px 5px 6px;
+	}
+
+.pun .postfootright li {
+	display: inline;
+	}
+
+.pun .postfootright li:before {
+	content: " | ";
+	}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+	}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+	}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+	}
+
+.pun .codebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0;
+	}
+
+.pun .quotebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+	}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+	}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+	}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+	}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+	}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+	}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+	}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+	}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+	}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+	}
+
+.pun .postmsg .postimg img {
+	max-width: 98%;
+	vertical-align: middle;
+	margin: 7px 0.5em 7px 0;
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-style: solid;
+	border-width: 2px;
+	}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+	}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+	}
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+	}
+
+#punhelp div.box {
+	padding: 10px
+	}
+
+#debugtime {
+	margin-top: -12px;
+	text-align: center;
+	}
+
+#brdwelcome, #brdfooter dl a, div.blockmenu li, div.rbox input {
+	line-height: 1.4em
+	}
+
+#announce div.inbox div {
+	padding: 3px 0
+	}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #2a2a2a;
+	color: #d4d4d4
+	}
+
+.pun {
+	color: #d4d4d4
+	}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #383838
+	}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#brdfooter #modcontrols, #adminconsole fieldset td, .pun .blockmenu .box, #adstats dd {
+	background-color: #424242
+	}
+
+.pun h2, #brdmenu {
+	background-color: #565656;
+	color: #d4d4d4
+	}
+
+.pun th {
+	background-color: #484848
+	}
+
+.pun legend {
+	color: #f6b620
+	}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #d4d4d4
+	}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #d4d4d4
+	}
+
+.pun textarea, .pun input, .pun select {
+	background-color: #2a2a2a;
+	color: #d4d4d4
+	}
+
+.pun .multiselect, .pun .checklist {
+	color: #D4D4D4;
+	}
+
+.pun .checklist {
+	border-color: #666;
+	}
+
+/* Posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #383838
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #424242
+	}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #424242
+	}
+
+.pun .blockpost h2 {
+	background-color: #565656
+	}
+
+.pun .blockpost h2 span.conr {
+	color: #a19e96
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+	}
+
+.pun hr {
+	background-color: #606060;
+	color: #606060
+	}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-color:#565656
+	}
+
+.pun td, #brdfooter #modcontrols {
+	border-color: #565656
+	}
+
+.pun th {
+	border-color: #484848
+	}
+
+.pun fieldset {
+	border-color: #565656
+	}
+
+#adminconsole td, #adminconsole th {
+	border-color: #383838
+	}
+
+.pun .quotebox, .pun .codebox, .pun .forminfo,
+.pun .blockpost label, .pun .deletemsg {
+	border-color: #565656
+	}
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #f6b620
+	}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #ffee40
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-color: #f6b620;
+	}
+
+.pun .postmsg .postimg a:hover img, .pun .postmsg .postimg a:active img, .pun .postmsg .postimg a:focus img {
+	border-color: #ffee40;
+	}
+
+.pun h2 a:link, .pun h2 a:visited,
+#brdmenu a:link, #brdmenu a:visited {
+	color: #d4d4d4
+	}
+
+.pun h2 a:hover, .pun h2 a:active,
+#brdmenu a:hover, #brdmenu a:active {
+	color: #d4d4d4
+	}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+	}
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+	}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #ff4000
+	}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #ff5010
+	}
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	border-color: #484848 #404040 #3c3c3c #444444
+	}
+
+.pun .iredirect .icon {
+	border-color: #383838 #383838 #383838 #383838
+	}
+
+.pun .inew .icon {
+	border-color: #f6b620 #ecae1f #d09a1b #e1a61d
+	}
diff --git a/style/Oxygen.css b/style/Oxygen.css
new file mode 100644
index 00000000..ac3d321c
--- /dev/null
+++ b/style/Oxygen.css
@@ -0,0 +1,1150 @@
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+	}
+
+.pun ul, .pun ol {
+	list-style: none
+	}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+	}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+	}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+	}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+	}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+	}
+
+.clearl {
+	clear: left;
+	}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3, span.closedtext,
+.pun .required strong span {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+	}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 68.75%/1.4545em Verdana, Helvetica, Arial, sans-serif;
+	line-height: normal;
+	}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun small, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: verdana, helvetica, arial, sans-serif;
+	}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+	}
+
+.pun pre code {
+	font-size: 1em;
+	}
+
+.pun strong {
+	font-weight: bold;
+	}
+
+.pun em {
+	font-style: italic;
+	}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+	}
+
+.pun h2 {
+	font-size: 1em;
+	font-weight: normal;
+	padding: 4px 6px;
+	}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+	}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+	}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+	}
+
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.75em 0
+	}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+	}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+	}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+	}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+	}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+	}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+	}
+
+.pun span.bbu {
+	text-decoration: underline
+	}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+	}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+	}
+
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+html, body {
+	margin: 0;
+	padding: 0
+	}
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+	}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%
+	}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+	}
+
+#brdtitle p {
+	padding-top: 0px
+	}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+	}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+	}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+	}
+
+#postreview .blockpost {
+	margin-bottom: -1px;
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+	}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+	}
+
+.pun .postlinksb {
+	margin-top: -6px
+	}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+	}
+
+#brdheader .box {
+	border-top-width: 4px;
+	}
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+	}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 3px 0 0 0;
+	}
+
+#brdmenu li {
+	display: inline;
+	margin-right: 12px;
+	}
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none
+	}
+
+#brdmenu a:hover, #brdmenu a:active {
+	text-decoration: underline
+	}
+
+#brdwelcome .conl {
+	float: left;
+	}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+	}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+	}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+	}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+	}
+
+.pun .pagelink {
+	float: left;
+	white-space: nowrap;
+	}
+
+.pun .postlink {
+	font-weight: bold;
+	white-space: nowrap;
+	}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+	}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+	}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+	}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	text-decoration: none
+	}
+
+.pun .postlink a:hover, .pun .postlink a:active {
+	text-decoration: underline;
+	}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+	}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter .conl {
+	float: left;
+	}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+	}
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+	}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin:0 6px;
+	}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+	}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+	}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+	}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+	}
+
+.pun .blocktable table {
+	table-layout: fixed;
+	}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	text-align: left;
+	font-weight: normal;
+	}
+
+.pun td, .pun th {
+	border-style: solid none none solid;
+	border-width: 1px;
+	}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+	}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+	}
+
+.pun .tcr {
+	width: 30%;
+	}
+
+.pun .tcl h3 {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .tcl h3 span.newtext {
+	font-size: 0.917em;
+	}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap;
+	font-weight: normal;
+	}
+
+.pun td span.byuser {
+	white-space: nowrap;
+	}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+	}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#users1 .tcr {
+	width: 25%
+	}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#debug .tcl {
+	width: 10%
+	}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+	}
+
+#punindex .tcr .byuser {
+	display: block
+	}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+	}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .icon {
+	margin: 0.1em 0 0 0.2em;
+	border-width: 0.6em;
+	border-style: solid;
+	height: 0;
+	width: 0;
+	overflow: hidden;
+	float: left;
+	}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+	}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+	}
+
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+.pun .blockform form, .pun .fakeform {
+	PADDING: 20px 20px 15px 20px
+	}
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+	}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+	}
+
+.pun .inform {
+	padding-bottom: 12px
+	}
+
+.pun fieldset {
+	padding: 0px 12px 0px 12px;
+	border-style: solid;
+	border-width: 1px
+	}
+
+.pun legend {
+	padding: 0px 6px
+	}
+
+.pun .infldset {
+	padding: 9px 0px 12px 0
+	}
+
+.pun label {
+	display: block;
+	padding: 3px 0
+	}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+	}
+
+.pun fieldset .rbox br {
+	display: none;
+	}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun .txtarea {
+	width: 75%
+	}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+	}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+	}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+	}
+
+.pun .blockform .buttons {
+	padding-left: 12px;
+	}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+	}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+	}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+	}
+
+.pun p.actions span {
+	margin-right: 12px;
+	}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+	}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.3em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+	}
+
+.pun .checklist fieldset {
+	border: 0;
+	padding: 0;
+	}
+
+.pun .checklist legend {
+	padding: 0;
+	}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+	}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+	}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+	}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+	}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+	}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+	}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+	}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+	}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+	}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+	}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+	}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+	}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+	}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+	}
+
+.pun .blockpost .box {
+	overflow: hidden;
+	}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	position: relative;
+	overflow: hidden;
+	}
+
+.pun .postleft dl {
+	padding: 6px;
+	}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+	}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+	}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+	}
+
+#postpreview .postright {
+	border-left: 0
+	}
+
+.pun .postright {
+	padding: 0 6px;
+	}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+	}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+	}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 10px 6px 5px 6px;
+	}
+
+.pun .postfootright li {
+	display: inline;
+	}
+
+.pun .postfootright li:before {
+	content: " | ";
+	}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+	}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+	}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+	}
+
+.pun .codebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0;
+	}
+
+.pun .quotebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+	}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+	}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+	}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+	}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+	}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+	}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+	}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+	}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+	}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+	}
+
+.pun .postmsg .postimg img {
+	max-width: 98%;
+	vertical-align: middle;
+	margin: 7px 0.5em 7px 0;
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-style: solid;
+	border-width: 2px;
+	}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+	}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+	}
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+	}
+
+#punhelp div.box {
+	padding: 10px
+	}
+
+#debugtime {
+	margin-top: -12px;
+	text-align: center;
+	}
+
+#brdwelcome, #brdfooter dl a, div.blockmenu li, div.rbox input {
+	line-height: 1.4em
+	}
+
+#announce div.inbox div {
+	padding: 3px 0
+	}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #fff;
+	color: #333
+	}
+
+.pun {
+	color: #333
+	}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #f1f1f1
+	}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#adminconsole fieldset td, .pun .blockmenu .box, #adstats dd, #brdfooter #modcontrols {
+	background-color: #dedfdf
+	}
+
+.pun h2, #brdmenu {
+	background-color: #0066b9;
+	color: #fff
+	}
+
+.pun th {
+	background-color: #d1d1d1
+	}
+
+.pun legend {
+	color: #005cb1
+	}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #333
+	}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #333
+	}
+
+.pun .multiselect, .pun .checklist {
+	color: #333;
+	}
+
+.pun .checklist {
+	border-color: #ACA899;
+	}
+
+/* Posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #dedfdf
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #f1f1f1
+	}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #f1f1f1
+	}
+
+#punhelp .codebox, #punhelp .quotebox {
+	background-color: #f9f9f9;
+	}
+
+.pun .blockpost h2 {
+	background-color: #006fc9
+	}
+
+.pun .blockpost h2 span.conr {
+	color: #aabdcd
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+	}
+
+.pun hr {
+	background-color: #333;
+	color: #333
+	}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-color: #0066b9
+	}
+
+.pun td, #brdfooter #modcontrols {
+	border-color: #bbcede
+	}
+
+.pun th {
+	border-color: #d1d1d1
+	}
+
+.pun fieldset {
+	border-color: #aca899
+	}
+
+#adminconsole td, #adminconsole th {
+	border-color: #f1f1f1
+	}
+
+.pun .quotebox, .pun .codebox, .pun .forminfo,
+.pun .blockpost label, .pun .deletemsg {
+	border-color: #aca899 #fff #fff #aca899
+	}
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #005cb1
+	}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #b42000
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-color: #005cb1;
+	}
+
+.pun .postmsg .postimg a:hover img, .pun .postmsg .postimg a:active img, .pun .postmsg .postimg a:focus img {
+	border-color: #b42000;
+	}
+
+.pun h2 a:link, .pun h2 a:visited,
+#brdmenu a:link, #brdmenu a:visited {
+	color: #fff
+	}
+
+.pun h2 a:hover, .pun h2 a:active,
+#brdmenu a:hover, #brdmenu a:active {
+	color: #fff
+	}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+	}
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+	}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #b42000
+	}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #b42000
+	}
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	border-color: #e6e6e6 #dedede #dadada #e2e2e2
+	}
+
+.pun .iredirect .icon {
+	border-color: #f1f1f1 #f1f1f1 #f1f1f1 #f1f1f1
+	}
+
+.pun .inew .icon {
+	border-color: #0080d7 #0065c0 #0058b3 #0072ca
+	}
diff --git a/style/Radium.css b/style/Radium.css
new file mode 100644
index 00000000..c572dbb8
--- /dev/null
+++ b/style/Radium.css
@@ -0,0 +1,1150 @@
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+	}
+
+.pun ul, .pun ol {
+	list-style: none
+	}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+	}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+	}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+	}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+	}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+	}
+
+.clearl {
+	clear: left;
+	}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3, span.closedtext,
+.pun .required strong span {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+	}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 68.75%/1.4545em Verdana, Helvetica, Arial, sans-serif;
+	line-height: normal;
+	}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: verdana, helvetica, arial, sans-serif;
+	}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+	}
+
+.pun pre code {
+	font-size: 1em;
+	}
+
+.pun strong {
+	font-weight: bold;
+	}
+
+.pun em {
+	font-style: italic;
+	}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+	}
+
+.pun h2 {
+	font-size: 1em;
+	font-weight: normal;
+	padding: 4px 6px;
+	}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+	}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+	}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+	}
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.75em 0
+	}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+	}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+	}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+	}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+	}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+	}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+	}
+
+.pun span.bbu {
+	text-decoration: underline
+	}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+	}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+	}
+
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+html, body {
+	margin: 0;
+	padding: 0
+	}
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+	}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%
+	}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+	}
+
+#brdtitle p {
+	padding-top: 0px
+	}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+	}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+	}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+	}
+
+#postreview .blockpost {
+	margin-bottom: -1px;
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+	}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+	}
+
+.pun .postlinksb {
+	margin-top: -6px
+	}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+	}
+
+#brdheader .box {
+	border-top-width: 4px;
+	}
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+	}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 3px 0 0 0;
+	}
+
+#brdmenu li {
+	display: inline;
+	margin-right: 12px;
+	}
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none
+	}
+
+#brdmenu a:hover, #brdmenu a:active {
+	text-decoration: underline
+	}
+
+#brdwelcome .conl {
+	float: left;
+	}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+	}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+	}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+	}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+	}
+
+.pun .pagelink {
+	float: left;
+	white-space: nowrap;
+	}
+
+.pun .postlink {
+	font-weight: bold;
+	white-space: nowrap;
+	}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+	}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+	}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+	}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	text-decoration: none
+	}
+
+.pun .postlink a:hover, .pun .postlink a:active {
+	text-decoration: underline;
+	}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+	}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter .conl {
+	float: left;
+	}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+	}
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+	}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin:0 6px;
+	}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+	}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+	}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+	}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+	}
+
+.pun .blocktable table {
+	table-layout: fixed;
+	}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	text-align: left;
+	font-weight: normal;
+	}
+
+.pun td, .pun th {
+	border-style: solid none none solid;
+	border-width: 1px;
+	}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+	}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+	}
+
+.pun .tcr {
+	width: 30%;
+	}
+
+.pun .tcl h3 {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .tcl h3 span.newtext {
+	font-size: 0.917em;
+	}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap;
+	font-weight: normal;
+	}
+
+.pun td span.byuser {
+	white-space: nowrap;
+	}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+	}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#users1 .tcr {
+	width: 25%
+	}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#debug .tcl {
+	width: 10%
+	}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+	}
+
+#punindex .tcr .byuser {
+	display: block
+	}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+	}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .icon {
+	margin: 0.1em 0 0 0.2em;
+	border-width: 0.6em;
+	border-style: solid;
+	height: 0;
+	width: 0;
+	overflow: hidden;
+	float: left;
+	}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+	}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+	}
+
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+.pun .blockform form, .pun .fakeform {
+	PADDING: 20px 20px 15px 20px
+	}
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+	}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+	}
+
+.pun .inform {
+	padding-bottom: 12px
+	}
+
+.pun fieldset {
+	padding: 0px 12px 0px 12px;
+	border-style: solid;
+	border-width: 1px
+	}
+
+.pun legend {
+	padding: 0px 6px
+	}
+
+.pun .infldset {
+	padding: 9px 0px 12px 0
+	}
+
+.pun label {
+	display: block;
+	padding: 3px 0
+	}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+	}
+
+.pun fieldset .rbox br {
+	display: none;
+	}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun .txtarea {
+	width: 75%
+	}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+	}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+	}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+	}
+
+.pun .blockform .buttons {
+	padding-left: 12px;
+	}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+	}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+	}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+	}
+
+.pun p.actions span {
+	margin-right: 12px;
+	}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+	}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.3em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+	}
+
+.pun .checklist fieldset {
+	border: 0;
+	padding: 0;
+	}
+
+.pun .checklist legend {
+	padding: 0;
+	}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+	}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+	}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+	}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+	}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+	}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+	}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+	}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+	}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+	}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+	}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+	}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+	}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+	}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+	}
+
+.pun .blockpost .box {
+	overflow: hidden;
+	}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	position: relative;
+	overflow: hidden;
+	}
+
+.pun .postleft dl {
+	padding: 6px;
+	}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+	}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+	}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+	}
+
+#postpreview .postright {
+	border-left: 0
+	}
+
+.pun .postright {
+	padding: 0 6px;
+	}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+	}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+	}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 10px 6px 5px 6px;
+	}
+
+.pun .postfootright li {
+	display: inline;
+	}
+
+.pun .postfootright li:before {
+	content: " | ";
+	}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+	}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+	}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+	}
+
+.pun .codebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0;
+	}
+
+.pun .quotebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+	}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+	}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+	}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+	}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+	}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+	}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+	}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+	}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+	}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+	}
+
+.pun .postmsg .postimg img {
+	max-width: 98%;
+	vertical-align: middle;
+	margin: 7px 0.5em 7px 0;
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-style: solid;
+	border-width: 2px;
+	}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+	}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+	}
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+	}
+
+#punhelp div.box {
+	padding: 10px
+	}
+
+#debugtime {
+	margin-top: -12px;
+	text-align: center;
+	}
+
+#brdwelcome, #brdfooter dl a, div.blockmenu li, div.rbox input {
+	line-height: 1.4em
+	}
+
+#announce div.inbox div {
+	padding: 3px 0
+	}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #2a2a2a;
+	color: #d4d4d4
+	}
+
+.pun {
+	color: #d4d4d4
+	}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #383838
+	}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#brdfooter #modcontrols, #adminconsole fieldset td, .pun .blockmenu .box, #adstats dd {
+	background-color: #424242
+	}
+
+.pun h2, #brdmenu {
+	background-color: #565656;
+	color: #d4d4d4
+	}
+
+.pun th {
+	background-color: #484848
+	}
+
+.pun legend {
+	color: #60c860
+	}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #d4d4d4
+	}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #d4d4d4
+	}
+
+.pun textarea, .pun input, .pun select {
+	background-color: #2a2a2a;
+	color: #d4d4d4
+	}
+
+.pun .multiselect, .pun .checklist {
+	color: #D4D4D4;
+	}
+
+.pun .checklist {
+	border-color: #666;
+	}
+
+/* Posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #383838
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #424242
+	}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #424242
+	}
+
+.pun .blockpost h2 {
+	background-color: #565656
+	}
+
+.pun .blockpost h2 span.conr {
+	color: #a19e96
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+	}
+
+.pun hr {
+	background-color: #606060;
+	color: #606060
+	}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-color:#565656
+	}
+
+.pun td, #brdfooter #modcontrols {
+	border-color: #565656
+	}
+
+.pun th {
+	border-color: #484848
+	}
+
+.pun fieldset {
+	border-color: #606060
+	}
+
+#adminconsole td, #adminconsole th {
+	border-color: #383838
+	}
+
+.pun .quotebox, .pun .codebox, .pun .forminfo,
+.pun .blockpost label, .pun .deletemsg {
+	border-color: #606060
+	}
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #60c860
+	}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #80ee80
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-color: #60c860;
+	}
+
+.pun .postmsg .postimg a:hover img, .pun .postmsg .postimg a:active img, .pun .postmsg .postimg a:focus img {
+	border-color: #80ee80;
+	}
+
+.pun h2 a:link, .pun h2 a:visited,
+#brdmenu a:link, #brdmenu a:visited {
+	color: #d4d4d4
+	}
+
+.pun h2 a:hover, .pun h2 a:active,
+#brdmenu a:hover, #brdmenu a:active {
+	color: #d4d4d4
+	}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+	}
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+	}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #ff4000
+	}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #ff5010
+	}
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	border-color: #484848 #404040 #3c3c3c #444444
+	}
+
+.pun .iredirect .icon {
+	border-color: #383838 #383838 #383838 #383838
+	}
+
+.pun .inew .icon {
+	border-color: #60c860 #54af54 #499849 #59b657
+	}
diff --git a/style/Sulfur.css b/style/Sulfur.css
new file mode 100644
index 00000000..0bf449f1
--- /dev/null
+++ b/style/Sulfur.css
@@ -0,0 +1,1149 @@
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+	}
+
+.pun ul, .pun ol {
+	list-style: none
+	}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+	}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+	}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+	}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+	}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+	}
+
+.clearl {
+	clear: left;
+	}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3, span.closedtext,
+.pun .required strong span {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+	}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 68.75%/1.4545em Verdana, Helvetica, Arial, sans-serif;
+	line-height: normal;
+	}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: verdana, helvetica, arial, sans-serif;
+	}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+	}
+
+.pun pre code {
+	font-size: 1em;
+	}
+
+.pun strong {
+	font-weight: bold;
+	}
+
+.pun em {
+	font-style: italic;
+	}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+	}
+
+.pun h2 {
+	font-size: 1em;
+	font-weight: normal;
+	padding: 4px 6px;
+	}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+	}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+	}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+	}
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.75em 0
+	}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+	}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+	}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+	}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+	}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+	}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+	}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+	}
+
+.pun span.bbu {
+	text-decoration: underline
+	}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+	}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+	}
+
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+html, body {
+	margin: 0;
+	padding: 0
+	}
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+	}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%
+	}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+	}
+
+#brdtitle p {
+	padding-top: 0px
+	}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+	}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+	}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+	}
+
+#postreview .blockpost {
+	margin-bottom: -1px;
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+	}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+	}
+
+.pun .postlinksb {
+	margin-top: -6px
+	}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+	}
+
+#brdheader .box {
+	border-top-width: 4px;
+	}
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+	}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 3px 0 0 0;
+	}
+
+#brdmenu li {
+	display: inline;
+	margin-right: 12px;
+	}
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none
+	}
+
+#brdmenu a:hover, #brdmenu a:active {
+	text-decoration: underline
+	}
+
+#brdwelcome .conl {
+	float: left;
+	}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+	}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+	}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+	}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+	}
+
+.pun .pagelink {
+	float: left;
+	white-space: nowrap;
+	}
+
+.pun .postlink {
+	font-weight: bold;
+	white-space: nowrap;
+	}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+	}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+	}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+	}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	text-decoration: none
+	}
+
+.pun .postlink a:hover, .pun .postlink a:active {
+	text-decoration: underline;
+	}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+	}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter .conl {
+	float: left;
+	}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+	}
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+	}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin:0 6px;
+	}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+	}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+	}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+	}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+	}
+
+.pun .blocktable table {
+	table-layout: fixed;
+	}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	text-align: left;
+	font-weight: normal;
+	}
+
+.pun td, .pun th {
+	border-style: solid none none solid;
+	border-width: 1px;
+	}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+	}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+	}
+
+.pun .tcr {
+	width: 30%;
+	}
+
+.pun .tcl h3 {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .tcl h3 span.newtext {
+	font-size: 0.917em;
+	}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap;
+	font-weight: normal;
+	}
+
+.pun td span.byuser {
+	white-space: nowrap;
+	}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+	}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#users1 .tcr {
+	width: 25%
+	}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+	}
+
+#debug .tcl {
+	width: 10%
+	}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+	}
+
+#punindex .tcr .byuser {
+	display: block
+	}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+	}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+	}
+
+.pun .icon {
+	margin: 0.1em 0 0 0.2em;
+	border-width: 0.6em;
+	border-style: solid;
+	height: 0;
+	width: 0;
+	overflow: hidden;
+	float: left;
+	}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+	}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+	}
+
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+.pun .blockform form, .pun .fakeform {
+	PADDING: 20px 20px 15px 20px
+	}
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+	}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+	}
+
+.pun .inform {
+	padding-bottom: 12px
+	}
+
+.pun fieldset {
+	padding: 0px 12px 0px 12px;
+	border-style: solid;
+	border-width: 1px
+	}
+
+.pun legend {
+	padding: 0px 6px
+	}
+
+.pun .infldset {
+	padding: 9px 0px 12px 0
+	}
+
+.pun label {
+	display: block;
+	padding: 3px 0
+	}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+	}
+
+.pun fieldset .rbox br {
+	display: none;
+	}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+	}
+
+.pun .txtarea {
+	width: 75%
+	}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+	}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+	}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+	}
+
+.pun .blockform .buttons {
+	padding-left: 12px;
+	}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+	}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+	}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+	}
+
+.pun p.actions span {
+	margin-right: 12px;
+	}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+	}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.3em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+	}
+
+.pun .checklist fieldset {
+	border: 0;
+	padding: 0;
+	}
+
+.pun .checklist legend {
+	padding: 0;
+	}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+	}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+	}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+	}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+	}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+	}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+	}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+	}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+	}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+	}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+	}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+	}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+	}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+	}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+	}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+	}
+
+.pun .blockpost .box {
+	overflow: hidden;
+	}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	position: relative;
+	overflow: hidden;
+	}
+
+.pun .postleft dl {
+	padding: 6px;
+	}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+	}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+	}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+	}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+	}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+	}
+
+#postpreview .postright {
+	border-left: 0
+	}
+
+.pun .postright {
+	padding: 0 6px;
+	}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+	}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+	}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 10px 6px 5px 6px;
+	}
+
+.pun .postfootright li {
+	display: inline;
+	}
+
+.pun .postfootright li:before {
+	content: " | ";
+	}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+	}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+	}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+	}
+
+.pun .codebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0;
+	}
+
+.pun .quotebox {
+	border-style: solid;
+	border-width: 1px;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+	}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+	}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+	}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+	}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+	}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+	}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+	}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+	}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+	}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+	}
+
+.pun .postmsg .postimg img {
+	max-width: 98%;
+	vertical-align: middle;
+	margin: 7px 0.5em 7px 0;
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-style: solid;
+	border-width: 2px;
+	}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+	}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+	}
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+	}
+
+#punhelp div.box {
+	padding: 10px
+	}
+
+#debugtime {
+	margin-top: -12px;
+	text-align: center;
+	}
+
+#brdwelcome, #brdfooter dl a, div.blockmenu li, div.rbox input {
+	line-height: 1.4em
+	}
+
+#announce div.inbox div {
+	padding: 3px 0
+	}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #fff;
+	color: #333
+	}
+
+.pun {
+	color: #333
+	}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #f1f1f1
+	}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#brdfooter #modcontrols, #adminconsole fieldset td, .pun .blockmenu .box, #adstats dd {
+	background-color: #dedfdf
+	}
+
+.pun h2, #brdmenu {
+	background-color: #b84623;
+	color: #fff
+	}
+
+.pun th {
+	background-color: #d1d1d1
+	}
+
+.pun legend {
+	color: #822100
+	}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #333
+	}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #333
+	}
+
+.pun .multiselect, .pun .checklist {
+	color: #333;
+	}
+
+.pun .checklist {
+	border-color: #ACA899;
+	}
+
+/* Posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #dedfdf
+	}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #f1f1f1
+	}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #f1f1f1
+	}
+
+#punhelp .codebox, #punhelp .quotebox {
+	background-color: #f9f9f9;
+	}
+
+.pun .blockpost h2 {
+	background-color: #d25028
+	}
+
+.pun .blockpost h2 span.conr {
+	color: #fccfc1
+	}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+	}
+
+.pun hr {
+	background-color: #333;
+	color: #333
+	}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-color: #b84623
+	}
+
+.pun td, #brdfooter #modcontrols {
+	border-color: #e1c3c3
+	}
+
+.pun th {
+	border-color: #d1d1d1
+	}
+
+.pun fieldset {
+	border-color: #aca899
+	}
+
+#adminconsole td, #adminconsole th {
+	border-color: #f1f1f1
+	}
+
+.pun .quotebox, .pun .codebox, .pun .forminfo,
+.pun .blockpost label, .pun .deletemsg {
+	border-color: #aca899 #fff #fff #aca899
+	}
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #822100
+	}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #ca3300
+	}
+
+.pun .postmsg .postimg a:link img, .pun .postmsg .postimg a:visited img {
+	border-color: #822100;
+	}
+
+.pun .postmsg .postimg a:hover img, .pun .postmsg .postimg a:active img, .pun .postmsg .postimg a:focus img {
+	border-color: #ca3300;
+	}
+
+.pun h2 a:link, .pun h2 a:visited,
+#brdmenu a:link, #brdmenu a:visited {
+	color: #fff
+	}
+
+.pun h2 a:hover, .pun h2 a:active,
+#brdmenu a:hover, #brdmenu a:active {
+	color: #fff
+	}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+	}
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+	}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #b42000
+	}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #b42000
+	}
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	border-color: #e6e6e6 #dedede #dadada #e2e2e2
+	}
+
+.pun .iredirect .icon {
+	border-color: #f1f1f1 #f1f1f1 #f1f1f1 #f1f1f1
+	}
+
+.pun .inew .icon {
+	border-color: #c23000 #af2c00 #992600 #ac2b00
+	}
diff --git a/style/Technetium.css b/style/Technetium.css
new file mode 100644
index 00000000..aa87399f
--- /dev/null
+++ b/style/Technetium.css
@@ -0,0 +1,1373 @@
+/*****************************************************************
+Technitium theme CSS
+*****************************************************************/
+
+/*****************************************************************
+1. INITIAL SETTINGS
+*****************************************************************/
+
+/* Limited Reset
+----------------------------------------------------------------*/
+
+.pun table, .pun div, .pun form, .pun p, .pun h1, .pun h2, .pun h3,
+.pun h4, .pun h5, .pun pre, .pun blockquote, .pun ul, .pun ol, .pun li, .pun dl,
+.pun dt, .pun dd, .pun th, .pun td, .pun fieldset, .pun img, .pun abbr, .pun cite {
+	margin: 0;
+	padding: 0;
+	border: 0;
+}
+
+.pun ul, .pun ol {
+	list-style: none
+}
+
+
+/* Structural Settings
+----------------------------------------------------------------*/
+
+body {
+	line-height: 1.9em;
+}
+
+.pun {
+	width: 95%;
+	margin: 0 auto;
+}
+
+.pun .clearer, .pun .nosize {
+	height: 0;
+	width: 0;
+	line-height: 0;
+	font-size: 0;
+	overflow: hidden
+}
+
+.pun .clearer, .pun .clearb {
+	clear: both
+}
+
+.pun .nosize {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	width: 0;
+}
+
+* html .inbox, * html .inform, * html .pun, * html .tclcon, * html .codebox {
+	height: 1px
+}
+
+.pun, .pun .inbox, .pun .inform, .pun .tclcon, .pun .codebox {
+	min-height: 1px
+}
+
+.clearl {
+	clear: left;
+}
+
+/* Hidden Elements
+----------------------------------------------------------------*/
+
+#brdfooter h2, #brdstats h2, #brdstats .conl dt, #brdstats .conr dt,
+#modcontrols dt, #searchlinks dt, div.postright h3 {
+	position: absolute;
+	display: block;
+	overflow: hidden;
+	width: 0;
+	left: -9999em;
+	text-indent: -9999em;
+}
+
+/*****************************************************************
+2. TEXT & CONTENT
+*****************************************************************/
+
+/* Text Defaults
+----------------------------------------------------------------*/
+
+.pun {
+	font: 10pt Georgia, Times, "Times New Roman", serif
+}
+
+.pun table, .pun td, .pun th, .pun input, .pun select, .pun optgroup, .pun textarea, .pun samp, .pun legend {
+	font-size: 1em;
+	font-family: Georgia, Times, "Times New Roman", serif;
+}
+
+.pun pre, .pun code {
+	font-size: 1.182em;
+	font-family: consolas, monaco, "bitstream vera sans mono", "courier new", courier, monospace
+}
+
+.pun pre code {
+	font-size: 1em;
+}
+
+.pun strong {
+	font-weight: bold;
+}
+
+.pun em {
+	font-style: italic;
+}
+
+#vf td {
+	font-size: 1.1em;
+}
+
+
+/* Content Defaults
+----------------------------------------------------------------*/
+
+.pun p, .pun ul, .pun ol, .pun dl {
+	font-size: 1em;
+	padding: 3px 0;
+}
+
+.pun h2 {
+	font-size: 1.5em;
+	font-weight: normal;
+	padding: 4px 6px;
+	padding: 6px;
+	border-radius: 0.3em 0.3em 0 0;
+}
+
+.pun h2 #brdmenu {
+	font-size: 1.1em;
+}
+
+.pun .blockpost h2 {
+	font-size: 1.0em;
+	padding: 8px;
+}
+
+.pun h3 {
+	font-size: 1.091em;
+	padding: 3px 0;
+}
+
+.pun table p, .pun table h3 {
+	padding: 0;
+}
+
+.pun span.warntext, .pun p.warntext {
+	font-weight: bold
+}
+
+.pun .postleft dl dt {
+	font-size: 1.4em;
+}
+
+/* User Content (Announcements, Rules, Posts)
+----------------------------------------------------------------*/
+
+.pun .usercontent p, .pun .postmsg p {
+	padding: 0.5em 0;
+	line-height: 1.6em;
+}
+
+.pun .usercontent ul, .pun .postmsg ul {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: disc
+}
+
+.pun .usercontent ol, .pun .postmsg ol {
+	padding: 0.75em 1em 0.75em 2.5em;
+	list-style: decimal
+}
+
+.pun .usercontent ol.alpha, .pun .postmsg ol.alpha {
+	list-style: lower-alpha
+}
+
+.pun .usercontent li ol, .pun .usercontent li ul, .pun .postmsg li ol, .pun .postmsg li ul {
+	padding: 0.25em 1em 0.75em 2.5em
+}
+
+.pun .usercontent li p, .pun .postmsg li p {
+	padding: 0
+}
+
+.pun .usercontent h1 {
+	font-size: 1.4em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+}
+
+.pun .usercontent h2 {
+	font-size: 1.2em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+}
+
+.pun .usercontent h3 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+}
+
+.pun .usercontent h4, .pun .usercontent h5, .pun .usercontent h6 {
+	font-size: 1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0
+}
+
+.pun .quotebox cite {
+	font-weight: bold;
+	font-style: normal;
+	padding: 0.75em 0.75em 0 0.75em
+}
+
+.pun span.bbu {
+	text-decoration: underline
+}
+
+.pun span.bbs, .pun del {
+	text-decoration: line-through;
+}
+
+.pun .postmsg ins, #punhelp samp ins {
+	text-decoration: none;
+}
+
+.pun div.postmsg h5, #punhelp h5 {
+	font-size: 1.1em;
+	font-weight: bold;
+	padding: 0.75em 0 0 0;
+}
+
+/*****************************************************************
+3. COMMON STYLES
+*****************************************************************/
+
+/* Page Layout
+----------------------------------------------------------------*/
+
+.pun {
+	max-width: 1070px;
+	width: 95%;
+	margin: 0 auto;
+	padding: 12px 20px;
+}
+
+#punredirect, #punmaint, #puninstall, #pundb_update {
+	margin: 50px 20% 12px 20%;
+	width: auto;
+}
+
+
+/* Vertical Element Spacing
+----------------------------------------------------------------*/
+
+#brdheader {
+	margin: 0 0 12px 0;
+}
+
+#announce, #brdstats {
+	margin: 12px 0 12px 0;
+}
+
+.pun .blocktable, .pun .block, .pun .blockform, .pun .block2col, #postreview {
+	margin-bottom: 12px
+}
+
+#punindex .blocktable, .pun .blockpost {
+	margin-bottom: 6px
+}
+
+#postreview .box {
+	margin-bottom: 3px;
+}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-bottom: 0px
+}
+
+.pun .linkst, .pun .linksb {
+	margin-top: -12px
+}
+
+.pun .postlinksb {
+	margin-top: -6px
+}
+
+
+/* External Borders
+----------------------------------------------------------------*/
+
+.pun .box {
+	border-style: solid;
+	border-width: 1px;
+}
+
+
+.pun h2 {
+	border-width: 1px;
+	border-style: solid;
+	border-bottom: none;
+}
+
+
+/* Default Internal Spacing
+----------------------------------------------------------------*/
+
+.pun .block .inbox, .pun .blockmenu .inbox {
+	padding: 3px 6px
+}
+
+/*****************************************************************
+4. COMMON BOARD ELEMENTS
+*****************************************************************/
+
+/* Board Header
+----------------------------------------------------------------*/
+
+#brdtitle h1 {
+	font-size: 1.5em;
+	line-height: 1.1em;
+	padding: 3px 0 0 0;
+}
+
+#brdmenu {
+	font-size:1.2em;
+}
+
+#brddesc {
+	padding: 3px 0;
+}
+
+#brddesc * {
+	padding-top: 0;
+	padding-bottom: 0;
+}
+
+
+#brdmenu li {
+	display: inline;
+	margin-right: 10px;
+	margin-top: 12px;
+	margin-bottom: 12px;
+}
+
+
+#brdmenu a:link, #brdmenu a:visited {
+	text-decoration: none;
+	text-shadow: #FFF 1px -1px 0.4em;
+	padding: 0.2em;
+}
+
+#brdwelcome .conl {
+	float: left;
+	white-space: nowrap;
+}
+
+#brdwelcome li {
+	float:left;
+	margin-right:8px;
+	white-space:nowrap;
+}
+
+#brdwelcome .conl li strong:after {
+	content: '.'
+}
+
+#brdwelcome .conr {
+	float: right;
+	text-align: right;
+}
+
+#brdwelcome .conr li {
+	float: right;
+	text-align: right;
+}
+
+/* Breadcrumbs and Post Links
+----------------------------------------------------------------*/
+
+.pun .linkst {
+	padding: 8px 6px 3px 6px
+}
+
+.pun .linksb, .pun .postlinksb {
+	padding: 3px 6px 8px 6px
+}
+
+.pun .crumbs {
+	clear: both;
+	width: 100%;
+	overflow: hidden;
+}
+
+.pun .crumbs li {
+	display: inline;
+	white-space: nowrap;
+	font-weight: bold;
+}
+
+.pun .linkst .crumbs {
+	font-size: 1.3em;
+}
+
+.pun .pagelink {
+	float: left;
+	display: block;
+	white-space: normal;
+}
+
+.pun .postlink {
+	font-size: 1.1em;
+	font-weight: bold;
+	white-space: wrap;
+	text-decoration: none;
+}
+
+.pun .linkst .postlink {
+	position: relative;
+	margin-top: -0.2em;
+	margin-bottom: 0.5em;
+}
+
+.pun .linksb .postlink, .pun .postlinksb .postlink {
+	position: relative;
+	margin-top: 0.5em;
+	margin-bottom: -0.5em;
+}
+
+.pun .postlink, .pun .modbuttons {
+	float: right;
+	text-align: right;
+}
+
+.pun .modbuttons {
+	padding: 1px 0;
+	white-space: nowrap;
+}
+
+.pun .modbuttons input {
+	margin-left: 6px;
+}
+
+#punindex .subscribelink {
+	margin-top: 6px;
+}
+
+/* Board Footer
+----------------------------------------------------------------*/
+
+#brdfooter #modcontrols {
+	border-bottom-style: solid;
+	border-bottom-width: 1px;
+	text-align: center;
+}
+
+#brdfooter #modcontrols dd {
+	display: inline;
+	margin-right: 10px;
+}
+
+#brdfooter .conl {
+	float: left;
+}
+
+#brdfooter .conr {
+	float: right;
+	text-align: right;
+}
+
+#brdfooter #feedlinks span {
+	background:url("Technetium/feed.png") no-repeat scroll left center transparent;
+	padding-left:18px;
+	display: inline;
+}
+
+
+/* Board Stats
+----------------------------------------------------------------*/
+
+#brdstats .conl {
+	float: left;
+}
+
+#brdstats .conr {
+	float: right;
+	text-align: right;
+}
+
+#onlinelist dd, #onlinelist dt {
+	display: inline;
+}
+
+
+/*****************************************************************
+5. MAIN TABLES
+*****************************************************************/
+
+.pun table {
+	width: 100%;
+	border-collapse: collapse;
+	border-spacing: 0;
+	empty-cells: show;
+}
+
+.pun .blocktable table {
+	table-layout: fixed;
+}
+
+.pun td, .pun th {
+	padding: 4px 6px;
+	line-height: 1.4em;
+	text-align: left;
+	font-weight: normal;
+}
+
+.pun td {
+	border-style: solid none none solid;
+	border-width: 1px;
+}
+
+.pun .tcl {
+	border-left: 0;
+	width: auto;
+}
+
+.pun .tc2, .pun .tc3, .pun .tcmod {
+	width: 10%;
+	text-align: center;
+	padding: 4px 0;
+}
+
+.pun .tcr {
+	width: 30%;
+}
+
+.pun .tcl h3 {
+	font-size: 1.3em;
+	font-weight: bold;
+}
+
+.pun .tcl span.newtext, .pun .tcl span.pagestext {
+	white-space: nowrap
+}
+
+.pun .tcl p {
+	padding: 5px 0 0 0
+}
+
+#punsearch #vf .tc2 {
+	width: 18%;
+	text-align: left;
+	padding: 4px 6px;
+}
+
+#users1 .tcr {
+	width: 25%
+}
+
+#users1 .tc2 {
+	width: 25%;
+	text-align: left;
+	padding: 4px 6px;
+}
+
+#debug .tcl {
+	width: 10%
+}
+
+#debug .tcr {
+	width: 90%;
+	white-space: normal
+}
+
+#punindex .tcr .byuser {
+	display: block
+}
+
+.pun .blocktable .tclcon {
+	padding: 0 11px 0 12px;
+	overflow: hidden;
+	min-height: 1px;
+	position: relative;
+}
+
+.pun .blocktable .tclcon div {
+	width: 100%;
+	overflow: hidden;
+}
+
+.pun .icon {
+	height: 24px;
+	width: 24px;
+	overflow: hidden;
+	float: left;
+}
+
+.pun .icon div {
+	position: absolute;
+	left: -9999em;
+	text-indent: -9999em;
+	height: 0;
+}
+
+.pun .iposted .ipost {
+	position: absolute;
+	left: 0;
+	font-weight: bold;
+	width: 8px;
+	padding-left: 4px;
+	text-align: center;
+	top: 0;
+}
+
+.pun .stickytext {
+	display: none;
+}
+
+.pun .movedtext {
+	display: none;
+}
+
+.pun .closedtext {
+	font-weight: bold;
+}
+/*****************************************************************
+6. MAIN FORMS
+*****************************************************************/
+
+
+.pun .forminfo {
+	margin-bottom: 12px;
+	padding: 9px 10px;
+	border-style: solid;
+	border-width: 1px;
+}
+
+.pun .forminfo h3 {
+	font-weight: bold;
+}
+
+
+
+.pun .inform {
+	padding: 0 18px;
+}
+
+.pun fieldset {
+	overflow: hidden;
+	width: 100%;
+	padding-bottom: 0.8em;
+}
+
+.pun legend {
+	font-size: 1.2em;
+	font-weight: bold;
+	margin-left: -7px;
+	padding: 10px 19px 7px 19px;
+}
+
+.pun div[class*="inform"] legend {
+	margin-left: 0;
+}
+
+.pun .infldset {
+	border-style: solid;
+	border-width: 1px;
+	display: inline-block;
+	overflow: hidden;
+	padding: 12px 18px;
+}
+
+.pun div[class*="infldset"] {
+	display: block;
+}
+
+#punregister #rules .infldset {
+	padding: 5px 18px;
+}
+
+.pun fieldset p {
+	clear: both;
+	padding: 0 0 7px 0;
+	width: 100%;
+}
+
+.pun fieldset .usercontent p {
+	padding: 7px 0;
+}
+
+.pun fieldset label {
+	clear: both;
+	display: block;
+	padding: 0 0 7px 0;
+}
+
+
+.pun label {
+	display: block;
+	padding: 3px 0
+}
+
+.pun label.conl {
+	float: left;
+	overflow: visible;
+	margin-right: 10px
+}
+
+.pun select {
+	padding-top: 1px;
+	padding-bottom: 1px;
+}
+
+.pun fieldset .rbox {
+}
+
+.pun fieldset .rbox br {
+	display: none;
+}
+
+.pun fieldset .rbox label {
+	padding: 3px 0 3px 25px;
+	position: relative;
+	vertical-align: middle;
+}
+
+.pun fieldset .rbox input {
+	margin: 0 9px 0 -25px;
+	padding: 0;
+	width: 16px;
+	position: relative;
+	vertical-align: middle;
+}
+
+.pun .txtarea {
+	width: 90%
+}
+
+.pun .txtarea textarea, .pun input.longinput {
+	width: 100%
+}
+
+.pun .bblinks {
+	padding-bottom: 10px;
+	padding-left: 4px
+}
+
+.pun .bblinks li {
+	display: inline;
+	padding-right: 20px
+}
+
+.pun .blockform .buttons {
+	padding-left: 18px;
+	padding-bottom: 5px;
+}
+
+.pun .blockform .buttons input {
+	margin-right: 8px;
+}
+
+#posterror ul {
+	list-style: square;
+	padding: 3px 0 3px 24px;
+}
+
+.pun .deletemsg {
+	border-style: solid;
+	border-width: 1px;
+	padding: 6px 15px;
+}
+
+.pun .multiselect {
+	float: left;
+	padding-bottom: 7px;
+}
+
+.pun .checklist {
+	border-width: 1px;
+	border-style: solid;
+	max-height: 9em;
+	width: 20em;
+	overflow: auto;
+	padding: 0.25em 0.5em;
+	margin: 0.25em 16px 0 0.15em;
+}
+
+.pun .checklist legend {
+	padding: 0;
+}
+
+.pun .checklist legend span {
+	width: auto;
+	max-width: 25em;
+}
+
+/*****************************************************************
+7. PROFILES AND ADMIN
+*****************************************************************/
+
+.pun .block2col {
+	padding-bottom: 1px
+}
+
+.pun .block2col .blockform, .pun .block2col .block {
+	margin-left: 14em
+}
+
+.pun .blockmenu {
+	float:left;
+	width: 13em
+}
+
+.pun .blockmenu li {
+	padding: 3px 0;
+	font-weight: bold;
+}
+
+.pun .blockmenu a:link, .pun .blockmenu a:visited {
+	text-decoration: none
+}
+
+.pun .blockmenu a:hover, .pun .blockmenu a:active {
+	text-decoration: underline
+}
+
+#viewprofile dl {
+	float: left;
+	width: 100%;
+	overflow: hidden
+}
+
+#viewprofile dd {
+	margin-left: 14em;
+	padding: 3px;
+}
+
+#viewprofile dt {
+	float: left;
+	width: 13em;
+	margin: 3px 0;
+}
+
+#profileavatar img {
+	float: right;
+	margin-left: 1em
+}
+
+/*****************************************************************
+8. MAIN POSTS
+*****************************************************************/
+
+.pun .blockpost h2 a:link, .pun .blockpost h2 a:visited {
+	text-decoration: none;
+}
+
+.pun .blockpost h2 a:hover, .pun .blockpost h2 a:active {
+	text-decoration: underline;
+}
+
+.pun .blockpost h2 .conr {
+	float: right;
+	text-align: right;
+}
+
+#punsearch .blockpost h2 span {
+	white-space: nowrap;
+}
+
+.pun .blockpost .box {
+	overflow: hidden;
+}
+
+.pun .postleft, .pun .postfootleft {
+	float:left;
+	width: 18em;
+	overflow: hidden;
+	position: relative;
+	overflow: hidden;
+}
+
+.pun .postleft dl {
+	padding: 0.5em 6px;
+}
+
+.pun .postleft .usercontacts, .pun .postleft .icon {
+	margin-top: 6px
+}
+
+.pun .postleft .postavatar, .pun .postleft .usertitle {
+	margin-bottom: 6px;
+	display: block;
+}
+
+.pun .blockpost dt {
+	font-size: 1.091em;
+	font-weight: bold;
+}
+
+.pun .blockpost dt a:link, .pun .blockpost dt a:visited {
+	text-decoration: none;
+}
+
+.pun .blockpost dt a:hover, .pun .blockpost dt a:active {
+	text-decoration: underline;
+}
+
+.pun .postright, .pun .postfootright {
+	border-left-width: 18em;
+	border-left-style: solid
+}
+
+#postpreview .postright {
+	border-left: 0
+}
+
+.pun .postright {
+	padding: 0 6px;
+}
+
+.pun .postfootright, .pun .multidelete {
+	text-align: right
+}
+
+.pun .postmsg {
+	width:98%;
+	overflow: hidden;
+	padding-bottom: 6px;
+	word-wrap: break-word;
+}
+
+.pun .postfootright ul, .pun .postfootright div, .pun .postfootright p,
+.pun .postfootleft p {
+	padding: 6px 6px 6px 6px;
+}
+
+.pun .postfootright li {
+	display: inline;
+}
+
+.pun .postfootright li:before {
+	content: " | ";
+}
+
+.pun .postfootright li:first-child:before {
+	content: "";
+}
+
+.pun .postfootright a:link, .pun .postfootright a:visited {
+	text-decoration: none
+}
+
+.pun .postfootright a:hover, .pun .postfootright a:active {
+	text-decoration: underline
+}
+
+
+.pun .quotebox, .pun .codebox {
+	border-style: solid;
+	border-width: 2px;
+	border-left: 5px solid;
+	margin: 0.75em 1em;
+	padding: 0 0.75em;
+}
+
+.pun .quotebox cite {
+	display: block;
+	padding: 0.75em 0 0 0;
+}
+
+.pun .quotebox blockquote {
+	width: 100%;
+	overflow: hidden
+}
+
+.pun .codebox pre {
+	overflow: auto;
+	width: 100%;
+	overflow-y:hidden
+}
+
+* html .pun .codebox pre {
+	padding-bottom: 10px;
+}
+
+*+html .pun .codebox pre {
+	padding-bottom: 10px
+}
+
+.pun .codebox pre code {
+	display: block;
+	padding: 0.75em;
+}
+
+.pun .codebox pre.vscroll {
+	height: 32em;
+	overflow: auto;
+	overflow-y: auto
+}
+
+.pun .postmsg .postimg img, .pun .postmsg a .postimg img {
+	max-width: 100%;
+	vertical-align: middle;
+}
+
+.pun .postmsg img {
+	vertical-align: bottom;
+}
+
+.pun .postsignature hr {
+	margin-left: 0px;
+	width: 200px;
+	text-align: left;
+	height: 1px;
+	border:none
+}
+
+.pun .blockpost label {
+	padding: 3px 6px;
+	border-style: solid;
+	border-width: 1px;
+	vertical-align: middle;
+	display: inline-block;
+}
+
+.pun .blockpost label * {
+	vertical-align: middle;
+	margin: 0;
+	padding: 0;
+}
+
+
+/****************************************************************/
+/* 9. HELP FILES AND MISC. */
+/****************************************************************/
+
+#punhelp h2 {
+	margin-top: 12px
+}
+
+#punhelp div.box {
+	padding: 10px
+}
+
+/*****************************************************************
+COLOUR SCHEME
+*****************************************************************/
+
+/* Background / Text
+----------------------------------------------------------------*/
+
+body {
+	background: #fff url("Technetium/bg.png") repeat-x top;
+	color: #122434
+}
+
+.pun {
+	color: #122434
+}
+
+.pun .box, #adminconsole fieldset th {
+	background-color: #FBFCFD;
+	background-image: url("Technetium/light-shade.png");
+	background-position: bottom;
+	background-repeat: repeat-x;
+}
+
+.pun td.tc2, .pun td.tc3, .pun td.tcmod, #postpreview, #viewprofile dd, .pun .forminfo,
+#brdfooter #modcontrols, #adminconsole fieldset td, .pun .blockmenu .box, #adstats dd {
+	background-color: #F4F9FD;
+	background-image: url("Technetium/light-shade.png");
+	background-repeat: repeat-x;
+	background-position: bottom;
+}
+
+.pun h2, #brdmenu {
+	background-color: #C5D8EB;
+	color: #122434;
+	background-image: url("Technetium/dark-shade.png");
+	background-repeat: repeat-x;
+	background-position: top;
+}
+
+.pun h2  {
+	background-color: #C5D8EB;
+	background-image: url("Technetium/inv-shade.png");
+	background-repeat: repeat-x;
+	color: #122434;
+	text-shadow: #FFF 1px -1px 0.7em;
+}
+
+.pun #announce h2  {
+	display: none;
+}
+
+.box #announce-block {
+	background-color: #FDFCE3;
+}
+
+.pun th {
+	background-color: #EFF3F8;
+	background-image: url("Technetium/light-shade.png");
+	background-repeat: repeat-x;
+}
+
+.pun td {
+	background-image: url("Technetium/light-shade.png");
+	background-color: #FBFCFD;
+	background-position: bottom;
+	background-repeat: repeat-x;
+}
+
+.pun .isticky td {
+	background-color: #E4EBF1;
+}
+
+.pun .iclosed td {
+	background-color: #ECEEF0
+}
+
+.pun .iclosed.isticky td {
+	background-color: #CDD6E0;
+}
+
+.pun legend {
+	color: #122434
+}
+
+.pun .blockmenu li.isactive a, #posterror li strong {
+	color: #333
+}
+
+.pun .usercontent * {
+	background: transparent;
+	color: #333
+}
+
+#adminmenu .box {
+	background: #FBFCFD;
+}
+
+.pun .postlink a:link, .pun .postlink a:visited, .pun .postlink a:active  {
+	background-color:#F0F5FA;
+	background-image:url(Technetium/inv-shade.png);
+	background-repeat:repeat-x;
+	border: 1px solid;
+	color:#2B3037;
+	text-shadow: #FFF 1px -1px 0.4em;
+	padding: 0.3em;
+	border-radius: 0.4em;
+	position: relative;
+}
+
+.pun .postlink a:hover {
+	background-color: #C0D6E9;
+	color: #000;
+}
+
+#brdheader .box {
+	background-color:#F0F5FA;
+	background-image:url(Technetium/light-shade.png);
+	background-repeat:repeat-x;
+	background-position: top;
+	color:#122434;
+	border-radius: 0.4em;
+}
+
+.pun #brdtitle {
+	background-color: #D1E1EF;
+	background-image: url("Technetium/inv-shade.png");
+	background-repeat: repeat-x;
+	text-shadow: #FFF 1px -1px 0.4em;
+}
+
+
+.pun .infldset, #pundelete .deletemsg, #adintro .inbox, #adstats .inbox {
+	background: #FBFCFD url(Technetium/light-shade.png) bottom repeat-x;
+	border-color: #C0CCD8;
+}
+
+#adintro ul {
+	list-style-type: disc;
+	margin-left: 8px;
+	padding-left: 16px;
+}
+
+.pun .multiselect {
+	color: #122434;
+}
+
+.pun .checklist {
+	background: white;
+	border-color: #A2B5CC;
+}
+
+/* Posts
+----------------------------------------------------------------*/
+
+.pun .blockpost .box, .pun .postright, .pun .postfootright, .pun .deletemsg {
+	background-color: #F8FAFD;
+}
+
+.pun .postright, .pun .postfootright {
+	border-left-color: #F0F5FA
+}
+
+.pun .postleft, .pun .postfootleft, .pun .blockpost label, .pun .codebox, .pun .quotebox {
+	background-color: #F0F5FA
+}
+
+#punhelp .codebox, #punhelp .quotebox {
+	background-color: #f9f9f9;
+}
+
+.pun .blockpost h2 {
+	background-color: #F0F5FA;
+}
+
+.pun .blockpost h2 span.conr {
+	color: #aabdcd
+}
+
+.pun hr {
+	background-color: #333;
+	color: #333
+}
+
+.pun .quotebox {
+	background-color: #FAFCFE;
+}
+
+.pun .postmsg ins, #punhelp samp ins {
+	background-color: #ff0;
+}
+
+/* Borders
+----------------------------------------------------------------*/
+
+.pun .box, .pun h2, #brdfooter #modcontrols {
+	border-color: #A2B5CC;
+}
+
+.blocktable #announce h2 {
+	border-color: #F6B620;
+}
+
+.pun td {
+	border-color: #A2B5CC;
+}
+
+.pun th, .pun fieldset {
+	border-color: #A2B5CC;
+}
+
+#adminconsole td, #adminconsole th {
+	border-style:solid;
+	border-width:1px 0px !important;
+}
+
+#adminconsole th {
+	border-width: 1px 0px 1px 1px !important;
+}
+
+#adminconsole td {
+	border-width: 1px 1px 1px 1px !important;
+}
+
+.pun .forminfo, .pun .blockpost label, .pun .deletemsg {
+	border-color: #aca899 #fff #fff #aca899;
+}
+
+.pun .quotebox, .pun .codebox {
+	border-color: #BCD2E9;
+}
+
+.pun .postlink a:link, .pun .postlink a:visited {
+	border-color: #C0D6E9
+}
+
+
+/* Links
+----------------------------------------------------------------*/
+
+.pun a:link, .pun a:visited {
+	color: #1F537B;
+	text-decoration: none;
+}
+
+.pun a:hover, .pun a:active, .pun a:focus {
+	color: #9E1D00
+}
+
+#brdmenu li a:active, #brdmenu li a:link, #brdmenu li a:visited {
+	color: #1F2E3D;
+}
+
+#brdmenu li a:hover {
+	color: #000;
+	text-shadow: #8895A2 1px -1px 0.4em;
+}
+
+#vf a {
+	font-weight: bold;
+}
+
+.pun .postreport a:link, .pun .postreport a:visited,
+.pun .iclosed td.tcl a:link, .pun .iclosed td.tcl a:visited {
+	color: #888
+}
+
+.pun .isticky.iclosed td.tcl a:link, .pun .isticky.iclosed td.tcl a:visited {
+	color: #475F6B !important;
+}
+
+.pun .isticky.iclosed td.tcl a:hover {
+	color: #577382 !important;
+}
+
+
+.pun .postreport a:hover, .pun .postreport a:active,
+.pun .iclosed td.tcl a:hover, .pun .iclosed td.tcl a:active {
+	color: #aaa
+}
+
+.pun .maintenancelink a:link, .pun .maintenancelink a:visited {
+	color: #b42000
+}
+
+.pun .maintenancelink a:hover, .pun .maintenancelink a:active {
+	color: #b42000
+}
+
+
+/* Status Indicators
+----------------------------------------------------------------*/
+
+.pun .icon {
+	background-image:url(Technetium/icon-nonew.png);
+}
+
+.pun .iredirect .icon {
+	background-image:url(Technetium/icon-moved.png);
+}
+
+.pun .inew .icon{
+	background-image:url(Technetium/icon-new.png);
+}
+
+.pun .iclosed .icon  {
+	background-image:url(Technetium/icon-closed.png);
+}
+
+.pun .isticky .icon {
+	background-image:url(Technetium/icon-nonew-sticky.png);
+}
+
+.pun .isticky.inew .icon {
+	background-image:url(Technetium/icon-new-sticky.png);
+}
+
+.pun .iclosed.isticky .icon {
+	background-image:url(Technetium/icon-closed-sticky.png);
+}
+
+.pun .imoved .icon {
+	background-image:url(Technetium/icon-moved.png);
+}
\ No newline at end of file
diff --git a/style/Technetium/bg.png b/style/Technetium/bg.png
new file mode 100644
index 00000000..92611176
Binary files /dev/null and b/style/Technetium/bg.png differ
diff --git a/style/Technetium/dark-shade.png b/style/Technetium/dark-shade.png
new file mode 100644
index 00000000..0bd7ae6a
Binary files /dev/null and b/style/Technetium/dark-shade.png differ
diff --git a/style/Technetium/darker-shade.png b/style/Technetium/darker-shade.png
new file mode 100644
index 00000000..b3ca98a4
Binary files /dev/null and b/style/Technetium/darker-shade.png differ
diff --git a/style/Technetium/feed.png b/style/Technetium/feed.png
new file mode 100644
index 00000000..3704226a
Binary files /dev/null and b/style/Technetium/feed.png differ
diff --git a/style/Technetium/icon-closed-sticky.png b/style/Technetium/icon-closed-sticky.png
new file mode 100644
index 00000000..92f76a91
Binary files /dev/null and b/style/Technetium/icon-closed-sticky.png differ
diff --git a/style/Technetium/icon-closed.png b/style/Technetium/icon-closed.png
new file mode 100644
index 00000000..4d9c93e0
Binary files /dev/null and b/style/Technetium/icon-closed.png differ
diff --git a/style/Technetium/icon-moved.png b/style/Technetium/icon-moved.png
new file mode 100644
index 00000000..2484c2fb
Binary files /dev/null and b/style/Technetium/icon-moved.png differ
diff --git a/style/Technetium/icon-new-sticky.png b/style/Technetium/icon-new-sticky.png
new file mode 100644
index 00000000..e9fb5a66
Binary files /dev/null and b/style/Technetium/icon-new-sticky.png differ
diff --git a/style/Technetium/icon-new.png b/style/Technetium/icon-new.png
new file mode 100644
index 00000000..a832adb6
Binary files /dev/null and b/style/Technetium/icon-new.png differ
diff --git a/style/Technetium/icon-nonew-sticky.png b/style/Technetium/icon-nonew-sticky.png
new file mode 100644
index 00000000..f148013c
Binary files /dev/null and b/style/Technetium/icon-nonew-sticky.png differ
diff --git a/style/Technetium/icon-nonew.png b/style/Technetium/icon-nonew.png
new file mode 100644
index 00000000..547c7603
Binary files /dev/null and b/style/Technetium/icon-nonew.png differ
diff --git a/style/Technetium/index.html b/style/Technetium/index.html
new file mode 100644
index 00000000..89337b2f
--- /dev/null
+++ b/style/Technetium/index.html
@@ -0,0 +1 @@
+<html><head><title>.</title></head><body>.</body></html>
diff --git a/style/Technetium/inv-shade.png b/style/Technetium/inv-shade.png
new file mode 100644
index 00000000..eb9650b4
Binary files /dev/null and b/style/Technetium/inv-shade.png differ
diff --git a/style/Technetium/light-shade.png b/style/Technetium/light-shade.png
new file mode 100644
index 00000000..cd95460c
Binary files /dev/null and b/style/Technetium/light-shade.png differ
diff --git a/style/imports/base_admin.css b/style/imports/base_admin.css
index 0907a183..d0466905 100644
--- a/style/imports/base_admin.css
+++ b/style/imports/base_admin.css
@@ -1,6 +1,7 @@
 #adminconsole .block2 {margin-top: 12px}
 
 /*** Admin Main Content ***/
+* html #adstats dd {height: 1%}
 #adstats dd {margin-left: 14em; padding: 3px; margin-bottom: 5px; line-height: 1.5em}
 #adstats dt {float: left; width: 13em; padding: 3px; line-height: 1.5em}
 #adstats {padding: 15px 15px 5px 10px}
diff --git a/tests/functions/flux_password_needs_rehash_Test.php b/tests/functions/flux_password_needs_rehash_Test.php
deleted file mode 100644
index fd6a02f7..00000000
--- a/tests/functions/flux_password_needs_rehash_Test.php
+++ /dev/null
@@ -1,53 +0,0 @@
-<?php
-
-use PHPUnit\Framework\TestCase;
-
-require_once __DIR__.'/../../include/functions.php';
-
-class flux_password_needs_rehash_Test extends TestCase
-{
-	public function setUp()
-	{
-		$GLOBALS['password_hash_cost'] = 10;
-	}
-
-	public function testModernHashDoesNotNeedRehash()
-	{
-		// Generated by password_hash() - default algorithm, cost = 10
-		$hash = '$2y$10$2jxnmnumkXcRJKWLe7fZSeGQ7lM/Sq54hpN1Bup2CrP4iEvVlSPbe';
-
-		$this->assertFalse(
-			flux_password_needs_rehash($hash)
-		);
-	}
-
-	public function testWrappedMd5HashNeedsRehash()
-	{
-		// MD5 hash passed through password_hash()
-		$hash = '#MD5#$2y$10$r1LX7fOs7Wn7CvCgWYplleNs4Vt0qrSx3HCmE/bIpNRl6dtKL/XQO';
-
-		$this->assertTrue(
-			flux_password_needs_rehash($hash)
-		);
-	}
-
-	public function testWrappedSaltedSha1HashNeedsRehash()
-	{
-		// Salted SHA1 (salt = "pepper") passed through password_hash()
-		$hash = '#SHA1-S#pepper#$2y$10$wXrX5f8RUwX7kAPH2e1PgOQTNFHm5s/Jzt76icoFC81rX66cS7QSe';
-
-		$this->assertTrue(
-			flux_password_needs_rehash($hash)
-		);
-	}
-
-	public function testWrappedUnsaltedSha1HashNeedsRehash()
-	{
-		// SHA1 hash passed through password_hash()
-		$hash = '#SHA1#$2y$10$XWRFN4jqCXkrL6e8TGEKZ.BIorXIx/09RmNqoGSpMfxiMHTvr10J2';
-
-		$this->assertTrue(
-			flux_password_needs_rehash($hash)
-		);
-	}
-}
diff --git a/tests/functions/flux_password_verify_Test.php b/tests/functions/flux_password_verify_Test.php
deleted file mode 100644
index f832a288..00000000
--- a/tests/functions/flux_password_verify_Test.php
+++ /dev/null
@@ -1,55 +0,0 @@
-<?php
-
-use PHPUnit\Framework\TestCase;
-
-require_once __DIR__.'/../../include/functions.php';
-
-class flux_password_verify_Test extends TestCase
-{
-	public function testVerificationFailsWithUnhashedPassword()
-	{
-		$this->assertFalse(
-			flux_password_verify('password', 'password')
-		);
-	}
-
-	public function testVerificationSucceedsWithModernHash()
-	{
-		// Generated by password_hash() - default algorithm, cost = 10
-		$hash = '$2y$10$2jxnmnumkXcRJKWLe7fZSeGQ7lM/Sq54hpN1Bup2CrP4iEvVlSPbe';
-
-		$this->assertTrue(
-			flux_password_verify('password', $hash)
-		);
-	}
-
-	public function testVerificationSucceedsWithMd5Hash()
-	{
-		// MD5 hash passed through password_hash()
-		$hash = '#MD5#$2y$10$r1LX7fOs7Wn7CvCgWYplleNs4Vt0qrSx3HCmE/bIpNRl6dtKL/XQO';
-
-		$this->assertTrue(
-			flux_password_verify('password', $hash)
-		);
-	}
-
-	public function testVerificationSucceedsWithSaltedSha1Hash()
-	{
-		// Salted SHA1 (salt = "pepper") passed through password_hash()
-		$hash = '#SHA1-S#pepper#$2y$10$wXrX5f8RUwX7kAPH2e1PgOQTNFHm5s/Jzt76icoFC81rX66cS7QSe';
-
-		$this->assertTrue(
-			flux_password_verify('password', $hash)
-		);
-	}
-
-	public function testVerificationSucceedsWithUnsaltedSha1Hash()
-	{
-		// SHA1 hash passed through password_hash()
-		$hash = '#SHA1#$2y$10$XWRFN4jqCXkrL6e8TGEKZ.BIorXIx/09RmNqoGSpMfxiMHTvr10J2';
-
-		$this->assertTrue(
-			flux_password_verify('password', $hash)
-		);
-	}
-}
diff --git a/userlist.php b/userlist.php
index 0eac7903..bb02b63c 100644
--- a/userlist.php
+++ b/userlist.php
@@ -137,7 +137,7 @@ while ($cur_group = $db->fetch_assoc($result))
 // Retrieve a list of user IDs, LIMIT is (really) expensive so we only fetch the IDs here then later fetch the remaining data
 $result = $db->query('SELECT u.id FROM '.$db->prefix.'users AS u WHERE u.id>1 AND u.group_id!='.PUN_UNVERIFIED.(!empty($where_sql) ? ' AND '.implode(' AND ', $where_sql) : '').' ORDER BY '.$sort_by.' '.$sort_dir.', u.id ASC LIMIT '.$start_from.', 50') or error('Unable to fetch user IDs', __FILE__, __LINE__, $db->error());
 
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 {
 	$user_ids = array();
 	for ($i = 0;$cur_user_id = $db->result($result, $i);$i++)
diff --git a/viewforum.php b/viewforum.php
index 8672a730..6f49847a 100644
--- a/viewforum.php
+++ b/viewforum.php
@@ -27,7 +27,7 @@ if (!$pun_user['is_guest'])
 else
 	$result = $db->query('SELECT f.forum_name, f.redirect_url, f.moderators, f.num_topics, f.sort_by, fp.post_topics, 0 AS is_subscribed FROM '.$db->prefix.'forums AS f LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND f.id='.$id) or error('Unable to fetch forum info', __FILE__, __LINE__, $db->error());
 
-if (!$db->has_rows($result))
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $cur_forum = $db->fetch_assoc($result);
@@ -80,20 +80,44 @@ $paging_links = '<span class="pages-label">'.$lang_common['Pages'].' </span>'.pa
 
 // Add relationship meta tags
 $page_head = array();
-$page_head['canonical'] = '<link rel="canonical" href="viewforum.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'" title="'.sprintf($lang_common['Page'], $p).'" />';
+$page_head['meta_robots'] = '<meta name="robots" content="noindex, follow">';
+$page_head['meta_desc'] = '<meta name="description" content="Listings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_forum['forum_name']).'’ subforum at the Textpattern CMS support forum.">';
+$page_head['twitter-card'] = '<meta name="twitter:card" content="summary">';
+$page_head['twitter-site'] = '<meta name="twitter:site" content="@txpforum">';
+$page_head['twitter-title'] = '<meta name="twitter:title" content="'.pun_htmlspecialchars($cur_forum['forum_name']).($p == 1 ? '' : ' ('.sprintf($lang_common['Page'], $p).')').'">';
+$page_head['twitter-description'] = '<meta name="twitter:description" content="Listings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_forum['forum_name']).'’ subforum at the Textpattern CMS support forum.">';
+$page_head['twitter-image'] = '<meta name="twitter:image:src" content="https://forum.textpattern.com/apple-touch-icon-180x180.png">';
+$page_head['twitter-url'] = '<meta name="twitter:url" content="https://forum.textpattern.com/viewforum.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'">';
+$page_head['og-site'] = '<meta property="og:site_name" content="Textpattern CMS support forum">';
+$page_head['og-type'] = '<meta property="og:type" content="website">';
+$page_head['og-title'] = '<meta property="og:title" content="'.pun_htmlspecialchars($cur_forum['forum_name']).($p == 1 ? '' : ' ('.sprintf($lang_common['Page'], $p).')').'">';
+$page_head['og-description'] = '<meta property="og:description" content="Listings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_forum['forum_name']).'’ subforum at the Textpattern CMS support forum.">';
+$page_head['og-image'] = '<meta property="og:image" content="https://textpattern.com/assets/img/branding/textpattern/textpattern-og.png">';
+$page_head['og-image-width'] = '<meta property="og:image:width" content="1200">';
+$page_head['og-image-height'] = '<meta property="og:image:height" content="1200">';
+$page_head['og-image-alt'] = '<meta property="og:image:alt" content="Textpattern logo">';
+$page_head['og-url'] = '<meta property="og:url" content="https://forum.textpattern.com/viewforum.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'">';
+$page_head['json-ld'] = '<script type="application/ld+json">'."\n".
+'{"@context": "https://schema.org",'."\n".
+'"@type": "WebPage",'."\n".
+'"headline": '.json_encode(pun_htmlspecialchars($cur_forum['forum_name']).($p == 1 ? '' : ' ('.sprintf($lang_common['Page'], $p).')')).','."\n".
+'"description": '.json_encode(pun_htmlspecialchars('Listings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_forum['forum_name']).'’ subforum at the Textpattern CMS support forum.')).','."\n".
+'"url": "https://forum.textpattern.com/viewforum.php?id='.intval($id).($p == 1 ? '' : '&p='.intval($p)).'"}'."\n".
+'</script>';
+$page_head['canonical'] = '<link rel="canonical" href="https://forum.textpattern.com/viewforum.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'" title="'.sprintf($lang_common['Page'], $p).'">';
 
 if ($num_pages > 1)
 {
 	if ($p > 1)
-		$page_head['prev'] = '<link rel="prev" href="viewforum.php?id='.$id.($p == 2 ? '' : '&amp;p='.($p - 1)).'" title="'.sprintf($lang_common['Page'], $p - 1).'" />';
+		$page_head['prev'] = '<link rel="prev" href="https://forum.textpattern.com/viewforum.php?id='.$id.($p == 2 ? '' : '&amp;p='.($p - 1)).'" title="'.sprintf($lang_common['Page'], $p - 1).'">';
 	if ($p < $num_pages)
-		$page_head['next'] = '<link rel="next" href="viewforum.php?id='.$id.'&amp;p='.($p + 1).'" title="'.sprintf($lang_common['Page'], $p + 1).'" />';
++		$page_head['next'] = '<link rel="next" href="https://forum.textpattern.com/viewforum.php?id='.$id.'&amp;p='.($p + 1).'" title="'.sprintf($lang_common['Page'], $p + 1).'">';
 }
 
 if ($pun_config['o_feed_type'] == '1')
-	$page_head['feed'] = '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;fid='.$id.'&amp;type=rss" title="'.$lang_common['RSS forum feed'].'" />';
+	$page_head['feed'] = '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;fid='.$id.'&amp;type=rss" title="'.$lang_common['RSS forum feed'].'">';
 else if ($pun_config['o_feed_type'] == '2')
-	$page_head['feed'] = '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;fid='.$id.'&amp;type=atom" title="'.$lang_common['Atom forum feed'].'" />';
+	$page_head['feed'] = '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;fid='.$id.'&amp;type=atom" title="'.$lang_common['Atom forum feed'].'">';
 
 $forum_actions = array();
 
@@ -112,11 +136,6 @@ if (!$pun_user['is_guest'])
 	$forum_actions[] = '<a href="misc.php?action=markforumread&amp;fid='.$id.$token_url.'">'.$lang_common['Mark forum read'].'</a>';
 }
 
-$crumbs = generate_crumbs(array(
-	array($lang_common['Index'], 'index.php'),
-	array($cur_forum['forum_name'], 'viewforum.php?id='.$id),
-));
-
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), pun_htmlspecialchars($cur_forum['forum_name']));
 define('PUN_ALLOW_INDEX', 1);
 define('PUN_ACTIVE_PAGE', 'index');
@@ -125,7 +144,10 @@ require PUN_ROOT.'header.php';
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><strong><a href="viewforum.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></a></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink conl"><?php echo $paging_links ?></p>
 <?php echo $post_link ?>
@@ -154,7 +176,7 @@ require PUN_ROOT.'header.php';
 $result = $db->query('SELECT id FROM '.$db->prefix.'topics WHERE forum_id='.$id.' ORDER BY sticky DESC, '.$sort_by.', id DESC LIMIT '.$start_from.', '.$pun_user['disp_topics']) or error('Unable to fetch topic IDs', __FILE__, __LINE__, $db->error());
 
 // If there are topics in this forum
-if ($db->has_rows($result))
+if ($db->num_rows($result))
 {
 	$topic_ids = array();
 	for ($i = 0; $cur_topic_id = $db->result($result, $i); $i++)
@@ -298,7 +320,10 @@ else
 			<p class="pagelink conl"><?php echo $paging_links ?></p>
 <?php echo $post_link ?>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><strong><a href="viewforum.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_forum['forum_name']) ?></a></strong></li>
+		</ul>
 <?php echo (!empty($forum_actions) ? "\t\t".'<p class="subscribelink clearb">'.implode(' - ', $forum_actions).'</p>'."\n" : '') ?>
 		<div class="clearer"></div>
 	</div>
diff --git a/viewtopic.php b/viewtopic.php
index 5cfb77a2..408c882c 100644
--- a/viewtopic.php
+++ b/viewtopic.php
@@ -28,7 +28,7 @@ require PUN_ROOT.'lang/'.$pun_user['language'].'/topic.php';
 if ($pid)
 {
 	$result = $db->query('SELECT topic_id, posted FROM '.$db->prefix.'posts WHERE id='.$pid) or error('Unable to fetch topic ID', __FILE__, __LINE__, $db->error());
-	if (!$db->has_rows($result))
+	if (!$db->num_rows($result))
 		message($lang_common['Bad request'], false, '404 Not Found');
 
 	list($id, $posted) = $db->fetch_row($result);
@@ -85,7 +85,7 @@ if (!$pun_user['is_guest'])
 else
 	$result = $db->query('SELECT t.subject, t.closed, t.num_replies, t.sticky, t.first_post_id, f.id AS forum_id, f.forum_name, f.moderators, fp.post_replies, 0 AS is_subscribed FROM '.$db->prefix.'topics AS t INNER JOIN '.$db->prefix.'forums AS f ON f.id=t.forum_id LEFT JOIN '.$db->prefix.'forum_perms AS fp ON (fp.forum_id=f.id AND fp.group_id='.$pun_user['g_id'].') WHERE (fp.read_forum IS NULL OR fp.read_forum=1) AND t.id='.$id.' AND t.moved_to IS NULL') or error('Unable to fetch topic info', __FILE__, __LINE__, $db->error());
 
-if (!$db->has_rows($result))
+if (!$db->num_rows($result))
 	message($lang_common['Bad request'], false, '404 Not Found');
 
 $cur_topic = $db->fetch_assoc($result);
@@ -171,26 +171,44 @@ else
 
 // Add relationship meta tags
 $page_head = array();
-$page_head['canonical'] = '<link rel="canonical" href="viewtopic.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'" title="'.sprintf($lang_common['Page'], $p).'" />';
+$page_head['meta_robots'] = '<meta name="robots" content="index, follow">';
+$page_head['meta_desc'] = '<meta name="description" content="Postings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_topic['subject']).'’ topic in the ‘'.pun_htmlspecialchars($cur_topic['forum_name']).'’ subforum.">';
+$page_head['twitter-card'] = '<meta name="twitter:card" content="summary">';
+$page_head['twitter-site'] = '<meta name="twitter:site" content="@txpforum">';
+$page_head['twitter-title'] = '<meta name="twitter:title" content="'.pun_htmlspecialchars($cur_topic['subject']).($p == 1 ? '' : ' ('.sprintf($lang_common['Page'], $p).')').'">';
+$page_head['twitter-description'] = '<meta name="twitter:description" content="Postings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_topic['subject']).'’ topic in the ‘'.pun_htmlspecialchars($cur_topic['forum_name']).'’ subforum.">';
+$page_head['twitter-image'] = '<meta name="twitter:image:src" content="https://forum.textpattern.com/apple-touch-icon-180x180.png">';
+$page_head['twitter-url'] = '<meta name="twitter:url" content="https://forum.textpattern.com/viewtopic.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'">';
+$page_head['og-site'] = '<meta property="og:site_name" content="Textpattern CMS support forum">';
+$page_head['og-type'] = '<meta property="og:type" content="website">';
+$page_head['og-title'] = '<meta property="og:title" content="'.pun_htmlspecialchars($cur_topic['subject']).($p == 1 ? '' : ' ('.sprintf($lang_common['Page'], $p).')').'">';
+$page_head['og-description'] = '<meta property="og:description" content="Postings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.pun_htmlspecialchars($cur_topic['subject']).'’ topic in the ‘'.pun_htmlspecialchars($cur_topic['forum_name']).'’ subforum.">';
+$page_head['og-image'] = '<meta property="og:image" content="https://textpattern.com/assets/img/branding/textpattern/textpattern-og.png">';
+$page_head['og-image-width'] = '<meta property="og:image:width" content="1200">';
+$page_head['og-image-height'] = '<meta property="og:image:height" content="1200">';
+$page_head['og-image-alt'] = '<meta property="og:image:alt" content="Textpattern logo">';
+$page_head['og-url'] = '<meta property="og:url" content="https://forum.textpattern.com/viewtopic.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'">';
+$page_head['json-ld'] = '<script type="application/ld+json">'."\n".
+'{"@context": "https://schema.org",'."\n".
+'"@type": "WebPage",'."\n".
+'"headline": '.json_encode(pun_htmlspecialchars($cur_topic['subject']).($p == 1 ? '' : ' ('.sprintf($lang_common['Page'], $p).')')).','."\n".
+'"description": '.json_encode(pun_htmlspecialchars('Postings in'.($p == 1 ? '' : ' page '.$p.' of').' the ‘'.$cur_topic['subject'].'’ topic in the ‘'.$cur_topic['forum_name'].'’ subforum.')).','."\n".
+'"url": "https://forum.textpattern.com/viewtopic.php?id='.intval($id).($p == 1 ? '' : '&p='.intval($p)).'"}'."\n".
+'</script>';
+$page_head['canonical'] = '<link rel="canonical" href="https://forum.textpattern.com/viewtopic.php?id='.$id.($p == 1 ? '' : '&amp;p='.$p).'" title="'.sprintf($lang_common['Page'], $p).'">';
 
 if ($num_pages > 1)
 {
 	if ($p > 1)
-		$page_head['prev'] = '<link rel="prev" href="viewtopic.php?id='.$id.($p == 2 ? '' : '&amp;p='.($p - 1)).'" title="'.sprintf($lang_common['Page'], $p - 1).'" />';
+		$page_head['prev'] = '<link rel="prev" href="https://forum.textpattern.com/viewtopic.php?id='.$id.($p == 2 ? '' : '&amp;p='.($p - 1)).'" title="'.sprintf($lang_common['Page'], $p - 1).'">';
 	if ($p < $num_pages)
-		$page_head['next'] = '<link rel="next" href="viewtopic.php?id='.$id.'&amp;p='.($p + 1).'" title="'.sprintf($lang_common['Page'], $p + 1).'" />';
+		$page_head['next'] = '<link rel="next" href="https://forum.textpattern.com/viewtopic.php?id='.$id.'&amp;p='.($p + 1).'" title="'.sprintf($lang_common['Page'], $p + 1).'">';
 }
 
 if ($pun_config['o_feed_type'] == '1')
-	$page_head['feed'] = '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;tid='.$id.'&amp;type=rss" title="'.$lang_common['RSS topic feed'].'" />';
+	$page_head['feed'] = '<link rel="alternate" type="application/rss+xml" href="extern.php?action=feed&amp;tid='.$id.'&amp;type=rss" title="'.$lang_common['RSS topic feed'].'">';
 else if ($pun_config['o_feed_type'] == '2')
-	$page_head['feed'] = '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid='.$id.'&amp;type=atom" title="'.$lang_common['Atom topic feed'].'" />';
-
-$crumbs = generate_crumbs(array(
-	array($lang_common['Index'], 'index.php'),
-	array($cur_topic['forum_name'], 'viewforum.php?id='.$cur_topic['forum_id']),
-	array($cur_topic['subject'], 'viewtopic.php?id='.$id),
-));
+	$page_head['feed'] = '<link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid='.$id.'&amp;type=atom" title="'.$lang_common['Atom topic feed'].'">';
 
 $page_title = array(pun_htmlspecialchars($pun_config['o_board_title']), pun_htmlspecialchars($cur_topic['forum_name']), pun_htmlspecialchars($cur_topic['subject']));
 define('PUN_ALLOW_INDEX', 1);
@@ -200,7 +218,11 @@ require PUN_ROOT.'header.php';
 ?>
 <div class="linkst">
 	<div class="inbox crumbsplus">
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $cur_topic['forum_id'] ?>"><?php echo pun_htmlspecialchars($cur_topic['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><strong><a href="viewtopic.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></a></strong></li>
+		</ul>
 		<div class="pagepost">
 			<p class="pagelink conl"><?php echo $paging_links ?></p>
 <?php echo $post_link ?>
@@ -368,11 +390,11 @@ while ($cur_post = $db->fetch_assoc($result))
 
 ?>
 <div id="p<?php echo $cur_post['id'] ?>" class="blockpost<?php echo ($post_count % 2 == 0) ? ' roweven' : ' rowodd' ?><?php if ($cur_post['id'] == $cur_topic['first_post_id']) echo ' firstpost'; ?><?php if ($post_count == 1) echo ' blockpost1'; ?>">
-	<h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <a href="viewtopic.php?pid=<?php echo $cur_post['id'].'#p'.$cur_post['id'] ?>"><?php echo format_time($cur_post['posted']) ?></a></span></h2>
 	<div class="box">
 		<div class="inbox">
 			<div class="postbody">
 				<div class="postleft">
+                    <h2><span><span class="conr">#<?php echo ($start_from + $post_count) ?></span> <a href="viewtopic.php?pid=<?php echo $cur_post['id'].'#p'.$cur_post['id'] ?>"><?php echo format_time($cur_post['posted']) ?></a></span></h2>
 					<dl>
 						<dt><strong><?php echo $username ?></strong></dt>
 						<dd class="usertitle"><strong><?php echo $user_title ?></strong></dd>
@@ -411,7 +433,11 @@ while ($cur_post = $db->fetch_assoc($result))
 			<p class="pagelink conl"><?php echo $paging_links ?></p>
 <?php echo $post_link ?>
 		</div>
-		<?php echo $crumbs ?>
+		<ul class="crumbs">
+			<li><a href="index.php"><?php echo $lang_common['Index'] ?></a></li>
+			<li><span>»&#160;</span><a href="viewforum.php?id=<?php echo $cur_topic['forum_id'] ?>"><?php echo pun_htmlspecialchars($cur_topic['forum_name']) ?></a></li>
+			<li><span>»&#160;</span><strong><a href="viewtopic.php?id=<?php echo $id ?>"><?php echo pun_htmlspecialchars($cur_topic['subject']) ?></a></strong></li>
+		</ul>
 <?php echo $subscraction ?>
 		<div class="clearer"></div>
 	</div>
@@ -445,8 +471,8 @@ if ($pun_user['is_guest'])
 	$email_form_name = ($pun_config['p_force_guest_email'] == '1') ? 'req_email' : 'email';
 
 ?>
-						<label class="conl required"><strong><?php echo $lang_post['Guest name'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" size="25" maxlength="25" tabindex="<?php echo $cur_index++ ?>" /><br /></label>
-						<label class="conl<?php echo ($pun_config['p_force_guest_email'] == '1') ? ' required' : '' ?>"><?php echo $email_label ?><br /><input type="text" name="<?php echo $email_form_name ?>" size="50" maxlength="80" tabindex="<?php echo $cur_index++ ?>" /><br /></label>
+						<label class="conl required"><strong><?php echo $lang_post['Guest name'] ?> <span><?php echo $lang_common['Required'] ?></span></strong><br /><input type="text" name="req_username" size="25" maxlength="25" required /><br /></label>
+						<label class="conl<?php echo ($pun_config['p_force_guest_email'] == '1') ? ' required' : '' ?>"><?php echo $email_label ?><br /><input type="text" name="<?php echo $email_form_name ?>" size="50" maxlength="80" /><br /></label>
 						<div class="clearer"></div>
 <?php
 
@@ -456,7 +482,7 @@ else
 	echo "\t\t\t\t\t\t".'<label>';
 
 ?>
-<textarea name="req_message" rows="7" cols="75" tabindex="<?php echo $cur_index++ ?>"></textarea></label>
+<textarea name="req_message" rows="7" cols="75" required></textarea></label>
 						<ul class="bblinks">
 							<li><span><a href="help.php#bbcode" onclick="window.open(this.href); return false;"><?php echo $lang_common['BBCode'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>
 							<li><span><a href="help.php#url" onclick="window.open(this.href); return false;"><?php echo $lang_common['url tag'] ?></a> <?php echo ($pun_config['p_message_bbcode'] == '1' && $pun_user['g_post_links'] == '1') ? $lang_common['on'] : $lang_common['off']; ?></span></li>
@@ -467,7 +493,7 @@ else
 				</fieldset>
 			</div>
 <?php flux_hook('quickpost_before_submit') ?>
-			<p class="buttons"><input type="submit" name="submit" tabindex="<?php echo $cur_index++ ?>" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_topic['Preview'] ?>" tabindex="<?php echo $cur_index++ ?>" accesskey="p" /></p>
+			<p class="buttons"><input type="submit" name="submit" value="<?php echo $lang_common['Submit'] ?>" accesskey="s" /> <input type="submit" name="preview" value="<?php echo $lang_topic['Preview'] ?>" accesskey="p" /></p>
 		</form>
 	</div>
 </div>
